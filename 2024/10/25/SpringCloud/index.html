<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringCloud | Aoaojiao</title><meta name="author"><meta name="copyright"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、SpringCloud概述1.1 微服务是什么由于单体应用的局限性和性能瓶颈，使得微服务技术的出现。微服务就是将单体应用的各个功能拆分成各种服务，每一个服务是一个单独的进程。服务与服务之间互不干扰，也就是说在开发的时候可以去并行开发，每个人可以负责开发不同的模块，也就是我们所说的服务。由于是单个服务，所以在请求流量多的情况下我们可以扩容当前服务，从而减少资源的浪费，就好比如我们的上传和下载服务">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="https://dd-xiaozhi.github.io/dd/2024/10/25/SpringCloud/index.html">
<meta property="og:site_name" content="Aoaojiao">
<meta property="og:description" content="一、SpringCloud概述1.1 微服务是什么由于单体应用的局限性和性能瓶颈，使得微服务技术的出现。微服务就是将单体应用的各个功能拆分成各种服务，每一个服务是一个单独的进程。服务与服务之间互不干扰，也就是说在开发的时候可以去并行开发，每个人可以负责开发不同的模块，也就是我们所说的服务。由于是单个服务，所以在请求流量多的情况下我们可以扩容当前服务，从而减少资源的浪费，就好比如我们的上传和下载服务">
<meta property="og:locale">
<meta property="og:image" content="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png">
<meta property="article:published_time" content="2024-10-24T17:53:53.000Z">
<meta property="article:modified_time" content="2025-08-27T18:21:54.151Z">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png"><link rel="shortcut icon" href="/dd/static/img/twemoji--grinning-cat.svg"><link rel="canonical" href="https://dd-xiaozhi.github.io/dd/2024/10/25/SpringCloud/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/dd/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/dd/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'medium_zoom',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-center"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-28 02:21:54'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/dd/static/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/dd/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/dd/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/dd/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/dd/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/dd/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/dd/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/dd/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/dd/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/dd/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/dd/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/dd/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/dd/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://picsum.photos/id/316/400/400);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/dd/"><img class="site-icon" src="/dd/static/img/twemoji--grinning-cat.svg" alt="Logo"><span class="site-name">Aoaojiao</span></a><a class="nav-page-title" href="/dd/"><span class="site-name">SpringCloud</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/dd/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/dd/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/dd/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/dd/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/dd/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/dd/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/dd/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/dd/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/dd/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-27T18:21:54.151Z" title="Updated 2025-08-28 02:21:54">2025-08-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、SpringCloud概述"><a href="#一、SpringCloud概述" class="headerlink" title="一、SpringCloud概述"></a>一、SpringCloud概述</h1><h2 id="1-1-微服务是什么"><a href="#1-1-微服务是什么" class="headerlink" title="1.1 微服务是什么"></a>1.1 微服务是什么</h2><p>由于单体应用的局限性和性能瓶颈，使得微服务技术的出现。微服务就是将单体应用的各个功能拆分成各种服务，每一个服务是一个单独的进程。服务与服务之间互不干扰，也就是说在开发的时候可以去并行开发，每个人可以负责开发不同的模块，也就是我们所说的服务。由于是单个服务，所以在请求流量多的情况下我们可以扩容当前服务，从而减少资源的浪费，就好比如我们的上传和下载服务是不经常使用，而下订单的服务是流量巨大的，那么我们就可以对下单的这个服务进行扩容。相比于单体应用，微服务的可扩展性提高了。服务拆分必然会出现很多的问题，服务与服务之间的调用问题，服务的监控问题，服务的链路追踪问题。</p>
<p>SpringCound提供了分布式微服务架构的一站式解决方案，俗称微服务全家桶，它是微服务开发的主流技术栈，在国内开发者社区非常火爆。spring Cloud Alibaba较为突出。它通过一系列的技术来解决分布式微服务所带来的问题。</p>
<p>例子：京东2018年的架构</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205120403321.png" alt="image-20230205120403321"></p>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205114858713.png" alt="image-20230205114858713" style="zoom:67%;" />

<p>业务和非业务的模块进行拆分</p>
<h2 id="1-2-SpringCloud主流技术栈"><a href="#1-2-SpringCloud主流技术栈" class="headerlink" title="1.2 SpringCloud主流技术栈"></a>1.2 SpringCloud主流技术栈</h2><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205115124762.png" alt="image-20230205115124762"></p>
<p>上图所示技术在2020年几乎都已经被新技术替代，但是他们的使用方式和原理大体类似，这里我们还是会学习这些技术，因为一些老项目会用到这些技术</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205161827474.png" alt="image-20230205161827474"></p>
<h2 id="1-3-Boot和Could技术选型"><a href="#1-3-Boot和Could技术选型" class="headerlink" title="1.3 Boot和Could技术选型"></a>1.3 Boot和Could技术选型</h2><p>在官网中可以看到springCloud对应建议的Boot版本</p>
<h1 id="二、微服务工程搭建"><a href="#二、微服务工程搭建" class="headerlink" title="二、微服务工程搭建"></a>二、微服务工程搭建</h1><p><strong>五大步骤</strong></p>
<ol>
<li>建模块</li>
<li>改pom</li>
<li>改yalml</li>
<li>主启动</li>
<li>业务类</li>
</ol>
<p>&#x3D;&#x3D;最重要的一步：先搭建好环境，防止环境出现问题！！！&#x3D;&#x3D;</p>
<p>需要构建两个服务，订单服务和支付服务，订单服务去调用支付服务的接口</p>
<h2 id="父工程搭建"><a href="#父工程搭建" class="headerlink" title="父工程搭建"></a>父工程搭建</h2><p>创建一个空的Maven项目</p>
<p>修改POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.com<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 统一管理jar包版本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 子模块继承之后，提供作用：锁定版本+子modlue不用写groupId和version  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="支付模块搭建"><a href="#支付模块搭建" class="headerlink" title="支付模块搭建"></a>支付模块搭建</h2><h3 id="①创建模块"><a href="#①创建模块" class="headerlink" title="①创建模块"></a>①创建模块</h3><p>cloud-provider-payment</p>
<h3 id="②修改Pom"><a href="#②修改Pom" class="headerlink" title="②修改Pom"></a>②修改Pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.com<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="③改yalml"><a href="#③改yalml" class="headerlink" title="③改yalml"></a>③改yalml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.gjt.mm.mysql.Driver</span>              <span class="comment"># mysql驱动包 com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://study-mysql.com:3306/spring-cloud-study?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">abc123</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.atguigu.springcloud.entities</span>    <span class="comment"># 所有Entity别名类所在包</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>



<h3 id="④主启动"><a href="#④主启动" class="headerlink" title="④主启动"></a>④主启动</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="⑤业务类"><a href="#⑤业务类" class="headerlink" title="⑤业务类"></a>⑤业务类</h3><ul>
<li><p>entity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String serial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span>;</span><br><span class="line"></span><br><span class="line">    Payment <span class="title function_">getPaymentById</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.springcloud.mapper.PaymentMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;payment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">property</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;create&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Payment&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert into payment(SERIAL) VALUES (#&#123;serial&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getPaymentById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT * FROM payment where `id`= #&#123;id&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">PayService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentMapper paymentMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentMapper.create(payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentMapper.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PayService payService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">addPayment</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> payService.create(payment);</span><br><span class="line">        log.info(<span class="string">&quot;插入结果为 --- &#123;&#125;&quot;</span>, res);</span><br><span class="line">        <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;添加成功&quot;</span>, res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>, <span class="string">&quot;添加失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getPaymentById&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> payService.getPaymentById(id);</span><br><span class="line">        log.info(<span class="string">&quot;查询结果为 --- &#123;&#125;&quot;</span>, payment);</span><br><span class="line">        <span class="keyword">if</span> (payment != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;查询成功&quot;</span>, payment);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>, <span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="订单模块搭建"><a href="#订单模块搭建" class="headerlink" title="订单模块搭建"></a>订单模块搭建</h2><p>和支付模块一样的步骤，同时假设订单模块调用支付模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.com<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consumer-order8002<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CommonResult和Payment类</span><br></pre></td></tr></table></figure>



<p><strong>RestTemplate</strong></p>
<p>spring提供的发起http请求的请求类，和<code>Httpclient</code>的功能类似，它是web模块下的，所以不需要引入额外依赖，只需要将它注册到容器中即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是使用<code>RestTemplate</code>请求服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PaymentSrv_URL</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8001&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/addOrder&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">addPayment</span><span class="params">(Payment payment)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(PaymentSrv_URL + <span class="string">&quot;/payment/add&quot;</span>,</span><br><span class="line">                payment, CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getOrderById&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PaymentSrv_URL + <span class="string">&quot;/payment/getPaymentById?id=&quot;</span> + id,</span><br><span class="line">                CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试通过~~~~</p>
<h2 id="抽取公共模块"><a href="#抽取公共模块" class="headerlink" title="抽取公共模块"></a>抽取公共模块</h2><p>观察发现两个模块都有相同的两个实体类，而且<code>CommonResult</code>应该不属于是业务类中的，所以需要将他们抽取出来放入到公共模块<code>common</code>或者<code>model</code>模块</p>
<p>接下进行改造，将entities移动到<code>common</code>模块下，同时将一下公共的依赖也放到<code>common</code>下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230205174812928.png" alt="image-20230205174812928"></p>
<p>其他模块引用它即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.com<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以后就可以实体类放到common中了，这样就不用重复写</p>
<h1 id="三、服务注册与发现"><a href="#三、服务注册与发现" class="headerlink" title="三、服务注册与发现"></a>三、服务注册与发现</h1><p><strong>什么是服务治理</strong></p>
<p>在我们的前一章节，我们使用了<code>RestTemplate</code>来直接请求目标地址，这种调用方式是非常方便的，但是会出现一个问题，那就是一旦微服务模块多了之后，它们之间的依赖关系就非常复杂，难以管理。想想一下，如果某些服务地址改变，我们程序中的请求地址也需要修改，如果项目非常大的话，改起来也是很麻烦的。所以需要使用服务治理，管理服务与服务之间的依赖，实现服务的调用、负载均衡、容错等，实现服务注册与发现。</p>
<p><strong>什么是服务注册与发现</strong></p>
<p>服务注册：要对服务进行管理，首先需要告诉我服务在哪，它叫什么，所以在调度之间需要将服务的信息注册到服务注册中心。</p>
<p>发现：通过轮询的负载算法发送心跳，默认周期是30秒，如果在多个周期没有收到来自服务的心跳，注册中心就会移除这个服务。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206114138304.png" alt="image-20230206114138304"></p>
<p>上图左边是Eureka的架构，右图是Dubbo的架构。都是先注册，然后再调用</p>
<h2 id="Eureka（停更维护⚠）"><a href="#Eureka（停更维护⚠）" class="headerlink" title="Eureka（停更维护⚠）"></a>Eureka（停更维护⚠）</h2><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206114554754.png" alt="image-20230206114554754"></p>
<p><em><strong>Eureka有两大组件</strong></em></p>
<ul>
<li><p>Eureka Server：提供服务注册服务。</p>
<p>各个微服务节点通过配置启动后，会在Eureka Server进行注册，在Eureka的管理界面可以看到已注册的服务信息</p>
</li>
<li><p>Eureka Client：通过注册中心进行访问。</p>
<p>是一个Java客户端，用于简化Eureka Server的交互，客户端同时也具备一个内置的、使用轮询(round-robin)负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心跳(默认周期为30秒)。如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，EurekaServer将会从服务注册表中把这个服务节点移除（默认90秒）</p>
</li>
</ul>
<h3 id="搭建单机服务"><a href="#搭建单机服务" class="headerlink" title="搭建单机服务"></a>搭建单机服务</h3><p>改造我们之前的两个服务（订单和支付），使用Eureka对他们进行管理</p>
<h4 id="①搭建注册中心"><a href="#①搭建注册中心" class="headerlink" title="①搭建注册中心"></a>①搭建注册中心</h4><ol>
<li><p>建模块 -&gt; <code>cloud-eureka-server7001</code></p>
</li>
<li><p>改pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-eureka-server7001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--boot web actuator--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--一般通用配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>改yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 是否向注册中心注册 -&gt; 当前是注册中心，所以为false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 是否需要检索服务 -&gt; false表示当前端是服务中心</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 注册中心的地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaMain7001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>&#x3D;&#x3D;注意：Server端的启动注解是<code>@EnableEurekaServer</code>，客户端的启动注解是<code>@EnableEurekaClient</code>&#x3D;&#x3D;</p>
<p>启动测试：浏览器中输入<code>localhost:7001</code>访问控制页面</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206121914411.png" alt="image-20230206121914411"></p>
<p>测试成功~~~</p>
<h4 id="②将模块注册"><a href="#②将模块注册" class="headerlink" title="②将模块注册"></a>②将模块注册</h4><p>两个模块执行同样的操作</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>改yml -&gt; 添加eurake的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 是否注册到eureka中 -&gt; true为是</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否是否从EurekaServer抓取已有的注册信息，默认为true。</span></span><br><span class="line">    <span class="comment"># 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 注册中心的服务地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动测试</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206122324638.png" alt="image-20230206122324638"></p>
<p>可以看到服务都注册进来</p>
</li>
</ol>
<p>&#x3D;&#x3D;<em><strong>出现一个小问题</strong></em>&#x3D;&#x3D;<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206122047376.png" alt="image-20230206122047376"></p>
<p>注意：出现<code>UNKNOWN</code>是因为我们没有给服务起名字，加上名字就可以显示了</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br></pre></td></tr></table></figure>

<p>成功~~~</p>
<h4 id="③调用服务"><a href="#③调用服务" class="headerlink" title="③调用服务"></a>③调用服务</h4><p>这里不用修改，还是使用<code>RestTemplate</code>发起请求</p>
<h3 id="搭建集群服务"><a href="#搭建集群服务" class="headerlink" title="搭建集群服务"></a>搭建集群服务</h3><p> 问题：微服务RPC远程调用服务的核心是什么？</p>
<p>高可用，服务中心挂了，整个微服务不可用，所以要采用集群服务保证它的高可用</p>
<h4 id="①集群原理说明"><a href="#①集群原理说明" class="headerlink" title="①集群原理说明"></a>①集群原理说明</h4><p>Eurake 服务和 Eurake服务之间相互注册，彼此守望。</p>
<h4 id="②搭建"><a href="#②搭建" class="headerlink" title="②搭建"></a>②搭建</h4><ol>
<li><p>创建第二个Eurake Server，模块名为<code>cloud-eureka-server7002</code>，&#x3D;&#x3D;端口号为7002&#x3D;&#x3D;</p>
</li>
<li><p>pom一致</p>
</li>
<li><p>yaml些许不同</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206142300581.png" alt="image-20230206142300581"></p>
<p>首先，因为是搭建集群，所以会有很多台机器，所以它们的主机名不能为同样，我们是在本地测试的，因此使用主机名映射的方式来测试。在本地的<code>host</code>文件修改映射</p>
<table>
<thead>
<tr>
<th>域名</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>eureka7001.com</td>
<td>127.0.0.1</td>
</tr>
<tr>
<td>eureka7002.com</td>
<td>127.0.0.1</td>
</tr>
</tbody></table>
<p>映射完成之后还需要修改需要将服务注册的目标注册中心，集群之间的服务相互注册，也就是说7001需要注册到7002，7002需要注册到7001。接下来需要修改<code>yml配置</code></p>
<p><strong>服务主机名修改，两个都要修改成对应的主机名</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206143606854.png" alt="image-20230206143606854"></p>
<p><strong>注册中心地址修改</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206142837211.png" alt="image-20230206142837211"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 7001 配置</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="comment"># defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">  <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002.comeureka/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 7002 配置</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="comment"># defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">  <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001.comeureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动测试</p>
<p>7001显示</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206144705582.png" alt="image-20230206144705582"></p>
<p>7002显示</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206144738040.png" alt="image-20230206144738040"></p>
<p>完美~~~，老子真是天才，哈哈哈</p>
</li>
</ol>
<h4 id="③服务注册到注册中心集群"><a href="#③服务注册到注册中心集群" class="headerlink" title="③服务注册到注册中心集群"></a>③服务注册到注册中心集群</h4><p>需要修改yml文件，将注册中心的地址进行添加，两个模块都要</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册中心的服务地址</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206145858717.png" alt="image-20230206145858717"></p>
<p>测试成功~~~,芜湖</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>我i们说订单模块它是消费者，支付模块是提供者，那么在微服务中，服务者一般也是以集群的形式部署，eureka可以对请求进行负载均衡，让集群平摊请求流量</p>
<h4 id="①提供者增加"><a href="#①提供者增加" class="headerlink" title="①提供者增加"></a>①提供者增加</h4><p>当前我们的支付模块只有一个，我们给它增加一个，其他的保持不变，端口号改为<code>8003</code>，模块名为<code>cloud-eutake-server8003</code></p>
<h4 id="②修改消费者的请求路径"><a href="#②修改消费者的请求路径" class="headerlink" title="②修改消费者的请求路径"></a>②修改消费者的请求路径</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206150900172.png" alt="image-20230206150900172"></p>
<p>在之前我们这个请求地址是写死的，这样就达不到负载均衡的效果，所以需要将它的地址修改为eureka提供的地址<code>http://CLOUD-PAYMENT-SERVICE</code>，可以看到这个域名就是我们的应用名，所以这个应用名是很重要的!!!</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206151223413.png" alt="image-20230206151223413"></p>
<p>接着需要修改一下我们的支付模块接口，让它输出的信息可以看到是调用那个端口号的服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer serverPort;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206151534475.png" alt="image-20230206151534475"></p>
<p>最后，需要添加一个注解开启负载功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span> <span class="comment">//使用@LoadBalanced注解赋予RestTemplate负载均衡的能力</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="③启动测试"><a href="#③启动测试" class="headerlink" title="③启动测试"></a>③启动测试</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206152450167.png" alt="image-20230206152450167"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206152435291.png" alt="image-20230206152435291"></p>
<p>完美~~~</p>
<h3 id="actuator微服务信息完善"><a href="#actuator微服务信息完善" class="headerlink" title="actuator微服务信息完善"></a>actuator微服务信息完善</h3><h4 id="监控接口名"><a href="#监控接口名" class="headerlink" title="监控接口名"></a>监控接口名</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206165752800.png" alt="image-20230206165752800"></p>
<p>在eueka的管理界面可以看到有<code>actuator</code>信息相关的链接，它的命名是<code>主机名:服务名:端口号</code>，我们可以将它修改成我们的业务名称。这个链接跳转的url是<code>主机名:端口号/actuator/info</code>，是以主机名的方式去访问，我们可以修改成以ip的方式去访问，这样可以在排查错误的时候定位那个机子出现了问题。</p>
<h4 id="修改服务id和显示ip"><a href="#修改服务id和显示ip" class="headerlink" title="修改服务id和显示ip"></a>修改服务id和显示ip</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206171048764.png" alt="image-20230206171048764"></p>
<p>当前只修改了一台机子，所以另外两台还是默认的命名</p>
<p>点击链接跳转可以看到ip显示出来了</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206171133576.png" alt="image-20230206171133576"></p>
<h3 id="服务发现Discovery"><a href="#服务发现Discovery" class="headerlink" title="服务发现Discovery"></a>服务发现Discovery</h3><p>怎么获取注册中心上的服务信息呢，通过服务发现机制获取</p>
<p>这里我们获取<code>payment8001</code>服务的信息</p>
<ol>
<li><p>依赖<code>DiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改PaymentController  -&gt; 创建访问接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DiscoveryClient <span class="title function_">getDiscovery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取所有服务</span></span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">        log.info(service);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取实例</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">        log.info(instance.getServiceId() + <span class="string">&quot;\t&quot;</span> + instance.getHost()</span><br><span class="line">                 + <span class="string">&quot;\t&quot;</span> + instance.getPort() + <span class="string">&quot;\t&quot;</span> + instance.getUri());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启服务发现机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主类添加</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x3D;&#x3D;注意：需要将<code>eureka.client.fetch-registry</code>改为<code>true</code>才能获取到服务信息，因为这个功能就是控制我们是否能获取注册中心信息的开关.&#x3D;&#x3D;</p>
</li>
</ol>
<p><strong>测试</strong></p>
<p>访问<code>http://localhost:8001/payment/discovery</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206173433796.png" alt="image-20230206173433796"></p>
<p>可以看到返回的是注册的服务列表</p>
<p>查看日志输出</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206173647625.png" alt="image-20230206173647625"></p>
<p>可以看到我们获取的指定服务id的服务实例，可以看到我们修改和没修改的两个服务</p>
<h3 id="Eureka自我保护模式"><a href="#Eureka自我保护模式" class="headerlink" title="Eureka自我保护模式"></a>Eureka自我保护模式</h3><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230206164113933.png" alt="image-20230206164113933"></p>
<p>在eureka的管理界面可以看到这一行话，它的意思是Eureka进入了保护模式</p>
<h4 id="什么是自我保护模式"><a href="#什么是自我保护模式" class="headerlink" title="什么是自我保护模式"></a><em><strong>什么是自我保护模式</strong></em></h4><p>eureka发现机制是默认每30秒发送一起心跳，如果30过后没有发送心跳，开启自我保护模式的话，那么它默认将此服务信息保存90秒，在90秒内还是没有发送心跳，那么它就会将此服务移除。关闭自我保护模式的话，在指定时间没有收到Eureka Clinet发送的心跳，它会直接移除，不进行自我保护（残忍的Eureka~~~）。</p>
<p>自我保护的好处就是在发送心跳的过程中服务网络拥塞或者服务执行缓慢导致心跳发送不及时，这个时候eureka会给它一定的时间发送心跳，如果超出这一段时间，那么eureka只能狠心的将它移除。</p>
<p>自我保护模式符合CSP中的AP机制</p>
<h4 id="如何关闭自我保护模式"><a href="#如何关闭自我保护模式" class="headerlink" title="如何关闭自我保护模式"></a><em><strong>如何关闭自我保护模式</strong></em></h4><p>它默认是开启的，我们想要关闭就需要修改它的配置，也就是修改<code>yaml配置文件</code></p>
<ul>
<li><p>Eureka Server端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="comment"># 禁用自我保护模式</span></span><br><span class="line">  <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Eureka Client端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 发送心跳间隔时间，默认是30s</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 等待时间，默认是90s，开启自我保护模式会等待到指定的时间，在指定时间内没有发送心跳，eureka移除该服务信息</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>测试</strong></p>
<p>启动Server，在启动client，然后停掉client，看管理页面是否还有该服务</p>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><p>zookeeper是一个分布式协调工具，可以实现注册中心功能。一般是用它去替代eureka，但是用的少，这里介绍一下单机版的zookeeper，集群的可以自行学习。安装这里也不讲解。当前使用的cloud对应的zookeeper版本是<code>3.5.3-beta</code></p>
<h3 id="①构建服务提供者"><a href="#①构建服务提供者" class="headerlink" title="①构建服务提供者"></a>①构建服务提供者</h3><p>向zk注册信息</p>
<ol>
<li><p>建模块 -&gt; 新建cloud-provider-payment8004</p>
</li>
<li><p>改pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>改yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8004</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务别名----注册zookeeper到注册中心名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-payment</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="comment"># zk服务器地址，我这里做了映射</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">study-zookeeper.com:2181</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>  <span class="comment">//该注解用于向使用consul或者zookeeper作为注册中心时注册服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8004</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8004.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类</p>
</li>
</ol>
<p><strong>查看</strong></p>
<p>启动zk的client端查看注册的信息</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207111756161.png" alt="image-20230207111756161"></p>
<p>zk是无状态的，只要服务下线，立刻将服务信息删除，再次上线，重新分配新的id。不像eureka那样拥有自我保护机制。</p>
<h3 id="②构建服务消费者"><a href="#②构建服务消费者" class="headerlink" title="②构建服务消费者"></a>②构建服务消费者</h3><p>调用提供者的接口</p>
<ol>
<li><p>新建cloud-consumerzk-order8002模块</p>
</li>
<li><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8004</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务别名----注册zookeeper到注册中心名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-payment</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">study-zookeeper.com:2181</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>  <span class="comment">//该注解用于向使用consul或者zookeeper作为注册中心时注册服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8004</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8004.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/zk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentZK</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;springcloud with ck：&quot;</span> + serverPort + <span class="string">&quot;\t&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>查看服务是否注册进zk</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207113727953.png" alt="image-20230207113727953"></p>
<p>测试服务是否正常 -&gt; 访问<code>http://localhost:8002/consumer/payment/zk</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207113755471.png" alt="image-20230207113755471"></p>
<p>正常~~~😋😋😋</p>
<h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p>官网：<code>https://www.consul.io/</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207141931306.png" alt="image-20230207141931306"></p>
<p>上图是官网的说明。</p>
<p>翻译：HashiCorp Consul 是一种服务网络解决方案，使团队能够管理服务之间以及跨本地和多云环境和运行时的安全网络连接。Consul 为网络基础设施设备提供服务发现、服务网格、流量管理和自动更新。您可以在单个 Consul 部署中单独或一起使用这些功能。</p>
<p>人话：就是服务注册与发现功能和服务管理，当然还有一些其他的功能</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>实现</th>
</tr>
</thead>
<tbody><tr>
<td>服务发现</td>
<td>提供HTTP和DNS两种发现方式。</td>
</tr>
<tr>
<td>健康监测</td>
<td>支持多种方式，HTTP、TCP、Docker、Shell脚本定制化监控</td>
</tr>
<tr>
<td>KV存储</td>
<td>Key、Value的存储方式</td>
</tr>
<tr>
<td>多数据中心</td>
<td>Consul支持多数据中心</td>
</tr>
<tr>
<td>可视化Web界面</td>
<td></td>
</tr>
</tbody></table>
<h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h3><p>在官网下载，这里选择的是<code>1.13.0</code>版本，选择适合你的机器的系统和架构类型，我这里是window和x86架构</p>
<p>下载完解压后是一个<code>.exe</code>文件。</p>
<p><em><strong>运行</strong></em>：打开cmd界面输入<code>consul agent -dev</code>，它默认是在本机的<code>8500</code>端口</p>
<p><em><strong>访问</strong></em>：浏览器输入<code>http://localhost:8500/</code>或<code>http://localhost:8500/ui/dc1/services</code>访问可视化web界面</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207141708460.png" alt="image-20230207141708460"></p>
<h3 id="3-使用"><a href="#3-使用" class="headerlink" title="3.使用"></a>3.使用</h3><p>还是一样的套路，五步走，建model、改pom、改yml、主启动、业务类</p>
<h4 id="3-1-构建提供者模块"><a href="#3-1-构建提供者模块" class="headerlink" title="3.1 构建提供者模块"></a>3.1 构建提供者模块</h4><ol>
<li><p>新建<code>cloud-providerconsul-payment8006</code>模块</p>
</li>
<li><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud consul-server --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###consul服务端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider-payment</span></span><br><span class="line"><span class="comment">####consul注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#hostname: 127.0.0.1</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentConsulMain8004</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentConsulMain8004.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/zk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentZK</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;springcloud with consul：&quot;</span> + serverPort + <span class="string">&quot;\t&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-2-构建消费者模块"><a href="#3-2-构建消费者模块" class="headerlink" title="3.2 构建消费者模块"></a>3.2 构建消费者模块</h4><ol>
<li><p>新建<code>cloud-consumerconsul-order8002</code>模块</p>
</li>
<li><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud consul-server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###consul服务端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-consumer-order</span></span><br><span class="line"><span class="comment">####consul注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#hostname: 127.0.0.1</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">//该注解用于向使用consul或者zookeeper作为注册中心时注册服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConsulMain8002</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SpringApplication.run(OrderConsulMain8002.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextBean</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INVOKE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://cloud-provider-payment&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/consul&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;消费者调用支付服务 ---&gt; result:&quot;</span> + restTemplate.getForObject(</span><br><span class="line">                INVOKE_URL + <span class="string">&quot;/payment/zk&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-3-测试"><a href="#3-3-测试" class="headerlink" title="3.3 测试"></a>3.3 测试</h4><p><em><strong>查看web界面</strong></em></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207153540785.png" alt="image-20230207153540785"></p>
<p>可以看到已经注册进去的两个服务</p>
<p><em><strong>测试是否可以调用提供者接口</strong></em></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207153822298.png" alt="image-20230207153822298"></p>
<p>成功~~~😋😋😋</p>
<h2 id="三个注册中心异同点"><a href="#三个注册中心异同点" class="headerlink" title="三个注册中心异同点"></a>三个注册中心异同点</h2><h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><p>CAP理论关注粒度是数据，而不是整体系统设计的策略</p>
<ul>
<li>C:Consistency（强一致性）</li>
<li>A:Availability（可用性）</li>
<li>P:Partition tolerance（分区容错性）</li>
</ul>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><h4 id="AP"><a href="#AP" class="headerlink" title="AP"></a>AP</h4><p><code>eureka</code>就是AP。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207160815582.png" alt="image-20230207160815582"></p>
<p>AP的特点就是A系统和B系统数据同步失败时，它优先考虑的是可用性，所以它将旧的值返回，对于一些不是很重要的数据时使用CP架构是合理的。</p>
<h4 id="CP"><a href="#CP" class="headerlink" title="CP"></a>CP</h4><p><code>zookeeper</code>和<code>consul</code>是CP</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230207160934013.png" alt="image-20230207160934013"></p>
<p>CP就是如果数据同步失败，那么它就会返回一个异常。它损失了高可用，但是保证了一致性，对于一些重要的数据使用CP是合理的。</p>
<h1 id="四、负载均衡服务调用"><a href="#四、负载均衡服务调用" class="headerlink" title="四、负载均衡服务调用"></a>四、负载均衡服务调用</h1><h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><p>在我们学习Eureka的那一章节，我们在<code>RestTemplate</code>上使用<code>@LoadBalanced </code>注解，用它来开启负载均衡，它的底层是使用了<code>Ribbon</code>来做负载均衡</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230212111414993-16761716561541.png" alt="image-20230212111414993"></p>
<p><strong>LB（负载均衡）</strong></p>
<ul>
<li>集中式LB：将请求用过某些策略转发到服务方，可以是硬件、也可以是软件，如nginx</li>
<li>进程式LB：它是客户端上的一个进程，它负责获取提供方的提供服务的一系列主机地址，通过负载均衡算法将请求发送给提供方集群。</li>
</ul>
<p>ribbon属于是进程式LB，eureka的例子我们可以看出来我们只在客户端开启了负载均衡。ribbon是一个框架，在客户端通过算法来做负载均衡调用。它还可以结合其他的客户端使用，不仅限于eureka</p>
<p>&#x3D;&#x3D;Ribbon进入了维护模式，后面有新的技术可以替代它&#x3D;&#x3D;</p>
<h3 id="2、Ribbon核心组件IRule"><a href="#2、Ribbon核心组件IRule" class="headerlink" title="2、Ribbon核心组件IRule"></a>2、Ribbon核心组件IRule</h3><p>IRule：根据特定算法从服务列表中获取服务</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230212113530326.png" alt="image-20230212113530326"></p>
<p>上面是IRule的实现类，可以看到所有的负载均衡规则都继承了<code>AbstractLoadBalancerRule</code></p>
<p>它们对应的规则</p>
<table>
<thead>
<tr>
<th>实现类</th>
<th>规则</th>
</tr>
</thead>
<tbody><tr>
<td>RoundRobinRule</td>
<td>轮询</td>
</tr>
<tr>
<td>RandomRule</td>
<td>随机</td>
</tr>
<tr>
<td>RetryRule</td>
<td>先按照RoundRobinRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用的服务</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>先过滤掉故障实例，再选择并发较小的实例</td>
</tr>
<tr>
<td>ZoneAvoidanceRule</td>
<td>默认规则,复合判断server所在区域的性能和server的可用性选择服务器</td>
</tr>
</tbody></table>
<h3 id="3、替换默认的IRule"><a href="#3、替换默认的IRule" class="headerlink" title="3、替换默认的IRule"></a>3、替换默认的IRule</h3><p>在之前的<code>cloud-consumer-order8002（rureka工程）</code>上添加下面的操作</p>
<ol>
<li><p>创建一个新的package</p>
<p><code>com.atguigu.myrule</code></p>
</li>
<li><p>重新实现IRule</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelfRule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类添加<code>@RibbonClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MySelfRule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMain8002</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderMain8002.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>注意点：</p>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230212114841739.png" alt="image-20230212114841739" style="zoom:50%;" />

<p><strong>官方文档明确给出了警告</strong>：<br>这个自定义配置类不能放在@ComponentScan所扫描的当前包下以及子包下，否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，达不到特殊化定制的目的了。springBoot它默认是扫描当前启动类所在包的组件以及所在包子包下的所有组件，所以我们要将自定义的<code>Rule</code>放到其他包下</p>
<h3 id="4、RoundRobinRule源码分析"><a href="#4、RoundRobinRule源码分析" class="headerlink" title="4、RoundRobinRule源码分析"></a>4、RoundRobinRule源码分析</h3><p><code>RoundRobinRule</code>它的规则是轮询，轮询就是 <code>获取的服务index = 请求的次数 % 服务提供者的数</code>，通过这个<code>index</code>来获取对应位置的服务信息，然后再向目标主机发起请求</p>
<p><strong>源码分析</strong></p>
<p>IRule中有一个<code>choose</code>方法，这个方法就是定义如何进行选择。我们看一下<code>RoundRobinRule</code>中的<code>choose</code>就知道是怎样的规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;no load balancer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (server == <span class="literal">null</span> &amp;&amp; count++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br><span class="line">        List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">        <span class="comment">// 正常运行的提供者数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">upCount</span> <span class="operator">=</span> reachableServers.size();</span><br><span class="line">        <span class="comment">// 总的提供者数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allServers.size();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((upCount == <span class="number">0</span>) || (serverCount == <span class="number">0</span>)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No up servers available from load balancer: &quot;</span> + lb);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	    <span class="comment">// 最主要获取index的方法 </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextServerIndex</span> <span class="operator">=</span> incrementAndGetModulo(serverCount);</span><br><span class="line">        server = allServers.get(nextServerIndex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* Transient. */</span></span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">            <span class="keyword">return</span> (server);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next.</span></span><br><span class="line">        server = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span></span><br><span class="line">                + lb);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> server;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">incrementAndGetModulo</span><span class="params">(<span class="type">int</span> modulo)</span> &#123;</span><br><span class="line">    <span class="comment">// 自旋锁</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> nextServerCyclicCounter.get();</span><br><span class="line">        <span class="comment">// current -&gt; 当前请求次数</span></span><br><span class="line">        <span class="comment">// modulo -&gt; 提供者数量</span></span><br><span class="line">        <span class="comment">// 当前请求数 % 提供者数量 = 实际调用的提供者</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> (current + <span class="number">1</span>) % modulo;</span><br><span class="line">        <span class="keyword">if</span> (nextServerCyclicCounter.compareAndSet(current, next))</span><br><span class="line">            <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如：提供者数量为3</p>
<table>
<thead>
<tr>
<th>请求数</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1 % 3 &#x3D; 1，list.get(1)</td>
</tr>
<tr>
<td>2</td>
<td>2 % 3 &#x3D; 2，list.get(2)</td>
</tr>
<tr>
<td>3</td>
<td>3 % 3 &#x3D; 0，list.get(0)</td>
</tr>
<tr>
<td>4</td>
<td>4 % 3 &#x3D; 1，list.get(1)</td>
</tr>
</tbody></table>
<p>观察发现，请求很均匀的分发给提供者。</p>
<h3 id="5、手写一个负载均衡调用"><a href="#5、手写一个负载均衡调用" class="headerlink" title="5、手写一个负载均衡调用"></a>5、手写一个负载均衡调用</h3><p>在上一节我们知道了轮询算法的原理，接下来我们自己来手写一个轮询算法做负载均衡</p>
<h4 id="提供者改造"><a href="#提供者改造" class="headerlink" title="提供者改造"></a>提供者改造</h4><p><code>cloud-provider-payment8001</code>和<code>cloud-provider-payment8003</code>两个模块添加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;lb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lb</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> serverPort.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="消费者改造"><a href="#消费者改造" class="headerlink" title="消费者改造"></a>消费者改造</h4><p><code>cloud-consumer-order8002</code></p>
<ol>
<li><p>首先定义一个获取服务信息的规则，这里我们使用的还是轮询策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.lb;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceInstances 服务实例列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ServiceInstance <span class="title function_">instance</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.lb;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLB</span> <span class="keyword">implements</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 原子类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span>  <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> current;</span><br><span class="line">        <span class="type">int</span> next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 获取当前值</span></span><br><span class="line">            current = <span class="built_in">this</span>.atomicInteger.get();</span><br><span class="line">            <span class="comment">// 下一次请求数，超过int最大值就设置为0,</span></span><br><span class="line">            next = current &gt;= Integer.MAX_VALUE ? <span class="number">0</span> : current + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!<span class="built_in">this</span>.atomicInteger.compareAndSet(current, next));</span><br><span class="line">        log.info(<span class="string">&quot;*****next*****: &#123;&#125;&quot;</span>, next);</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstance <span class="title function_">instance</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> getAndIncrement() % serviceInstances.size();</span><br><span class="line">        <span class="keyword">return</span> serviceInstances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加接口方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/lb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPaymentLB</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过我们自定义的规则来获取处理请求的服务实例</span></span><br><span class="line">    <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> loadBalancer.instance(instances);</span><br><span class="line">    <span class="keyword">if</span> (instances == <span class="literal">null</span> || instances.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取服务的uri</span></span><br><span class="line">    <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serviceInstance.getUri();</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(uri + <span class="string">&quot;/payment/lb&quot;</span>, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>去掉<code>RestTemplate</code>中的<code>@LoadBalanced</code>注解</p>
</li>
<li><p>测试 -&gt; 每次出现不同的端口号表示成功</p>
</li>
</ol>
<h1 id="五、服务接口调用"><a href="#五、服务接口调用" class="headerlink" title="五、服务接口调用"></a>五、服务接口调用</h1><h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><h3 id="1、概述-1"><a href="#1、概述-1" class="headerlink" title="1、概述"></a>1、概述</h3><h4 id="1-1-Feign是什么"><a href="#1-1-Feign是什么" class="headerlink" title="1.1 Feign是什么"></a>1.1 Feign是什么</h4><p><strong>官网原话</strong>：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">Feign</a> is a declarative web service client. It makes writing web service clients easier. To use Feign create an interface and annotate it. It has pluggable annotation support including Feign annotations and JAX-RS annotations. Feign also supports pluggable encoders and decoders. Spring Cloud adds support for Spring MVC annotations and for using the same <code>HttpMessageConverters</code> used by default in Spring Web. Spring Cloud integrates Eureka, Spring Cloud CircuitBreaker, as well as Spring Cloud LoadBalancer to provide a load-balanced http client when using Feign.</p>
<p>Feign 是一个声明式的 Web 服务客户端。它使编写 Web 服务客户端变得更加容易。<strong>要使用 Feign，请创建一个接口并对其进行注释</strong>。它具有可插入的注释支持，包括 Feign 注释和 JAX-RS 注释。Feign 还支持可插入的编码器和解码器。 Spring Cloud 添加了对 Spring MVC 注释的支持，并支持使用在 Spring Web 中默认使用的相同HttpMessageConverters。Spring Cloud 集成了 Eureka，Spring Cloud CircuitBreaker，以及 Spring Cloud LoadBalancer，在使用 Feign 时提供负载均衡的 http 客户端。</p>
<p>通过这段话可以看出来使用Feign可以使用请求变得更加方便和简单，只需要一个接口和配置即可。</p>
<h4 id="1-2-Feign能做什么？"><a href="#1-2-Feign能做什么？" class="headerlink" title="1.2 Feign能做什么？"></a>1.2 Feign能做什么？</h4><p>Feign使编写Java Http客户端变得更容易</p>
<p>在前面的章节中我们学习了<code>Ribbon + RestTemplate</code>请求服务，利用RestTemplate对http请求的封装处理，形成了一套模版化的调用方法。但是在实际的开发中，由于对服务的依赖可能不止一处，往往一个接口会被多处调用，所以需要将这些接口进行封装，然后再进行调用。Feign帮我们实现了封装，它只需要我们定义一个接口和标注注解就会自动帮我们生成对服务的调用封装。</p>
<p>Feign它集成了Ribbon，所以Feign也可以做负载均衡调用。只需要做一些配置即可。</p>
<h4 id="1-3-Feign和OpenFeign的区别"><a href="#1-3-Feign和OpenFeign的区别" class="headerlink" title="1.3 Feign和OpenFeign的区别"></a>1.3 Feign和OpenFeign的区别</h4><table>
<thead>
<tr>
<th>Feign</th>
<th>OpenFeign</th>
</tr>
</thead>
<tbody><tr>
<td>Feign是Spring Cloud组件中的一个轻量级RESTful的HTTP服务客户端，Feign内置了Ribbon，用来做客户端负载均衡，去调用服务注册中心的服务。Feign的使用方式是：使用Feign的注解定义接口，调用这个接口，就可以调用服务注册中心的服务</td>
<td>OpenFeign是Spring Cloud 在Feign的基础上支持了SpringMVC的注解，如@RequesMapping等等。OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。</td>
</tr>
<tr>
<td><code>&lt;dependency&gt;    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-feign&lt;/artifactId&gt;&lt;/dependency&gt;</code></td>
<td><code>&lt;dependency&gt;    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;&lt;/dependency&gt;</code></td>
</tr>
</tbody></table>
<h3 id="2、使用OpenFeign"><a href="#2、使用OpenFeign" class="headerlink" title="2、使用OpenFeign"></a>2、使用OpenFeign</h3><p>微服务调用接口+<code>@FeignClient</code>来使用</p>
<ol>
<li><p>新建<code>cloud-consumer-feign-order80</code></p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--一般基础通用配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignMain80</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderFeignMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类</p>
<p>新建一个包放我们的服务调用接口，这里使用service包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// value为服务名</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/getPaymentById&quot;)</span></span><br><span class="line">    CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建一个controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务测试</p>
<p>由于OpenFeign自带Ribbon，所以它也有负载均衡的功能。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213154951123.png" alt="image-20230213154951123"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213155017116.png" alt="image-20230213155017116"></p>
</li>
</ol>
<h3 id="3、OpenFeign超时控制"><a href="#3、OpenFeign超时控制" class="headerlink" title="3、OpenFeign超时控制"></a>3、OpenFeign超时控制</h3><p>默认情况下，OpenFeign等待1秒钟，<strong>如果服务端处理超过1秒钟</strong>，Feign客户端就会报错。在某些场景下允许服务处理超过一秒钟，为了避免报错的情况发生，我们需要设置Feign客户端的超时时间，也就是超时控制。在yml文件中进行配置</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213160629506.png" alt="image-20230213160629506"></p>
<p>这个是超时的报错。</p>
<p>yml文件配置超时控制</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置feign客户端超时时间(OpenFeign默认支持ribbon)</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment">#指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment">#指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>



<h3 id="4、开启日志打印功能"><a href="#4、开启日志打印功能" class="headerlink" title="4、开启日志打印功能"></a>4、开启日志打印功能</h3><p>Feign 提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解 Feign 中 Http 请求的细节。就是对Feign接口的调用情况进行监控和输出</p>
<h4 id="4-1-日志级别"><a href="#4-1-日志级别" class="headerlink" title="4.1 日志级别"></a>4.1 日志级别</h4><table>
<thead>
<tr>
<th>级别</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>NONE</td>
<td>默认的，不显示任何日志；</td>
</tr>
<tr>
<td>BASIC</td>
<td>仅记录请求方法、URL、响应状态码及执行时间；</td>
</tr>
<tr>
<td>HEADERS</td>
<td>除了 BASIC 中定义的信息之外，还有请求和响应的头信息；</td>
</tr>
<tr>
<td>FULL</td>
<td>除了 HEADERS 中定义的信息之外，还有请求和响应的正文及元数据。</td>
</tr>
</tbody></table>
<h4 id="4-2-配置输出日志级别"><a href="#4-2-配置输出日志级别" class="headerlink" title="4.2 配置输出日志级别"></a>4.2 配置输出日志级别</h4><p>将我们需要修改的日志级别注入到容器中即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-3-配置文件中设置需要开启的Feign客户端"><a href="#4-3-配置文件中设置需要开启的Feign客户端" class="headerlink" title="4.3 配置文件中设置需要开启的Feign客户端"></a>4.3 配置文件中设置需要开启的Feign客户端</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">  	<span class="comment"># 开启service下的所有Feign客户端的</span></span><br><span class="line">    <span class="string">com.atguigu.springcloud.service.*:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>



<h4 id="4-4-查看日志输出结果"><a href="#4-4-查看日志输出结果" class="headerlink" title="4.4 查看日志输出结果"></a>4.4 查看日志输出结果</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213161648831.png" alt="image-20230213161648831"></p>
<h1 id="六、服务降级"><a href="#六、服务降级" class="headerlink" title="六、服务降级"></a>六、服务降级</h1><h2 id="Hystrix（停更维护⚠）"><a href="#Hystrix（停更维护⚠）" class="headerlink" title="Hystrix（停更维护⚠）"></a>Hystrix（停更维护⚠）</h2><h3 id="1、概述-2"><a href="#1、概述-2" class="headerlink" title="1、概述"></a>1、概述</h3><h4 id="1-1-分布式系统面临的问题"><a href="#1-1-分布式系统面临的问题" class="headerlink" title="1.1 分布式系统面临的问题"></a>1.1 分布式系统面临的问题</h4><p>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230213180236426.png" alt="image-20230213180236426"></p>
<p><strong>服务雪崩</strong></p>
<p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其它的微服务，这就是所谓的“扇出”，“扇出就是向扇子打开的时候一样一个个褶子向外张开。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”.</p>
<p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。<br>所以，<br>通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接收流量，然后这个有问题的模块还调用了其他的模块，这样就会发生级联故障，或者叫雪崩。</p>
<p><em><strong>总结就是</strong></em>：微服务调用链路上的一个服务出现问题就会导致整个服务的调用出现问题，这个问题可以是延迟或者是错误。</p>
<h4 id="1-2-Hystrix是什么"><a href="#1-2-Hystrix是什么" class="headerlink" title="1.2 Hystrix是什么"></a>1.2 Hystrix是什么</h4><p>Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。</p>
<p>“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（<strong>FallBack</strong>），而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p>
<h4 id="1-3-最主要的功能"><a href="#1-3-最主要的功能" class="headerlink" title="1.3 最主要的功能"></a>1.3 最主要的功能</h4><p><em><strong>服务降级</strong></em></p>
<p>在服务发生超时或者异常错误的时候对服务进行处理，返回一个友好的提示(<code>fallback</code>)</p>
<p>例如：返回信息 -&gt; 服务器繁忙，请稍后重试</p>
<p>那些情况会发生降级</p>
<ul>
<li>程序运行异常</li>
<li>超时</li>
<li>服务熔断触发服务降级</li>
<li>线程池&#x2F;信号量打满也会导致服务降级</li>
</ul>
<p><em><strong>服务熔断</strong></em></p>
<p>请求达到服务能处理的最大值，直接拒接访问。就像保险丝一样，电量到达最大值就会跳闸。</p>
<p><em><strong>服务限流</strong></em></p>
<p>秒杀等高并发操作。不能一下子请求过来，规定一秒能处理的请求，其他请求需要进行排队。</p>
<p><em><strong>服务监控</strong></em></p>
<p>对服务进行监控。</p>
<h3 id="2、服务降级"><a href="#2、服务降级" class="headerlink" title="2、服务降级"></a>2、服务降级</h3><h4 id="2-1-搭建工程"><a href="#2-1-搭建工程" class="headerlink" title="2.1 搭建工程"></a>2.1 搭建工程</h4><h5 id="2-1-1提供者搭建"><a href="#2-1-1提供者搭建" class="headerlink" title="2.1.1提供者搭建"></a>2.1.1提供者搭建</h5><ol>
<li><p>创建<code>cloud-provider-hystrix-payment8001</code>模块</p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-payment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentHystrixMain8001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类</p>
<p><em><strong>service</strong></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;当前线程：%s\tpaymentInfo_OK\tid:%d\tO(∩_∩)O哈哈~&quot;</span>,</span><br><span class="line">                Thread.currentThread().getName(), id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;当前线程：%s\tpaymentInfo_TimeOut\tid:%d\tO(∩_∩)O哈哈~，耗费%d秒&quot;</span>,</span><br><span class="line">                Thread.currentThread().getName(), id, number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>controller</strong></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentInfo_OK(id);</span><br><span class="line">        log.info(<span class="string">&quot;result******：&#123;&#125;&quot;</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentInfo_TimeOut(id);</span><br><span class="line">        log.info(<span class="string">&quot;result******：&#123;&#125;&quot;</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="2-1-2消费者工程搭建"><a href="#2-1-2消费者工程搭建" class="headerlink" title="2.1.2消费者工程搭建"></a>2.1.2消费者工程搭建</h5><ol>
<li>创建&#96;&#96;</li>
</ol>
<h4 id="2-2-模拟并发"><a href="#2-2-模拟并发" class="headerlink" title="2.2 模拟并发"></a>2.2 模拟并发</h4><h5 id="2-2-1-JMater配置"><a href="#2-2-1-JMater配置" class="headerlink" title="2.2.1 JMater配置"></a>2.2.1 JMater配置</h5><p>使用<code>JMater</code>向<code>8001</code>服务发起20000个请求</p>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214111847339.png" alt="image-20230214111847339" style="zoom: 67%;" />

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214111955082.png" alt="image-20230214111955082" style="zoom:67%;" />



<h5 id="2-2-2-并发下的消费接口"><a href="#2-2-2-并发下的消费接口" class="headerlink" title="2.2.2 并发下的消费接口"></a>2.2.2 并发下的消费接口</h5><p>在并发下访问<code>http://localhost:8002/consumer/payment/hystrix/timeout/1</code>，这个接口是消费者访问提供者</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214115816121.png" alt="image-20230214115816121"></p>
<p>结果发现报错了或者是等待加载，这个错误是Feign调用的超时错误。</p>
<p>很明显客户看不懂这个错误，我们应该返回友好的提示而不是错误，所以需要做服务降级，在发生异常或错误的时候<code>fallback</code>，<strong>返回一个兜底的方法</strong>。</p>
<blockquote>
<p>  Q：我们使用Feign的超时控制处理不就好了</p>
<p>  A：那得将Feign的超时控制设置很长的时间，这个确实也可以解决问题，但是让客户等那么长时间不合适，而且占资源，会把服务器拖垮。想象一下一个请求没解决完，下一个请求又进来了，这样一堆积，服务器资源很快就会用完。所以这个时候使用服务降级是比较合适的。</p>
</blockquote>
<h4 id="2-3-设置服务降级"><a href="#2-3-设置服务降级" class="headerlink" title="2.3 设置服务降级"></a>2.3 设置服务降级</h4><p>可能发生的问题：</p>
<table>
<thead>
<tr>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>超时导致服务变慢</td>
<td>超时不再等待，提供者端需要做服务降级，超出指定时间就返回兜底方法</td>
</tr>
<tr>
<td>出错(宕机或程序运行出错)</td>
<td>出错要有兜底，提供者端宕机或者出错，消费者端需要有兜底的方法(fallback)</td>
</tr>
</tbody></table>
<h5 id="2-3-1-提供者端降级"><a href="#2-3-1-提供者端降级" class="headerlink" title="2.3.1 提供者端降级"></a>2.3.1 提供者端降级</h5><p><em><strong>开启服务降级功能</strong></em></p>
<p>主启动类添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCircuitBreaker</span>   <span class="comment">// 开启服务降级</span></span><br></pre></td></tr></table></figure>

<p><em><strong>设置异常或超时并设置服务降级</strong></em></p>
<p><code>localhost:8001/payment/hystrix/timeout/&#123;id&#125;</code>这个接口是我们模拟的超时接口。它实际调用返回的是<code>PaymentService#paymentInfo_TimeOut</code>方法</p>
<p>修改<code>paymentInfo_TimeOut</code>方法：设置超时或者异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启服务降级 -&gt; 处理超过3秒就fallback，执行兜底方法 paymentInfo_TimeOutHandler 返回</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot;, commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="comment">// 制造异常</span></span><br><span class="line">    <span class="comment">// int = 10 / 0;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// 制造超时</span></span><br><span class="line">    <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">3</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);&#125;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">&quot;当前线程：%s\tpaymentInfo_TimeOut\tid:%d\tO(∩_∩)O哈哈~，耗费%d秒&quot;</span>,</span><br><span class="line">            Thread.currentThread().getName(), id, number);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOutHandler</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/(ㄒoㄒ)/调用支付接口超时或异常：\t&quot;</span>+ <span class="string">&quot;\t当前线程池名字&quot;</span> + Thread.currentThread().getName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：此时开启了服务降级。当方法处理超过3秒或者发生错误就返回兜底方法。</p>
<p><em><strong>测试</strong></em></p>
<p>提供者端：访问<code>http://localhost:8001/payment/hystrix/timeout/1</code>，返回的是兜底方法</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214142611023.png" alt="image-20230214142611023"></p>
<p>消费者端：访问<code>http://localhost:8002/consumer/payment/hystrix/timeout/1</code>,返回的是错误信息</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214142824832.png" alt="image-20230214142824832"></p>
<p>Feign调用超时异常，这是因为提供者端做了服务降级，但是消费者端没有做服务降级，所以提供者端发生异常或超时，消费端还是会报错的。所以需要在两个端都要进行服务降级才能保证服务正常返回。</p>
<h5 id="2-3-2-消费者端降级"><a href="#2-3-2-消费者端降级" class="headerlink" title="2.3.2 消费者端降级"></a>2.3.2 消费者端降级</h5><p><em><strong>开启服务降级</strong></em></p>
<ol>
<li><p>主启动类添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableHystrix</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于服务降级 在注解@FeignClient中添加fallbackFactory属性值</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="comment"># 开启hystrix</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><em><strong>设置服务降级</strong></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置服务降级 -&gt; 处理时间超过2秒就fallback</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentTimeOutFallbackMethod&quot;, commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value=&quot;2000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfoTimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentTimeOutFallbackMethod</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我是消费者80,对方支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,o(╥﹏╥)o&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>测试</strong></em></p>
<p>此时访问<code>http://localhost:8002/consumer/payment/hystrix/timeout/1</code>就不会有错误信息，而是fallback</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214143825300.png" alt="image-20230214143825300"></p>
<h4 id="2-4-代码耦合问题"><a href="#2-4-代码耦合问题" class="headerlink" title="2.4 代码耦合问题"></a>2.4 代码耦合问题</h4><h5 id="2-4-1-耦合问题"><a href="#2-4-1-耦合问题" class="headerlink" title="2.4.1 耦合问题"></a>2.4.1 耦合问题</h5><p>观察我们的代码发现，业务代码和服务降级的代码耦合了</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214144356338.png" alt="image-20230214144356338"></p>
<p>如果每一个业务方法都要有一个兜底方法的话，代码就会很混乱，也不符合我们面向对象的思想，所以这些和业务无关的代码我们应该给它解耦。</p>
<h5 id="2-4-2-设置全局fallback方法"><a href="#2-4-2-设置全局fallback方法" class="headerlink" title="2.4.2 设置全局fallback方法"></a>2.4.2 设置全局fallback方法</h5><p>设置一个全局fallback方法，所以服务降级的方法都返回全局的，个别需要定制的就自己设置自己的fallback方法。</p>
<p>类上标注注解并设置fallback方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultProperties(defaultFallback = &quot;paymentGlobalFallbackMethod&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystirxController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentGlobalFallbackMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Global 444 对方系统繁忙或宕机了，请稍后重试，O(∩_∩)O哈哈~~~&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所有服务熔断方法都修改成默认的，个别需要定制的就不需要修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value=&quot;2000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfoTimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><em><strong>测试</strong></em></p>
<p>访问<code>http://localhost:8002/consumer/payment/hystrix/timeout/1</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214145620146.png" alt="image-20230214145620146"></p>
<p>成功，nice~~~</p>
<h5 id="2-4-3-统一管理fallback方法"><a href="#2-4-3-统一管理fallback方法" class="headerlink" title="2.4.3 统一管理fallback方法"></a>2.4.3 统一管理fallback方法</h5><blockquote>
<p>  Q：我想每一个都有专属的fallback方法可不可以</p>
<p>  A：当然可以</p>
</blockquote>
<p>创建一个类实现服务调用接口，在重写的方法中写我们的兜底方法，对应调用的接口方法发生超时或者异常就会调用实现类中对应方法作为兜底方法，这样我们的每一个调用都可以定制自己的fallback方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title class_">PaymentHystrixService</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;服务调用失败，提示来自：&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cloud-consumer-feign-order8002#paymentInfo_OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;服务调用失败，提示来自：&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cloud-consumer-feign-order8002#paymentInfo_TimeOut&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;注意：一定要将它注入到容器中，也就是一定要加<code>@component</code>注解&#x3D;&#x3D;</p>
<p>在服务调用接口中声明fallback方法所在的实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;,fallback = PaymentFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHystrixService</span> &#123;</span><br></pre></td></tr></table></figure>

<p>这个时候默认的fallback就不能用了，因为每个都有专属的fallback方法了。</p>
<h3 id="3、服务熔断"><a href="#3、服务熔断" class="headerlink" title="3、服务熔断"></a>3、服务熔断</h3><h4 id="3-1-熔断机制概述"><a href="#3-1-熔断机制概述" class="headerlink" title="3.1 熔断机制概述"></a>3.1 熔断机制概述</h4><p>熔断机制是应对雪崩效应的微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间过长时，会对服务降级，当失败的次数或失败率达到指定值就会触发熔断机制，直接返回错误信息，减少响应时间。当检测该节点服务调用响应正常后，就会恢复链路调用。</p>
<p>在SpringCloud框架中，熔断机制通过Hystrix实现。Hystrix会监控微服务的调用状况。当失败的调用达到一定的阈值，缺省是5秒内20次调用失败，就会启动熔断机制。</p>
<blockquote>
<p>  大神论文：<a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">https://martinfowler.com/bliki/CircuitBreaker.html</a></p>
<p>  这篇论文说的很详细</p>
</blockquote>
<p>断路器负责开启和关闭熔断</p>
<h4 id="3-2-使用服务熔断"><a href="#3-2-使用服务熔断" class="headerlink" title="3.2 使用服务熔断"></a>3.2 使用服务熔断</h4><p>熔断机制的注解是<code>@HistrixCommand</code></p>
<p><strong>修改<code>cloud-provider-hystrix-payment8001</code>工程</strong></p>
<ul>
<li><p>添加service并设置熔断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    	// 开启服务熔断</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">    	// 滚动时间窗口期内失败10次开启熔断</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),</span></span><br><span class="line"><span class="meta">    	// 滚动时间窗口期，该时间用于断路器判断健康度时需要收集信息的持续时间</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),</span></span><br><span class="line"><span class="meta">    	// 滚动时间窗口期内，错误请求数百分比超过了60就打开熔断</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;),</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(id &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;******id 不能负数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serialNumber</span> <span class="operator">=</span> IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;调用成功，流水号: &quot;</span> + serialNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;id 不能负数，请稍后再试，/(ㄒoㄒ)/~~   id: &quot;</span> +id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>说明</strong></em>：@HystrixCommand属性的意思是开启熔断机制，在10秒内超过6次失败就开启断路器</p>
</li>
<li><p>添加controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/circuit/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentCircuitBreaker(id);</span><br><span class="line">    log.info(<span class="string">&quot;****result: &quot;</span>+result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>测试</strong></p>
<p>首先先不断访问<code>http://localhost:8001/payment/circuit/-1</code>，多次访问后再访问<code>http://localhost:8001/payment/circuit/1</code>，此时就是返回的是fallback方法，而不是业务方法</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214181312840.png" alt="image-20230214181312840"></p>
<p>等待一段时间再次访问又恢复了正常。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214181337314.png" alt="image-20230214181337314"></p>
<h4 id="3-3-原理"><a href="#3-3-原理" class="headerlink" title="3.3 原理"></a>3.3 原理</h4><h5 id="3-3-1-大神论文"><a href="#3-3-1-大神论文" class="headerlink" title="3.3.1 大神论文"></a>3.3.1 大神论文</h5><blockquote>
<p>  大神论文[<a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html]%E4%B8%AD%E6%9C%89%E8%AF%B4%E6%98%8E%E6%96%AD%E8%B7%AF%E5%99%A8%E7%9A%84%E6%9C%BA%E5%88%B6">https://martinfowler.com/bliki/CircuitBreaker.html]中有说明断路器的机制</a></p>
</blockquote>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214181615815.png" alt="image-20230214181615815"></p>
<p><strong>说明</strong>：意思就是当服务调用的失败次数达到一定阈值就会打开断路器，过一段时间后就会以半开的状态来打开断路器。，如果调用成功则将重置断路器，否则将重新启动断路器。</p>
<h5 id="3-3-2-熔断类型"><a href="#3-3-2-熔断类型" class="headerlink" title="3.3.2 熔断类型"></a>3.3.2 熔断类型</h5><ul>
<li><p>熔断打开</p>
<p>请求不再进行调用当前服务，内部设置时钟一般为MTTR（平均故障处理时间)，当打开时长达到所设时钟则进入半熔断状态</p>
</li>
<li><p>熔断关闭</p>
<p>熔断关闭不会对服务进行熔断</p>
</li>
<li><p>熔断半开</p>
<p>部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断</p>
</li>
</ul>
<h5 id="3-3-3-熔断器执行步骤"><a href="#3-3-3-熔断器执行步骤" class="headerlink" title="3.3.3 熔断器执行步骤"></a>3.3.3 熔断器执行步骤</h5><p>官网原文：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230214182658468.png" alt="image-20230214182658468"></p>
<p>Hystrix 实现服务熔断的步骤如下：</p>
<ol>
<li>当服务的调用出错率达到或超过 Hystix 规定的比率（默认为 50%）后，熔断器进入熔断开启状态。</li>
<li>熔断器进入熔断开启状态后，Hystrix 会启动一个休眠时间窗，在这个时间窗内，该服务的降级逻辑（fallback方法）会临时充当业务主逻辑，而原来的业务主逻辑不可用。</li>
<li>当有请求再次调用该服务时，会直接调用降级逻辑（fallback方法）快速地返回失败响应，以避免系统雪崩。</li>
<li>当休眠时间窗到期后，Hystrix 会进入半熔断转态，允许部分请求对服务原来的主业务逻辑进行调用，并监控其调用成功率。</li>
<li>如果调用成功率达到预期，则说明服务已恢复正常，Hystrix 进入熔断关闭状态，服务原来的主业务逻辑恢复；否则 Hystrix 重新进入熔断开启状态，休眠时间窗口重新计时，继续重复第 2 到第 5 步。</li>
</ol>
<h4 id="3-4-属性值及其作用"><a href="#3-4-属性值及其作用" class="headerlink" title="3.4 属性值及其作用"></a>3.4 属性值及其作用</h4><p>在<code>HystrixCommandProperties</code>类中可以找到所有的属性</p>
<table>
<thead>
<tr>
<th>属性值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>execution.isolation.strategy</td>
<td>设置隔离策略，THREAD 表示线程池 SEMAPHORE：信号池隔离</td>
</tr>
<tr>
<td>execution.isolation.semaphore.maxConcurrentRequests</td>
<td>当隔离策略选择信号池隔离的时候，用来设置信号池的大小（最大并发数）</td>
</tr>
<tr>
<td>execution.isolation.thread.timeoutinMilliseconds</td>
<td>配置命令执行的超时时间</td>
</tr>
<tr>
<td>execution.timeout.enabled</td>
<td>是否启用超时时间</td>
</tr>
<tr>
<td>execution.isolation.thread.interruptOnTimeout</td>
<td>执行超时的时候是否中断</td>
</tr>
<tr>
<td>execution.isolation.thread.interruptOnCancel</td>
<td>执行被取消的时候是否中断</td>
</tr>
<tr>
<td>fallback.isolation.semaphore.maxConcurrentRequests</td>
<td>允许回调方法执行的最大并发数</td>
</tr>
<tr>
<td>fallback.enabled</td>
<td>服务降级是否启用，是否执行回调函数</td>
</tr>
<tr>
<td>circuitBreaker.enabled</td>
<td>是否启用断路器</td>
</tr>
<tr>
<td>circuitBreaker.requestVolumeThreshold</td>
<td>该属性用来设置在滚动时间窗中，断路器熔断的最小请求数。例如，默认该值为 20 的时候，如果滚动时间窗（默认10秒）内仅收到了19个请求， 即使这19个请求都失败了，断路器也不会打开。</td>
</tr>
<tr>
<td>circuitBreaker.errorThresholdPercentage</td>
<td>该属性用来设置在滚动时间窗中，表示在滚动时间窗中，在请求数量超过，circuitBreaker.requestVolumeThreshold 的情况下，如果错误请求数的百分比超过50,就把断路器设置为 “打开” 状态，否则就设置为 “关闭” 状态。</td>
</tr>
<tr>
<td>circuitBreaker.sleepWindowinMilliseconds</td>
<td>&#x2F;&#x2F; 该属性用来设置当断路器打开之后的休眠时间窗。 休眠时间窗结束之后，会将断路器置为 “半开” 状态，尝试熔断的请求命令，如果依然失败就将断路器继续设置为 “打开” 状态，如果成功就设置为 “关闭” 状态。</td>
</tr>
<tr>
<td>ircuitBreaker.forceOpen</td>
<td>断路器强制打开</td>
</tr>
<tr>
<td>circuitBreaker.forceClosed</td>
<td>断路器强制关闭</td>
</tr>
<tr>
<td>metrics.rollingStats.timeinMilliseconds</td>
<td>滚动时间窗设置，该时间用于断路器判断健康度时需要收集信息的持续时间</td>
</tr>
<tr>
<td>metrics.rollingStats.numBuckets</td>
<td>该属性用来设置滚动时间窗统计指标信息时划分”桶”的数量，断路器在收集指标信息的时候会根据设置的时间窗长度拆分成多个 “桶” 来累计各度量值，每个”桶”记录了一段时间内的采集指标。比如 10 秒内拆分成 10 个”桶”收集这样，所以 timeinMilliseconds 必须能被 numBuckets 整除。否则会抛异常</td>
</tr>
<tr>
<td>metrics.rollingPercentile.enabled</td>
<td>该属性用来设置对命令执行的延迟是否使用百分位数来跟踪和计算。如果设置为 false, 那么所有的概要统计都将返回 -1</td>
</tr>
<tr>
<td>metrics.rollingPercentile.timeInMilliseconds</td>
<td>该属性用来设置百分位统计的滚动窗口的持续时间，单位为毫秒</td>
</tr>
<tr>
<td>metrics.rollingPercentile.numBuckets</td>
<td>该属性用来设置百分位统计滚动窗口中使用 “ 桶 ”的数量。</td>
</tr>
<tr>
<td>metrics.rollingPercentile.bucketSize</td>
<td>该属性用来设置在执行过程中每个 “桶” 中保留的最大执行次数。如果在滚动时间窗内发生超过该设定值的执行次数，就从最初的位置开始重写。例如，将该值设置为100, 滚动窗口为10秒，若在10秒内一个 “桶 ”中发生了500次执行，那么该 “桶” 中只保留 最后的100次执行的统计。另外，增加该值的大小将会增加内存量的消耗，并增加排序百分位数所需的计算时间。</td>
</tr>
<tr>
<td>metrics.healthSnapshot.intervalinMilliseconds</td>
<td>该属性用来设置采集影响断路器状态的健康快照（请求的成功、 错误百分比）的间隔等待时间。</td>
</tr>
<tr>
<td>requestCache.enabled</td>
<td>是否开启请求缓存</td>
</tr>
<tr>
<td>requestLog.enabled</td>
<td>HystrixCommand的执行和事件是否打印日志到 HystrixRequestLog 中</td>
</tr>
<tr>
<td>coreSize</td>
<td>该参数用来设置执行命令线程池的核心线程数，该值也就是命令执行的最大并发量</td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>该参数用来设置线程池的最大队列大小。当设置为 -1 时，线程池将使用 SynchronousQueue 实现的队列，否则将使用 LinkedBlockingQueue 实现的队列。</td>
</tr>
<tr>
<td>queueSizeRejectionThreshold</td>
<td>该参数用来为队列设置拒绝阈值。 通过该参数， 即使队列没有达到最大值也能拒绝请求。该参数主要是对 LinkedBlockingQueue 队列的补充,因为LinkedBlockingQueue队列不能动态修改它的对象大小，而通过该属性就可以调整拒绝请求的队列大小了。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="4、服务限流"><a href="#4、服务限流" class="headerlink" title="4、服务限流"></a>4、服务限流</h3><p>在Spring Cloud Alibaba 中讲解</p>
<h3 id="5、服务监控hystrixDashboard"><a href="#5、服务监控hystrixDashboard" class="headerlink" title="5、服务监控hystrixDashboard"></a>5、服务监控hystrixDashboard</h3><h4 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h4><p>除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard），Hystrix会持续地记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求多少成功，多少失败等。Netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控。Spring Cloud也提供了Hystrix Dashboard的整合，对监控内容转化成可视化界面。</p>
<h4 id="5-2-搭建监控平台"><a href="#5-2-搭建监控平台" class="headerlink" title="5.2 搭建监控平台"></a>5.2 搭建监控平台</h4><h5 id="5-2-1-模块搭建"><a href="#5-2-1-模块搭建" class="headerlink" title="5.2.1 模块搭建"></a>5.2.1 模块搭建</h5><ol>
<li><p><code>cloud-consumer-hystrix-dashboard9001</code></p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 开启服务监控</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixDashboardMain9001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixDashboardMain9001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类（没有业务）</p>
</li>
</ol>
<p><strong>测试</strong></p>
<p>访问<code>http://localhost:9001/hystrix</code>，然后不断访问正常和错误的接口就会出现下图的情况</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113239905.png" alt="image-20230215113239905"></p>
<p>可以看到这个表盘记录了访问的情况</p>
<h5 id="5-2-2-参数说明"><a href="#5-2-2-参数说明" class="headerlink" title="5.2.2 参数说明"></a>5.2.2 参数说明</h5><p>实心圆：共有两种含义。它通过颜色的变化代表了实例的健康程度，它的健康度从绿色&lt;黄色&lt;橙色&lt;红色递减。<br>该实心圆除了颜色的变化之外，它的大小也会根据实例的请求流量发生变化，流量越大该实心圆就越大。所以通过该实心圆的展示，就可以在大量的实例中快速的发现故障实例和高压力实例</p>
<p>曲线：用来记录2分钟内流量的相对变化，可以通过它来观察到流量的上升和下降趋势。</p>
<p>整图说明：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113802575.png" alt="image-20230215113802575"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113827704.png" alt="image-20230215113827704"></p>
<p>监控多个服务</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215113922130.png" alt="image-20230215113922130"></p>
<h1 id="七、网关"><a href="#七、网关" class="headerlink" title="七、网关"></a>七、网关</h1><h2 id="Zuul（停更维护⚠）和zuul2"><a href="#Zuul（停更维护⚠）和zuul2" class="headerlink" title="Zuul（停更维护⚠）和zuul2"></a>Zuul（停更维护⚠）和zuul2</h2><p>zuul的技术上被淘汰了，会因为它是阻塞模型的。</p>
<p>zuul2因为公司内部的矛盾导致迟迟未开发，所以springcloud官方就自己研发了一个自己的网关出来，就是Gateway，它替代了zuul</p>
<h2 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h2><h3 id="1、概述-3"><a href="#1、概述-3" class="headerlink" title="1、概述"></a>1、概述</h3><h4 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h4><p>Spring Cloud Gateway是Spring Cloud中的网关。它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。<strong>它是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty</strong>。Spring Cloud Gateway的目标提供统一的路由方式且基于 Filter 链的方式提供了网关基本的功能，例如：反向代理、安全，监控&#x2F;指标、限流等等。</p>
<p>Gateway的依赖</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215185024466.png" alt="image-20230215185024466"></p>
<p>网关在微服务中的位置</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215184933478.png" alt="image-20230215184933478"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215185103474.png" alt="image-20230215185103474"></p>
<h4 id="1-2-zuul-VS-Gateway"><a href="#1-2-zuul-VS-Gateway" class="headerlink" title="1.2 zuul VS Gateway"></a>1.2 zuul VS Gateway</h4><p><strong>Q：为什么选择Gateway而不是zuul？</strong></p>
<p>1、Zuul 1.x，是一个基于阻塞 I&#x2F; O 的 API Gateway</p>
<p>2、Zuul 1.x 基于Servlet 2. 5使用阻塞架构它不支持任何长连接(如 WebSocket) Zuul 的设计模式和Nginx较像，每次 I&#x2F; O 操作都是从工作线程中选择一个执行，请求线程被阻塞到工作线程完成，但是差别是Nginx 用C++ 实现，Zuul 用 Java 实现，而 JVM 本身会有第一次加载较慢的情况，使得Zuul 的性能相对较差。</p>
<p>3、Zuul 2.x理念更先进，想基于Netty非阻塞和支持长连接，但SpringCloud目前还没有整合。 Zuul 2.x的性能较 Zuul 1.x 有较大提升。在性能方面，根据官方提供的基准测试， Spring Cloud Gateway 的 RPS（每秒请求数）是Zuul 的 1. 6 倍。</p>
<p>4、Spring Cloud Gateway 建立 在 Spring Framework 5、 Project Reactor 和 Spring Boot 2 之上， 使用非阻塞 API。</p>
<p>5、Spring Cloud Gateway 还 支持 WebSocket， 并且与Spring紧密集成拥有更好的开发体验</p>
<h4 id="1-3-三大核心概念"><a href="#1-3-三大核心概念" class="headerlink" title="1.3 三大核心概念"></a>1.3 三大核心概念</h4><p>Route（路由）：路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由</p>
<p>Predicate(断言)：路由的规则，与规则匹配的请求就可以通过</p>
<p>Filter（过滤器）：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</p>
<h4 id="1-4-工作流程"><a href="#1-4-工作流程" class="headerlink" title="1.4 工作流程"></a>1.4 工作流程</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215200903043.png" alt="image-20230215200903043"></p>
<p>Clients make requests to Spring Cloud Gateway. If the Gateway Handler Mapping determines that a request matches a route, it is sent to the Gateway Web Handler. This handler runs the request through a filter chain that is specific to the request. The reason the filters are divided by the dotted line is that filters can run logic both before and after the proxy request is sent. All “pre” filter logic is executed. Then the proxy request is made. After the proxy request is made, the “post” filter logic is run.</p>
<p>客户端向 Spring Cloud Gateway 发出请求。如果 Gateway Handler Mapping 确定请求与路由匹配，则将其发送到 Gateway Web Handler。此处理程序通过特定于请求的过滤器链运行请求。过滤器被虚线分开的原因是过滤器可以在发送代理请求之前和之后运行逻辑。执行所有“预”过滤器逻辑。然后进行代理请求。发出代理请求后，运行“post”过滤器逻辑。</p>
<p>人话就是断言规则匹配就将请求交给过滤器前置处理器处理，然后再交给处理请求的微服务进行处理，最后返回结果再交给过滤器后置处理器处理。</p>
<h3 id="2、入门案例"><a href="#2、入门案例" class="headerlink" title="2、入门案例"></a>2、入门案例</h3><ol>
<li><p>cloud-gateway-gateway9527</p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--gateway--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route</span>                       <span class="comment"># 路由唯一ID</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>              <span class="comment"># 路由匹配的路径</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://CLOUD-PAYMENT-SERVICE</span>         <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span>                             <span class="comment"># 断言 -&gt; 路由匹配规则</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/getPaymentById/**</span>     <span class="comment"># 断言路径为true放行</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route2</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GateWayMain9527</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GateWayMain9527.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>启动测试访问<code>http://localhost:9527/payment/lb</code>，显示的是8001端口，目前我们没有设置动态路由，所以它不会有负载均衡的效果</p>
<h3 id="3、动态路由"><a href="#3、动态路由" class="headerlink" title="3、动态路由"></a>3、动态路由</h3><p>要实现动态路由需要将服务注册到 eureka 中，修改上面的模块</p>
<ol>
<li><p>POM -&gt; 添加eureka starter</p>
</li>
<li><p>YAML -&gt; 开启动态路由功能，修改路由配置</p>
<p>uri项设置为服务服务名</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment">#开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route</span>                       <span class="comment"># 路由唯一ID</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001              # 路由匹配的路径</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://CLOUD-PAYMENT-SERVICE</span>         <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">        <span class="attr">predicates:</span>                             <span class="comment"># 断言 -&gt; 路由匹配规则</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">Path=/payment/getPaymentById/**</span>     <span class="comment"># 断言路径为true放行</span></span><br><span class="line"></span><br><span class="line">	 <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route2</span></span><br><span class="line">	   <span class="attr">uri:</span> <span class="string">lb://CLOUD-PAYMENT-SERVICE</span>         <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001</span></span><br><span class="line">	   <span class="attr">predicates:</span></span><br><span class="line">	     <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>访问<code>http://localhost:9527/payment/lb</code>是有负载均衡的功能，成功~~~</p>
<h3 id="4、Predicate-断言"><a href="#4、Predicate-断言" class="headerlink" title="4、Predicate(断言)"></a>4、Predicate(断言)</h3><h4 id="4-1-说明"><a href="#4-1-说明" class="headerlink" title="4.1 说明"></a>4.1 说明</h4><p>符合路由规则的就放行，不符合就报下面的404错误</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215165141349.png" alt="image-20230215165141349"></p>
<p>断言的规则在官方文档的第5章</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215195612847.png" alt="image-20230215195612847"></p>
<h4 id="4-2-案例"><a href="#4-2-案例" class="headerlink" title="4.2 案例"></a>4.2 案例</h4><p>这里用After来举列子，其他的规则都是差不多的，满足就放行，不满足就报404</p>
<p>修改yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">After=2022-02-15T17:10:03.685+08:00[Asia/Shanghai]</span>  <span class="comment"># 断言，在指定时间之后才能访问</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2023-03-25T18:59:06.206+08:00[Asia/Shanghai]</span>	   <span class="comment"># 断言，在指定时间范围内才能访问</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Cookie=username,xiaozhi</span>     <span class="comment"># cookie中username=小智才能访问</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Method=GET</span>  				  <span class="comment"># 请求方法是GET</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Query=name</span>				  <span class="comment"># 请求携带name参数才能访问</span></span><br></pre></td></tr></table></figure>

<p>说明：After断言就是请求要在指定时间之后才能访问，不然就报错</p>
<p>获取上述例子的时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前时区的时间</span></span><br><span class="line"><span class="type">ZonedDateTime</span> <span class="variable">now</span> <span class="operator">=</span> ZonedDateTime.now();</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<p>因为需要携带cookie，所以不能在浏览器测试，需要使用Postman或者curl工具测试。这里使用curl工具</p>
<p>打开cmd窗口，输入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9527/payment/lb?name=xiaozhi --cookie=xiaozhi</span><br></pre></td></tr></table></figure>



<h4 id="4-3-规则列表"><a href="#4-3-规则列表" class="headerlink" title="4.3 规则列表"></a>4.3 规则列表</h4><table>
<thead>
<tr>
<th>断言关键字</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>After</td>
<td>指定时间之后访问</td>
</tr>
<tr>
<td>Before</td>
<td>指定时间之前访问</td>
</tr>
<tr>
<td>Between</td>
<td>指定时间范围内访问</td>
</tr>
<tr>
<td>Cookie</td>
<td>携带符合规则的cookie才能访问</td>
</tr>
<tr>
<td>Header</td>
<td>携带指定的请求头</td>
</tr>
<tr>
<td>Host</td>
<td>指定的主机名</td>
</tr>
<tr>
<td>Method</td>
<td>指定请求方法</td>
</tr>
<tr>
<td>Path</td>
<td>匹配路径</td>
</tr>
<tr>
<td>Query</td>
<td>指定参数名</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>指定IP地址</td>
</tr>
<tr>
<td>Weight</td>
<td>权重</td>
</tr>
<tr>
<td>XForwardedRemoteAddr</td>
<td>指定的代理服务器</td>
</tr>
</tbody></table>
<p>注意：value都是正则表达式</p>
<h3 id="5、Filter"><a href="#5、Filter" class="headerlink" title="5、Filter"></a>5、Filter</h3><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215202115225.png" alt="image-20230215202115225"></p>
<p>路由过滤器允许以某种方式修改传入的 HTTP 请求或传出的 HTTP 响应。路由过滤器的范围是特定路由。 Spring Cloud Gateway 包括许多内置的 GatewayFilter 工厂。</p>
<p>在官网的67章有说明，目前全局的有10个，网关过滤器的有37个，加起来47个</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215201428752.png" alt="image-20230215201428752"></p>
<h4 id="5-1-案例说明"><a href="#5-1-案例说明" class="headerlink" title="5.1 案例说明"></a>5.1 案例说明</h4><p>修改之前的模块，添加Filters配置项</p>
<p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment">#开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route</span>                       <span class="comment"># 路由唯一ID</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001              # 路由匹配的路径</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://CLOUD-PAYMENT-SERVICE</span>         <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span>                             <span class="comment"># 断言 -&gt; 路由匹配规则</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/getPaymentById/**</span>     <span class="comment"># 断言路径为true放行</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route2</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://CLOUD-PAYMENT-SERVICE</span>         <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">After=2022-02-15T17:10:03.685+08:00[Asia/Shanghai]</span>  <span class="comment"># 断言，在指定时间之后才能访问</span></span><br><span class="line"><span class="comment">#            # 断言，在指定时间范围内才能访问</span></span><br><span class="line"><span class="comment">#            - Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2023-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br><span class="line"><span class="comment">#            - Cookie=username,xiaozhi     # cookie中username=小智才能访问</span></span><br><span class="line"><span class="comment">#            - Method=GET  # 请求方法是GET</span></span><br><span class="line"><span class="comment">#            - Query=name</span></span><br><span class="line"><span class="comment">#            - Host=localhost</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-Id,xiaozhi666</span>  <span class="comment"># 过滤器会在匹配的请求头上加一对请求头，名为X-Request-Id，值为444</span></span><br></pre></td></tr></table></figure>

<p>说明：<code>AddRequestHeader</code>过滤器会在匹配请求的请求头加上<code>X-Request-Id: xiaozhi666</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;lb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lb</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">header</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Request-Id&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (header == <span class="literal">null</span>) &#123;</span><br><span class="line">        header = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serverPort.toString() + <span class="string">&quot;---&quot;</span> + header;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提供者中获取这个请求头</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215203915360.png" alt="image-20230215203915360"></p>
<p>访问8001端口的服务出现请求头的内容，说明成功~~~</p>
<p>其他的Filter也是类似的功能，可以按照官方文档来学习。</p>
<h4 id="5-2-自定义Global-Filter"><a href="#5-2-自定义Global-Filter" class="headerlink" title="5.2 自定义Global Filter"></a>5.2 自定义Global Filter</h4><p>案例：获取url参数，如果为空则不放行</p>
<p>方式一：实现GlobalFilter并注入容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange,</span></span><br><span class="line"><span class="params">                             GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;time：&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;\t执行了自定义全局过滤器&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;用户名不正确，无法登陆&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方式二：使用@bean注解的方式注入容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> GlobalFilter <span class="title function_">myCustomGlobalFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">&quot;time：&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;\t执行了自定义全局过滤器&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;用户名不正确，无法登陆&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和方式一是一样的功能效果。</p>
<p><strong>测试</strong></p>
<p>不带有参数访问</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215204603567.png" alt="image-20230215204603567"></p>
<p>可以看到使我们设置的错误状态码</p>
<p>带参数访问</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230215204643821.png" alt="image-20230215204643821"></p>
<p>很nice，测试通过了~~~😋</p>
<h1 id="八、分布式配置中心"><a href="#八、分布式配置中心" class="headerlink" title="八、分布式配置中心"></a>八、分布式配置中心</h1><h2 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h2><h3 id="1、概述-4"><a href="#1、概述-4" class="headerlink" title="1、概述"></a>1、概述</h3><h4 id="1-1-分布式系统遇到的问题"><a href="#1-1-分布式系统遇到的问题" class="headerlink" title="1.1 分布式系统遇到的问题"></a>1.1 分布式系统遇到的问题</h4><p>分布式系统又一个个的微服务组成。修改一个配置就需要多台机器进行修改，然后还得重启，而且还有大量的配置是重复的，导致工作量巨大，所以非常需要一个集中式管理配置的服务。SpringCloud中由spring cloud config来做这个事。通过配置中心去动态修改我们的配置，不需要重启就可以修改我们的配置。大大缩减了任务量</p>
<h4 id="1-2-是什么"><a href="#1-2-是什么" class="headerlink" title="1.2 是什么"></a>1.2 是什么</h4><p>官网：<code>https://spring.io/projects/spring-cloud-config</code></p>
<p>SpringCloud Config为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用的所有环境提供了一个中心化的外部配置。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216144050413.png" alt="image-20230216144050413"></p>
<p>上图是它的工作原理图。首先需要启动配置中心服务(<code>Config Server</code>)，服务的每一次请求就会获取一下Git上的配置文件，然后各个微服务从配置中心服务获取新的配置。所以我们只需要将需要修改的配置在Git仓库中进行修改即可</p>
<h3 id="2、使用"><a href="#2、使用" class="headerlink" title="2、使用"></a>2、使用</h3><p>SpringCloud Config分为<strong>服务端和客户端</strong>两部分。</p>
<p>服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密&#x2F;解密信息等访问接口</p>
<p>客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息配置服务器默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理，并且可以通过git客户端工具来方便的管理和访问配置内容。</p>
<h4 id="2-1-服务端搭建"><a href="#2-1-服务端搭建" class="headerlink" title="2.1 服务端搭建"></a>2.1 服务端搭建</h4><p><strong>Git仓库设置</strong></p>
<ol>
<li><p>创建名为<code>spring-cloud-config</code>的仓库</p>
</li>
<li><p>添加三个文件 yaml文件</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216145126104.png" alt="image-20230216145126104"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">dev,</span> <span class="string">version=1</span></span><br></pre></td></tr></table></figure>

<p>不同文件内容不同。</p>
</li>
</ol>
<p><strong>工程搭建</strong></p>
<ol>
<li><p>创建<code>cloud-config-center-3344</code>模块</p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span>  <span class="string">cloud-config-center</span> <span class="comment">#注册进Eureka服务器的微服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/mazhi-oss/spring-cloud-config.git</span> <span class="comment">#GitHub上面的git仓库名字</span></span><br><span class="line">          <span class="comment">####搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">spring-cloud-config</span></span><br><span class="line">        <span class="comment"># 由于github 2020-10-1 将主分支修改为main,所以要修改默认的label</span></span><br><span class="line">        <span class="attr">defaultLabel:</span> <span class="string">main</span></span><br><span class="line">      <span class="comment">####读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span>		<span class="comment">// 开启服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigCenterMain3344</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">            SpringApplication.run(ConfigCenterMain3344.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>测试</strong></p>
<p>启动<code>eureka7001</code>，启动配置中心服务器</p>
<p>访问<code>http://localhost:3344/main/config-dev.yml</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216145506422.png" alt="image-20230216145506422"></p>
<h4 id="2-2-文件访问规则"><a href="#2-2-文件访问规则" class="headerlink" title="2.2 文件访问规则"></a>2.2 文件访问规则</h4><p>访问规则如下图，没有标明<code>label</code>的访问的是默认的分支，可以在server端进行设置</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216145557360.png" alt="image-20230216145557360"></p>
<p>文件名说明：</p>
<ul>
<li>application：应用名</li>
<li>label：分支名</li>
<li>profile：环境名</li>
</ul>
<p>例如：<code>http://localhost:3344/main/config-dev.yml</code>，<code>main</code>就是分支名,<code>config</code>就是应用名，<code>dev</code>就是环境名</p>
<p><strong>不同访问格式会返回不同的内容</strong></p>
<p>比如<code>/&#123;application&#125;/&#123;profile&#125;/[/&#123;label&#125;]</code>这种格式</p>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216150345931.png" alt="image-20230216150345931" style="zoom:67%;" />



<h4 id="2-3-客户端搭建"><a href="#2-3-客户端搭建" class="headerlink" title="2.3 客户端搭建"></a>2.3 客户端搭建</h4><p>客户端就是我们各个微服务，通过<code>Config Server</code>获取修改的配置</p>
<p><strong>搭建工程</strong></p>
<ol>
<li><p>创建<code>cloud-config-client-3355</code>模块</p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;注意：Client端的POM和Server端的是不一样的，server端的名字为<code>spring-cloud-config-server</code>，Client端为<code>spring-cloud-starter-config</code>，要注意这两个的区别&#x3D;&#x3D;</p>
</li>
<li><p>YAML -&gt; <code>bootstrap.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#Config客户端配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span>  <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="comment">#读取后缀名称   上述3个综合：main分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span> <span class="comment">#配置中心地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientMain3355</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SpringApplication.run(ConfigClientMain3355.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>测试</strong></p>
<p>启动访问<code>http://localhost:3355/configInfo</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216151104128.png" alt="image-20230216151104128"></p>
<p>获取到了配置，nice~~~😋😋😋</p>
<h4 id="2-4-bootstrap-yml文件说明"><a href="#2-4-bootstrap-yml文件说明" class="headerlink" title="2.4 bootstrap.yml文件说明"></a>2.4 bootstrap.yml文件说明</h4><p>我们经常使用的<code>application.yml</code>，为什么刚才使用了<code>bootstrap.yml</code>，他们两个区别在哪？</p>
<ul>
<li>applicaiton.yml是<strong>用户级</strong>的资源配置项</li>
<li>bootstrap.yml 是<strong>系统级</strong>的，优先级更加高</li>
</ul>
<p>Spring Cloud会创建一个“Bootstrap Context”，作为Spring应用的<code>Application Context</code>的父上下文。初始化的时候，<code>Bootstrap Context</code>负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的<code>Environment</code>。</p>
<p><code>Bootstrap</code>属性有高优先级，默认情况下，它们不会被本地配置覆盖。 <code>Bootstrap context</code>和<code>Application Context</code>有着不同的约定，所以新增了一个<code>bootstrap.yml</code>文件，保证<code>Bootstrap Context</code>和<code>Application Context</code>配置的分离。</p>
<p>要将Client模块下的<code>application.yml</code>文件改为<code>bootstrap.yml</code>,这是很关键的，因为<code>bootstrap.yml</code>是比<code>application.yml</code>先加载的。<code>bootstrap.yml</code>优先级高于<code>application.yml</code>。</p>
<p>&#x3D;&#x3D;配置变更会覆盖<code>application</code>中的配置，所以一般不变更的配置放到<code>bootstrap.yml</code>中&#x3D;&#x3D;</p>
<h3 id="3、配置动态刷新"><a href="#3、配置动态刷新" class="headerlink" title="3、配置动态刷新"></a>3、配置动态刷新</h3><h4 id="3-1-修改Git仓库上的配置文件"><a href="#3-1-修改Git仓库上的配置文件" class="headerlink" title="3.1 修改Git仓库上的配置文件"></a>3.1 修改Git仓库上的配置文件</h4><p>设置版本为2</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153110129.png" alt="image-20230216153110129"></p>
<p>接下来访问<code>Config Server</code>看是否已经更新了。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153209280.png" alt="image-20230216153209280"></p>
<p>可以看到服务器端已经更新了，我们再看一下客户端</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153241470.png" alt="image-20230216153241470"></p>
<p>并没有刷新，因为我们还没有配置动态刷新~~~</p>
<h4 id="3-2-动态刷新配置"><a href="#3-2-动态刷新配置" class="headerlink" title="3.2 动态刷新配置"></a>3.2 动态刷新配置</h4><ol>
<li><p>首先需要引入<code>actuator</code>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改客户端YAML配置 -&gt; <code>bootstrap.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暴露监控端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">      	<span class="comment"># 这里为了方便暴露全部端点</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>controller上标注<code>@RefreshScope</code>注解</p>
</li>
<li><p>重新启动服务</p>
</li>
</ol>
<p>启动服务之后访问是可以获取到最新的配置的，但是我们要的就是不重启也可以获取，所以这里还是需要修改一下配置</p>
<p>修改version为3</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216153814993.png" alt="image-20230216153814993"></p>
<p>再次请求发现<code>Config Server</code>更新了，但是<code>Client端</code>还是没有更新，还需要我们手动发请求刷新一下</p>
<p>打开cmd窗口，使用<code>curl</code>工具发送<code>Post</code>请求<code>http://localhost:3355/actuator/refresh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一定要加 -X</span></span><br><span class="line">curl -X POST <span class="string">&quot;http://localhost:3355/actuator/refresh&quot;</span></span><br><span class="line"><span class="comment"># 修改的配置信息</span></span><br><span class="line">[<span class="string">&quot;config.client.version&quot;</span>,<span class="string">&quot;config.info&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216154318465.png" alt="image-20230216154318465"></p>
<p>发送完成后再次访问</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216154338147.png" alt="image-20230216154338147"></p>
<p>漂亮，你做到了，你真的做到了，它改变了，Oh~~~~😂</p>
<h4 id="3-3-问题"><a href="#3-3-问题" class="headerlink" title="3.3 问题"></a>3.3 问题</h4><p>Q：对于上面的动态刷新配置我们已经实现了，但是发现一个问题，难道每次配置更改就要手动刷新一次吗？这样此不是每一个修改配置的微服务都要刷新一次，微服务多的话任务量还是有点大。能不能广播呢，一次通知，到处生效。</p>
<p>A：是的，spring cloud考虑到了这个问题，接下来我们就学习消息总线，它可以帮我们解决这个问题</p>
<h1 id="九、消息总线"><a href="#九、消息总线" class="headerlink" title="九、消息总线"></a>九、消息总线</h1><h2 id="SpringCloud-Bus"><a href="#SpringCloud-Bus" class="headerlink" title="SpringCloud Bus"></a>SpringCloud Bus</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><p>我们使用<code>SpringCloud Config</code>来管理配置，但是配置修改需要我们手动去刷新，如果服务太多的话，重复的工作就会变多，<code>SpringCloud BUS</code>就是来解决这个问题的，一次刷新，广播通知，处处生效。<code>Spring Cloud Config</code> + <code>SpringCloud BUS</code> 实现真正的动态刷新。只需要刷新一次，就能通过总线推送给各个服务。</p>
<p>Spring Cloud Bus是用来将分布式系统的节点与轻量级消息系统链接起来的框架，它整合了Java的事件处理机制和消息中间件的功能。<strong>Spring Clud Bus目前支持RabbitMQ和Kafka。</strong></p>
<p>Spring Cloud Bus能管理和传播分布式系统间的消息，就像一个分布式执行器，可用于广播状态更改、事件推送等，也可以当作微服务间的通信通道。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230216170503829.png" alt="image-20230216170503829"></p>
<p><strong>什么是总线</strong><br>在微服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中所有微服务实例都连接上来。由于该主题中产生的消息会被所有实例监听和消费，所以称它为消息总线。在总线上的各个实例，都可以方便地广播一些需要让其他连接在该主题上的实例都知道的消息。</p>
<p><strong>基本原理</strong><br>ConfigClient实例都订阅MQ中同一个topic(默认是springCloudBus)。当一个服务刷新数据的时候，它会把这个信息放入到Topic中，这样其它监听同一Topic的服务就能得到通知，然后去更新自身的配置。</p>
<p><strong>两种传播方式</strong>：</p>
<p>方式一：利用配置中心触发一个客户端，再由客户端触发全部的客户端。</p>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219112506319.png" alt="image-20230219112506319" style="zoom: 67%;" />

<p>方式二：利用消息总线触发一个服务端ConfigServer的&#x2F;bus&#x2F;refresh端点，而刷新所有客户端的配置（推荐使用这种方式）</p>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219112635696.png" alt="image-20230219112635696" style="zoom:67%;" />





<h3 id="2-安装RabbitMQ-省略"><a href="#2-安装RabbitMQ-省略" class="headerlink" title="2.安装RabbitMQ(省略)"></a>2.安装RabbitMQ(省略)</h3><h3 id="3-动态刷新全局广播"><a href="#3-动态刷新全局广播" class="headerlink" title="3.动态刷新全局广播"></a>3.动态刷新全局广播</h3><p>在<code>SpringCloud Config</code>章节我们搭建了3355工程，现在我们再搭建一个3366工程，配置都是一样的，端口号不一致，业务上多一个端口号</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">configInfo</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;serverPort: &quot;</span>+serverPort+<span class="string">&quot;\t\n\n configInfo: &quot;</span>+configInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着添加BUS的POM，两个都要添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--bus整合RabbitMQ的POM--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yml添加配置项</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.156</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>

<p><strong>配置中心工程修改</strong></p>
<ul>
<li><p>添加POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># rabbitmq配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.156</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">##rabbitmq相关配置,暴露bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这个官网上可以找到暴露的端点</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219113404288.png" alt="image-20230219113404288"></p>
<p>上图是4.0.1版本的，不是当前使用的这个版本！！！</p>
</li>
</ul>
<p><strong>测试</strong></p>
<p>启动Eureka7001和3344、3355、3366这三台</p>
<p>在<code>RabbitMQ</code>控制台中可以看到<code>SpringCloudBus</code>的信息</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220202302139.png" alt="image-20230220202302139"></p>
<p>修改github上的配置文件</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219113610248.png" alt="image-20230219113610248"></p>
<p>接着发送刷新请求</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">&quot;http://localhost:3344/actuator/bus-refresh&quot;</span></span><br></pre></td></tr></table></figure>

<p>观察结果</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219113742325.png" alt="image-20230219113742325"></p>
<p>成功~~~😋😋😋</p>
<h3 id="4-动态刷新定点通知"><a href="#4-动态刷新定点通知" class="headerlink" title="4.动态刷新定点通知"></a>4.动态刷新定点通知</h3><p>场景：某几台配置修改，其他的不修改</p>
<p>案例：通知3355，3366不修改</p>
<p><strong>公式</strong>：<code>http://localhost:配置中心的端口号/actuator/bus-refresh/注册中心服务名:端口号</code></p>
<p>例子：通知<code>config-client</code>服务的<code>3355</code>端口的服务修改</p>
<p><code>localhost:3344/actuator/bus-refresh/config-client:3355</code></p>
<p><strong>实现</strong></p>
<p>修改github的配置文件，在发送例子中的命令，查看变化</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219134237524.png" alt="image-20230219134237524"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219132548049.png" alt="image-20230219132548049"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230219134151725.png" alt="image-20230219134151725"></p>
<h1 id="十、消息驱动"><a href="#十、消息驱动" class="headerlink" title="十、消息驱动"></a>十、消息驱动</h1><p>在我们的系统中，不仅有我们的中台，也就是Java Web程序，同时还有大数据平台，那么它会出现一种情况，就是我们Java程序用的消息队列是RabbitMQ，大数据平台用的是Kafka，<strong>那么这个时候我们需要在这两种消息队列中来回切换</strong>。这是相当费劲的，而且它的学习成本也提高了，虽然都是消息队列，但是在很多方面还是有很多的不同，学习起来需要花费许多的时间，那有没有一个框架或者软件来集成两个消息队列，让我们不再专注底层的细节，而是专注于我们的业务呢？是的，它就是我们的主角，消息驱动。</p>
<h2 id="SpringCloud-Stream"><a href="#SpringCloud-Stream" class="headerlink" title="SpringCloud Stream"></a>SpringCloud Stream</h2><h3 id="1、概述-5"><a href="#1、概述-5" class="headerlink" title="1、概述"></a>1、概述</h3><h4 id="1-1-是什么？"><a href="#1-1-是什么？" class="headerlink" title="1.1 是什么？"></a>1.1 是什么？</h4><p>官方定义 Spring Cloud Stream 是一个构建消息驱动微服务的框架。</p>
<p>应用程序通过 inputs 或者 outputs 来与 Spring Cloud Stream中binder对象交互。通过我们配置来binding(绑定) ，而 Spring Cloud Stream 的 <strong>binder对象负责与消息中间件交互</strong>。所以，我们只需要搞清楚如何与 Spring Cloud Stream 交互就可以方便使用消息驱动的方式。</p>
<p>通过使用Spring Integration来连接消息代理中间件以实现消息事件驱动。Spring Cloud Stream 为一些供应商的消息中间件产品提供了个性化的自动化配置实现，引用了<strong>发布-订阅、消费组、分区</strong>的三个核心概念。</p>
<p>&#x3D;&#x3D;<strong>目前仅支持RabbitMQ、Kafka。</strong>&#x3D;&#x3D;</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220152928327.png" alt="image-20230220152928327"></p>
<p><strong>中文指导手册</strong>：<code>https://m.wang1314.com/doc/webapp/topic/20971999.html</code></p>
<h4 id="1-2-设计思想"><a href="#1-2-设计思想" class="headerlink" title="1.2 设计思想"></a>1.2 设计思想</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220202922897.png" alt="image-20230220202922897"></p>
<p>标准消息队列的三个步骤：</p>
<ul>
<li>消息：生产者&#x2F;消费者之间通过消息媒介传递信息</li>
<li>通道：消息必须要走的特殊通道（<code>MessageChannel</code>）</li>
<li>处理：由<code>MessageHandler</code>消息处理器向订阅的客户端推送消息</li>
</ul>
<p>使用<code>SpringCloud Stream</code>可以使我们屏蔽底层消息队列的操作细节。通过绑定器（<code>Binder</code>）作为中间层，完美的实现了应用程序和消息中间件细节之间的隔离，通过向应用程序暴露统一的Channel通道，使得应用程序不需要再考虑各种不同的消息中间件实现。Stream中的消息通信方式遵循了发布-订阅模式。</p>
<h4 id="1-3-核心组件和注解"><a href="#1-3-核心组件和注解" class="headerlink" title="1.3 核心组件和注解"></a>1.3 核心组件和注解</h4><ul>
<li>Binder（绑定器）：Binder可以生成Binding，Binding用来绑定消息容器的生产者和消费者，它有两种类型，INPUT和OUTPUT，INPUT对应于消费者，OUTPUT对应于生产者</li>
<li>Channel（通道）：是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel对队列进行配置</li>
<li>Source和Sink：简单的可理解为参照对象是Spring Cloud Stream自身，从Stream发布消息就是输出，接受消息就是输入。Suorce就是输出，Sink就是输入。</li>
</ul>
<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220204132411.png" alt="image-20230220204132411" style="zoom:67%;" />

<img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230220204136473.png" alt="image-20230220204136473"  />





<h3 id="2、使用-1"><a href="#2、使用-1" class="headerlink" title="2、使用"></a>2、使用</h3><h4 id="2-1-消息生产者搭建"><a href="#2-1-消息生产者搭建" class="headerlink" title="2.1 消息生产者搭建"></a>2.1 消息生产者搭建</h4><ol>
<li><p>创建<code>cloud-stream-rabbitmq-provider8801</code></p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--基础配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span>   <span class="comment"># 应用名</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.156</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">####################### stream配置 ########################</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span>  <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line"><span class="comment">#          environment: # 设置rabbitmq的相关的环境配置</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">output:</span>  <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span>      <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span>  <span class="comment"># 设置消息类型，本次为对象json，如果是文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>           <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">####################### rabbitmq配置 ########################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####################### eureka配置 ########################</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">send-8801.com</span>    <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>       <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamMQMain8801</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(StreamMQMain8801.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085217729.png" alt="image-20230221085217729"></p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMessageProvider iMessageProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sendMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iMessageProvider.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProviderImpl</span> <span class="keyword">implements</span> <span class="title class_">IMessageProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serial</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        output.send(MessageBuilder.withPayload(serial).build());</span><br><span class="line">        log.info(<span class="string">&quot;serial：&#123;&#125;&quot;</span>, serial);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>测试，访问定义好的接口</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085329782.png" alt="image-20230221085329782"></p>
<p>有日志输出，成功~~~😋😋😋</p>
<h4 id="2-2-消息消费者搭建"><a href="#2-2-消息消费者搭建" class="headerlink" title="2.2 消息消费者搭建"></a>2.2 消息消费者搭建</h4><p>需要搭建两个同样的消费者，端口号不同</p>
<ol>
<li><p>创建<code>cloud-stream-rabbitmq-consumer8803</code>和<code>cloud-stream-rabbitmq-consumer8802</code>模块</p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--基础配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8803</span> <span class="comment"># 8802</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line"><span class="comment">#          environment: # 设置rabbitmq的相关的环境配置</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">input:</span>  <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span>      <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span>  <span class="comment"># 设置消息类型，本次为对象json，如果是文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>           <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.156</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">receive-8802.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamMQMain8803</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SpringApplication.run(StreamMQMain8803.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类</p>
<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveMessageListener</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">input</span><span class="params">(Message&lt;String&gt; message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;消费者-------&gt;接收到的消息：&#123;&#125;\t&#123;&#125;&quot;</span>, message.getPayload(), serverPort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><em><strong>测试</strong></em></p>
<p>多次访问8801的发送消息接口，观察8802和8803的日志输出</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221084855659-16769405367371.png" alt="image-20230221084855659"></p>
<p>可以看到峰值的变化，当我们不点的时候它就归0了</p>
<p>8803日志输出</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085747897.png" alt="image-20230221085747897"></p>
<p>8802日志输出</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221085825854.png" alt="image-20230221085825854"></p>
<h3 id="3、分组消费和持久化"><a href="#3、分组消费和持久化" class="headerlink" title="3、分组消费和持久化"></a>3、分组消费和持久化</h3><p>观察上面的案例发现，一个消息被两个服务消费了，这种被多个消费的叫重复消费。重复消费会导致数据的不一致性，所以我们要对消息进行分组，<strong>不同组的服务可以多个消费，同个组的服务只能有一个消费</strong>。</p>
<h4 id="3-1-分组"><a href="#3-1-分组" class="headerlink" title="3.1 分组"></a>3.1 分组</h4><p>修改上面的案例，使他们之间只有一个服务能消费，所以我们需要将他们分在同一个组</p>
<p>自动分配的分组名</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091256573.png" alt="image-20230221091256573"></p>
<p>可以看到两个是不同的分组，所以两个服务都消费了消息，接下来我们要给两个服务分到一个分组中。</p>
<p><strong>修改两个服务的<code>YAML</code>文件</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091515273.png" alt="image-20230221091515273"></p>
<p>现在他们都在一个组中</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091657017.png" alt="image-20230221091657017"></p>
<p><strong>测试</strong></p>
<p>生产者发送4条消息。观察两个消费者的日志</p>
<ul>
<li><p>8803</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091827898.png" alt="image-20230221091827898"></p>
</li>
<li><p>8802</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221091846946.png" alt="image-20230221091846946"></p>
</li>
</ul>
<p>可以看到很每个服务都消费了两条，没有被重复消费。</p>
<h4 id="3-2-持久化"><a href="#3-2-持久化" class="headerlink" title="3.2 持久化"></a>3.2 持久化</h4><p>服务宕机后，再次启动，如果没有设置分组，消息就会发生丢失的情况，这就是持久化问题。</p>
<p><strong>场景复现</strong></p>
<ul>
<li><p>将两台消费者关掉。一台设置分组，一台不设置。</p>
<p>8802的去掉</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221092224227.png" alt="image-20230221092224227"></p>
</li>
<li><p>生产者8801发送多条消息</p>
</li>
<li><p>启动两台消费者，观察日志是否有输出</p>
<p>8803消费了消息</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221092500164.png" alt="image-20230221092500164"></p>
<p>8802没有消费。</p>
</li>
</ul>
<p><strong>解决问题</strong></p>
<p>给它设置一个分组。我们将两个服务分到不同的分组，因为分在一个分组先启动的就会将消息全部消费，后启动的就不用消费了，因为是同一个组。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221100808511.png" alt="image-20230221100808511"></p>
<p><strong>测试</strong></p>
<p>先停掉两台服务。使用8801生产者生产消息，再次启动两台服务</p>
<p>观察发现两台服务器都有消息消费的日志，nice~~~😈😋😋</p>
<h1 id="十一、分布式链路追踪"><a href="#十一、分布式链路追踪" class="headerlink" title="十一、分布式链路追踪"></a>十一、分布式链路追踪</h1><p>在微服务架构中，一次请求可能需要多个服务节点调用来协同产出结果，每一段请求都会形成一个复杂的分布式调用链路，链路中的任何一个服务出现高延时或错误都会引起整个请求的失败。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221153148441.png" alt="image-20230221153148441"></p>
<p>分布式链路追踪可以帮助我们追踪这一段调用链路的服务，当出现问题时，可以很直观的看到出错的服务。</p>
<h2 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h2><h3 id="1、概述-6"><a href="#1、概述-6" class="headerlink" title="1、概述"></a>1、概述</h3><p>Spring Cloud Sleuth提供了一套完整的服务跟踪的解决方案，在分布式系统中提供追踪解决方案并且兼容支持了zipkin</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155422621.png" alt="image-20230221155422621"></p>
<p>上图是完整的链路调用</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155539663.png" alt="image-20230221155539663"></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155757474.png" alt="image-20230221155757474"></p>
<p>一条链路通过Trace Id唯一标识，Span标识发起的请求信息，各span通过<code>parent id </code>关联起来，<code>parent id</code>可以理解为是调用它的服务</p>
<p>Trace:类似于树结构的Span集合，表示一条调用链路，存在唯一标识</p>
<p>span:表示调用链路来源，通俗的理解span就是一次请求信息</p>
<p><strong>SpringCloud从F版起已不需要自己构建Zipkin Server了，只需调用jar包即可</strong></p>
<p><strong>启动命令</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jar包名</span><br></pre></td></tr></table></figure>

<p>然后访问<code>http://localhost:9411</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221155325873.png" alt="image-20230221155325873"></p>
<p>成功~~~</p>
<h3 id="2、使用-2"><a href="#2、使用-2" class="headerlink" title="2、使用"></a>2、使用</h3><p>添加它的POM和修改YAML。观察web 控制台即可。</p>
<ol>
<li><p>修改<code>cloud-consumer-order8002</code>和<code>cloud-provider-payment8001</code>工程</p>
</li>
<li><p>POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--包含了sleuth+zipkin--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">    <span class="attr">sleuth:</span></span><br><span class="line">      <span class="attr">sampler:</span></span><br><span class="line">        <span class="comment">#采样率值介于 0 到 1 之间，1 则表示全部采集</span></span><br><span class="line">        <span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类</p>
<ul>
<li><p>8001-paymnt</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/zipkin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentZipkin</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hi ,I am xiaozhi&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>8002-order</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/zipkin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentZipkin</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8001&quot;</span>+<span class="string">&quot;/payment/zipkin/&quot;</span>, String.class);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<p><strong>测试</strong></p>
<p>访问几次<code>http://localhost:8002/order/payment/zipkin</code>，观察web控制台变化</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221160533972.png" alt="image-20230221160533972"></p>
<p>3个spans，还有一个是<code>zipkin</code>本身，点击对应的栏目可以看到详细的信息</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221160625533.png" alt="image-20230221160625533"></p>
<p><strong>查看依赖</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img/image-20230221160652692.png" alt="image-20230221160652692"></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/dd/tags/Spring/">Spring</a></div><div class="post-share"><div class="social-share" data-image="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/dd/2024/10/25/%E4%B8%9A%E5%8A%A1%E8%AE%BE%E8%AE%A1/" title="业务设计"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png" onerror="onerror=null;src='/dd/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">业务设计</div></div><div class="info-2"><div class="info-item-1">业务实现树状结构数据创建 上图，是我们最终实现的结构，将数据以树状控件的方式展示，前端这里不多解释 树的节点与节点之间是如何进行联系的呢？ 我们可以在表中设置一个 parentId 字段来建立父子关系，它表示是父亲的ID，通过这个可以找到对应节点的父亲节点，以此类推往上也是通过它来查找，以此来创建树 代码实现 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** * 构建树结构数据 * @param deptList  部门list */private List&lt;SysDeptResp&gt; getDeptTree(List&lt;SysDeptResp&gt; deptList) &#123;    // 核心：子找父    var deptTreeList = new ArrayList&lt;SysDeptResp&gt;();    // 根据父ID进行分组    List&lt;Long&gt; idList =...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/%E6%97%A5%E5%B8%B8%E8%BD%AF%E4%BB%B6/" title="常用类库"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/dd/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">常用类库</div></div><div class="info-2"><div class="info-item-1">查看功能QuickLook快速查看文本和图片 https://github.com/QL-Win/QuickLook 美化Clover文件控制器美化 软件搜索everything </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/dd/2024/10/25/SpringBoot-%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/" title="SpringBoot-接口设计"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">SpringBoot-接口设计</div></div><div class="info-2"><div class="info-item-1">接口 - 结果返回封装enum类12345678910111213141516171819202122232425262728@Getter@AllArgsConstructorpublic enum ResponseStatus &#123;    SUCCESS(&quot;200&quot;, &quot;success&quot;),    FAIL(&quot;500&quot;, &quot;failed&quot;),    HTTP_STATUS_200(&quot;200&quot;, &quot;ok&quot;),    HTTP_STATUS_400(&quot;400&quot;, &quot;request error&quot;),    HTTP_STATUS_401(&quot;401&quot;, &quot;no authentication&quot;),    HTTP_STATUS_403(&quot;403&quot;, &quot;no authorities&quot;),   ...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/Spring%20Data/" title="Spring Data"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">Spring Data</div></div><div class="info-2"><div class="info-item-1">Spring Data JPA概述 官网：Spring Data JPA provides repository support for the Jakarta Persistence API (JPA). It eases development of applications with a consistent programming model that need to access JPA data sources. 翻译：Spring Data JPA为Jakarta Persistence API（JPA）提供存储库支持。它通过一致的编程模型简化了需要访问JPA数据源的应用程序的开发。  JPA 是 Java 5.0 的概念，规范持久化操作的API规范，而 Spring Data JPA 是对 JPA  的二次封装，提供给各个 ORM 框架遵循的 API 规范，底层负责实现各种功能的是各种的 ORM 框架，比如知名的 Hibernate 框架。 Spring Data JPA 默认使用的是 Hibernate，由它来完成数据库的一系列操作 Getter...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/Spring%20Cloud%20Alibaba/" title="Spring Cloud Alibaba"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg3.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">Spring Cloud Alibaba</div></div><div class="info-2"><div class="info-item-1">一、概述1.1 Spring Cloud Alibaba为什么出现由于Spring Cloud Netflix项目进入维护模式，Spring Cloud官方和Alibaba合作搞出一套来替换Netflix的各个技术  进入维护模式意味着Spring Cloud Netflix 将不再开发新的组件，我们都知道Spring Cloud 版本迭代算是比较快的，因而出现了很多重大ISSUE都还来不及Fix就又推另一个Release了。进入维护模式意思就是目前一直以后一段时间Spring Cloud Netflix提供的服务和功能就这么多了，不在开发新的组件和功能了。以后将以维护和Merge分支Full Request为主，所以新组件功能将以其他替代平代替的方式实现。 1.2 是什么官网：https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md 诞生：2018.10.31，Spring Cloud Alibaba 正式入驻了 Spring Cloud 官方孵化器，并在 Maven...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/Spring/" title="Spring"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">Spring</div></div><div class="info-2"><div class="info-item-1">Spring的概述简介   spring   是一个开源框架，它由Rod Johnson创建。它是为了解决企业应用开发的复杂性而创建的  Rod Johnson是个音乐家 &#x3D;&#x3D;Spring是一个轻量级的控制反转(IoC)和面向切面(AOP)的容器框架。&#x3D;&#x3D;  轻量级：只需要导入对应的jar包就可以使用 IOC：所有的对象有spring来托管和分配 AOP：Spring提供了面向切面编程的丰富支持，允许通过分离应用的业务逻辑与系统级服务（例如审计（auditing）和事务（transaction）管理）进行内聚性的开发 容器：Spring包含并管理应用对象的配置和生命周期，在这个意义上它是一种容器，你可以配置你的每个bean如何被创建——基于一个可配置原型（prototype），你的bean可以创建一个单独的实例或者每次需要时都生成一个新的实例——以及它们是如何相互关联的  spring理念：是现有的技术更加容易使用，本身是一个大杂烩。  SSH：Struct2 + Spring + Hibernate SSM: SpringMVC +...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/SpringBoot-%E9%9B%86%E6%88%90/" title="SpringBoot-集成"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">SpringBoot-集成</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/SpringSecutiry/" title="SpringSecutiry"><img class="cover" src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">SpringSecutiry</div></div><div class="info-2"><div class="info-item-1">一、概述简介springSecutiry是一个安全框架，负责对用户的认证和授权 认证：通过用户名和密码来对用户进行认证，判断是否是本系统的用户 授权：用户拥有哪些访问权限，可以访问哪些页面 我们都知道 servlet 是用来接收请求服务器的，而在它之前还会经过一系列的 Filter，通过Filter 来对请求进行拦截过滤，防止非法人员对服务进行非法操作，保护服务安全，而 SpringSecurity 的核心也是由多个Filter 来进行构建的。 它默认是已经帮我们配置好了一些Filter，这里我们简单的介绍下重要的几个Filter：  CsrfFilter：这个Filter 用于防止跨站点请求伪造攻击，它会导致除了 GET 请求之外的所有请求都失败，前后端分离的基于Token认证的API服务可以关闭这个 Filter BasicAuthenticationFilter：支持 HTTP 的标准 Basic Auth 的身份认证模块 UsernamePasswordAuthenticationFilter：支持 Form...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/dd/static/img/avatar.png" onerror="this.onerror=null;this.src='/dd/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name"></div><div class="author-info-description">孤独患者</div><div class="site-data"><a href="/dd/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/dd/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/dd/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/dd-xiaozhi" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="mailto:1596971466@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81SpringCloud%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">一、SpringCloud概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 微服务是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-SpringCloud%E4%B8%BB%E6%B5%81%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 SpringCloud主流技术栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Boot%E5%92%8CCould%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 Boot和Could技术选型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">二、微服务工程搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%88%B6%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">父工程搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA"><span class="toc-number">2.2.</span> <span class="toc-text">支付模块搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97"><span class="toc-number">2.2.1.</span> <span class="toc-text">①创建模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1%E4%BF%AE%E6%94%B9Pom"><span class="toc-number">2.2.2.</span> <span class="toc-text">②修改Pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A2%E6%94%B9yalml"><span class="toc-number">2.2.3.</span> <span class="toc-text">③改yalml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A3%E4%B8%BB%E5%90%AF%E5%8A%A8"><span class="toc-number">2.2.4.</span> <span class="toc-text">④主启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A4%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.2.5.</span> <span class="toc-text">⑤业务类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA"><span class="toc-number">2.3.</span> <span class="toc-text">订单模块搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E5%8F%96%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97"><span class="toc-number">2.4.</span> <span class="toc-text">抽取公共模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">三、服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka%EF%BC%88%E5%81%9C%E6%9B%B4%E7%BB%B4%E6%8A%A4%E2%9A%A0%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">Eureka（停更维护⚠）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%8D%95%E6%9C%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.1.</span> <span class="toc-text">搭建单机服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E6%90%AD%E5%BB%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">①搭建注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%B0%86%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%86%8C"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">②将模块注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">③调用服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.2.</span> <span class="toc-text">搭建集群服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">①集群原理说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E6%90%AD%E5%BB%BA"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">②搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%9B%86%E7%BE%A4"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">③服务注册到注册中心集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.1.3.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E6%8F%90%E4%BE%9B%E8%80%85%E5%A2%9E%E5%8A%A0"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">①提供者增加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E4%BF%AE%E6%94%B9%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">②修改消费者的请求路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">③启动测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#actuator%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%A1%E6%81%AF%E5%AE%8C%E5%96%84"><span class="toc-number">3.1.4.</span> <span class="toc-text">actuator微服务信息完善</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%8E%A5%E5%8F%A3%E5%90%8D"><span class="toc-number">3.1.4.1.</span> <span class="toc-text">监控接口名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%8D%E5%8A%A1id%E5%92%8C%E6%98%BE%E7%A4%BAip"><span class="toc-number">3.1.4.2.</span> <span class="toc-text">修改服务id和显示ip</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Discovery"><span class="toc-number">3.1.5.</span> <span class="toc-text">服务发现Discovery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.6.</span> <span class="toc-text">Eureka自我保护模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.6.1.</span> <span class="toc-text">什么是自我保护模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%85%B3%E9%97%AD%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.6.2.</span> <span class="toc-text">如何关闭自我保护模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper"><span class="toc-number">3.2.</span> <span class="toc-text">Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">3.2.1.</span> <span class="toc-text">①构建服务提供者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">3.2.2.</span> <span class="toc-text">②构建服务消费者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consul"><span class="toc-number">3.3.</span> <span class="toc-text">Consul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">3.3.1.</span> <span class="toc-text">1.简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.2.</span> <span class="toc-text">2.安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%9E%84%E5%BB%BA%E6%8F%90%E4%BE%9B%E8%80%85%E6%A8%A1%E5%9D%97"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">3.1 构建提供者模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%9E%84%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9D%97"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">3.2 构建消费者模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.3.3.</span> <span class="toc-text">3.3 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E4%B8%AA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%BC%82%E5%90%8C%E7%82%B9"><span class="toc-number">3.4.</span> <span class="toc-text">三个注册中心异同点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP"><span class="toc-number">3.4.1.</span> <span class="toc-text">CAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">3.4.2.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AP"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">AP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CP"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">CP</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">四、负载均衡服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon"><span class="toc-number">4.1.</span> <span class="toc-text">Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Ribbon%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6IRule"><span class="toc-number">4.1.2.</span> <span class="toc-text">2、Ribbon核心组件IRule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9B%BF%E6%8D%A2%E9%BB%98%E8%AE%A4%E7%9A%84IRule"><span class="toc-number">4.1.3.</span> <span class="toc-text">3、替换默认的IRule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81RoundRobinRule%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.1.4.</span> <span class="toc-text">4、RoundRobinRule源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E7%94%A8"><span class="toc-number">4.1.5.</span> <span class="toc-text">5、手写一个负载均衡调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85%E6%94%B9%E9%80%A0"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">提供者改造</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%94%B9%E9%80%A0"><span class="toc-number">4.1.5.2.</span> <span class="toc-text">消费者改造</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">五、服务接口调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign"><span class="toc-number">5.1.</span> <span class="toc-text">OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Feign%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">1.1 Feign是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Feign%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">1.2 Feign能做什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Feign%E5%92%8COpenFeign%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">1.3 Feign和OpenFeign的区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8OpenFeign"><span class="toc-number">5.1.2.</span> <span class="toc-text">2、使用OpenFeign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81OpenFeign%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">5.1.3.</span> <span class="toc-text">3、OpenFeign超时控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%BC%80%E5%90%AF%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">5.1.4.</span> <span class="toc-text">4、开启日志打印功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">5.1.4.1.</span> <span class="toc-text">4.1 日志级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E9%85%8D%E7%BD%AE%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">5.1.4.2.</span> <span class="toc-text">4.2 配置输出日志级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AE%BE%E7%BD%AE%E9%9C%80%E8%A6%81%E5%BC%80%E5%90%AF%E7%9A%84Feign%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">5.1.4.3.</span> <span class="toc-text">4.3 配置文件中设置需要开启的Feign客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C"><span class="toc-number">5.1.4.4.</span> <span class="toc-text">4.4 查看日志输出结果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">6.</span> <span class="toc-text">六、服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix%EF%BC%88%E5%81%9C%E6%9B%B4%E7%BB%B4%E6%8A%A4%E2%9A%A0%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">Hystrix（停更维护⚠）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">1.1 分布式系统面临的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Hystrix%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.1.1.2.</span> <span class="toc-text">1.2 Hystrix是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%9C%80%E4%B8%BB%E8%A6%81%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">6.1.1.3.</span> <span class="toc-text">1.3 最主要的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">6.1.2.</span> <span class="toc-text">2、服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%90%AD%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">2.1 搭建工程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1%E6%8F%90%E4%BE%9B%E8%80%85%E6%90%AD%E5%BB%BA"><span class="toc-number">6.1.2.1.1.</span> <span class="toc-text">2.1.1提供者搭建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">6.1.2.1.2.</span> <span class="toc-text">2.1.2消费者工程搭建</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%A8%A1%E6%8B%9F%E5%B9%B6%E5%8F%91"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">2.2 模拟并发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-JMater%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.2.2.1.</span> <span class="toc-text">2.2.1 JMater配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%9A%84%E6%B6%88%E8%B4%B9%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.1.2.2.2.</span> <span class="toc-text">2.2.2 并发下的消费接口</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">2.3 设置服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E6%8F%90%E4%BE%9B%E8%80%85%E7%AB%AF%E9%99%8D%E7%BA%A7"><span class="toc-number">6.1.2.3.1.</span> <span class="toc-text">2.3.1 提供者端降级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF%E9%99%8D%E7%BA%A7"><span class="toc-number">6.1.2.3.2.</span> <span class="toc-text">2.3.2 消费者端降级</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E4%BB%A3%E7%A0%81%E8%80%A6%E5%90%88%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.2.4.</span> <span class="toc-text">2.4 代码耦合问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-%E8%80%A6%E5%90%88%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.2.4.1.</span> <span class="toc-text">2.4.1 耦合问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-%E8%AE%BE%E7%BD%AE%E5%85%A8%E5%B1%80fallback%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.2.4.2.</span> <span class="toc-text">2.4.2 设置全局fallback方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3-%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86fallback%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.2.4.3.</span> <span class="toc-text">2.4.3 统一管理fallback方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">6.1.3.</span> <span class="toc-text">3、服务熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">3.1 熔断机制概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">6.1.3.2.</span> <span class="toc-text">3.2 使用服务熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%8E%9F%E7%90%86"><span class="toc-number">6.1.3.3.</span> <span class="toc-text">3.3 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-%E5%A4%A7%E7%A5%9E%E8%AE%BA%E6%96%87"><span class="toc-number">6.1.3.3.1.</span> <span class="toc-text">3.3.1 大神论文</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-%E7%86%94%E6%96%AD%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.1.3.3.2.</span> <span class="toc-text">3.3.2 熔断类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-3-%E7%86%94%E6%96%AD%E5%99%A8%E6%89%A7%E8%A1%8C%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.1.3.3.3.</span> <span class="toc-text">3.3.3 熔断器执行步骤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E5%B1%9E%E6%80%A7%E5%80%BC%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8"><span class="toc-number">6.1.3.4.</span> <span class="toc-text">3.4 属性值及其作用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="toc-number">6.1.4.</span> <span class="toc-text">4、服务限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7hystrixDashboard"><span class="toc-number">6.1.5.</span> <span class="toc-text">5、服务监控hystrixDashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">6.1.5.1.</span> <span class="toc-text">5.1 概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E6%90%AD%E5%BB%BA%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0"><span class="toc-number">6.1.5.2.</span> <span class="toc-text">5.2 搭建监控平台</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA"><span class="toc-number">6.1.5.2.1.</span> <span class="toc-text">5.2.1 模块搭建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2-%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">6.1.5.2.2.</span> <span class="toc-text">5.2.2 参数说明</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%BD%91%E5%85%B3"><span class="toc-number">7.</span> <span class="toc-text">七、网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Zuul%EF%BC%88%E5%81%9C%E6%9B%B4%E7%BB%B4%E6%8A%A4%E2%9A%A0%EF%BC%89%E5%92%8Czuul2"><span class="toc-number">7.1.</span> <span class="toc-text">Zuul（停更维护⚠）和zuul2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gateway"><span class="toc-number">7.2.</span> <span class="toc-text">Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-3"><span class="toc-number">7.2.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">1.1 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-zuul-VS-Gateway"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">1.2 zuul VS Gateway</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">7.2.1.3.</span> <span class="toc-text">1.3 三大核心概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">7.2.1.4.</span> <span class="toc-text">1.4 工作流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">7.2.2.</span> <span class="toc-text">2、入门案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">7.2.3.</span> <span class="toc-text">3、动态路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81Predicate-%E6%96%AD%E8%A8%80"><span class="toc-number">7.2.4.</span> <span class="toc-text">4、Predicate(断言)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E8%AF%B4%E6%98%8E"><span class="toc-number">7.2.4.1.</span> <span class="toc-text">4.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%A1%88%E4%BE%8B"><span class="toc-number">7.2.4.2.</span> <span class="toc-text">4.2 案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E8%A7%84%E5%88%99%E5%88%97%E8%A1%A8"><span class="toc-number">7.2.4.3.</span> <span class="toc-text">4.3 规则列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81Filter"><span class="toc-number">7.2.5.</span> <span class="toc-text">5、Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E6%A1%88%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">7.2.5.1.</span> <span class="toc-text">5.1 案例说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E8%87%AA%E5%AE%9A%E4%B9%89Global-Filter"><span class="toc-number">7.2.5.2.</span> <span class="toc-text">5.2 自定义Global Filter</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">8.</span> <span class="toc-text">八、分布式配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud-Config"><span class="toc-number">8.1.</span> <span class="toc-text">Spring Cloud Config</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-4"><span class="toc-number">8.1.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">8.1.1.1.</span> <span class="toc-text">1.1 分布式系统遇到的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">8.1.1.2.</span> <span class="toc-text">1.2 是什么</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8"><span class="toc-number">8.1.2.</span> <span class="toc-text">2、使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%90%AD%E5%BB%BA"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">2.1 服务端搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E8%A7%84%E5%88%99"><span class="toc-number">8.1.2.2.</span> <span class="toc-text">2.2 文件访问规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%90%AD%E5%BB%BA"><span class="toc-number">8.1.2.3.</span> <span class="toc-text">2.3 客户端搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-bootstrap-yml%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">8.1.2.4.</span> <span class="toc-text">2.4 bootstrap.yml文件说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E9%85%8D%E7%BD%AE%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">8.1.3.</span> <span class="toc-text">3、配置动态刷新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E4%BF%AE%E6%94%B9Git%E4%BB%93%E5%BA%93%E4%B8%8A%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">8.1.3.1.</span> <span class="toc-text">3.1 修改Git仓库上的配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">8.1.3.2.</span> <span class="toc-text">3.2 动态刷新配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E9%97%AE%E9%A2%98"><span class="toc-number">8.1.3.3.</span> <span class="toc-text">3.3 问题</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF"><span class="toc-number">9.</span> <span class="toc-text">九、消息总线</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Bus"><span class="toc-number">9.1.</span> <span class="toc-text">SpringCloud Bus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">9.1.1.</span> <span class="toc-text">1.概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85RabbitMQ-%E7%9C%81%E7%95%A5"><span class="toc-number">9.1.2.</span> <span class="toc-text">2.安装RabbitMQ(省略)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%85%A8%E5%B1%80%E5%B9%BF%E6%92%AD"><span class="toc-number">9.1.3.</span> <span class="toc-text">3.动态刷新全局广播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%AE%9A%E7%82%B9%E9%80%9A%E7%9F%A5"><span class="toc-number">9.1.4.</span> <span class="toc-text">4.动态刷新定点通知</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="toc-number">10.</span> <span class="toc-text">十、消息驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Stream"><span class="toc-number">10.1.</span> <span class="toc-text">SpringCloud Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-5"><span class="toc-number">10.1.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">1.1 是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">1.2 设计思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E5%92%8C%E6%B3%A8%E8%A7%A3"><span class="toc-number">10.1.1.3.</span> <span class="toc-text">1.3 核心组件和注解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8-1"><span class="toc-number">10.1.2.</span> <span class="toc-text">2、使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85%E6%90%AD%E5%BB%BA"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">2.1 消息生产者搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85%E6%90%AD%E5%BB%BA"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">2.2 消息消费者搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%88%86%E7%BB%84%E6%B6%88%E8%B4%B9%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">10.1.3.</span> <span class="toc-text">3、分组消费和持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%88%86%E7%BB%84"><span class="toc-number">10.1.3.1.</span> <span class="toc-text">3.1 分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">10.1.3.2.</span> <span class="toc-text">3.2 持久化</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="toc-number">11.</span> <span class="toc-text">十一、分布式链路追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud-Sleuth"><span class="toc-number">11.1.</span> <span class="toc-text">Spring Cloud Sleuth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-6"><span class="toc-number">11.1.1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8-2"><span class="toc-number">11.1.2.</span> <span class="toc-text">2、使用</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/dd/2024/10/25/Dubbo/" title="Dubbo"><img src="https://cn.dubbo.apache.org/imgs/nav_logo2.png" onerror="this.onerror=null;this.src='/dd/img/404.jpg'" alt="Dubbo"/></a><div class="content"><a class="title" href="/dd/2024/10/25/Dubbo/" title="Dubbo">Dubbo</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/dd/2024/10/25/JVM/" title="JVM"><img src="https://jsd.012700.xyz/gh/jerryc127/CDN@latest/cover/default_bg2.png" onerror="this.onerror=null;this.src='/dd/img/404.jpg'" alt="JVM"/></a><div class="content"><a class="title" href="/dd/2024/10/25/JVM/" title="JVM">JVM</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/dd/2024/10/25/IDEA/" title="IDEA"><img src="/dd/static/img/top_img.png" onerror="this.onerror=null;this.src='/dd/img/404.jpg'" alt="IDEA"/></a><div class="content"><a class="title" href="/dd/2024/10/25/IDEA/" title="IDEA">IDEA</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/dd/2024/10/25/Git&amp;GitHub&amp;Gitee/" title="Git&amp;GitHub&amp;Gitee"><img src="https://github.githubassets.com/assets/apple-touch-icon-144x144-b882e354c005.png" onerror="this.onerror=null;this.src='/dd/img/404.jpg'" alt="Git&amp;GitHub&amp;Gitee"/></a><div class="content"><a class="title" href="/dd/2024/10/25/Git&amp;GitHub&amp;Gitee/" title="Git&amp;GitHub&amp;Gitee">Git&amp;GitHub&amp;Gitee</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/dd/2024/10/25/Maven/" title="Maven"><img src="https://pica.zhimg.com/v2-54238236f8c623fa79e1a3084f2c2d48_720w.jpg?source=172ae18b" onerror="this.onerror=null;this.src='/dd/img/404.jpg'" alt="Maven"/></a><div class="content"><a class="title" href="/dd/2024/10/25/Maven/" title="Maven">Maven</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347);"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By null</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/dd/js/utils.js"></script><script src="/dd/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>