<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Java并发编程 | 欢迎来到小智的blog</title><meta name="author" content="小智"><meta name="copyright" content="小智"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、概述1、进程与线程1.1 进程程序由指令和数据组成，数据要进行读写，就必须将指令加载到 CPU ，数据记载到内存中，在指令的运行过程中还需要用到磁盘、网络等设备。这些加载指令、管理内存和管理 IO 的操作 由进程来完成 程序运行从磁盘中加载代码到内存中，这就开启了一个进程，进程可以视为程序的一个实例，有些程序只能由一个实例，有些程序可以有多个实力，看这个程序是否支持多实例 1.2 线程一个进程">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发编程">
<meta property="og:url" content="https://dd-xiaozhi.github.io/dd/2024/10/25/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="欢迎来到小智的blog">
<meta property="og:description" content="一、概述1、进程与线程1.1 进程程序由指令和数据组成，数据要进行读写，就必须将指令加载到 CPU ，数据记载到内存中，在指令的运行过程中还需要用到磁盘、网络等设备。这些加载指令、管理内存和管理 IO 的操作 由进程来完成 程序运行从磁盘中加载代码到内存中，这就开启了一个进程，进程可以视为程序的一个实例，有些程序只能由一个实例，有些程序可以有多个实力，看这个程序是否支持多实例 1.2 线程一个进程">
<meta property="og:locale">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/83541888?s=400&u=c1a17f2da2425d5c4214b9d1e0a3c3a6de998d4a&v=4">
<meta property="article:published_time" content="2024-10-24T17:53:53.000Z">
<meta property="article:modified_time" content="2025-08-25T17:33:08.808Z">
<meta property="article:author" content="小智">
<meta property="article:tag" content="test">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/83541888?s=400&u=c1a17f2da2425d5c4214b9d1e0a3c3a6de998d4a&v=4"><link rel="shortcut icon" href="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/2025/372132.jpg"><link rel="canonical" href="https://dd-xiaozhi.github.io/dd/2024/10/25/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/dd/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/dd/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'medium_zoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java并发编程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-26 01:33:08'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/83541888?s=400&amp;u=c1a17f2da2425d5c4214b9d1e0a3c3a6de998d4a&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/dd/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/dd/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/dd/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/dd/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/dd/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/dd/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/dd/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/dd/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/dd/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/dd/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/dd/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/dd/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://picsum.photos/id/242/400/400);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/dd/"><img class="site-icon" src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/2025/372132.jpg" alt="Logo"><span class="site-name">欢迎来到小智的blog</span></a><a class="nav-page-title" href="/dd/"><span class="site-name">Java并发编程</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/dd/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/dd/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/dd/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/dd/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/dd/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/dd/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/dd/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/dd/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/dd/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Java并发编程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-25T17:33:08.808Z" title="Updated 2025-08-26 01:33:08">2025-08-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><h2 id="1、进程与线程"><a href="#1、进程与线程" class="headerlink" title="1、进程与线程"></a>1、进程与线程</h2><h3 id="1-1-进程"><a href="#1-1-进程" class="headerlink" title="1.1 进程"></a>1.1 进程</h3><p>程序由指令和数据组成，数据要进行读写，就必须将指令加载到 CPU ，数据记载到内存中，在指令的运行过程中还需要用到磁盘、网络等设备。这些加载指令、管理内存和管理 IO 的操作 由进程来完成</p>
<p>程序运行从磁盘中加载代码到内存中，这就开启了一个进程，进程可以视为程序的一个实例，有些程序只能由一个实例，有些程序可以有多个实力，看这个程序是否支持多实例</p>
<h3 id="1-2-线程"><a href="#1-2-线程" class="headerlink" title="1.2 线程"></a>1.2 线程</h3><p>一个进程中可以拥有多个线程，通过线程来执行不同的任务。线程就是一个指令容器，将一条条的指令按照一定顺序交给 CPU 读取和执行。它本身是不具备执行的能力的。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011212713711.png" alt="image-20231011212713711"> </p>
<p>在Java中，线程是最小的调度单位，进程作为资源分配的最小单位。在 windows 中进程是不活动的，它只是充当了线程容器的身份</p>
<h3 id="1-3-两者对比"><a href="#1-3-两者对比" class="headerlink" title="1.3 两者对比"></a>1.3 两者对比</h3><ul>
<li>进程基本相对独立，线程在进程内，是进程的一个子集</li>
<li>进程内的线程资源共享</li>
<li>进程间通信较为复杂<ul>
<li>同一台计算机的进程通信称为 IPC(inter-process-communication)</li>
<li>不同计算机之间的进程间通信，需要通过网络，并遵守共同的协议，比如HTTP协议</li>
</ul>
</li>
<li>线程通信相对简单，他们共享进程内的内存</li>
<li>线程更加轻量，线程上下文切换成本一般要比进程上下文切换低</li>
</ul>
<h2 id="2、并行和并发"><a href="#2、并行和并发" class="headerlink" title="2、并行和并发"></a>2、并行和并发</h2><h3 id="2-1-并发"><a href="#2-1-并发" class="headerlink" title="2.1 并发"></a>2.1 并发</h3><p>单核 CPU 下，线程实际是串行运行的，操作系统中有一个组件叫做任务调度器，将 cpu 的时间片（windows 下时间片最小约为 15 毫秒）分给不同的程序使用，只是由于 CPU 在线程间的切换非常快，人类感觉是 <code>同时运行的</code>。</p>
<p>微观串行，宏观并行。一般会将这种 <code>线程轮流使用 CPU 时间片</code>的做法称为并发，concurrent</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011214932416.png" alt="image-20231011214932416"> </p>
<p>如上图所示，任务调度器在多个线程间来回切换，这个行为就是并发</p>
<h3 id="2-2-并行"><a href="#2-2-并行" class="headerlink" title="2.2 并行"></a>2.2 并行</h3><p>多个核心同时执行任务的行为就是并行，现代计算器的 CPU 普遍拥有多个核心，那也就意味着多个核心可以同时执行任务，大大提高运行效率，但是这也会出现同个资源被多个核心抢夺的问题。</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011214941634.png" alt="image-20231011214941634"> </p>
<p>如上图，每个 <code>核（core）</code> 都可以调度运行线程，这时候线程可以是并行的。</p>
<blockquote>
<p>引用 <code>Rob Pike(golang创始人之一)</code> 的一段描述：</p>
<p>并发（concurrent）是同一时间应对（dealing with）多件事情的能力</p>
<p>并行（parallel）是同一时间动手做（doing）多件事情的能力</p>
</blockquote>
<h1 id="二、Java线程"><a href="#二、Java线程" class="headerlink" title="二、Java线程"></a>二、Java线程</h1><h2 id="1、创建和运行线程"><a href="#1、创建和运行线程" class="headerlink" title="1、创建和运行线程"></a>1、创建和运行线程</h2><h3 id="1-1-方式一：Thread"><a href="#1-1-方式一：Thread" class="headerlink" title="1.1 方式一：Thread"></a>1.1 方式一：Thread</h3><p>直接创建 线程的方式，通过继承 Thread 类重写 run 方法的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式一</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;方式一&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;方式一执行任务...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011221918765.png" alt="image-20231011221918765"> </p>
<h3 id="1-2-方式二：Runnable"><a href="#1-2-方式二：Runnable" class="headerlink" title="1.2 方式二：Runnable"></a>1.2 方式二：Runnable</h3><p>这种方式需要配合 Thread 使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式二：</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;方式二执行任务...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;方式二&quot;</span>).start();</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011222004853.png" alt="image-20231011222004853"> </p>
<h3 id="1-3-方式三：FutureTask"><a href="#1-3-方式三：FutureTask" class="headerlink" title="1.3 方式三：FutureTask"></a>1.3 方式三：FutureTask</h3><p><code>FutureTask</code> 的顶级父类是 <code>Runnable</code>，它能够接受 Callable 类型的参数，用来处理由返回结果的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式三</span></span><br><span class="line">FutureTask&lt;Integer&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;方式三执行任务...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;方式三&quot;</span>).start();</span><br><span class="line"><span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> task.get();</span><br><span class="line">log.debug(<span class="string">&quot;结果是：&#123;&#125;&quot;</span>, result);</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011222229768.png" alt="image-20231011222229768"> </p>
<h3 id="1-4、Thread-和-Runnable-的关系（原理）"><a href="#1-4、Thread-和-Runnable-的关系（原理）" class="headerlink" title="1.4、Thread 和 Runnable 的关系（原理）"></a>1.4、Thread 和 Runnable 的关系（原理）</h3><p><code>Runnable</code> 需要借助 <code>Thread</code> 来创建线程，需要以参数的形式传递给 Thread，我们看一下参数传给谁了</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011223255614.png" alt="image-20231011223255614"> </p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011223307612.png" alt="image-20231011223307612"> </p>
<p>最后 init 方法中它将 Runnable 对象赋值给了 Thread 的属性 </p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011223331864.png" alt="image-20231011223331864"> </p>
<p>查看 Thread 的 run 方法</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011223445321.png" alt="image-20231011223445321"> </p>
<p>可以发现调用的是 Runnable 对象中的 run 方法，前提是对象不为空</p>
<p><strong>总结</strong></p>
<ul>
<li>方法1 就是将线程和任务合并在一起，方法2 把线程和任务分开了，方法3 是将任务进行细分</li>
<li>用 Runnable 的方式更加容易与线程池等高级 API 配合</li>
<li>用 Runnable 让任务脱离了 Thread 继承体系，更加灵活</li>
</ul>
<h2 id="2、查看进城线程的方法"><a href="#2、查看进城线程的方法" class="headerlink" title="2、查看进城线程的方法"></a>2、查看进城线程的方法</h2><h3 id="2-1-windows"><a href="#2-1-windows" class="headerlink" title="2.1 windows"></a>2.1 windows</h3><p>任务管理器可以查看进程和线程数，也可以用来杀死进程</p>
<ul>
<li><p>tasklist 查看进程</p>
</li>
<li><p>taskkill 杀死进程</p>
</li>
</ul>
<h3 id="2-2-Linux"><a href="#2-2-Linux" class="headerlink" title="2.2 Linux"></a>2.2 Linux</h3><ul>
<li>ps -fe 查看所有进程</li>
<li><code>ps -fT -p &lt;PID&gt;</code> 查看某个进程（PID）的所有线程</li>
<li>kill 杀死进程</li>
<li>top 按大写 H 切换是否显示线程</li>
<li><code>top -H -p &lt;PID&gt;</code> 查看某个进程（PID）的所有线程</li>
</ul>
<h3 id="3-2-Java自带工具"><a href="#3-2-Java自带工具" class="headerlink" title="3.2 Java自带工具"></a>3.2 Java自带工具</h3><ul>
<li>jps 命令查看所有 Java 进程</li>
<li><code>jstack &lt;PID&gt;</code> 查看某个 Java 进程（PID）的所有线程状态</li>
<li>jconsole 来查看某个 Java 进程中线程的运行情况（图形界面）</li>
</ul>
<h2 id="3、线程运行原理"><a href="#3、线程运行原理" class="headerlink" title="3、线程运行原理"></a>3、线程运行原理</h2><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231011231220721.png" alt="image-20231011231220721"> </p>
<p>上图是线程运行的内存原理图</p>
<h3 id="3-1-栈和栈帧"><a href="#3-1-栈和栈帧" class="headerlink" title="3.1 栈和栈帧"></a>3.1 栈和栈帧</h3><p>Java Virtual Machine Stacks （Java 虚拟机栈），Java中的每个线程都有一个独立的栈，每个方法是一个栈帧（Frame），栈帧中有局部变量表、返回地址、锁记录、操作数栈</p>
<h3 id="3-2-线程上下文切换（Thread-Context-Switch）"><a href="#3-2-线程上下文切换（Thread-Context-Switch）" class="headerlink" title="3.2 线程上下文切换（Thread Context Switch）"></a>3.2 线程上下文切换（Thread Context Switch）</h3><p>因为以下一些原因导致 CPU 不在执行当前线程，转而执行另一个线程就会发生上下文切换</p>
<ul>
<li>线程的 cpu 时间片用完</li>
<li>垃圾回收</li>
<li>有更高优先级的线程需要运行</li>
<li>线程自己调用了 sleep、yield、wait、join、park、synchronized、lock 等方法</li>
</ul>
<p>当切换线程时，需要由操作系统保存当前线程的状态，然后恢复将要执行线程的状态。</p>
<p>Java 虚拟机中有一个组件叫程序计数器，它的作用是记录下一条 jvm 指令的执行地址，是线程私有的。</p>
<ul>
<li>状态包括程序计数器、虚拟机栈中每个栈帧的信息，如局部变量、操作数栈、返回地址等</li>
<li>Context Switch 频繁发生会影响性能</li>
</ul>
<h2 id="4、常见方法"><a href="#4、常见方法" class="headerlink" title="4、常见方法"></a>4、常见方法</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>static</th>
<th>功能说明</th>
<th>注意</th>
</tr>
</thead>
<tbody><tr>
<td>start()</td>
<td></td>
<td>启动一个新线程，在新的线程运行 run 方法中的代码</td>
<td>start 方法只是让线程进入就绪，里面代码不一定立刻运行（CPU 的时间片还没分给它）。每个线程对象的start方法只能调用一次，如果调用了多次会出现<code>IllegalThreadStateException</code></td>
</tr>
<tr>
<td>run()</td>
<td></td>
<td>新线程启动后会调用的方法</td>
<td>如果在构造 Thread 对象时传递了 Runnable 参数，则线程启动后会调用 Runnable 中的 run 方法，否则默认不执行任何操作。但可以创建 Thread 的子类对象，来覆盖默认行为</td>
</tr>
<tr>
<td>join()</td>
<td></td>
<td>等待线程运行结束</td>
<td></td>
</tr>
<tr>
<td>join(long)</td>
<td></td>
<td>等待线程运行结束,最多等待 n 毫秒</td>
<td></td>
</tr>
<tr>
<td>getId()</td>
<td></td>
<td>获取线程长整型的 id</td>
<td>每个线程都有唯一ID</td>
</tr>
<tr>
<td>getName()</td>
<td></td>
<td>获取线程名</td>
<td></td>
</tr>
<tr>
<td>setName(String)</td>
<td></td>
<td>修改线程名</td>
<td></td>
</tr>
<tr>
<td>getPriority()</td>
<td></td>
<td>获取线程优先级</td>
<td></td>
</tr>
<tr>
<td>setPriority(int)</td>
<td></td>
<td>修改线程优先级</td>
<td>java中规定线程优先级是1~10 的整数，较大的优先级能提高该线程被 CPU 调度的机率，但是 CPU 空闲时则此时优先级不起作用。</td>
</tr>
<tr>
<td>getState()</td>
<td></td>
<td>获取线程状态</td>
<td>Java 中线程状态是用 6 个 enum 表示，分别为：<code>NEW</code>, <code>RUNNABLE</code>, <code>BLOCKED</code>, <code>WAITING</code>, <code>TIMED_WAITING</code>, <code>TERMINATED</code></td>
</tr>
<tr>
<td>interrupt()</td>
<td></td>
<td>打断线程</td>
<td>如果被打断线程正在 sleep，wait，join 会导致被打断的线程抛出 InterruptedException，并清除 打断标记 ；如果打断的正在运行的线程，则会设置 打断标记 ；park 的线程被打断，也会设置 打断标记</td>
</tr>
<tr>
<td>isInterrupted()</td>
<td></td>
<td>判断线程是否被打断</td>
<td>不会清除 打断标记</td>
</tr>
<tr>
<td>interrupted()</td>
<td>static</td>
<td>判断当前线程是否被打断</td>
<td>会清除 打断标记，它和<code>isInterrupted()</code>最大的区别就是它是静态的而且它会清除打断标记</td>
</tr>
<tr>
<td>isAlive()</td>
<td></td>
<td>线程是否存活（还没有运行完毕）</td>
<td></td>
</tr>
<tr>
<td>currentThread()</td>
<td>static</td>
<td>获取当前正在执行的线程</td>
<td></td>
</tr>
<tr>
<td>sleep(long)</td>
<td>static</td>
<td>让当前执行的线程休眠n毫秒，休眠时让出 cpu 的时间片给其它线程</td>
<td></td>
</tr>
<tr>
<td>yield()</td>
<td>static</td>
<td>提示线程调度器让出当前线程对CPU的使用</td>
<td>主要是为了测试和调试</td>
</tr>
</tbody></table>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoZVdpbmRPZlNvbg==,size_16,color_FFFFFF,t_70.png" alt="img"></p>
<h3 id="4-1-start和run"><a href="#4-1-start和run" class="headerlink" title="4.1 start和run"></a>4.1 start和run</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;startAndRun.test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartAmdRunTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// run();</span></span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;============= start ===========&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;线程名为：&#123;&#125;&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            <span class="comment">// 读取文件操作</span></span><br><span class="line">            FileReader.read();</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;============= run ===========&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;线程名为：&#123;&#125;&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            <span class="comment">// 读取文件操作</span></span><br><span class="line">            FileReader.read();</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t2.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果如下：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014172303752.png" alt="image-20231014172303752"> </p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014172329903.png" alt="image-20231014172329903"> </p>
<p><strong>小结</strong>：</p>
<ul>
<li>run 方法并没有创建新的线程，而是在 main 主线程中执行的同步操作</li>
<li>start 方法则是创建了一个新的线程，在新线程中调用了 run 方法，执行异步操作</li>
</ul>
<h3 id="4-2-join"><a href="#4-2-join" class="headerlink" title="4.2 join"></a>4.2 join</h3><p>获取线程执行权。可以理解为插队现象，线程A执行了线程B的join方法，那么就要等线程B完事后线程A才会继续往下走。也就是说我们将异步的操作变成了同步的。</p>
<ul>
<li>join() 等待线程执行完成才往下执行</li>
<li>join(long) 等待指定时间，时间一到则往下执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JoinTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">r1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">r2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;========== t1 start ==========&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);      <span class="comment">// 休眠一秒</span></span><br><span class="line">            r1 = <span class="number">10</span>;</span><br><span class="line">            log.debug(<span class="string">&quot;========== t1 end ==========&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;========== t2 start ==========&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);      <span class="comment">// 休眠一秒</span></span><br><span class="line">            r2 = <span class="number">20</span>;</span><br><span class="line">            log.debug(<span class="string">&quot;========== t2 end ==========&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="comment">// t1.join();</span></span><br><span class="line">        <span class="comment">// t2.join();</span></span><br><span class="line">        log.debug(<span class="string">&quot;r1的值为：&#123;&#125;&quot;</span>, r1);</span><br><span class="line">        log.debug(<span class="string">&quot;r2的值为：&#123;&#125;&quot;</span>, r2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述例子中，结果是异步的，<code>r1</code> 和 <code>r2</code> 的值都为 <code>0</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014202612285.png" alt="image-20231014202612285"> </p>
<p>使用 <code>join()</code> 之后</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014202755821.png" alt="image-20231014202755821"> </p>
<p>可以是执行完两个线程，结果也是获取到了线程设置的值。</p>
<p><strong>注意</strong>：在这里的两个线程是异步的，因为我们是在 main方法 中使用 join 方法，所以是对 main 线程有效果，其他线程中没效果，除非是在其他线程中也执行了 join 方法。</p>
<p><strong>拓展一下</strong></p>
<p>这里我想使用 join 方法完成 奇数和偶数交替输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    t1 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(String.valueOf(i));</span><br><span class="line">                    t2.join();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t2 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(String.valueOf(i));</span><br><span class="line">                    t1.join();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码执行会出现死锁现象，原因是 t1 在等 t2，t2 在等 t1 ，因此发生了死锁</p>
<h3 id="4-3-interrupt、interrupted、isInterrupted"><a href="#4-3-interrupt、interrupted、isInterrupted" class="headerlink" title="4.3 interrupt、interrupted、isInterrupted"></a>4.3 interrupt、interrupted、isInterrupted</h3><ul>
<li>interrupt：打断线程</li>
<li>interrupted：判断线程是否被打断，会清除标记，方法为 static</li>
<li>isInterrupted：判断线程是否被打断吗，不会清除标记</li>
</ul>
<h4 id="4-3-1-打断-wait、sleep、join-的线程"><a href="#4-3-1-打断-wait、sleep、join-的线程" class="headerlink" title="4.3.1 打断 wait、sleep、join 的线程"></a>4.3.1 打断 wait、sleep、join 的线程</h4><p>这几个方法会是线程进入阻塞状态，打断 sleep 状态会清空打断标记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">BreakSleep</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    TimeUtil.sleep(<span class="number">1</span>);	<span class="comment">// 休眠1秒是因为 t1 是异步执行的，所以要防止main线程执行完t1线程还没启动</span></span><br><span class="line">    t1.interrupt();</span><br><span class="line">    log.debug(<span class="string">&quot;打断状态：&#123;&#125;&quot;</span>, t1.isInterrupted());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014210027944.png" alt="image-20231014210027944"></p>
<h4 id="4-3-2-打断正常运行的线程"><a href="#4-3-2-打断正常运行的线程" class="headerlink" title="4.3.2 打断正常运行的线程"></a>4.3.2 打断正常运行的线程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">BreakNormalThread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> current.isInterrupted();</span><br><span class="line">            <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;(isInterrupted) 打断状态：&#123;&#125;&quot;</span>, interrupted);</span><br><span class="line">                log.debug(<span class="string">&quot;(interrupted) 打断状态：&#123;&#125;&quot;</span>, Thread.interrupted());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    TimeUtil.sleep(<span class="number">1</span>);  <span class="comment">// 休眠1秒是因为 t1 是异步执行的，所以要防止main线程执行完t1线程还没启动</span></span><br><span class="line">    t2.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014212128297.png" alt="image-20231014212128297">  </p>
<h4 id="4-3-3-两阶段终止模式"><a href="#4-3-3-两阶段终止模式" class="headerlink" title="4.3.3 两阶段终止模式"></a>4.3.3 两阶段终止模式</h4><p><strong>为什么需要这个模式?</strong></p>
<p>程序发生异常被迫停止，在停止之前我们需要记录一下最后的日志，此时以下两种方式就不适用：</p>
<ul>
<li>stop()方法，此方法会发生死锁的情况。它会真正的杀死线程，但是如果这个时候线程锁住了共享资源，就会导致共享资源一直被锁着，其他线程永远无法获取到共享资源。</li>
<li>System.exit(0)，此方法会将整个程序直接停掉</li>
</ul>
<p>所以我们需要使用 <code>interrupt打断线程</code> 的方式来实现</p>
<p><strong>如何实现?</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231017165425417.png" alt="image-20231017165425417"> </p>
<p>上图描述的是此模式的具体流程，可以看到我们是在料理后事之后才结束的循环，符合我们的要求</p>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 两阶段终止模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTwoPhaseTermination</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">TwoPhaseTermination</span> <span class="variable">twoPhaseTermination</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TwoPhaseTermination</span>();</span><br><span class="line">        twoPhaseTermination.start();</span><br><span class="line"></span><br><span class="line">        TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">        twoPhaseTermination.stop();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;TwoPhaseTermination&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread monitor;     <span class="comment">// 监控线程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span> (currentThread.isInterrupted()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;料理后事...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;监控中...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    currentThread.interrupt();      <span class="comment">// 重新设置打印标记</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231017172812590.png" alt="image-20231017172812590"> </p>
<p>可以看到结果是和我们设想的一样.😁</p>
<h4 id="4-3-4-打断pack线程"><a href="#4-3-4-打断pack线程" class="headerlink" title="4.3.4 打断pack线程"></a>4.3.4 打断pack线程</h4><ul>
<li>打断 park 线程, 不会清空打断状态</li>
<li>如果打断标记已经是true，park会失效。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 打断 park 线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;BreakParkThread&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BreakParkThread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// test();</span></span><br><span class="line">        test2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">                LockSupport.park();     <span class="comment">// 多次循环没有重置标记，park 失效</span></span><br><span class="line">                log.debug(<span class="string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4-4-sleep-与-yield"><a href="#4-4-sleep-与-yield" class="headerlink" title="4.4  sleep 与 yield"></a>4.4  sleep 与 yield</h3><p><strong>sleep</strong></p>
<ol>
<li>调用 sleep 会让当前线程从 <em>Running</em> 进入 <em>Timed Waiting</em> 状态（阻塞）</li>
<li>其它线程可以使用 interrupt 方法打断正在睡眠的线程，这时 sleep 方法会抛出 InterruptedException</li>
<li>睡眠结束后的线程未必会立刻得到执行</li>
<li>建议用 TimeUnit 的 sleep 代替 Thread 的 sleep 来获得更好的可读性</li>
</ol>
<p><strong>yield</strong></p>
<ol>
<li>调用 yield 会让当前线程从 <em>Running</em> 进入 <em>Runnable</em> 就绪状态，然后调度执行其它线程</li>
<li>具体的实现依赖于操作系统的任务调度器</li>
</ol>
<p>这里我们做一个实验，使用 yield 来让奇数和偶数交替输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testYield</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;t1 输出：&#123;&#125;&quot;</span>, i);</span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;t2 输出：&#123;&#125;&quot;</span>, i);</span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231014212953242.png" alt="image-20231014212953242"> </p>
<p>结果显示，它们并没有按顺序交替输出，也就是说 yield 虽然让出了 CPU时间片，&#x3D;&#x3D;但是任务调度器下一次还是有可能选中它&#x3D;&#x3D;</p>
<h3 id="4-5-线程优先级"><a href="#4-5-线程优先级" class="headerlink" title="4.5 线程优先级"></a>4.5 线程优先级</h3><ul>
<li>线程优先级会提示（hint）调度器优先调度该线程，但它仅仅是一个提示，&#x3D;&#x3D;调度器可以忽略它&#x3D;&#x3D;</li>
<li>如果 cpu 比较忙，那么优先级高的线程会获得更多的时间片，但 cpu 闲时，优先级几乎没作用</li>
</ul>
<h2 id="5、同步模式-两阶段终止模式"><a href="#5、同步模式-两阶段终止模式" class="headerlink" title="5、同步模式-两阶段终止模式"></a>5、同步模式-两阶段终止模式</h2><p>它和直接停掉程序不同，它只会关闭当前线程并且可以料理后事再进行停止。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 两阶段终止模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTwoPhaseTermination</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">TwoPhaseTermination</span> <span class="variable">twoPhaseTermination</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TwoPhaseTermination</span>();</span><br><span class="line">        twoPhaseTermination.start();</span><br><span class="line"></span><br><span class="line">        TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">        twoPhaseTermination.stop();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;TwoPhaseTermination&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread monitor;     <span class="comment">// 监控线程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span> (currentThread.isInterrupted()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;料理后事...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;监控中...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    currentThread.interrupt();      <span class="comment">// 重新设置打印标记</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="6、不推荐方法"><a href="#6、不推荐方法" class="headerlink" title="6、不推荐方法"></a>6、不推荐方法</h2><p>这些方法已过时，容易破坏同步代码块，造成线程死锁</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th><strong>功能说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>stop()</td>
<td>停止线程运行</td>
</tr>
<tr>
<td>suspend()</td>
<td>挂起（暂停）线程运行</td>
</tr>
<tr>
<td>resume()</td>
<td>恢复线程运行</td>
</tr>
</tbody></table>
<h2 id="7、主线程与守护线程"><a href="#7、主线程与守护线程" class="headerlink" title="7、主线程与守护线程"></a>7、主线程与守护线程</h2><p>在 Java 中 Main 方法就是主线程，我们自己创建的线程为辅助线程或者工作线程，工作线程可以通过 <code>Thread#setDomain()</code> 方法设置成守护线程，&#x3D;&#x3D;当所有非守护线程停止，那么守护线程也会停止&#x3D;&#x3D;，即使还有任务未执行完毕。</p>
<ul>
<li>垃圾回收器线程就是一种守护线程</li>
<li>Tomcat 中的 Acceptor 和 Poller 线程都是守护线程，所以 Tomcat 接收到 shutdown 命令后，不会等待它们处理完当前请求</li>
</ul>
<p><strong>案例</strong>：创建两个线程，t2为守护线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SetDaemon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetDaemon</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t1 start...&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;线程 &#123;&#125; end...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t2 start...&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;线程 &#123;&#125; end...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        t2.start();</span><br><span class="line">        log.debug(<span class="string">&quot;线程 &#123;&#125; end...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231019203133328.png" alt="image-20231019203133328"> </p>
<p>从结果可以看出，t2 代码尚未执行结束就停止了。</p>
<h2 id="8、线程状态"><a href="#8、线程状态" class="headerlink" title="8、线程状态"></a>8、线程状态</h2><h3 id="8-1-五种状态"><a href="#8-1-五种状态" class="headerlink" title="8.1 五种状态"></a>8.1 五种状态</h3><p>从操作系统层面描述的五种线程状态</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231020185533975.png" alt="image-20231020185533975"> </p>
<ul>
<li><p>【初始状态】仅是在语言层面创建了线程对象，还未与操作系统线程关联</p>
</li>
<li><p>【可运行状态】（就绪状态）指该线程已经被创建（与操作系统线程关联），可以由 CPU 调度执行</p>
</li>
<li><p>【运行状态】指获取了 CPU 时间片运行中的状态</p>
<ul>
<li>当 CPU 时间片用完，会从【运行状态】转换至【可运行状态】，会导致线程的上下文切换</li>
</ul>
</li>
<li><p>【阻塞状态】</p>
<ul>
<li>如果调用了阻塞 API，如 BIO 读写文件，这时该线程实际不会用到 CPU，会导致线程上下文切换，进入【阻塞状态】</li>
<li>等 BIO 操作完毕，会由操作系统唤醒阻塞的线程，转换至【可运行状态】与【可运行状态】的区别是，对【阻塞状态】的线程来说只要它们一直不唤醒，调度器就一直不会考虑调度它们</li>
</ul>
</li>
<li><p>【终止状态】表示线程已经执行完毕，生命周期已经结束，不会再转换为其它状态</p>
</li>
</ul>
<h3 id="8-2-六种状态"><a href="#8-2-六种状态" class="headerlink" title="8.2 六种状态"></a>8.2 六种状态</h3><p>从 Java API 层面描述。根据 Thread.State 枚举，分为六种状态</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231020185709791.png" alt="image-20231020185709791"> </p>
<ul>
<li><code>NEW</code> 线程刚被创建，但是还没有调用 start() 方法</li>
<li><code>RUNNABLE</code> 当调用了 start() 方法之后，注意，<strong>Java API</strong> 层面的 RUNNABLE 状态涵盖了 <strong>操作系统</strong> 层面的【可运行状态】、【运行状态】和【阻塞状态】（由于 BIO 导致的线程阻塞，在 Java 里无法区分，仍然认为是可运行）</li>
<li><code>BLOCKED</code> ， <code>WAITING</code> ， <code>TIMED_WAITING</code> 都是 <strong>Java API</strong> 层面对【阻塞状态】的细分，后面会在状态转换一节详述</li>
<li><code>TERMINATED</code> 当线程代码运行结束</li>
</ul>
<p><strong>代码实现这六种状态</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ThreadState&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadState</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t1...&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t2.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ThreadState.class) &#123;</span><br><span class="line">                TimeUtil.sleep(<span class="number">10000000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t4.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ThreadState.class) &#123;</span><br><span class="line">                TimeUtil.sleep(<span class="number">10000000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t5.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;welcome...&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        t6.start();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;六种线程状态如下：&quot;</span>);</span><br><span class="line">        log.debug(String.valueOf(t1.getState()));</span><br><span class="line">        log.debug(String.valueOf(t2.getState()));</span><br><span class="line">        log.debug(String.valueOf(t3.getState()));</span><br><span class="line">        log.debug(String.valueOf(t4.getState()));</span><br><span class="line">        log.debug(String.valueOf(t5.getState()));</span><br><span class="line">        log.debug(String.valueOf(t6.getState()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231020191224408.png" alt="image-20231020191224408"> </p>
<h1 id="三、共享模型之管程"><a href="#三、共享模型之管程" class="headerlink" title="三、共享模型之管程"></a>三、共享模型之管程</h1><h2 id="1、共享带来的问题"><a href="#1、共享带来的问题" class="headerlink" title="1、共享带来的问题"></a>1、共享带来的问题</h2><h3 id="加减例子"><a href="#加减例子" class="headerlink" title="加减例子"></a>加减例子</h3><p>有两个线程：</p>
<ul>
<li>t1 线程对变量 count 进行 5000 次加加</li>
<li>t2 线程对变量 count 进行 5000 次减减</li>
</ul>
<p>预想的结果输出最后 count 为 0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Test01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                count--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.info(<span class="string">&quot;count=&#123;&#125;&quot;</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果显示：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231021171652736.png" alt="image-20231021171652736"> </p>
<p>这个结果和我们设想的不一样，这是因为两个线程增强共享资源导致的问题</p>
<h3 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h3><p>我们的 <code>i++</code> 和 <code>i--</code> 操作的 <code>JVM字节码指令</code> 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i++</span></span><br><span class="line">getstatic count <span class="comment">// 获取静态变量i的值</span></span><br><span class="line">iconst_1 	    <span class="comment">// 准备常量1</span></span><br><span class="line">iadd 		   <span class="comment">// 自增</span></span><br><span class="line">putstatic i 	<span class="comment">// 将修改后的值存入静态变量i</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i--</span></span><br><span class="line">getstatic count  <span class="comment">// 获取静态变量i的值</span></span><br><span class="line">iconst_1 		<span class="comment">// 准备常量1</span></span><br><span class="line">isub 			<span class="comment">// 自减</span></span><br><span class="line">putstatic count  <span class="comment">// 将修改后的值存入静态变量i</span></span><br></pre></td></tr></table></figure>

<p>可以看到指令有四条，所以加加减减操作并不是原子操作。</p>
<p>如果在单线程中执行 <code>i++</code> 和 <code>i--</code> 操作是没有问题的，他们会按照顺序依次往下执行。</p>
<p>但是在多线程中执行就会出现共享资源争抢的问题</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231021174418600.png" alt="image-20231021174418600"> </p>
<p>上图是两个线程的时序图，可以看到最后的结果是负数，这是因为执行的操作不是原子性的，导致在最后写回的时候强制切换，那么当再次切换回来的时候还是执行写入操作，而这个时候的共享资源 i 已经被另外一个线程重新赋值，所以当前线程提交就会覆盖之前的线程修改的值，也就会导致我们的结果出现问题。</p>
<p>因此最后的结果也可能会出现是正数的情况，和我们设想的结果依然不同。</p>
<h3 id="临界区-Critical-Section-和-竞态条件-Race-Condition"><a href="#临界区-Critical-Section-和-竞态条件-Race-Condition" class="headerlink" title="临界区 Critical Section 和 竞态条件 Race Condition"></a>临界区 Critical Section 和 竞态条件 Race Condition</h3><p><strong>临界区</strong></p>
<p>多个线程访问同一个共享变量时会发生指令交错，导致结果出现偏差。</p>
<p>一段代码内如果存在对共享资源访问的多线程读写操作，称这段代码快为临界区</p>
<p>举例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> </span><br><span class="line"><span class="comment">// 临界区</span></span><br><span class="line">&#123; </span><br><span class="line"> counter++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> </span><br><span class="line"><span class="comment">// 临界区</span></span><br><span class="line">&#123; </span><br><span class="line"> counter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>counter 是共享资源，多个线程对它进行读写操作，加加减减就是读写操作。</p>
<p><strong>竞态条件</strong></p>
<p>多个线程在临界区内执行，由于代码的<strong>执行序列不同</strong>而导致结果无法预测，称之为发生了<strong>竞态条件</strong></p>
<h2 id="2、synchronized解决方案"><a href="#2、synchronized解决方案" class="headerlink" title="2、synchronized解决方案"></a>2、synchronized解决方案</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>为了避免临界区的竞态条件发生，我们可以有以下方案：</p>
<ul>
<li>阻塞式的解决方案：<code>synchronized</code>、<code>Lock</code></li>
<li>非阻塞式的解决方案：原子变量</li>
</ul>
<p>本次我们使用 <code>synchronized</code> 解决上述问题，俗称的【对象锁】，它采用互斥的方式让同一时刻至多有一个线程持有【对象锁】，其他线程如果想要获取这个【对象锁】就要阻塞等待持有【对象锁】的线程释放锁，这样来保证拥有锁的线程可以完整执行完临界区的代码，不用担心线程上下文切换到出现的问题。</p>
<blockquote>
<p><strong>注意</strong></p>
<p>虽然 java 中互斥和同步都可以采用 synchronized 关键字来完成，但它们还是有区别的：</p>
<ul>
<li>互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码</li>
<li>同步是由于线程执行的先后、顺序不同、需要一个线程等待其它线程运行到某个点</li>
</ul>
</blockquote>
<p><strong>语法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(对象) <span class="comment">// 线程1， 线程2(blocked)</span></span><br><span class="line">&#123;</span><br><span class="line"> 临界区代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>接下来我们使用 <code>synchronized</code> 来解决之前的问题</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231021224648733.png" alt="image-20231021224648733"> </p>
<p>给临界区的代码都加上同步代码块，接下来我们看一下结果是不是我们预想的</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231021224725541.png" alt="image-20231021224725541"> </p>
<p>count &#x3D; 0，结果和我们设想的一样，nice~~~</p>
<h3 id="面向对象改进"><a href="#面向对象改进" class="headerlink" title="面向对象改进"></a>面向对象改进</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;test02&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Option</span> <span class="variable">option</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Option</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                option.increase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                option.decrease();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;count=&#123;&#125;&quot;</span>, option.getCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Option</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3、方法上的-synchronized"><a href="#3、方法上的-synchronized" class="headerlink" title="3、方法上的 synchronized"></a>3、方法上的 synchronized</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Test03.class) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到成员方法和静态方法锁住的对象是不同的：</p>
<p>成员方法：this</p>
<p>静态方法：类</p>
<p><strong>要注意这两者的区别，锁的东西不一样，那么获取的时候也要是这样东西才行</strong>。</p>
<h3 id="习题：“线程八锁”"><a href="#习题：“线程八锁”" class="headerlink" title="习题：“线程八锁”"></a>习题：“线程八锁”</h3><p>“线程八锁”是出题人起的名字</p>
<p><strong>情况1</strong>：12 或 21</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">    	log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line"> 		log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况2</strong>：1s后12，或 2 1s后 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">         sleep(<span class="number">1</span>);</span><br><span class="line">         log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">         log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">     <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">     <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">     <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况3</strong>：3 1s 12 或 23 1s 1 或 32 1s 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">c</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.c(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况4</strong>：2 1s 后 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">     sleep(<span class="number">1</span>);</span><br><span class="line">     log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">     log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况5</strong>：2 1s 后 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">     sleep(<span class="number">1</span>);</span><br><span class="line">     log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">     log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况6</strong>：1s 后12， 或 2 1s后 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况7</strong>：2 1s 后 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况8</strong>：1s 后12， 或 2 1s后 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Number&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="4、变量线程安全分析"><a href="#4、变量线程安全分析" class="headerlink" title="4、变量线程安全分析"></a>4、变量线程安全分析</h2><p><strong>局部变量线程安全分析</strong></p>
<ul>
<li>如果它们没有共享，则线程安全</li>
<li>如果它们被共享了，根据它们的状态是否能够改变，又分两种情况<ul>
<li>如果只有读操作，则线程安全</li>
<li>如果有读写操作，则这段代码是临界区，需要考虑线程安全</li>
</ul>
</li>
</ul>
<p><strong>局部变量线程安全分析</strong></p>
<ul>
<li><p>局部变量是线程安全的</p>
</li>
<li><p>但局部变量引用的对象则未必</p>
<ul>
<li><p>如果该对象没有逃离方法的作用访问，它是线程安全的</p>
<p>  比如在一个方法内使用的局部变量的值不是在方法内的，而是存在于外部，那么这个时候就会有线程安全问题</p>
</li>
<li><p>如果该对象逃离方法的作用范围，需要考虑线程安全</p>
</li>
</ul>
</li>
</ul>
<h3 id="局部变量线程安全分析"><a href="#局部变量线程安全分析" class="headerlink" title="局部变量线程安全分析"></a>局部变量线程安全分析</h3><h4 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个线程调用 test1 方法时，局部变量会在每个线程的栈帧内存中创建多份，因此不存在共享</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JVM 字节码文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">     flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">0</span></span><br><span class="line">        <span class="number">0</span>: bipush <span class="number">10</span></span><br><span class="line">        <span class="number">2</span>: istore_0</span><br><span class="line">        <span class="number">3</span>: iinc <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">        <span class="number">6</span>: <span class="keyword">return</span></span><br><span class="line">    LineNumberTable:</span><br><span class="line">        line <span class="number">10</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">11</span>: <span class="number">3</span></span><br><span class="line">        line <span class="number">12</span>: <span class="number">6</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">        Start Length Slot Name Signature</span><br><span class="line">        <span class="number">3</span> 	  <span class="number">4</span> 	 <span class="number">0</span> 	 i 	  I</span><br></pre></td></tr></table></figure>



<h4 id="引用数据类型"><a href="#引用数据类型" class="headerlink" title="引用数据类型"></a>引用数据类型</h4><p>它是局部变量但是它的引用是外部的，这就会造成线程安全</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_NUMBER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LOOP_NUMBER</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadUnsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadUnsafe</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; THREAD_NUMBER; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                unsafe.method01(LOOP_NUMBER);</span><br><span class="line">            &#125;, <span class="string">&quot;t&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadUnsafe</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method01</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            method02();</span><br><span class="line">            method03();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method02</span><span class="params">()</span> &#123;</span><br><span class="line">        list.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">()</span> &#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中就会出现 线程1 未 add，然后线程2 remove 掉了，就会报错</p>
<p>它们两个线程共用一个变量就会产生竞态条件从而产生安全问题。</p>
<p><strong>解决方式</strong>：</p>
<ol>
<li>给临界区的代码上锁</li>
<li>将 list 变成局部变量，这样每个线程都有一个独立的 list ，因此也不会产生临界区和竞态条件。</li>
</ol>
<h4 id="子类安全"><a href="#子类安全" class="headerlink" title="子类安全"></a>子类安全</h4><p>我们在之前的基础上将 <code>ThreadUnsafe类</code> 的 <code>private</code> 方法修改成 <code>public</code> ，然后创建一个它的子类，在子类中覆盖 <code>method2</code> 和 <code>method3</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadSafeSubClass</span> <span class="keyword">extends</span> <span class="title class_">ThreadUnsafe</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            list.remove(<span class="number">0</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 此时我们将  <code>ThreadUnsafe类</code> 的实现类换成它的子类。此时还是会产生安全问题。因为它在子类的方法中又创建了一个线程，如果此时我们没有加锁，那么还是会出现线程安全问题，所以如果我们不希望子类来继承破坏我们的方法我们可以使用 <code>private</code> 或者将类设为 <code>final类</code>，这样就可以保证我们子类的安全。</p>
<h3 id="常见线程安全类"><a href="#常见线程安全类" class="headerlink" title="常见线程安全类"></a>常见线程安全类</h3><ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector</li>
<li>Hashtable</li>
<li>java.util.concurrent 包下的类</li>
</ul>
<p>这里说它们是线程安全的是指，多个线程调用它们同一个实例的某个方法时，是线程安全的。</p>
<ul>
<li>单个方法是原子的</li>
<li>多个方法的组合就不是原子的</li>
</ul>
<h4 id="线程安全方法的组合"><a href="#线程安全方法的组合" class="headerlink" title="线程安全方法的组合"></a>线程安全方法的组合</h4><p>分析下面代码是否线程安全？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (map.get(<span class="string">&quot;key&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023152731635.png" alt="image-20231023152731635"> </p>
<p>它是线程不安全的，单独的方法是原子的，但是他们的组合不是。</p>
<h4 id="不可变类线程安全性"><a href="#不可变类线程安全性" class="headerlink" title="不可变类线程安全性"></a>不可变类线程安全性</h4><p>String、Integer 等都是不可变类，因为其内部的状态不可以改变，因此它们的方法都是线程安全的</p>
<p>String 有 replace，substring 等方法【可以】改变值啊，那么这些方法又是如何保证线程安全的呢？</p>
<p>这是因为 String 它会重新生成一个 String 对象进行返回，所以它是线程安全的</p>
<h2 id="5、习题"><a href="#5、习题" class="headerlink" title="5、习题"></a>5、习题</h2><h3 id="卖票"><a href="#卖票" class="headerlink" title="卖票"></a>卖票</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 卖票</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Ticket&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExerciseSell</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">TicketWindow</span> <span class="variable">window</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketWindow</span>(<span class="number">2000</span>);</span><br><span class="line">        List&lt;Thread&gt; threads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; sellCount = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> window.sell(randomCount());</span><br><span class="line">                sellCount.add(count);</span><br><span class="line">            &#125;);</span><br><span class="line">            threads.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;售出票：&#123;&#125;&quot;</span>, sellCount.stream().mapToInt(i -&gt; i).sum());</span><br><span class="line">        log.debug(<span class="string">&quot;余票：&#123;&#125;&quot;</span>, window.getCount());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">randomCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">5</span>) + <span class="number">1</span>;   <span class="comment">// 生成1-5</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TicketWindow</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> count;      <span class="comment">// 总票数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TicketWindow</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购票</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount    票数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>          购买的票数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sell</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.count &gt;= amount) &#123;  <span class="comment">// 如果有票</span></span><br><span class="line">            <span class="built_in">this</span>.count -= amount;</span><br><span class="line">            <span class="keyword">return</span> amount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023154718421.png" alt="image-20231023154718421"> </p>
<p>结果显示错误，这是因为我们没有加锁的原因。此时的临界区是在 <code>sell</code> 方法处，所以我们可以对它加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">sell</span><span class="params">(<span class="type">int</span> amount)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.count &gt;= amount) &#123;  <span class="comment">// 如果有票</span></span><br><span class="line">        <span class="built_in">this</span>.count -= amount;</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就没问题了</p>
<h3 id="转账"><a href="#转账" class="headerlink" title="转账"></a>转账</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 转账</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;TransferMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExerciseTransfer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Account</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>(<span class="number">2000</span>);</span><br><span class="line">        <span class="type">Account</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>(<span class="number">2000</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                a.transfer(b, randomAmount());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                b.transfer(a, randomAmount());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;转账前后总金额：&#123;&#125;&quot;</span>, a.getMoney() + b.getMoney());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Random 为线程安全</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="comment">// 随机 1~100</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">randomAmount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> money;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Account</span><span class="params">(<span class="type">int</span> money)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMoney</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMoney</span><span class="params">(<span class="type">int</span> money)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target    转账账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money     金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Account target, <span class="type">int</span> money)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.money &gt;= money) &#123;</span><br><span class="line">            <span class="built_in">this</span>.setMoney(<span class="built_in">this</span>.getMoney() - money);</span><br><span class="line">            target.setMoney(target.getMoney() + money);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023155730725.png" alt="image-20231023155730725"> </p>
<p>这钱怎么会越来越多呢，所以我们需要给临界区的代码上锁，防止线程不安全的现象发生</p>
<p>我们从代码中可以看出来临界区还是 <code>Account#transfer</code> 方法，所以我们给这个方法解锁可以吗？</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023160100532.png" alt="image-20231023160100532"> </p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023160109203.png" alt="image-20231023160109203"> </p>
<p>结果显示还是不对，这是为什么？</p>
<p><strong>分析</strong>：</p>
<p>在方法上加 synchronized 锁住的是 this 对象，但是在方法中我们还有另外一个 Account 对象，也就是说这两外一个对象没有锁住所以导致问题的发生。</p>
<p><strong>解决方法</strong>：</p>
<p>我们锁住的不能只是 this，Account 对象也要锁住，他们两个都是 Account 类，所以锁住 Account.class 才是正解</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023160436720.png" alt="image-20231023160436720"> </p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023160442212.png" alt="image-20231023160442212"> </p>
<p>结果显示是正确的，nice~~~</p>
<h2 id="6、Monitor"><a href="#6、Monitor" class="headerlink" title="6、Monitor"></a>6、Monitor</h2><h3 id="Java对象头"><a href="#Java对象头" class="headerlink" title="Java对象头"></a>Java对象头</h3><p>以32位虚拟机为例</p>
<p><strong>普通对象</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023203904118.png" alt="image-20231023203904118"> </p>
<p><strong>数组对象</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023203913752.png" alt="image-20231023203913752"> </p>
<p><strong>说明</strong>：</p>
<ul>
<li>Mark Word（标记字）：主要用来表示对象的线程锁状态，另外还可以用来配合GC、存放该对象的hashCode；</li>
<li>Klass Word：是一个指向方法区中Class信息的指针，意味着该对象可随时知道自己是哪个Class的实例；</li>
<li>还有一些在这里不列举….</li>
<li>对象还有对象体和对齐字节，这里我们不展开</li>
</ul>
<p>其中 MarkWord 结果为</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023203932565.png" alt="image-20231023203932565"> </p>
<p>64 位虚拟机 MarkWord</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023203947925.png" alt="image-20231023203947925"> </p>
<p><strong>注意</strong>：不是整个表表示一个 <code>Mark word</code>，这是例举了会出现的 <code>Mark Word</code>，没一行都是代表不同的状态</p>
<p>可以看到表中有五种状态：</p>
<ol>
<li>Normal 是正常状态，就是没上锁的状态</li>
<li>Biased 是偏向锁</li>
<li>Lightweight Locked 是轻量级锁</li>
<li>Heavyweight Locked 是重量级锁</li>
<li>GC标记</li>
</ol>
<p>对应不同的状态会有不同的功能，下面我们就对中间四种状态进行讲解</p>
<h3 id="原理之-Monitor（锁）"><a href="#原理之-Monitor（锁）" class="headerlink" title="原理之 Monitor（锁）"></a>原理之 Monitor（锁）</h3><p>Monitor 翻译成 监视器或管程</p>
<p>每个Java 对象都可以关联一个 Monitor 对象，如果使用 <code>synchronized</code> 给对象上锁（重量级锁）之后，该对象的 <code>Mrak Word</code> 中就会被设置指向 Monitor 对象的指针</p>
<p><strong>注意</strong>：</p>
<ul>
<li>没有使用 <code>synchronized</code> 是不会关联 Monitor 对象的</li>
<li>只有 <code>synchronized</code> 锁住的同一个对象才能被 Monitor 进行管理</li>
</ul>
<p> Monitor 结构如下：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023210615351.png" alt="image-20231023210615351">  </p>
<p><strong>说明</strong>：</p>
<ul>
<li>每个对象都可以关联一个 <code>Monitor</code></li>
<li><code>Monitor</code> 中的 <code>Owner</code> 刚开始是为 null 的</li>
<li>当 Thread-2 执行 <code>synchronized(obj)</code> 就会将 <code>Owner</code> 设置为 <code>Thread-2</code> ，Monitor 只有一个 Owner</li>
<li>当 Owner 不为 null，此时后面来的线程就要进入到 EntryList 中阻塞等待 Owner 再次为空</li>
<li>当 Thread-2 执行完 synchronized 中的代码时，就会唤醒 EntryList 中的线程进行竞争，竞争的时是非公平的</li>
<li>图中的 Thread-0 和 Thread-1 是之前获过锁的，但条件不满足所以进入 WAITING 状态的线程，后面讲到 wait-notify 会分析</li>
</ul>
<h3 id="原理之-synchronized"><a href="#原理之-synchronized" class="headerlink" title="原理之 synchronized"></a>原理之 synchronized</h3><p>我们可以从字节码层面来看一下 <code>synchronized</code> 做了什么操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test06</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac Test06.java		<span class="comment">// 编译</span></span><br><span class="line">javap -c Test06.class 	<span class="comment">// 查看字节码文件</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">com</span>.xiaozhi.sharedmodel03.Test06 &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> java.lang.Object lock;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> com.xiaozhi.sharedmodel03.Test06();</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: getstatic     #<span class="number">2</span>                  <span class="comment">// &lt;- lock引用 （synchronized开始）</span></span><br><span class="line">       <span class="number">3</span>: dup</span><br><span class="line">       <span class="number">4</span>: astore_1						  <span class="comment">// lock引用 -&gt;  slot 1</span></span><br><span class="line">       <span class="number">5</span>: monitorenter					  <span class="comment">// 将 lock 对象 Mark Word 置为Monitor指针，这个是由c去做的</span></span><br><span class="line">       <span class="number">6</span>: getstatic     #<span class="number">3</span>                  <span class="comment">// &lt;- i</span></span><br><span class="line">       <span class="number">9</span>: iconst_1						  <span class="comment">// 准备常数1</span></span><br><span class="line">      <span class="number">10</span>: iadd							  <span class="comment">// +1</span></span><br><span class="line">      <span class="number">11</span>: putstatic     #<span class="number">3</span>                  <span class="comment">// -&gt; i</span></span><br><span class="line">      <span class="number">14</span>: aload_1						  <span class="comment">// &lt;- lock引用 </span></span><br><span class="line">      <span class="number">15</span>: monitorexit					  <span class="comment">// 将 lock 对象 Mark Word 重置，唤醒 EntryList</span></span><br><span class="line">      <span class="number">16</span>: <span class="keyword">goto</span>          <span class="number">24</span></span><br><span class="line">      <span class="number">19</span>: astore_2						  <span class="comment">// e -&gt; slot 2</span></span><br><span class="line">      <span class="number">20</span>: aload_1						  <span class="comment">// &lt;- lock引用</span></span><br><span class="line">      <span class="number">21</span>: monitorexit					  <span class="comment">// 将 lock对象 MarkWord 重置, 唤醒 EntryList</span></span><br><span class="line">      <span class="number">22</span>: aload_2						  <span class="comment">//  &lt;- slot 2 (e)</span></span><br><span class="line">      <span class="number">23</span>: athrow						  <span class="comment">// throw e</span></span><br><span class="line">      <span class="number">24</span>: <span class="keyword">return</span></span><br><span class="line">    Exception table:					   <span class="comment">// 异常表：6 - 16 行的位置如果发生错误就跳到 19 行执行</span></span><br><span class="line">       from    to  target type			    <span class="comment">// 19 行开始是释放锁的操作，所以发生异常之后也还是会释放锁的</span></span><br><span class="line">           <span class="number">6</span>    <span class="number">16</span>    <span class="number">19</span>   any</span><br><span class="line">          <span class="number">19</span>    <span class="number">22</span>    <span class="number">19</span>   any</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">4</span>                  <span class="comment">// class java/lang/Object</span></span><br><span class="line">       <span class="number">3</span>: dup</span><br><span class="line">       <span class="number">4</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">7</span>: putstatic     #<span class="number">2</span>                  <span class="comment">// Field lock:Ljava/lang/Object;</span></span><br><span class="line">      <span class="number">10</span>: iconst_0</span><br><span class="line">      <span class="number">11</span>: putstatic     #<span class="number">3</span>                  <span class="comment">// Field count:I</span></span><br><span class="line">      <span class="number">14</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="原理之-synchronized进阶"><a href="#原理之-synchronized进阶" class="headerlink" title="原理之 synchronized进阶"></a>原理之 synchronized进阶</h3><h4 id="小故事"><a href="#小故事" class="headerlink" title="小故事"></a>小故事</h4><p>故事角色</p>
<ul>
<li>老王 - JVM</li>
<li>小南 - 线程</li>
<li>小女 - 线程</li>
<li>房间 - 对象</li>
<li>房间门上 - 防盗锁 - Monitor</li>
<li>房间门上 - 小南书包 - 轻量级锁</li>
<li>房间门上 - 刻上小南大名 - 偏向锁</li>
<li>批量重刻名 - 一个类的偏向锁撤销到达 20 阈值</li>
<li>不能刻名字 - 批量撤销该类对象的偏向锁，设置该类不可偏向</li>
</ul>
<p>小南要使用房间保证计算不被其它人干扰（原子性），最初，他用的是防盗锁，当上下文切换时，锁住门。这样，</p>
<p>即使他离开了，别人也进不了门，他的工作就是安全的。</p>
<p>但是，很多情况下没人跟他来竞争房间的使用权。小女是要用房间，但使用的时间上是错开的，小南白天用，小女</p>
<p>晚上用。每次上锁太麻烦了，有没有更简单的办法呢？</p>
<p>小南和小女商量了一下，约定不锁门了，而是谁用房间，谁把自己的书包挂在门口，但他们的书包样式都一样，因</p>
<p>此每次进门前得翻翻书包，看课本是谁的，如果是自己的，那么就可以进门，这样省的上锁解锁了。万一书包不是</p>
<p>自己的，那么就在门外等，并通知对方下次用锁门的方式。</p>
<p>后来，小女回老家了，很长一段时间都不会用这个房间。小南每次还是挂书包，翻书包，虽然比锁门省事了，但仍</p>
<p>然觉得麻烦。</p>
<p>于是，小南干脆在门上刻上了自己的名字：【小南专属房间，其它人勿用】，下次来用房间时，只要名字还在，那</p>
<p>么说明没人打扰，还是可以安全地使用房间。如果这期间有其它人要用这个房间，那么由使用者将小南刻的名字擦</p>
<p>掉，升级为挂书包的方式。</p>
<p>同学们都放假回老家了，小南就膨胀了，在 20 个房间刻上了自己的名字，想进哪个进哪个。后来他自己放假回老</p>
<p>家了，这时小女回来了（她也要用这些房间），结果就是得一个个地擦掉小南刻的名字，升级为挂书包的方式。老</p>
<p>王觉得这成本有点高，提出了一种批量重刻名的方法，他让小女不用挂书包了，可以直接在门上刻上自己的名字</p>
<p>后来，刻名的现象越来越频繁，老王受不了了：算了，这些房间都不能刻名了，只能挂书包</p>
<h4 id="1-轻量级锁"><a href="#1-轻量级锁" class="headerlink" title="1.轻量级锁"></a>1.轻量级锁</h4><p>轻量级锁的使用场景：如果一个对象虽然有多个线程访问，但是每个线程不访问的时间不重叠（也就是没有竞争），那么可以使用轻量锁来优化</p>
<p>在Java中，轻量锁对于使用者是透明的，它会自动变成轻量锁，它的语法依然是 <code>synchronized</code></p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">        <span class="comment">// 同步块</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">        <span class="comment">// 同步块B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加锁的执行流程如下：</p>
<p>1.创建锁记录（Lock Record）对象，每个线程的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的<code>Mark Word</code></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024160329889.png" alt="image-20231024160329889"> </p>
<p>2.接着让锁记录中 <code>Object reference</code> 指向锁对象，并尝试用 cas 替换 Object 的 <code>Mark Word</code>，将 <code>Mark Word</code> 的值存入 Lock Record中，将 <code>lock recode 地址 00</code> 存入到 Ojbect 中，完成一个替换</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024160708393.png" alt="image-20231024160708393"> </p>
<p>3.cas 替换会有成功和失败两种情况</p>
<p>cas 替换成功，对象头存储了 <code>锁记录地址和状态 00</code>，表示由该线程给对象加上了 轻量级锁，这时图表示如下：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024160947324.png" alt="image-20231024160947324"> </p>
<p>cas 替换失败，有两种情况：</p>
<ul>
<li><p>其他线程拥有该对象的轻量级锁，这时表明有竞争，进入锁膨胀过程</p>
</li>
<li><p>自己执行了 synchronized 锁重入，那么再添加一条 Lock Record 作为重入的计数</p>
<p>  <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024161237023.png" alt="image-20231024161237023"></p>
</li>
</ul>
<p>4.当退出 synchronized 代码块时（解锁时）如果有取值为 null 的锁记录，表示是重入的，这时重置锁记录，表示重入计数减一</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024160947324.png" alt="image-20231024160947324"> </p>
<p>5.当退出 synchronized 代码快（解锁时）所记录的值不为 null，这时使用 cas 将 Mark Word 的值恢复给对象头</p>
<ul>
<li>成功，则解锁成功</li>
<li>失败，说明轻量级锁进行了锁膨胀升级为了重量级锁，进入重量级锁的解锁流程</li>
</ul>
<h4 id="2-锁膨胀"><a href="#2-锁膨胀" class="headerlink" title="2.锁膨胀"></a>2.锁膨胀</h4><p>如果在尝试加轻量锁的过程中，cas 操作无法成功，这时一种情况就是其他线程参入竞争想要给对象加上轻量级锁，这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">        <span class="comment">// 同步块</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 Thread-1 进行轻量级加锁时，Thread-0 已经给该对象加上了轻量级锁</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024162017989.png" alt="image-20231024162017989"> </p>
<p>此时 Thread-1 加轻量级锁失败，进入锁膨胀流程</p>
<ul>
<li>既为对象申请 Monitor 锁，让 Object 指向重量级锁地址</li>
<li>然后自己进入 Monitor 的 EntryList 进行 BLOCKED</li>
</ul>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024162449107.png" alt="image-20231024162449107"> </p>
<p>当 Thread-0 退出同步代码块解锁时，使用 cas 将 Mark Word 的值回复给对象头，失败。这时会进入重量级锁流程，就是按照 Monitor 地址找到 Monitor 对象，设置 Owner 为 null，唤醒 EntryList 中 BLOCKED 的线程</p>
<h4 id="3-自旋优化"><a href="#3-自旋优化" class="headerlink" title="3.自旋优化"></a>3.自旋优化</h4><p>重量级锁竞争的时候，还可以使用自旋来进行优化，自旋就是循环获取锁，获取到就不需要唤醒直接上位。如果当前线程自旋成功（即这时候持锁的县城已经退出了同步块，释放了锁），这时当前线程就可以避免阻塞。如果自旋失败那么就会进入阻塞状态。</p>
<p><strong>注意</strong>：</p>
<ul>
<li>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势</li>
<li>Java6 之后自旋是自适应的，比如对象刚刚的依次自旋操作成功过，那么认为这次自旋成功的可能性就会高，就会多自旋几次；反之，就会少自旋或者干脆不自旋，比较智能化</li>
<li>Java7 之后不能控制是否开启自旋功能</li>
</ul>
<p><strong>自选重试成功的情况</strong>：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024172433301.png" alt="image-20231024172433301"> </p>
<p><strong>自旋重试失败的情况</strong>：<br><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024172449039.png" alt="image-20231024172449039"> </p>
<h4 id="4-偏向锁"><a href="#4-偏向锁" class="headerlink" title="4.偏向锁"></a>4.偏向锁</h4><h5 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h5><p>轻量锁在没有竞争时（就自己这个线程），每次重入任需要执行 CAS 操作</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024161237023.png" alt="image-20231024161237023"> </p>
<p>上图是重入一次的 CAS 操作，这样的操作比较耗资源，所以要进行优化。</p>
<p>Java6 中引入了偏向所来做进一步优化：</p>
<p>只有线程第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现如果还是这个线程 ID，不用重新 CAS。以后只要不发生竞争，那么这个对象就归该线程所有。</p>
<p><strong>下面是一个优化的例子：轻量锁 -&gt; 偏向锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 A</span></span><br><span class="line">        m2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 B</span></span><br><span class="line">        m3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 C</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024173257250.png" alt="image-20231024173257250"> </p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024173304671.png" alt="image-20231024173304671"> </p>
<h5 id="偏向状态"><a href="#偏向状态" class="headerlink" title="偏向状态"></a>偏向状态</h5><p>回忆一下对象头格式</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024173417288.png" alt="image-20231024173417288"> </p>
<p>一个对象创建时：</p>
<ul>
<li>如果开启了偏向锁（默认开启），那么创建对象后，Mark Word 值为 0x05，即最后三位为 101 ，此时它的 thraed、epoch、age 都为 0</li>
<li>偏向锁默认是延时的，不会在程序启动的时立即生效，我们可以使用 <code>sleep方法</code> 来等待它加载，也可以加 VM参数 <code>-XX:BiasedLockingStartupDelay=0</code> 来禁用延迟</li>
<li>如果没有开启偏向锁，那么对象创建后，Mark Word 值为 0x01 即最后三位为 001，此时它的hashcode、age都为0，第一次使用 hashcode 时才会赋值</li>
</ul>
<p><strong>测试偏向锁</strong></p>
<p>这里使用第三方工具 jol 来查看对象头信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jol<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jol-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10-TEST<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加虚拟机参数 -XX:BiasedLockingStartupDelay=0 </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">    <span class="type">ClassLayout</span> <span class="variable">classLayout</span> <span class="operator">=</span> ClassLayout.parseInstance(d);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;synchronized 前&quot;</span>);</span><br><span class="line">        System.out.println(classLayout.toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">        	log.debug(<span class="string">&quot;synchronized 中&quot;</span>);</span><br><span class="line">        	System.out.println(classLayout.toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">    	&#125;</span><br><span class="line">        log.debug(<span class="string">&quot;synchronized 后&quot;</span>);</span><br><span class="line">    	System.out.println(classLayout.toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:08:<span class="number">58.117</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 前</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000101</span> </span><br><span class="line"><span class="number">11</span>:08:<span class="number">58.121</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 中</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">11101011</span> <span class="number">11010000</span> <span class="number">00000101</span> </span><br><span class="line"><span class="number">11</span>:08:<span class="number">58.121</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 后</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">11101011</span> <span class="number">11010000</span> <span class="number">00000101</span></span><br></pre></td></tr></table></figure>

<p>从结果可以看出来 默认是加的偏向锁</p>
<p><strong>测试禁用偏向锁</strong></p>
<p>在上面测试代码运行时在添加 VM 参数 -XX:-UseBiasedLocking 禁用偏向锁</p>
<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">13</span>:<span class="number">10.018</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 前</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000001</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">13</span>:<span class="number">10.021</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 中</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00100000</span> <span class="number">00010100</span> <span class="number">11110011</span> <span class="number">10001000</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">13</span>:<span class="number">10.021</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 后</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000001</span></span><br></pre></td></tr></table></figure>

<p>禁用之后上锁加的是轻量级锁</p>
<h5 id="撤销偏向锁情况"><a href="#撤销偏向锁情况" class="headerlink" title="撤销偏向锁情况"></a>撤销偏向锁情况</h5><h6 id="1、对象调用-hashCode"><a href="#1、对象调用-hashCode" class="headerlink" title="1、对象调用 hashCode"></a>1、对象调用 hashCode</h6><p>调用了对象的 hashCode，但偏向锁的对象 MarkWord 中存储的是线程 id，如果调用 hashCode 会导致偏向锁被撤销</p>
<ul>
<li>轻量级锁会在锁记录中记录 hashCode</li>
<li>重量级锁会在 Monitor 中记录 hashCode</li>
</ul>
<p>结果输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">10.386</span> c.TestBiased [main] - 调用 hashCode:<span class="number">1778535015</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">10.391</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 前</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">01101010</span> <span class="number">00000010</span> <span class="number">01001010</span> <span class="number">01100111</span> <span class="number">00000001</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">10.393</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 中</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00100000</span> <span class="number">11000011</span> <span class="number">11110011</span> <span class="number">01101000</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">10.393</span> c.TestBiased [t1] - <span class="keyword">synchronized</span> 后</span><br><span class="line"><span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">01101010</span> <span class="number">00000010</span> <span class="number">01001010</span> <span class="number">01100111</span> <span class="number">00000001</span></span><br></pre></td></tr></table></figure>

<p>结果可以看出来，当对象调用 hashCode ，就会导致偏向锁被撤销</p>
<h6 id="2、其它线程使用对象"><a href="#2、其它线程使用对象" class="headerlink" title="2、其它线程使用对象"></a>2、其它线程使用对象</h6><p>当有其它线程使用偏向锁对象时，<strong>会将偏向锁升级为轻量级锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">            log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (TestBiased.class) &#123;</span><br><span class="line">            TestBiased.class.notify();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不用 wait/notify 使用 join 必须打开下面的注释</span></span><br><span class="line">        <span class="comment">// 因为：t1 线程不能结束，否则底层线程可能被 jvm 重用作为 t2 线程，底层线程 id 是一样的</span></span><br><span class="line">         <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">            System.in.read();</span></span><br><span class="line"><span class="comment">         &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="comment">         e.printStackTrace();</span></span><br><span class="line"><span class="comment">         &#125;*/</span></span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (TestBiased.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TestBiased.class.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">            log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">01000001</span> <span class="number">00010000</span> <span class="number">00000101</span> </span><br><span class="line">[t2] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">01000001</span> <span class="number">00010000</span> <span class="number">00000101</span> </span><br><span class="line">[t2] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">10110101</span> <span class="number">11110000</span> <span class="number">01000000</span> </span><br><span class="line">[t2] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000001</span></span><br></pre></td></tr></table></figure>



<h6 id="3、调用-wait-notify"><a href="#3、调用-wait-notify" class="headerlink" title="3、调用 wait&#x2F;notify"></a>3、调用 wait&#x2F;notify</h6><p>它会让偏向锁变成重量级锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">            log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                d.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;notify&quot;</span>);</span><br><span class="line">            d.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000101</span> </span><br><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011111</span> <span class="number">10110011</span> <span class="number">11111000</span> <span class="number">00000101</span> </span><br><span class="line">[t2] - notify </span><br><span class="line">[t1] - <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00011100</span> <span class="number">11010100</span> <span class="number">00001101</span> <span class="number">11001010</span></span><br></pre></td></tr></table></figure>



<h5 id="批量重偏向"><a href="#批量重偏向" class="headerlink" title="批量重偏向"></a>批量重偏向</h5><p>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程 t1 的对象任有机会重新偏向 t2，重偏向会重置对象的 Thread ID</p>
<p>当撤销偏向锁阈值超过 20 次后，JVM会觉得是否是偏向错了，于是会给这些对象加锁时重新偏向至加锁线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    Vector&lt;Dog&gt; list = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">            list.add(d);</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            list.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                list.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;===============&gt; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">[t1] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t1] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - ===============&gt; </span><br><span class="line">[t2] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 0 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 1 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 1 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 2 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 2 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 3 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 3 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 4 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 4 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 5 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 5 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 6 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 6 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 7 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 7 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 8 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 9 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 9 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 10 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 10 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 11 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 11 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 12 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 12 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 13 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 13 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 14 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 14 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 15 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 15 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 16 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 16 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 17 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 17 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 18 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 </span><br><span class="line">[t2] - 18 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 </span><br><span class="line">[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 </span><br><span class="line">[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 </span><br><span class="line">[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101</span><br></pre></td></tr></table></figure>

<p>从结果我们可以看出来在 t2 线程从 19 开始之后就是处于偏向锁的状态，没有变成轻量级锁，所以 JVM 它重新偏向了 t2 </p>
<h5 id="批量撤销"><a href="#批量撤销" class="headerlink" title="批量撤销"></a>批量撤销</h5><p>当撤销偏向锁阈值超过 40 次后，JVM就会觉得自己偏向错了。于是就会将整个类的所有对象都设置成不可偏向，新建的对象也是不可偏向</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Thread t1,t2,t3;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    Vector&lt;Dog&gt; list = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">loopNumber</span> <span class="operator">=</span> <span class="number">39</span>;</span><br><span class="line">    t1 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">            list.add(d);</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LockSupport.unpark(t2);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;===============&gt; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        LockSupport.unpark(t3);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t3 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;===============&gt; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">d</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            <span class="keyword">synchronized</span> (d) &#123;</span><br><span class="line">                log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(i + <span class="string">&quot;\t&quot;</span> + ClassLayout.parseInstance(d).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t3&quot;</span>);</span><br><span class="line">    t3.start();</span><br><span class="line">    t3.join();</span><br><span class="line">    log.debug(ClassLayout.parseInstance(<span class="keyword">new</span> <span class="title class_">Dog</span>()).toPrintableSimple(<span class="literal">true</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-锁消除"><a href="#5-锁消除" class="headerlink" title="5.锁消除"></a>5.锁消除</h4><p>下面一段代码来测试上锁和没上锁的性能差别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Fork(1)</span></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.AverageTime)</span></span><br><span class="line"><span class="meta">@Warmup(iterations=3)</span></span><br><span class="line"><span class="meta">@Measurement(iterations=5)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBenchmark</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        x++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">            x++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打成 Jar 包</p>
<p>java -jar benchmarks.jar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Benchmark			Mode 	Samples 	Score 	Score error 	Units </span><br><span class="line">c.i.MyBenchmark.a 	 avgt 	 <span class="number">5</span> 			 <span class="number">1.542</span> 		  <span class="number">0.056</span> 	 ns/op </span><br><span class="line">c.i.MyBenchmark.b 	 avgt 	 <span class="number">5</span> 			 <span class="number">1.518</span> 		  <span class="number">0.091</span> 	 ns/op</span><br></pre></td></tr></table></figure>

<p>结果显示性能基本相近，这是因为 JVM 默认会进行锁消除</p>
<p>JVM 有一个 JIT 编译器，它会将热点代码进行优化，在我们的代码中 b方法 锁住的对象是局部变量，它不会被共享，也就没有安全问题，所以 JIT 编译器就会将这段代码优化直接将锁去掉，所以我们看到的结果性能几乎一样</p>
<p><code>-XX:-EliminateLocks</code> 参数是取消锁消除优化</p>
<p>java -XX:-EliminateLocks -jar benchmarks.jar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Benchmark 			Mode 	Samples Score Score error Units </span><br><span class="line">c.i.MyBenchmark.a 	 avgt 		<span class="number">5</span> 	<span class="number">1.507</span> 		<span class="number">0.108</span> ns/op </span><br><span class="line">c.i.MyBenchmark.b 	 avgt 		<span class="number">5</span> 	<span class="number">16.976</span> 		<span class="number">1.572</span> ns/op</span><br></pre></td></tr></table></figure>

<p>这次我们没有取消锁，可以看到结果相差还是很大的。这也就证明了锁消除的好处。</p>
<h2 id="7、wait-和-notify"><a href="#7、wait-和-notify" class="headerlink" title="7、wait 和 notify"></a>7、wait 和 notify</h2><h3 id="小故事-为什么需要wait"><a href="#小故事-为什么需要wait" class="headerlink" title="小故事 - 为什么需要wait"></a>小故事 - 为什么需要wait</h3><p>由于条件不满足，小南不能继续进行计算</p>
<p>但小南如果一直占用着锁，其它人就得一直阻塞，效率太低</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024233447429.png" alt="image-20231024233447429"> </p>
<p>于是老王单开了一间休息室（调用 wait 方法），让小南到休息室（WaitSet）等着去了，但这时锁释放开，</p>
<p>其它人可以由老王随机安排进屋</p>
<p>直到小M将烟送来，大叫一声 [ 你的烟到了 ] （调用 notify 方法）</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024233500102.png" alt="image-20231024233500102"> </p>
<p>小南于是可以离开休息室，重新进入竞争锁的队列</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024233509519.png" alt="image-20231024233509519"> </p>
<h3 id="API-介绍"><a href="#API-介绍" class="headerlink" title="API 介绍"></a>API 介绍</h3><table>
<thead>
<tr>
<th>方法名</th>
<th>static</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>wait()</td>
<td></td>
<td>让进入 object 监视器的线程到 waitSet 等待</td>
</tr>
<tr>
<td>wait(long n)</td>
<td></td>
<td>有限时间的等待，n毫秒结束等待，或者被 notify 唤醒</td>
</tr>
<tr>
<td>notify()</td>
<td></td>
<td>在 object 上正在 waitSet 等待的线程中挑一个唤醒</td>
</tr>
<tr>
<td>notifyAll()</td>
<td></td>
<td>让 object 上正在 waitSet 等待的线程全部唤醒</td>
</tr>
</tbody></table>
<p>它们都是线程之间进行协作的手段，都属于 Object 对象的方法。必须获得此对象的锁，才能调用这几个方法</p>
<p>也就是说单独使用不行的，必须和 synchronized 一起使用才可以，不然会报错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalMonitorStateException</span><br></pre></td></tr></table></figure>

<p>下面做一个案例体会一下三个方法的用处</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;TestWaitAndNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestWaitAndNotify</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;执行...&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;其他代码...&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;执行...&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;其他代码...&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            lock.notify();          <span class="comment">// 随机唤醒一个线程</span></span><br><span class="line">            <span class="comment">// lock.notifyAll();    // 唤醒全部线程</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">42</span>:<span class="number">47.220</span> [t1] DEBUG TestWaitAndNotify - 执行...</span><br><span class="line"><span class="number">23</span>:<span class="number">42</span>:<span class="number">47.220</span> [t2] DEBUG TestWaitAndNotify - 执行...</span><br><span class="line"><span class="number">23</span>:<span class="number">42</span>:<span class="number">48.221</span> [t1] DEBUG TestWaitAndNotify - 其他代码...</span><br></pre></td></tr></table></figure>

<p>可以看到 t2 线程没有被唤醒</p>
<p>我们使用 <code>Object#notify</code> 方法看一下如何</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231024234439125.png" alt="image-20231024234439125"> </p>
<h3 id="wati-notify-的正确使用姿势"><a href="#wati-notify-的正确使用姿势" class="headerlink" title="wati &#x2F; notify 的正确使用姿势"></a>wati &#x2F; notify 的正确使用姿势</h3><h4 id="sleep-n-和-wait-n-的区别"><a href="#sleep-n-和-wait-n-的区别" class="headerlink" title="sleep(n) 和 wait(n) 的区别"></a>sleep(n) 和 wait(n) 的区别</h4><ol>
<li>sleep 是 Thread 方法，wait 是 Object 的方法</li>
<li>sleep 不需要强制和 synchronized 配合使用，但是wait 需要</li>
<li>sleep 在睡眠的同时，不会释放对象锁，但 wait 等待的时候释放对象锁</li>
<li>他们的状态都是 TIME_WAITING</li>
<li></li>
</ol>
<h4 id="案例：体会一下两者的区别"><a href="#案例：体会一下两者的区别" class="headerlink" title="案例：体会一下两者的区别"></a><strong>案例</strong>：体会一下两者的区别</h4><h5 id="setp1：sleepd等待"><a href="#setp1：sleepd等待" class="headerlink" title="setp1：sleepd等待"></a>setp1：sleepd等待</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SleepAndWaitTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepAndWaitTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;没烟，先歇会！&quot;</span>);</span><br><span class="line">                    TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;可以开始干活了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;小南&quot;</span>).start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;其他人可以干活了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;其他人&quot;</span>).start();</span><br><span class="line">        &#125;</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            hasCigarette = <span class="literal">true</span>;</span><br><span class="line">            log.debug(<span class="string">&quot;烟到了噢！&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;送烟的&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">42.344</span> [小南] DEBUG SleepAndWaitTest - 有烟没？[<span class="literal">false</span>]</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">42.349</span> [小南] DEBUG SleepAndWaitTest - 没烟，先歇会！</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">43.358</span> [送烟的] DEBUG SleepAndWaitTest - 烟到了噢！</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.355</span> [小南] DEBUG SleepAndWaitTest - 有烟没？[<span class="literal">true</span>]</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.355</span> [小南] DEBUG SleepAndWaitTest - 可以开始干活了</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.355</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.355</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.355</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.356</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">23</span>:<span class="number">55</span>:<span class="number">44.356</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：</p>
<ul>
<li>其他干活的线程，要等小南执行完才能执行，一直阻塞，效率太低</li>
<li>小南要休眠 2 秒，烟提前到了也无法立刻醒来，效率低</li>
<li>加了 synchronized(room) 后，就好比小南在里面反锁了门睡觉，烟根本没法送进门</li>
</ul>
<p><strong>解决方案</strong>：使用 wait - notify 机制</p>
<h5 id="setp2：wait-notify-机制"><a href="#setp2：wait-notify-机制" class="headerlink" title="setp2：wait - notify 机制"></a>setp2：wait - notify 机制</h5><p>将 sleep 替换成 wait ，然后在送烟线程中唤醒它</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SleepAndWaitTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepAndWaitTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;没烟，先歇会！&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;可以开始干活了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;小南&quot;</span>).start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;其他人可以干活了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;其他人&quot;</span>).start();</span><br><span class="line">        &#125;</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            hasCigarette = <span class="literal">true</span>;</span><br><span class="line">            log.debug(<span class="string">&quot;烟到了噢！&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                room.notify();   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;送烟的&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.324</span> [小南] DEBUG SleepAndWaitTest - 有烟没？[<span class="literal">false</span>]</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.331</span> [小南] DEBUG SleepAndWaitTest - 没烟，先歇会！</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.331</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.331</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.331</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.331</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">30.331</span> [其他人] DEBUG SleepAndWaitTest - 其他人可以干活了</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">31.329</span> [送烟的] DEBUG SleepAndWaitTest - 烟到了噢！</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">31.329</span> [小南] DEBUG SleepAndWaitTest - 有烟没？[<span class="literal">true</span>]</span><br><span class="line"><span class="number">00</span>:<span class="number">05</span>:<span class="number">31.329</span> [小南] DEBUG SleepAndWaitTest - 可以开始干活了</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：解决了其它干活的线程阻塞的问题，但如果有其它线程也在等待条件呢？</p>
<h5 id="setp3：notifyAll"><a href="#setp3：notifyAll" class="headerlink" title="setp3：notifyAll()"></a>setp3：notifyAll()</h5><p>我们继续添加一个送外卖的线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SleepAndWaitTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepAndWaitTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;没烟，先歇会！&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;可以开始干活了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;小南&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;有外卖没？[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;没外卖，先歇会！&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;有外卖没？[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;可以开始送外卖了...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;小女&quot;</span>).start();</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                hasTakeout = <span class="literal">true</span>;</span><br><span class="line">                log.debug(<span class="string">&quot;外卖到了&quot;</span>);</span><br><span class="line">                room.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;送外卖的&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">12.054</span> [小南] DEBUG SleepAndWaitTest - 有烟没？[<span class="literal">false</span>]</span><br><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">12.058</span> [小南] DEBUG SleepAndWaitTest - 没烟，先歇会！</span><br><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">12.058</span> [小女] DEBUG SleepAndWaitTest - 有外卖没？[<span class="literal">false</span>]</span><br><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">12.058</span> [小女] DEBUG SleepAndWaitTest - 没外卖，先歇会！</span><br><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">13.059</span> [送外卖的] DEBUG SleepAndWaitTest - 外卖到了</span><br><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">13.059</span> [小女] DEBUG SleepAndWaitTest - 有外卖没？[<span class="literal">true</span>]</span><br><span class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">13.059</span> [小南] DEBUG SleepAndWaitTest - 有烟没？[<span class="literal">false</span>]</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：</p>
<ul>
<li>notifyAll 唤醒全部线程</li>
<li>可以看到线程中的 if 中只有一次判断，一旦条件不成立，就没有重新判断的机会了</li>
</ul>
<h5 id="setp4：解决虚假等待"><a href="#setp4：解决虚假等待" class="headerlink" title="setp4：解决虚假等待"></a>setp4：解决虚假等待</h5><p>解决只有一次机会的问题，使用 while 来解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;没烟，先歇会！&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        room.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line"><span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;可以开始干活了&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上述代码进行修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!hasCigarette) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;没烟，先歇会！&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        room.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;有烟没？[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">log.debug(<span class="string">&quot;可以开始干活了&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这样我们就能确保它有多次机会</p>
<p><strong>小总结</strong>：</p>
<p>下面这是一套模式，它可以确保执行指定条件下的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(lcok) &#123;</span><br><span class="line">	<span class="keyword">while</span> (条件不成立) &#123;</span><br><span class="line">		lock.wati();</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 干活</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另外一个线程</span></span><br><span class="line"><span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">    lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="原理之wati-notify"><a href="#原理之wati-notify" class="headerlink" title="原理之wati &#x2F; notify"></a>原理之wati &#x2F; notify</h3><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231023210615351.png" alt="image-20231023210615351"> </p>
<ul>
<li>Owner 线程发现条件不满足，调用 wait 方法，即可进入 WaitSet 变为 WAITING 状态</li>
<li>BLOCKED 和 WAITING 的线程都处于阻塞状态，不占用 CPU 时间片</li>
<li>BLOCKED 线程会在 Owner 线程释放锁时唤醒</li>
<li>WAITING 线程会在 Owner 线程调用 notify 或 notifyAll 时唤醒，但唤醒后并不意味着立刻获得锁，仍需进入 EntryList 重新竞争</li>
</ul>
<h3 id="同步模式之保护性暂停"><a href="#同步模式之保护性暂停" class="headerlink" title="同步模式之保护性暂停"></a>同步模式之保护性暂停</h3><h4 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h4><p>即 Guarded Suspension，用在一个线程等待另一个线程的执行结果</p>
<p><strong>要点</strong>：</p>
<ul>
<li>如果有一个结果需要从一个线程传递给另一个线程，可以让他们关联一个 <code>GuardedObject</code> 对象</li>
<li>如果有结果不断从一个线程到另一个线程，那么可以使用消息队列（见生产者消费者章节）</li>
<li>JDK中，join 的实现，Future 的实现，采用的就是此模式</li>
<li>此模式是一个线程等待另外一个线程，所以归类为同步模式</li>
</ul>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231025134058284.png" alt="image-20231025134058284"> </p>
<ol>
<li>t1 循环等待 t2 赋值</li>
<li>t2 给 response 赋值之后唤醒 t1</li>
<li>t1 获取到值</li>
</ol>
<h4 id="2-实现"><a href="#2-实现" class="headerlink" title="2. 实现"></a>2. 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    	<span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">             <span class="comment">// 不满足条件需要等待</span></span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            <span class="built_in">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ProtectivePause&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProtectivePause</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">res</span> <span class="operator">=</span> go.get();</span><br><span class="line">            log.debug(<span class="string">&quot;结果：&#123;&#125;&quot;</span>, res);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">            go.complete(<span class="string">&quot;我是个靓仔&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;结果已传递...&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果显示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">30</span>:<span class="number">37.070</span> [t2] DEBUG ProtectivePause - start...</span><br><span class="line"><span class="number">13</span>:<span class="number">30</span>:<span class="number">37.070</span> [t1] DEBUG ProtectivePause - start...</span><br><span class="line"><span class="number">13</span>:<span class="number">30</span>:<span class="number">37.074</span> [t2] DEBUG ProtectivePause - 结果已传递...</span><br><span class="line"><span class="number">13</span>:<span class="number">30</span>:<span class="number">37.074</span> [t1] DEBUG ProtectivePause - 结果：我是个靓仔</span><br></pre></td></tr></table></figure>



<h4 id="3-超时版-GuardedObject"><a href="#3-超时版-GuardedObject" class="headerlink" title="3. 超时版 GuardedObject"></a>3. 超时版 GuardedObject</h4><p>不让 t1 一直等待，我们给它设定一个时间，超过这个时间我们就不等待了</p>
<p>方法改造：complete 方法不变，get 方法发生变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 已经经历时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timePassed</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 不满足条件需要等待</span></span><br><span class="line">        <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 剩余等待的时间 = 总共等待时间 - 已经经历时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> timeout - timePassed;</span><br><span class="line">            <span class="comment">// 如果剩余等待时间为 0 则退出循环</span></span><br><span class="line">            <span class="keyword">if</span> (waitTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;退出循环...&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 只需要等待剩余的等待时间即可</span></span><br><span class="line">                <span class="built_in">this</span>.wait(waitTime);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 已经经历时间</span></span><br><span class="line">            timePassed = System.currentTimeMillis() -  begin;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>：我们让 t1 等待 2000ms，t2睡眠 3 秒，查看结果如何</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">res</span> <span class="operator">=</span> go.get(<span class="number">2000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;结果：&#123;&#125;&quot;</span>, res);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">        go.complete(<span class="string">&quot;我是个靓仔&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;结果已传递...&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">54</span>:<span class="number">29.144</span> [t1] DEBUG ProtectivePause - start...</span><br><span class="line"><span class="number">13</span>:<span class="number">54</span>:<span class="number">29.144</span> [t2] DEBUG ProtectivePause - start...</span><br><span class="line"><span class="number">13</span>:<span class="number">54</span>:<span class="number">31.168</span> [t1] DEBUG GuardedObject - 退出循环...</span><br><span class="line"><span class="number">13</span>:<span class="number">54</span>:<span class="number">31.168</span> [t1] DEBUG ProtectivePause - 结果：<span class="literal">null</span></span><br><span class="line"><span class="number">13</span>:<span class="number">54</span>:<span class="number">32.165</span> [t2] DEBUG ProtectivePause - 结果已传递...</span><br></pre></td></tr></table></figure>

<p>结果显示我们提前结束了等待，获取结果为 null</p>
<h4 id="4-原理之join"><a href="#4-原理之join" class="headerlink" title="4. 原理之join()"></a>4. 原理之join()</h4><p>join() 是 Thread 的方法，我们去 Thread 类中查看它的实现，join() 实现的原理其实就是 保护性暂停模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    join(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>join() 里面调用的是 join(long n) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">(<span class="type">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 获取开始时间</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 已经经历的时间</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 参数校验</span></span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;timeout value is negative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 如果等待时间为0</span></span><br><span class="line">    <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 循环判断线程是否存活，如果存活就执行等待方法</span></span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;	<span class="comment">// 不为0</span></span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            <span class="comment">// 获取剩余等待的时间 = 总等待时间 - 已经经历的等待时间</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> millis - now;</span><br><span class="line">            <span class="comment">// 小于 0 就退出等待</span></span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 等待剩余等待时间</span></span><br><span class="line">            wait(delay);</span><br><span class="line">            <span class="comment">// 经历的时间 = 当前时间 - 开始时间</span></span><br><span class="line">            now = System.currentTimeMillis() - base;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有一个 join(long, int) 方法，这个方法它的第二个参数是 纳秒，但是它的具体实现是不会精确到纳秒的，也是毫秒级</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nanos &gt;= <span class="number">500000</span> || (nanos != <span class="number">0</span> &amp;&amp; millis == <span class="number">0</span>)) &#123;</span><br><span class="line">    millis++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到它如果是大于 500000 就加一毫秒</p>
<h4 id="5-多任务版-GuardedObject"><a href="#5-多任务版-GuardedObject" class="headerlink" title="5. 多任务版 GuardedObject"></a>5. 多任务版 GuardedObject</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231025152753105.png" alt="image-20231025152753105"> </p>
<p>图中 Futures 中有多个 GuardedObject ，每个 GuardedObject 都有对应的 id，这是为了让 线程能够和对应的 GuardedObject 进行绑定，多个GuardedObject 来完成多任务</p>
<p><strong>案例</strong>：模拟邮递员送邮件</p>
<p>Furures 就相当于是我们的邮箱，t4、t5、t6 就是我们的邮递员，将信放入到我们的邮箱中，然后由 t1、t2、t3 获取信件</p>
<p>由于我们的 GuradedObject 对象做参数传递不方便，所以我们使用一个中间类来进行解耦，解耦出 【结果等待者】和【结果生产者】，还能同时支持多个任务的管理</p>
<p><strong>具体实现</strong>：</p>
<p><strong>给 GuradedObject 对象新增 id、构造器和get方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GuradedObject </span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">GuardedObject</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>构造中间类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MailBoxes</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, GuardedObject&gt; BOXES = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取唯一id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">generateId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过 ID 获取 GO</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">getGuardedObject</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BOXES.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">createGO</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>(generateId());</span><br><span class="line">        BOXES.put(go.getId(), go);</span><br><span class="line">        <span class="keyword">return</span> go;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Integer&gt; <span class="title function_">getIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BOXES.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>业务类构建</strong>：People 和 Postman 类，一个接受邮件，一个送邮件的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;People&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> MailBoxes.createGO();</span><br><span class="line">        log.debug(<span class="string">&quot;开始收信 id:&#123;&#125;&quot;</span>, go.getId());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">mail</span> <span class="operator">=</span> go.get(<span class="number">5000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;收到信 id：&#123;&#125;，内容；&#123;&#125;&quot;</span>, go.getId(), mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Postman&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Postman</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object mail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Postman</span><span class="params">(<span class="type">int</span> id, Object mail)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.mail = mail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> MailBoxes.getGuardedObject(<span class="built_in">this</span>.id);</span><br><span class="line">        log.debug(<span class="string">&quot;送信 id:&#123;&#125;, 内容:&#123;&#125;&quot;</span>, id, mail);</span><br><span class="line">        go.complete(mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FuturesTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">People</span>().start();</span><br><span class="line">        &#125;</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (Integer id : MailBoxes.getIds()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Postman</span>(id, <span class="string">&quot;内容：&quot;</span> + id).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结果输出</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">16:02:09.243 [Thread-2] DEBUG People - 开始收信 id:3</span><br><span class="line">16:02:09.243 [Thread-0] DEBUG People - 开始收信 id:1</span><br><span class="line">16:02:09.243 [Thread-1] DEBUG People - 开始收信 id:2</span><br><span class="line">16:02:10.250 [Thread-3] DEBUG Postman - 送信 id:3, 内容:内容：3</span><br><span class="line">16:02:10.250 [Thread-4] DEBUG Postman - 送信 id:2, 内容:内容：2</span><br><span class="line">16:02:10.250 [Thread-5] DEBUG Postman - 送信 id:1, 内容:内容：1</span><br><span class="line">16:02:10.250 [Thread-1] DEBUG People - 收到信 id：2，内容；内容：2</span><br><span class="line">16:02:10.250 [Thread-0] DEBUG People - 收到信 id：1，内容；内容：1</span><br><span class="line">16:02:10.250 [Thread-2] DEBUG People - 收到信 id：3，内容；内容：3</span><br></pre></td></tr></table></figure>

<p>完美~~~</p>
<h3 id="异步模式之生产者消费者"><a href="#异步模式之生产者消费者" class="headerlink" title="异步模式之生产者消费者"></a>异步模式之生产者消费者</h3><h4 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231025170344602.png" alt="image-20231025170344602"> </p>
<p><strong>要点</strong>：</p>
<ul>
<li>与前面的 保护性暂停的 GuradedObject 不同，它不需要生产者和消费者一一对应</li>
<li>消费队列可以用来平衡生产和消费的线程资源</li>
<li>生产者负责产生结果数据，不关心消息如何被处理，而消费者专心处理数据</li>
<li>消息队列是有容量的，因为资源是有限的，必须限制它的大小，不然就会导致内存满了服务被停止</li>
<li>JDK 各种阻塞队列，采用的就是这种模式</li>
</ul>
<h4 id="2-实现-1"><a href="#2-实现-1" class="headerlink" title="2.实现"></a>2.实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;MessageQueue&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageQueue</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;Message&gt; LIST = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LIST) &#123;</span><br><span class="line">            <span class="comment">// 如果队列为空，那么就等待</span></span><br><span class="line">            <span class="keyword">while</span> (LIST.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;队列为空，等待中...&quot;</span>);</span><br><span class="line">                    LIST.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> LIST.removeFirst();</span><br><span class="line">            LIST.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LIST) &#123;</span><br><span class="line">            <span class="comment">// 队列的长度达到设置的阈值，等待被消费</span></span><br><span class="line">            <span class="keyword">while</span> (LIST.size() &gt;= <span class="built_in">this</span>.capacity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;队列已满，等待中...&quot;</span>);</span><br><span class="line">                    LIST.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            LIST.push(message);</span><br><span class="line">            LIST.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(<span class="type">int</span> id, Object content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Message&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, content=&quot;</span> + content +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-应用"><a href="#3-应用" class="headerlink" title="3.应用"></a>3.应用</h4><p>创建三个生产者线程，然后创建一个消费者线程进行消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ProducesAndConsumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducesAndConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">messageQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(id, <span class="string">&quot;我是靓仔：&quot;</span> + id);</span><br><span class="line">                messageQueue.put(message);</span><br><span class="line">                log.debug(<span class="string">&quot;生产一条消息&quot;</span>);</span><br><span class="line">            &#125;, <span class="string">&quot;生产者&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> messageQueue.take();</span><br><span class="line">                log.debug(<span class="string">&quot;消费内容：&#123;&#125;&quot;</span>, msg.getContent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;消费者&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.720</span> [消费者] DEBUG MessageQueue - 队列为空，等待中...</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.723</span> [生产者<span class="number">1</span>] DEBUG ProducesAndConsumer - 生产一条消息</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.723</span> [生产者<span class="number">2</span>] DEBUG ProducesAndConsumer - 生产一条消息</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.723</span> [生产者<span class="number">0</span>] DEBUG MessageQueue - 队列已满，等待中...</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.723</span> [生产者<span class="number">0</span>] DEBUG ProducesAndConsumer - 生产一条消息</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.723</span> [消费者] DEBUG ProducesAndConsumer - 消费内容：我是靓仔：<span class="number">2</span></span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.726</span> [消费者] DEBUG ProducesAndConsumer - 消费内容：我是靓仔：<span class="number">1</span></span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.726</span> [消费者] DEBUG ProducesAndConsumer - 消费内容：我是靓仔：<span class="number">0</span></span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">56.726</span> [消费者] DEBUG MessageQueue - 队列为空，等待中...</span><br></pre></td></tr></table></figure>

<p>可以看到生产者生产到第二条的时候就满了就停止生产，然后消费者消费之后它再继续生产，最后消费完成，队列为空</p>
<h2 id="8、park-unpark"><a href="#8、park-unpark" class="headerlink" title="8、park &amp; unpark"></a>8、park &amp; unpark</h2><h3 id="API介绍"><a href="#API介绍" class="headerlink" title="API介绍"></a>API介绍</h3><p>park &amp; unpark 是 LockSupport 类的方法</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>static</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>park</td>
<td>true</td>
<td>让当前线程暂停执行</td>
</tr>
<tr>
<td>unpark(thread)</td>
<td>true</td>
<td>恢复某个线程的执行</td>
</tr>
</tbody></table>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p><strong>先 park 再 unpark</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;继续执行...&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">17</span>:<span class="number">16.387</span> [t1] DEBUG ParkAndUnpark - start...</span><br><span class="line"><span class="number">22</span>:<span class="number">17</span>:<span class="number">18.391</span> [main] DEBUG ParkAndUnpark - unpark...</span><br><span class="line"><span class="number">22</span>:<span class="number">17</span>:<span class="number">18.391</span> [t1] DEBUG ParkAndUnpark - 继续执行...</span><br></pre></td></tr></table></figure>



<p><strong>先 unpark 再 park</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;继续执行...&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">18</span>:<span class="number">01.142</span> [t1] DEBUG ParkAndUnpark - start...</span><br><span class="line"><span class="number">22</span>:<span class="number">18</span>:<span class="number">02.151</span> [main] DEBUG ParkAndUnpark - unpark...</span><br><span class="line"><span class="number">22</span>:<span class="number">18</span>:<span class="number">03.151</span> [t1] DEBUG ParkAndUnpark - 继续执行...</span><br></pre></td></tr></table></figure>

<p>诶？这怎么 unpark 提前执行了 t1 还会继续执行呢？下面就会讲解它的原理。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>它和 Object 的 wait &amp; notify 有什么区别吗？</p>
<ul>
<li>wait &amp; notify 必须和 Monitor 一起使用，park &amp; unpark 不需要</li>
<li>park &amp; unpark 刚明确，它可以将指定对应的线程唤醒。而 wait &amp; notify 不行，要么唤醒一个，要么使用 notifyAll 唤醒全部线程，它没有 park &amp; unpark 那么明确</li>
<li>park &amp; unpark 可以先 unpark，wait &amp; notify 不可以先 notify，notify 必须在 wait 后面才有效</li>
</ul>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>每个线程都有一个 Parker 对象，由 _counter、_cond 和 _mutex 三部分组成</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231025223949109.png" alt="image-20231025223949109"> </p>
<ol>
<li>当前线程调用 park 方法</li>
<li>检查 _counter，此时它的值为0，获得 mutex 互斥锁</li>
<li>线程进入 _cond条件变量阻塞</li>
<li>设置 _counter&#x3D;0</li>
</ol>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231025224008637.png" alt="image-20231025224008637"> </p>
<ol>
<li>调用 Unsafe.unpark 方法，设置 _counter 为 1</li>
<li>唤醒 _cond 条件变量中的线程</li>
<li>线程恢复运行</li>
<li>设置 _counter 为 0</li>
</ol>
<p><strong>先 unpark 后 park 还是能执行这是为什么？</strong></p>
<ol>
<li>调用 Unsafe.unpark 方法，设置 _counter 为 1</li>
<li>调用 Unsafe.unpark 方法，检查 _counter ，此时值 为1</li>
<li>不进入阻塞状态，继续执行</li>
<li>设置 _counter 为 0</li>
</ol>
<h2 id="9、线程状态转换"><a href="#9、线程状态转换" class="headerlink" title="9、线程状态转换"></a>9、线程状态转换</h2><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231025224342151.png" alt="image-20231025224342151"> </p>
<p>假设有线程 t</p>
<h3 id="情况1：NEW-RUNABLE"><a href="#情况1：NEW-RUNABLE" class="headerlink" title="情况1：NEW -&gt; RUNABLE"></a>情况1：<code>NEW -&gt; RUNABLE</code></h3><p>当调用 start() 时，状态由 <code>NEW -&gt; RUNABLE</code></p>
<h3 id="情况2：RUNNABLE-WAITING"><a href="#情况2：RUNNABLE-WAITING" class="headerlink" title="情况2：RUNNABLE &lt;--&gt; WAITING"></a>情况2：<code>RUNNABLE &lt;--&gt; WAITING</code></h3><ol>
<li>wait &amp; notify</li>
<li>join</li>
<li>park &amp; unpark</li>
</ol>
<h3 id="情况3：RUNNABLE-TIMED-WAITING"><a href="#情况3：RUNNABLE-TIMED-WAITING" class="headerlink" title="情况3：RUNNABLE &lt;--&gt; TIMED_WAITING"></a>情况3：<code>RUNNABLE &lt;--&gt; TIMED_WAITING</code></h3><ol>
<li>wait(n) </li>
<li>join(long n) </li>
<li>sleep(long n)</li>
</ol>
<h3 id="情况4：RUNNABLE-BLOCKED"><a href="#情况4：RUNNABLE-BLOCKED" class="headerlink" title="情况4：RUNNABLE &lt;--&gt; BLOCKED"></a>情况4：<code>RUNNABLE &lt;--&gt; BLOCKED</code></h3><ul>
<li>多个线程获取对象锁，获得锁的线程从 <code>BLOCKED -&gt; RUNNABLE</code></li>
<li>其余竞争失败的线程：<code>RUNNABLE &lt;--&gt; BLOCKED</code></li>
</ul>
<h3 id="情况5：RUNNABLE-TERMINATED"><a href="#情况5：RUNNABLE-TERMINATED" class="headerlink" title="情况5：RUNNABLE &lt;--&gt; TERMINATED"></a>情况5：<code>RUNNABLE &lt;--&gt; TERMINATED</code></h3><p>线程执行完成就会从 <code>RUNNABLE &lt;--&gt; TERMINATED</code></p>
<h2 id="11、活跃性"><a href="#11、活跃性" class="headerlink" title="11、活跃性"></a>11、活跃性</h2><h3 id="多把锁"><a href="#多把锁" class="headerlink" title="多把锁"></a>多把锁</h3><p>不同业务的线程锁定同一个对象，那么如果多个线程同时执行，就会产生竞争，多个线程只能有一个可以运行，其他线程进入 BLOCKED 状态，那么对于本身没有业务冲突的多个线程我们可以将他们的锁对象分开，更细粒度化</p>
<p><strong>案例</strong>：现在有一个 Room 对象，里面有两个方法，一个是学习的一个是玩耍的，他们两个方法没有任何的业务交集</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test07</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Room</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Room</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(room::study, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(room::play, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;room&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Room</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">study</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始学习...&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;结束学习...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始玩耍...&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;结束玩耍...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">36</span>:<span class="number">06.700</span> [t1] DEBUG room - 开始学习...</span><br><span class="line"><span class="number">16</span>:<span class="number">36</span>:<span class="number">07.711</span> [t1] DEBUG room - 结束学习...</span><br><span class="line"><span class="number">16</span>:<span class="number">36</span>:<span class="number">07.711</span> [t2] DEBUG room - 开始玩耍...</span><br><span class="line"><span class="number">16</span>:<span class="number">36</span>:<span class="number">08.723</span> [t2] DEBUG room - 结束玩耍...</span><br></pre></td></tr></table></figure>

<p>可以看到学习之后才到玩耍，这是因为 t1 一开始获得了锁，后面才到 t2</p>
<p>这两个方法没有任何关联，所以我们应该给不同业务的方法上不同的锁对象</p>
<p>修改之前的代码：将 LOCK 换成 this</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;开始玩耍...&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;结束玩耍...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">39</span>:<span class="number">14.066</span> [t2] DEBUG room - 开始玩耍...</span><br><span class="line"><span class="number">16</span>:<span class="number">39</span>:<span class="number">14.066</span> [t1] DEBUG room - 开始学习...</span><br><span class="line"><span class="number">16</span>:<span class="number">39</span>:<span class="number">15.073</span> [t1] DEBUG room - 结束学习...</span><br><span class="line"><span class="number">16</span>:<span class="number">39</span>:<span class="number">15.073</span> [t2] DEBUG room - 结束玩耍...</span><br></pre></td></tr></table></figure>

<p>可以看到两个线程同时执行，它们两个没有竞争，细粒度化有利于程序的运行</p>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><h4 id="什么是死锁"><a href="#什么是死锁" class="headerlink" title="什么是死锁"></a>什么是死锁</h4><ul>
<li>t1 线程获取了 A对象锁，它现在要获取 B对象锁</li>
<li>t2 线程获取了 B对象锁，它现在要获取 A对象锁</li>
</ul>
<p>两个线程都在等待对方释放锁，因此就导致程序一直在等待，这 <strong>你等待我我等待你</strong> 的现象就是死锁</p>
<p><strong>案例</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;DeadLockTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLockTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">A</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">B</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;获取到A锁&quot;</span>);</span><br><span class="line">                TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;获取到B锁&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;获取到B锁&quot;</span>);</span><br><span class="line">                TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;获取到A锁&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026164644953.png" alt="image-20231026164644953"> </p>
<p>结果显示程序一直在等待</p>
<h4 id="定位死锁"><a href="#定位死锁" class="headerlink" title="定位死锁"></a>定位死锁</h4><p>出现死锁的情况我们应该怎么找哪里出现问题了呢？</p>
<ul>
<li>jconsole</li>
<li>jstack</li>
</ul>
<h5 id="jconsole"><a href="#jconsole" class="headerlink" title="jconsole"></a>jconsole</h5><ol>
<li><p>输出命令</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jconsole</span><br></pre></td></tr></table></figure>

<p> <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026165800779.png" alt="image-20231026165800779"> </p>
</li>
<li><p>连接到我们出现问题的程序</p>
<p> <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026165844480.png" alt="image-20231026165844480"> </p>
</li>
<li><p>找到 <code>线程</code> 菜单按钮，然后进入点开检查死锁</p>
<p> <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026170058188.png" alt="image-20231026170058188"> </p>
</li>
<li><p>检测出死锁后我们可以点击对应的线程查看线程状态，它里面也告诉了我们那里出现了问题</p>
</li>
</ol>
<h5 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h5><ol>
<li><p>使用 jps 查看 JVM 进程</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jps命令</span></span><br><span class="line"><span class="number">36596</span> Jps</span><br><span class="line"><span class="number">31656</span> RemoteMavenServer36</span><br><span class="line"><span class="number">8280</span> Launcher</span><br><span class="line"><span class="number">27340</span> DeadLockTest			<span class="comment">// 这是我们产生死锁的程序</span></span><br><span class="line"><span class="number">7420</span> </span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 jstack PID 查看进程的线程状态</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;t2&quot;</span> #<span class="number">13</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x000002c20a42a000</span> nid=<span class="number">0x2fd4</span> waiting <span class="keyword">for</span> monitor entry [<span class="number">0x000000dca25ff000</span>]</span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at com.xiaozhi.sharedmodel03.DeadLockTest.lambda$main$<span class="number">1</span>(DeadLockTest.java:<span class="number">33</span>)</span><br><span class="line">        - waiting to lock &lt;<span class="number">0x000000076bee01e0</span>&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;<span class="number">0x000000076bee01f0</span>&gt; (a java.lang.Object)</span><br><span class="line">        at com.xiaozhi.sharedmodel03.DeadLockTest$$Lambda$<span class="number">2</span>/<span class="number">1685538367.</span>run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;t1&quot;</span> #<span class="number">12</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x000002c20a550800</span> nid=<span class="number">0x8240</span> waiting <span class="keyword">for</span> monitor entry [<span class="number">0x000000dca24ff000</span>]</span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at com.xiaozhi.sharedmodel03.DeadLockTest.lambda$main$<span class="number">0</span>(DeadLockTest.java:<span class="number">24</span>)</span><br><span class="line">        - waiting to lock &lt;<span class="number">0x000000076bee01f0</span>&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;<span class="number">0x000000076bee01e0</span>&gt; (a java.lang.Object)</span><br><span class="line">        at com.xiaozhi.sharedmodel03.DeadLockTest$$Lambda$<span class="number">1</span>/<span class="number">186276003.</span>run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">其他内容......</span><br><span class="line"></span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line"><span class="string">&quot;t2&quot;</span>:</span><br><span class="line">  waiting to lock monitor <span class="number">0x000002c27fb69748</span> (object <span class="number">0x000000076bee01e0</span>, a java.lang.Object),</span><br><span class="line">  which is held by <span class="string">&quot;t1&quot;</span></span><br><span class="line">        - locked &lt;<span class="number">0x000000076bee01e0</span>&gt; (a java.lang.Object)</span><br><span class="line">        at com.xiaozhi.sharedmodel03.DeadLockTest$$Lambda$<span class="number">1</span>/<span class="number">186276003.</span>run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br><span class="line"></span><br><span class="line">Found <span class="number">1</span> deadlock.</span><br></pre></td></tr></table></figure></li>
</ol>
<p>在输出的信息最后我们看到检测出了死锁，可以看到出现死锁的是 t1 和 t2 线程导致的，在前面我们可以看到 t1 和 t2 线程的状态，它们出现了死锁，其中告诉了我们 t1 和 t2 线程出现死锁的代码在哪里，通过这个我们就可以找到对应的行然后进行修改</p>
<h4 id="案例：哲学家就餐问题"><a href="#案例：哲学家就餐问题" class="headerlink" title="案例：哲学家就餐问题"></a>案例：哲学家就餐问题</h4><p>有五个哲学家和五双筷子，每个哲学家需要一双筷子才能吃饭，最后每个哲学家都拥有一支筷子，然后他们都在等待别人放下筷子，因此就出现了死锁</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026170524512.png" alt="image-20231026170524512">、</p>
<p><strong>代码实现</strong></p>
<p>筷子类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;筷子&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>哲学家类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;哲学家&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Chopstick left;</span><br><span class="line">    <span class="keyword">private</span> Chopstick right;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 拿到左边筷子</span></span><br><span class="line">            <span class="keyword">synchronized</span> (left) &#123;</span><br><span class="line">                <span class="comment">// 拿到右边筷子</span></span><br><span class="line">                <span class="keyword">synchronized</span> (right) &#123;</span><br><span class="line">                    eat();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125; 吃上了饭&quot;</span>, <span class="built_in">this</span>.name);</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;苏格拉底&quot;</span>, c1, c2).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;柏拉图&quot;</span>, c2, c3).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;亚里士多德&quot;</span>, c3, c4).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;赫拉克利特&quot;</span>, c4, c5).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;阿基米德&quot;</span>, c5, c1).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果输出</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026171739839.png" alt="image-20231026171739839"> </p>
<p>可以看到执行几次后死锁了</p>
<p>使用 jconsole 检查死锁</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231026171911272.png" alt="image-20231026171911272"> </p>
<p>可以看到五个线程阻塞住了</p>
<h3 id="活锁"><a href="#活锁" class="headerlink" title="活锁"></a>活锁</h3><p>循环的程序需要停止执行就需要有结束条件，那么如果我线程之间一直改变对应线程的结束条件，那么这个程序就会一直执行不结束，这种修改结束条件导致程序无法结束的现象叫活锁</p>
<p>它和死锁不同，死锁它的线程状态是 BLOCKED，活锁的状态是 RUNNABLE</p>
<p><strong>解决方案</strong>：分时间段去执行</p>
<p><strong>案例</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LiveLockTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiveLockTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Integer</span> <span class="variable">COUNT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (COUNT &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            TimeUtil.sleep(<span class="number">0.2</span>);</span><br><span class="line">            COUNT--;</span><br><span class="line">            log.debug(<span class="string">&quot;当前 count=&#123;&#125;&quot;</span>, COUNT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">increase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (COUNT &lt;= <span class="number">20</span>) &#123;</span><br><span class="line">            TimeUtil.sleep(<span class="number">0.2</span>);</span><br><span class="line">            COUNT++;</span><br><span class="line">            log.debug(<span class="string">&quot;当前 count=&#123;&#125;&quot;</span>, COUNT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(LiveLockTest::decrease, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(LiveLockTest::increase, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个程序会不断的执行下去</p>
<h3 id="饥饿"><a href="#饥饿" class="headerlink" title="饥饿"></a>饥饿</h3><p>哲学家就餐问题导致的死锁我们可以按照顺序来加锁解决这个死锁的问题。</p>
<p>但是它会导致某些线程的执行次数很多，而其他线程执行的次数很少，这种现象就是饥饿（狂执行哈哈~~~）</p>
<p><strong>修改之前哲学家就餐获取筷子的顺序</strong></p>
<p>没修改的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;苏格拉底&quot;</span>, c1, c2).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;柏拉图&quot;</span>, c2, c3).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;亚里士多德&quot;</span>, c3, c4).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;赫拉克利特&quot;</span>, c4, c5).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;阿基米德&quot;</span>, c5, c1).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;阿基米德&quot;</span>, c1, c5).start();</span><br></pre></td></tr></table></figure>

<p>本次执行结果显示：</p>
<p>一开始都有执行，然后后面基本是 赫拉克利特 和 亚里士多德 在执行……</p>
<h2 id="12、ReentrantLock"><a href="#12、ReentrantLock" class="headerlink" title="12、ReentrantLock"></a>12、ReentrantLock</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p><strong>语法</strong></p>
<ul>
<li>ReentrantLock#lock()：获取锁，&#x3D;&#x3D;它不是将自己锁住了，而是获取执行的锁对象&#x3D;&#x3D;</li>
<li>ReentrantLock#unlock()：释放锁对象，给其他需要获取锁对象的线程使用</li>
</ul>
<p><strong>注意</strong>：每次上锁都要释放锁，不然线程会阻塞。可以在 try-finally 中 的 finally 块执行 unlock()</p>
<p><strong>特点</strong>：</p>
<ul>
<li>和 synchonized 一样可重入</li>
<li>可中断</li>
<li>可以设置 公平锁</li>
<li>可以 多个条件变量，synchonized  只能由一个条件变量</li>
</ul>
<h3 id="1-可重入"><a href="#1-可重入" class="headerlink" title="1.可重入"></a>1.可重入</h3><p>可以多次上锁不阻塞，如果线程持有锁可以再次加锁，这个就是可重入</p>
<p><strong>例子</strong>：一个线程多次上锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ReentrantTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;main 加锁&quot;</span>);</span><br><span class="line">            m1();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;m1 加锁&quot;</span>);</span><br><span class="line">            m2();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;m2 加锁&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">44</span>:<span class="number">00.545</span> [main] DEBUG ReentrantTest - main 加锁</span><br><span class="line"><span class="number">22</span>:<span class="number">44</span>:<span class="number">00.547</span> [main] DEBUG ReentrantTest - m1 加锁</span><br><span class="line"><span class="number">22</span>:<span class="number">44</span>:<span class="number">00.548</span> [main] DEBUG ReentrantTest - m2 加锁</span><br></pre></td></tr></table></figure>

<p>结果显示线程没有被阻塞</p>
<h3 id="2-可打断"><a href="#2-可打断" class="headerlink" title="2.可打断"></a>2.可打断</h3><p>ReentranLock#lockInterruptibly()：</p>
<ul>
<li>没有竞争，获取锁</li>
<li>有竞争，进入阻塞队列，可以被其他线程调用当前线程的 interrupt 方法打断</li>
</ul>
<p>这个方法的好处就是防止无休止的等待，可以直接去打断它来结束</p>
<p><strong>注意</strong>：lock不能被打断…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockInterruptiblyTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockInterruptiblyTest</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;启动...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.lockInterruptibly();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.debug(<span class="string">&quot;等锁的过程中被打断...&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;执行其他代码...&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        lock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;获取锁...&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="comment">// TimeUtil.sleep(0.5);</span></span><br><span class="line">        <span class="comment">// lock.unlock();</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">            t1.interrupt();</span><br><span class="line">            log.debug(<span class="string">&quot;执行打断...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">18.310</span> [main] DEBUG LockInterruptiblyTest - 获取锁...</span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">18.313</span> [t1] DEBUG LockInterruptiblyTest - 启动...</span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">19.323</span> [main] DEBUG LockInterruptiblyTest - 执行打断...</span><br><span class="line"><span class="number">23</span>:<span class="number">07</span>:<span class="number">19.323</span> [t1] DEBUG LockInterruptiblyTest - 等锁的过程中被打断...</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:<span class="number">900</span>)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:<span class="number">1225</span>)</span><br><span class="line">	at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:<span class="number">340</span>)</span><br><span class="line">	at com.xiaozhi.sharedmodel03.reentranlock.LockInterruptiblyTest.lambda$main$<span class="number">0</span>(LockInterruptiblyTest.java:<span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<p>从结果可以看出来被打断之后就会报错，我们打断后要给它释放锁</p>
<h3 id="3-锁超时"><a href="#3-锁超时" class="headerlink" title="3.锁超时"></a>3.锁超时</h3><h4 id="尝试获取锁"><a href="#尝试获取锁" class="headerlink" title="尝试获取锁"></a>尝试获取锁</h4><p>ReentranLock#tryLock</p>
<ul>
<li>tryLock()：尝试获取锁，成功返回 true，失败返回 false</li>
<li>tryLock(long, TimeUnit)：指定时间内循环获取锁，成功返回 true，失败返回 false</li>
</ul>
<p><strong>tryLock()案例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;TryLockTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TryLockTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;启动...&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!lock.tryLock()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;立刻获取失败...&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;获取了锁...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        lock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;获得了锁&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">25</span>:<span class="number">23.040</span> [main] DEBUG TryLockTest - 获得了锁</span><br><span class="line"><span class="number">23</span>:<span class="number">25</span>:<span class="number">23.043</span> [t1] DEBUG TryLockTest - 启动...</span><br><span class="line"><span class="number">23</span>:<span class="number">25</span>:<span class="number">23.043</span> [t1] DEBUG TryLockTest - 立刻获取失败...</span><br></pre></td></tr></table></figure>



<p><strong>tryLock(n, m)</strong></p>
<p>我们让它的等待时间比释放锁的线程更长</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改 Thread 内部执行的代码</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;启动...&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lock.tryLock(<span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;立刻获取失败...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;t1 获取了锁...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="string">&quot;t1&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>:<span class="number">29</span>:<span class="number">13.542</span> [main] DEBUG TryLockTest - main 获得了锁</span><br><span class="line"><span class="number">23</span>:<span class="number">29</span>:<span class="number">13.546</span> [t1] DEBUG TryLockTest - 启动...</span><br><span class="line"><span class="number">23</span>:<span class="number">29</span>:<span class="number">14.558</span> [t1] DEBUG TryLockTest - t1 获取了锁...</span><br></pre></td></tr></table></figure>

<p>可以看到一秒后 t1 获取到了锁</p>
<h4 id="解决哲学家就餐问题"><a href="#解决哲学家就餐问题" class="headerlink" title="解决哲学家就餐问题"></a>解决哲学家就餐问题</h4><p>我们可以使用 tryLock 来解决这个问题，获取不了锁我们就让出去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 解决哲学家问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SolvePhilosopherEatQuestion</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;苏格拉底&quot;</span>, c1, c2).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;柏拉图&quot;</span>, c2, c3).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;亚里士多德&quot;</span>, c3, c4).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;赫拉克利特&quot;</span>, c4, c5).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;阿基米德&quot;</span>, c5, c1).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;筷子&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;哲学家&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Chopstick left;</span><br><span class="line">    <span class="keyword">private</span> Chopstick right;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 拿到左边筷子</span></span><br><span class="line">            <span class="keyword">if</span> (left.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (right.tryLock()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            eat();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            right.unlock();		<span class="comment">// 注意释放锁</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    left.unlock();	<span class="comment">// 注意释放锁</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125; 吃上了饭&quot;</span>, <span class="built_in">this</span>.name);</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-公平锁"><a href="#4-公平锁" class="headerlink" title="4.公平锁"></a>4.公平锁</h3><p>ReentranLock 默认是不公平的，我们可以通过它的构造器设置它为公平的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentranLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentranLock</span>(<span class="literal">true</span>);		<span class="comment">// 设置为公平锁</span></span><br></pre></td></tr></table></figure>

<p><strong>公平锁</strong>：多个线程按照申请锁的顺序进行排队，排在前面的优先获取锁，后面的线程阻塞等待</p>
<ul>
<li>优点：所有的线程都能获取到锁，不会饿死在等待队列中</li>
<li>缺点：吞吐量会下降很多，队里面除了第一个线程运行，其他线程阻塞，cpu按序唤醒线程阻塞线程的开销很大</li>
</ul>
<p><strong>非公平锁</strong>：每个线程获取锁的顺序是随机的，不会遵循顺序去获取锁，所有的线程都会竞争获取锁</p>
<ul>
<li>优点：执行效率高，谁先获取到锁，锁就是谁的</li>
<li>缺点：获取锁的顺序是随机的，可能会出现线程饿死的情况。</li>
</ul>
<p><strong>案例</strong>：</p>
<p>非公平锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;FairLockTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FairLockTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">false</span>);</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;  <span class="number">500</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                lock.lock();    <span class="comment">// 获取锁</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125; running...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;t&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; start...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125; running...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;强制插入&quot;</span>).start();</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231028005750497.png" alt="image-20231028005750497"> </p>
<p> <strong>公平锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231028010003534.png" alt="image-20231028010003534"> </p>
<p>结果显示它在最后才获取到锁，然后才执行输出</p>
<h3 id="5-可多个条件变量"><a href="#5-可多个条件变量" class="headerlink" title="5.可多个条件变量"></a>5.可多个条件变量</h3><p>synchronized 中的 waitSet 就是一个条件变量</p>
<p>ReentranLock 支持多个条件变量，可以根据条件变量来唤醒，更加细粒度话进行管理</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentranLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentranLock</span>();</span><br><span class="line"><span class="type">Condtion</span> <span class="variable">c1</span> <span class="operator">=</span> lock.newCondition();</span><br></pre></td></tr></table></figure>

<p>Condtion 方法：</p>
<ul>
<li>await()：线程等待</li>
<li>signal()：随机唤醒被等待线程</li>
<li>signalAll()：唤醒所有等待线程</li>
</ul>
<p><strong>要点</strong>：</p>
<ul>
<li>await 前需要获取锁，&#x3D;&#x3D;signal 释放锁的时候也需要获取锁，否则会报错&#x3D;&#x3D;</li>
<li>await 执行后释放锁，进入 conditionObject 等待</li>
<li>await 的线程被唤醒（或打断、或超时）时重新竞争 lock 锁</li>
<li>竞争锁成功，从 await 后面开始继续执行</li>
</ul>
<p><strong>注意</strong>：因为可以有多个条件变量，线程等待和唤醒的对象要是同一个</p>
<h4 id="例子：买烟和买早餐"><a href="#例子：买烟和买早餐" class="headerlink" title="例子：买烟和买早餐"></a>例子：买烟和买早餐</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;AwaitTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AwaitTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">waitCigaretteQueue</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">waitBreakfastQueue</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasBreakfast</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!hasCigarette) &#123;</span><br><span class="line">                    waitCigaretteQueue.await();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;烟送到了...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!hasBreakfast) &#123;</span><br><span class="line">                    waitBreakfastQueue.await();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;早餐送到了...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        sendCigarette();</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        sendBreakfast();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendBreakfast</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hasCigarette = <span class="literal">true</span>;</span><br><span class="line">            waitCigaretteQueue.signalAll();</span><br><span class="line">            log.debug(<span class="string">&quot;烟送出去了...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendCigarette</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hasBreakfast = <span class="literal">true</span>;</span><br><span class="line">            waitBreakfastQueue.signalAll();</span><br><span class="line">            log.debug(<span class="string">&quot;早餐送出去了...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>:<span class="number">29</span>:<span class="number">00.901</span> [main] DEBUG AwaitTest - 烟送出去了...</span><br><span class="line"><span class="number">01</span>:<span class="number">29</span>:<span class="number">00.904</span> [t1] DEBUG AwaitTest - 烟送到了...</span><br><span class="line"><span class="number">01</span>:<span class="number">29</span>:<span class="number">01.906</span> [main] DEBUG AwaitTest - 早餐送出去了...</span><br><span class="line"><span class="number">01</span>:<span class="number">29</span>:<span class="number">01.906</span> [t2] DEBUG AwaitTest - 早餐送到了...</span><br></pre></td></tr></table></figure>

<p>可以看到我们使用 ReentranLcok 可以各自唤醒对于条件变量的线程，而如果使用 wait &amp; notify 的话防止虚假等待就需要唤醒所有的线程，但是 【烟】比 【早餐】更早送出去，所以就会造成提前唤醒导致早餐获取为空，所以多个条件变量就可以解决这个问题，更加灵活的处理不同的业务。</p>
<h2 id="同步模式之顺序控制"><a href="#同步模式之顺序控制" class="headerlink" title="同步模式之顺序控制"></a>同步模式之顺序控制</h2><h3 id="顺序执行"><a href="#顺序执行" class="headerlink" title="顺序执行"></a>顺序执行</h3><h4 id="wait-notify-版"><a href="#wait-notify-版" class="headerlink" title="wait &amp; notify 版"></a>wait &amp; notify 版</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 顺序执行之 wait &amp; notify</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;SequentialExecutionForWaitNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequentialExecutionForWaitNotify</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">t2Run</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">                <span class="keyword">while</span> (!t2Run) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        LOCK.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;t1 执行...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;t2 执行...&quot;</span>);</span><br><span class="line">                t2Run = <span class="literal">true</span>;</span><br><span class="line">                LOCK.notifyAll();       <span class="comment">// 唤醒其他线程</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="park-unpark-版"><a href="#park-unpark-版" class="headerlink" title="park &amp; unpark 版"></a>park &amp; unpark 版</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 顺序执行之 park &amp; unpark</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;SequentialExecutionForParkUnpark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequentialExecutionForParkUnpark</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;t1 执行&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t2 执行&quot;</span>);</span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="交替输出"><a href="#交替输出" class="headerlink" title="交替输出"></a>交替输出</h3><h4 id="wait-notify-版-1"><a href="#wait-notify-版-1" class="headerlink" title="wait &amp; notify 版"></a>wait &amp; notify 版</h4><p>线程通过设置标记来判断是否该它执行，如果不是我们对应的标记，那么就等待</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlternatingOutputWaitNotify</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SyncWaitNotify</span> <span class="variable">notify</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncWaitNotify</span>(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; notify.print(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">2</span>); &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; notify.print(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">3</span>); &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; notify.print(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>, <span class="number">1</span>); &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncWaitNotify</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> flag;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> loopNum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SyncWaitNotify</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">        <span class="built_in">this</span>.loopNum = loopNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, <span class="type">int</span> waitFlag, <span class="type">int</span> nextFlag)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (flag != waitFlag) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(str);</span><br><span class="line">                flag = nextFlag;</span><br><span class="line">                <span class="built_in">this</span>.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcabcabcabcabc</span><br></pre></td></tr></table></figure>



<h4 id="park-unpark-版-1"><a href="#park-unpark-版-1" class="headerlink" title="park &amp; unpark 版"></a>park &amp; unpark 版</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlternatingOutputForPark</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SyncPark</span> <span class="variable">syncPark</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncPark</span>(<span class="number">5</span>, <span class="number">1</span>);</span><br><span class="line">        t1 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; syncPark.print(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">2</span>, t2); &#125;);</span><br><span class="line">        t2 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; syncPark.print(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">3</span>, t3); &#125;);</span><br><span class="line">        t3 = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; syncPark.print(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>, <span class="number">1</span>, t1); &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncPark</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> flag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SyncPark</span><span class="params">(<span class="type">int</span> loopNum, <span class="type">int</span> flag)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNum = loopNum;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, <span class="type">int</span> flag, <span class="type">int</span> nextFlag,Thread nextThread)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNum; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="built_in">this</span>.flag != flag) &#123;</span><br><span class="line">                LockSupport.park();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(str);</span><br><span class="line">            <span class="built_in">this</span>.flag = nextFlag;</span><br><span class="line">            LockSupport.unpark(nextThread);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="ReentranLock版"><a href="#ReentranLock版" class="headerlink" title="ReentranLock版"></a>ReentranLock版</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlternatingOutputForReentranLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AwaitSignal</span> <span class="variable">awaitSignal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AwaitSignal</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">c1</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">c2</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">c3</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; awaitSignal.print(<span class="string">&quot;a&quot;</span>, c1, c2); &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; awaitSignal.print(<span class="string">&quot;b&quot;</span>, c2, c3); &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; awaitSignal.print(<span class="string">&quot;c&quot;</span>, c3, c1); &#125;).start();</span><br><span class="line">        awaitSignal.start(c1);      <span class="comment">// 唤醒c1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AwaitSignal</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> loopNum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwaitSignal</span><span class="params">(<span class="type">int</span> loopNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNum = loopNum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 一开始多个线程都再等待，所以需要先唤醒一个线程才能往下执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Condition condition)</span> &#123;</span><br><span class="line">        lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, Condition cur, Condition next)</span> &#123;</span><br><span class="line">        lock();     <span class="comment">// 获取锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cur.await();</span><br><span class="line">            System.out.print(str);</span><br><span class="line">            next.signalAll();       <span class="comment">// 唤醒下一个条件变量的线程</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcabcabcabcabc</span><br></pre></td></tr></table></figure>

<p><strong>错误想法</strong>：</p>
<ul>
<li>我在想要不要用一个标记来实现这个功能，但其实并不需要，我们是通过条件变量唤醒，只需要传入对应需要唤醒的条件变量即可，我们不需要设置等待条件</li>
</ul>
<h2 id="本章小结"><a href="#本章小结" class="headerlink" title="本章小结"></a>本章小结</h2><p>重点掌握：</p>
<ul>
<li>分析线程访问共享资源时，那些代码属于临界区</li>
<li>使用 synchronized 解决临界区的线程安全问题<ul>
<li>掌握 synchronized 锁对象语法</li>
<li>掌握 synchronized 加载成员变量方法和静态方法</li>
<li>掌握 wait&#x2F;notify 同步方法</li>
</ul>
</li>
<li>使用 lock 互斥解决临界区线程安全问题<ul>
<li>掌握 lock 的使用细节：可重入、可打断、锁超时、公平锁、条件变量</li>
</ul>
</li>
<li>学会分析变量的线程安全性，掌握常见线程安全类的使用</li>
<li>了解线程活跃性问题：死锁、活锁、饥饿</li>
</ul>
<p><strong>应用方面</strong>：</p>
<ul>
<li>互斥：使用 synchronized 和 Lock 实现资源共享互斥效果</li>
<li>同步：使用 wait &#x2F; notify 或 Lock 条件变量来达到线程通信效果</li>
</ul>
<p><strong>原理方面</strong>：</p>
<ul>
<li>monitor、synchonized、wait &#x2F; notify 原理</li>
<li>synchronized 进阶原理</li>
<li>park &amp; unpark 原理</li>
</ul>
<p><strong>模式方面</strong>：</p>
<ul>
<li><h2 id="同步模式之保护性暂停-1"><a href="#同步模式之保护性暂停-1" class="headerlink" title="同步模式之保护性暂停"></a>同步模式之保护性暂停</h2></li>
<li>异步模式之生产者消费者</li>
<li>同步模式之顺序控制<ul>
<li>顺序执行</li>
<li>交替执行</li>
</ul>
</li>
</ul>
<h1 id="四、共享模型之内存"><a href="#四、共享模型之内存" class="headerlink" title="四、共享模型之内存"></a>四、共享模型之内存</h1><h2 id="Java-内存模型"><a href="#Java-内存模型" class="headerlink" title="Java 内存模型"></a>Java 内存模型</h2><p>全称 Java Memory model，简称 JMM，Java对主寸和工作内存进行了抽象，底层对应 CPU寄存器、缓存、硬件内存、CPU指令优化等等，它让程序员不必关注于底层的内存管理，通过 Java 提供的关键字来控制</p>
<p>JMM 体现在以下几个方面</p>
<ul>
<li>原子性：保证指令不受线程上下文切换的影响</li>
<li>可见性：保证指令不会受 CPU 缓存的影响</li>
<li>有序性：保证指令不会受 CPU 指令并行优化影响</li>
</ul>
<h2 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h2><h3 id="可见性问题"><a href="#可见性问题" class="headerlink" title="可见性问题"></a>可见性问题</h3><p>我们首先看一段程序，然后我们分析一下为什么会出现循环一直不退出的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoopDoesNotExit</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isStop</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isStop) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        System.out.println(<span class="string">&quot;停止...&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        isStop = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231029202952853.png" alt="image-20231029202952853"> </p>
<p>结果显示我们修改了退出条件但是程序不停止</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>这个是因为我们的内存可见性导致的，JIT 编译器会对频繁从主存中取值的值缓存到当前执行的线程的工作内存的高速缓存中，减少对主存中的值的访问，提高效率</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231029203853480.png" alt="image-20231029203853480"> </p>
<p>所以当主线程修改主存中的值的时候 <code>线程t1</code> 它还是访问的高速缓存，导致主存的修改<code>线程t1</code> 看不到，因此导致循环无法退出</p>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>可以使用 volatile 关键字解决主存不可见问题</p>
<p>volatile 翻译是异变的意思， 它可以用来修饰成员变量或静态变量，局部变量在工作内存中，无需 volatile 修饰。它可以避免从工作缓存中获取值，而是直接从主存中获取值，这样就可以解决可见性的问题。</p>
<p>synchonized 也可以解决此问题，但是它是重锁，性能较低，所以能用 volatile 解决就不使用它。</p>
<p><strong>程序改进</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isStop</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>再次运行</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231029204128059.png" alt="image-20231029204128059"> </p>
<p>可以看到循环结束了</p>
<h3 id="终止模式之两阶段终止模式"><a href="#终止模式之两阶段终止模式" class="headerlink" title="终止模式之两阶段终止模式"></a>终止模式之两阶段终止模式</h3><p>回顾我们之前的两阶段终止模式，使用 打断程序的方式 来终止运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;TwoPhaseTermination&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread monitor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span> (thread.isInterrupted()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;料理后事...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;记录监控日志...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    thread.interrupt();     <span class="comment">// 重新设置打印标记</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察发现我们在打断程序的时候需要给它重新设置一下打断标记，如果它没有正确设置，那么就会导致我们的程序无法料理后事，所以我们可以设置我们自己的标记，然后在 stop 方法中设置一下，当满足我们的退出条件就结束循环</p>
<p><strong>改进代码</strong>：使用 标记 的方式来终止</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;TwoPhaseTermination&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread monitor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isStop</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isStop) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;料理后事...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;记录监控日志...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;程序打断...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.isStop = <span class="literal">true</span>;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:08:<span class="number">28.749</span> [monitor] DEBUG TwoPhaseTermination - 记录监控日志...</span><br><span class="line"><span class="number">21</span>:08:<span class="number">29.755</span> [monitor] DEBUG TwoPhaseTermination - 记录监控日志...</span><br><span class="line"><span class="number">21</span>:08:<span class="number">30.764</span> [monitor] DEBUG TwoPhaseTermination - 记录监控日志...</span><br><span class="line"><span class="number">21</span>:08:<span class="number">31.259</span> [monitor] DEBUG TwoPhaseTermination - 程序打断...</span><br><span class="line"><span class="number">21</span>:08:<span class="number">31.259</span> [monitor] DEBUG TwoPhaseTermination - 料理后事...</span><br></pre></td></tr></table></figure>

<p>我们需要使用 volatile 来修饰 <code>isStop</code> 变量，因为它被多个程序使用，所以需要保证它的内存可见性。</p>
<h3 id="同步模式之-Balking"><a href="#同步模式之-Balking" class="headerlink" title="同步模式之 Balking"></a>同步模式之 Balking</h3><p>Balking（犹豫）模式是用于一个线程发现另外一个线程已经做过某一件相同的事，那么本线程无需重复操作，直接返回即可</p>
<h4 id="监控程序实现"><a href="#监控程序实现" class="headerlink" title="监控程序实现"></a>监控程序实现</h4><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231029213953985.png" alt="image-20231029213953985"></p>
<p>当我们点击开始按钮就启动我们的监控线程，停止就是将监控线程停止</p>
<p>但是如果我们多次点击开始，我们只需要使用一个标记来记录当前线程是否已经启动，如果已经启动那么就 break，没有启动就需要 new 一个线程</p>
<p><strong>下面是我们的监控线程启动方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 缩小同步范围，提升性能</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;该监控线程已启动?(&#123;&#125;)&quot;</span>, starting);</span><br><span class="line">        <span class="keyword">if</span> (starting) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        starting = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建线程执行监控任务</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这块使用的就是我们的 Blaking 模式，它首先判断是否已经启动，如果启动了就 return，否则就创建线程</p>
<h4 id="线程安全的单例"><a href="#线程安全的单例" class="headerlink" title="线程安全的单例"></a>线程安全的单例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Person</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Person <span class="title function_">getPerson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.person == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.person = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h2><h3 id="指令重排序"><a href="#指令重排序" class="headerlink" title="指令重排序"></a>指令重排序</h3><h4 id="1-什么是指令重排序"><a href="#1-什么是指令重排序" class="headerlink" title="1.什么是指令重排序"></a>1.什么是指令重排序</h4><p>指令重排序是指编译器或 CPU 为了优化程序的执行性能而对指令进行重新排序的一种手段， 重新排序会带来可见性问题，所以在多线程开发中要规避和关注重排序。</p>
<p><strong>举个例子</strong>：我们需要泡茶喝，有以下步骤：<code>洗茶壶-洗杯子-煮开水-洗茶-泡茶</code>，其中煮开水的时间是最长的，在这个时间内我们可以将其他的步骤先做好，那么此时我们可以修改一下它的顺序为：<code>煮开水-洗茶壶-洗杯子-洗茶-泡茶</code>，这个就和我们的指令重排比较相近了，在一段时间内完成多个指令操作，以此来优化指令的执行速度</p>
<p><strong>三种重排序的场景</strong>：</p>
<ol>
<li><p>编译器重排序</p>
<p> 编译器可以在不改变单线程代码执行结果的前提下，可以对代码执行顺序进行重排序</p>
</li>
<li><p>CPU指令重排序</p>
<p> 这个是针对 CPU 指令来说的，处理器采用指令集并行技术将许多条指令重叠执行，如果不存在数据依赖性，处理器可以改变语句对应的机器指令执行顺序</p>
</li>
<li><p>内存重排序</p>
<p> 因为CPU缓存使用 缓冲区的方式(Store Buffere )进行延迟写入，这个过程会造成多个CPU缓存可见性的问题，这种可见性的问题导致结果的对于指令的先后执行显示不一致，从表面结果上来看好像指令的顺序被改变了，内存重排序其实是造成可见性问题的主要原因所</p>
</li>
</ol>
<h4 id="2-指令重排的规则"><a href="#2-指令重排的规则" class="headerlink" title="2.指令重排的规则"></a>2.指令重排的规则</h4><p><strong>as-if-serial语义</strong></p>
<p>as-if-serial 表示所有程序指令都可以重排序，前提是在单线程环境下执行结果不变的情况下改变它的指令执行顺序</p>
<p>举个编译器层面的优化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">a = a + <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>那么这个时候我们可以将它修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">a = a + <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>相比于一开始的，a 在赋值完成后 不用再从 主存中给 b 赋值，直接就是放入寄存器中，接着执行 + 2 操作，这样省下了放入内存中然后再从内存中获取的情况</p>
<h4 id="3-重排序对多线程的影响"><a href="#3-重排序对多线程的影响" class="headerlink" title="3.重排序对多线程的影响"></a>3.重排序对多线程的影响</h4><p>以下一段代码，分析它在多线程环境下会有什么问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> value;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> flag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.value = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">this</span>.flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：</p>
<p>如果是代码都是按照允许执行，那么 getValue() 打印值就为8，但是如果对 init() 进行指令重排序，那么此时的顺序如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.flag = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">this</span>.value = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>这个时候两个线程同时调用 getValue() 和 init() 就会导致结果为 0</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231030005224974.png" alt="image-20231030005224974"> </p>
<h3 id="诡异的结果"><a href="#诡异的结果" class="headerlink" title="诡异的结果"></a>诡异的结果</h3><p>我们借助 java 并发压测工具 jcstress【<a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/CodeTools/jcstress%E3%80%91">https://wiki.openjdk.java.net/display/CodeTools/jcstress】</a> 来测试</p>
<p>创建 maven 工程，提供如下测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JCStressTest</span></span><br><span class="line"><span class="meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span></span><br><span class="line"><span class="meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)</span></span><br><span class="line"><span class="meta">@State</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrencyTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">            r.r1 = num + num;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r.r1 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        num = <span class="number">2</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打成 jar 包执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install </span><br><span class="line">java -jar target/jcstress.jar</span><br></pre></td></tr></table></figure>

<p><strong>执行结果</strong>：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231030173413890.png" alt="image-20231030173413890"> </p>
<p>可以看到，出现结果为 0 的情况有 1652 次，虽然次数相对很少，但毕竟是出现了。</p>
<h3 id="禁止指令重排"><a href="#禁止指令重排" class="headerlink" title="禁止指令重排"></a>禁止指令重排</h3><p>使用 volatile 来解决指令重排的问题，volatile 修饰的变量，可以禁用指令重排</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>再次测试结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*** INTERESTING tests </span><br><span class="line">Some interesting behaviors observed. This is <span class="keyword">for</span> the plain curiosity. </span><br><span class="line"><span class="number">0</span> matching test results.</span><br></pre></td></tr></table></figure>

<p>没有问题</p>
<h3 id="CPU-缓存结构原理"><a href="#CPU-缓存结构原理" class="headerlink" title="CPU 缓存结构原理"></a>CPU 缓存结构原理</h3><p>暂时不学</p>
<h3 id="Volatile原理"><a href="#Volatile原理" class="headerlink" title="Volatile原理"></a>Volatile原理</h3><p>volatile 的底层实现原理是内存屏障，Memory Barrier（Memory Fence）</p>
<ul>
<li>对 volatile 变量的写指令后会加入写屏障</li>
<li>对 volatile 变量的读指令前会加入读屏障</li>
</ul>
<h4 id="1、如何保证可见性"><a href="#1、如何保证可见性" class="headerlink" title="1、如何保证可见性"></a>1、如何保证可见性</h4><p>写屏障它保证了对共享变量的修改都会同步到主存中</p>
<p>读屏障保证在该凭证后，对共享变量的读取，加载的是主存中最新的数据</p>
<h4 id="2、如何保证有序性"><a href="#2、如何保证有序性" class="headerlink" title="2、如何保证有序性"></a>2、如何保证有序性</h4><p>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</p>
<p>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</p>
<h4 id="3、double-checked-locking-问题"><a href="#3、double-checked-locking-问题" class="headerlink" title="3、double-checked locking 问题"></a>3、double-checked locking 问题</h4><p>以著名的 double-checked locking 单例模式为例 </p>
<h4 id="4、double-checked-locking-解决"><a href="#4、double-checked-locking-解决" class="headerlink" title="4、double-checked locking 解决"></a>4、double-checked locking 解决</h4><h1 id="五、共享模型之无锁-CAS"><a href="#五、共享模型之无锁-CAS" class="headerlink" title="五、共享模型之无锁(CAS)"></a>五、共享模型之无锁(CAS)</h1><h2 id="CAS概述"><a href="#CAS概述" class="headerlink" title="CAS概述"></a>CAS概述</h2><h3 id="无锁-逻辑锁"><a href="#无锁-逻辑锁" class="headerlink" title="无锁(逻辑锁)"></a>无锁(逻辑锁)</h3><h4 id="问题提出"><a href="#问题提出" class="headerlink" title="问题提出"></a>问题提出</h4><p>我们写一个存钱获取取钱的案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AccountUnsafe</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountUnsafe</span>(<span class="number">10000</span>);</span><br><span class="line">        Account.demo(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AccountUnsafe</span> <span class="keyword">implements</span> <span class="title class_">Account</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountUnsafe</span><span class="params">(Integer balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance -= amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="comment">// 获取余额</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getBalance</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 取钱</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="number">10</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            list.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;剩余金额：&quot;</span> + account.getBalance()</span><br><span class="line">                + <span class="string">&quot; coat：&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">剩余金额：<span class="number">180</span> coat：137ms</span><br></pre></td></tr></table></figure>



<h4 id="解题难题-有锁"><a href="#解题难题-有锁" class="headerlink" title="解题难题 - 有锁"></a>解题难题 - 有锁</h4><p>上面的案例中，withdraw 方法是一个临界区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.balance -= amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>this.balance -= amount;</code> 这样代码进行了读写操作</p>
<p>我们可以通过 synchronized 和 ReentranLock 来解决这个问题，这里我使用 synchronized</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.balance -= amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们再次远行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">剩余金额：<span class="number">0</span> coat：140ms</span><br></pre></td></tr></table></figure>

<p>完美~~~</p>
<h4 id="解决问题-无锁"><a href="#解决问题-无锁" class="headerlink" title="解决问题 - 无锁"></a>解决问题 - 无锁</h4><p>那我们可以使用无锁的方式去做共享资源的保护吗？可以的，使用 CAS 的方式</p>
<p>我们使用 <code>AtomicInteger</code> 修改一下我们的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AccountUnsafe</span> <span class="keyword">implements</span> <span class="title class_">Account</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger balance;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AccountUnsafe</span><span class="params">(<span class="type">int</span> balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(balance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">prev</span> <span class="operator">=</span> <span class="built_in">this</span>.balance.get();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> prev - amount;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">剩余金额：<span class="number">0</span> coat：121ms</span><br></pre></td></tr></table></figure>

<p>此时我们的 withdraw 并没有用 synchronized 修饰，也就是说我们没有加锁，那么为什么不加锁也可以保证线程安全性呢？</p>
<h3 id="CAS-与-Volatile"><a href="#CAS-与-Volatile" class="headerlink" title="CAS 与 Volatile"></a>CAS 与 Volatile</h3><h4 id="CAS是什么"><a href="#CAS是什么" class="headerlink" title="CAS是什么"></a>CAS是什么</h4><p>CAS 就是通过比较上个版本来判断共享资源是否被其他线程改变了，如果改变了那么此次执行失败，接着它的循环去改变这个共享变量，直到它比较成功。CAS是原子操作。</p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li>其实 CAS 的底层是 <strong>lock cmpxchg</strong> 指令（X86 架构），在单核 CPU 和多核 CPU 下都能够保证【比较-交换】的原子性。</li>
<li>在多核状态下，某个核执行到带 lock 的指令时，CPU 会让总线锁住，当这个核把此指令执行完毕，再开启总线。这个过程中不会被线程的调度机制所打断，保证了多个线程对内存操作的准确性，是原子的。</li>
</ul>
</blockquote>
<p>接下来哦们看一下上一章节的 withdraw 方法做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">    <span class="comment">// 不断重试</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取没修改之前的值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">prev</span> <span class="operator">=</span> <span class="built_in">this</span>.balance.get();</span><br><span class="line">        <span class="comment">// 获取修改之后的值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> prev - amount;</span><br><span class="line">        <span class="comment">// 比较之前没修改的值，如果和现在获取的值一致，那么就将 next 设置为最新的值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的 compareAndSet 方法，它的简称就是 CAS （也有 compareAndSwap的说法），翻译 “比较和设置”，通过比较上一次的值来判断值是否被改变了，如果被改变了，那么当前的操作就会失败返回 false，所以我们这里使用 <code>while(true)</code> 来不断重试</p>
<p>它的执行序列图如下：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231102152958932.png" alt="image-20231102152958932"> </p>
<p>可以看到我们的线程一执行了两次操作才成功的减去了 10</p>
<h4 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h4><p>获取共享变量时，为了保证该变量的可见性，我们可以使用 volatile 来修饰变量</p>
<blockquote>
<p><strong>注意</strong></p>
<p>volatile 仅仅保证了共享变量的可见性，让其它线程能够看到最新值，但不能解决指令交错问题（不能保证原子性）</p>
</blockquote>
<p>那么我们使用的 AtomicInteger 类需要使用 volatile 修饰吗？</p>
<p>不需要，因为它所维护的变量已经用 volatile 修饰过了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 来自 AtomicInteger 类源码</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br></pre></td></tr></table></figure>



<h4 id="为什么无锁效率高呢？"><a href="#为什么无锁效率高呢？" class="headerlink" title="为什么无锁效率高呢？"></a>为什么无锁效率高呢？</h4><ul>
<li>无锁清况下即使它判断失败了，它还是一直处在 Runnable 状态，并没有 Blocked ，而 Synchronized 它在切换线程的时候进行上下文切换，线程会被 Blocked，一直跑的赛车和一直重新启动再加速的赛车那个更快呢？很显然是一直跑的那个</li>
<li>无锁它需要多个 CPU 核心支持，因为它是一直运行的，如果是单核心，它还是会上下文切换，所以建议使用无锁的时候它的线程数不要超过 CPU 的核心数</li>
</ul>
<h2 id="CAS类和方法"><a href="#CAS类和方法" class="headerlink" title="CAS类和方法"></a>CAS类和方法</h2><h3 id="原子整数"><a href="#原子整数" class="headerlink" title="原子整数"></a>原子整数</h3><h4 id="三种类型"><a href="#三种类型" class="headerlink" title="三种类型"></a>三种类型</h4><p>原子整数类有以下三种类型：</p>
<ul>
<li>AtomicInteger</li>
<li>AtomicLong</li>
<li>AtomicBoolean</li>
</ul>
<h4 id="方法-1"><a href="#方法-1" class="headerlink" title="方法"></a>方法</h4><p>我们这里使用 AtomicInteger 做示例，其他的都是类似的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicIntegerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;========= 获取值 =======&quot;</span>);</span><br><span class="line">        System.out.println(a.get());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;========= i加加 和 加加i OP =======&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;incrementAndGet：&quot;</span> + a.incrementAndGet());</span><br><span class="line">        System.out.println(<span class="string">&quot;getAndIncrement：&quot;</span> + a.getAndIncrement());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;========= 加法减法 OP =======&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;addAndGet(5)：&quot;</span> + a.addAndGet(<span class="number">5</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;getAndAdd(5)：&quot;</span> + a.getAndAdd(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;========= CAS OP =======&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;compareAndSet(2, 5)：&quot;</span> + a.compareAndSet(<span class="number">2</span>, <span class="number">5</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;get：&quot;</span> + a.get());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;========= 更新和获取值（lambda表达式） =====&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;更新并获取：&quot;</span> + a.updateAndGet(x -&gt; x * <span class="number">2</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;先获取再更新：&quot;</span> + a.getAndUpdate(x -&gt; x / <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======== 计算和获取值 ========&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;accumulateAndGet：&quot;</span> + a.accumulateAndGet(<span class="number">2</span>, (p, x) -&gt; p + x));</span><br><span class="line">        System.out.println(<span class="string">&quot;getAndAccumulate：&quot;</span> + a.getAndAccumulate(-<span class="number">2</span>, (p, x) -&gt;  p + x));   <span class="comment">// p 是还未修改前的值，x是第一个参数</span></span><br><span class="line">        System.out.println(<span class="string">&quot;get：&quot;</span> + a.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">========= 获取值 =======</span><br><span class="line"><span class="number">0</span></span><br><span class="line">========= i加加 和 加加i OP =======</span><br><span class="line">incrementAndGet：<span class="number">1</span></span><br><span class="line">getAndIncrement：<span class="number">1</span></span><br><span class="line">========= 加法减法 OP =======</span><br><span class="line">addAndGet(<span class="number">5</span>)：<span class="number">7</span></span><br><span class="line">getAndAdd(<span class="number">5</span>)：<span class="number">7</span></span><br><span class="line">========= CAS OP =======</span><br><span class="line">compareAndSet(<span class="number">2</span>, <span class="number">5</span>)：<span class="literal">false</span></span><br><span class="line">get：<span class="number">12</span></span><br><span class="line">========= 更新和获取值（lambda表达式） =====</span><br><span class="line">更新并获取：<span class="number">24</span></span><br><span class="line">先获取再更新：<span class="number">24</span></span><br><span class="line">======== 计算和获取值 ========</span><br><span class="line">accumulateAndGet：<span class="number">14</span></span><br><span class="line">getAndAccumulate：<span class="number">14</span></span><br><span class="line">get：<span class="number">12</span></span><br></pre></td></tr></table></figure>



<h4 id="updateAndGet原理"><a href="#updateAndGet原理" class="headerlink" title="updateAndGet原理"></a>updateAndGet原理</h4><p>下面是这个方法的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">updateAndGet</span><span class="params">(IntUnaryOperator updateFunction)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prev, next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 未修改的值</span></span><br><span class="line">        prev = get();</span><br><span class="line">        <span class="comment">// 修改后的值</span></span><br><span class="line">        next = updateFunction.applyAsInt(prev);</span><br><span class="line">        <span class="comment">// 进行 CAS 比较，不满足继续循环</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个不就是我们之前使用  AtomicInteger 解决问题时用的方式吗，它这里做了一些代码简化，也就是说我们不使用它的方法我们自己也可以用我们自己的</p>
<h3 id="原子引用"><a href="#原子引用" class="headerlink" title="原子引用"></a>原子引用</h3><ul>
<li>AtomicReference</li>
<li>AtomicMarkableReference</li>
<li>AtomicStampedReference</li>
</ul>
<h4 id="AtomicReference"><a href="#AtomicReference" class="headerlink" title="AtomicReference"></a>AtomicReference</h4><h5 id="修改-Account-的案例"><a href="#修改-Account-的案例" class="headerlink" title="修改 Account 的案例"></a>修改 Account 的案例</h5><p>我们修改之前的代码，将 int 类型改成 BigDecimal 类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UnsafeAccount</span> <span class="keyword">implements</span> <span class="title class_">Account</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UnsafeAccount</span><span class="params">(<span class="type">int</span> balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = BigDecimal.valueOf(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = <span class="built_in">this</span>.balance.subtract(amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Account</span> &#123;</span><br><span class="line"></span><br><span class="line">    BigDecimal <span class="title function_">getBalance</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">        List&lt;Thread&gt; threads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">10</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">            threads.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        threads.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;balance：&quot;</span> + account.getBalance()</span><br><span class="line">                + <span class="string">&quot;, time：&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">balance：410, time：166ms</span><br></pre></td></tr></table></figure>

<p>我们之前用的整数类型，现在我使用引用类型，那么我们就不能使用原子整数类来解决了，我们使用原子引用类来解决</p>
<h5 id="解决问题-1"><a href="#解决问题-1" class="headerlink" title="解决问题"></a>解决问题</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UnsafeAccount</span> <span class="keyword">implements</span> <span class="title class_">Account</span>&#123;</span><br><span class="line">    <span class="comment">// private BigDecimal balance;</span></span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;BigDecimal&gt; ref;    <span class="comment">// 使用原子引用解决资源共享问题</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UnsafeAccount</span><span class="params">(BigDecimal balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ref = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(balance);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ref.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ref.updateAndGet(balance -&gt; balance.subtract(amount));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>withdraw 中也可以不使用 AtomicReference 的方法，我们也可以编写我们自己的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">    BigDecimal prev;</span><br><span class="line">    BigDecimal next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = ref.get();</span><br><span class="line">        next = prev.subtract(amount);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!ref.compareAndSet(prev, next));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="AtomicStampedReference"><a href="#AtomicStampedReference" class="headerlink" title="AtomicStampedReference"></a>AtomicStampedReference</h4><h5 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ABAQuestion&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABAQuestion</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicReference&lt;String&gt; CODE = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prev</span> <span class="operator">=</span> CODE.get();</span><br><span class="line">        other();</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;A -&gt; C：&#123;&#125;&quot;</span>, CODE.compareAndSet(prev, <span class="string">&quot;C&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">other</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;A -&gt; B：&#123;&#125;&quot;</span>, CODE.compareAndSet(CODE.get(), <span class="string">&quot;B&quot;</span>));</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        TimeUtil.sleep(<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;B -&gt; A：&#123;&#125;&quot;</span>, CODE.compareAndSet(CODE.get(), <span class="string">&quot;A&quot;</span>));</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">49</span>:<span class="number">22.763</span> [t1] DEBUG ABAQuestion - A -&gt; B：<span class="literal">true</span></span><br><span class="line"><span class="number">21</span>:<span class="number">49</span>:<span class="number">23.262</span> [t1] DEBUG ABAQuestion - B -&gt; A：<span class="literal">true</span></span><br><span class="line"><span class="number">21</span>:<span class="number">49</span>:<span class="number">24.269</span> [main] DEBUG ABAQuestion - A -&gt; C：<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：两个线程先 A -&gt; B，然后 B -&gt; A，最后是 main线程 A -&gt; C，那么在这个过程中发生了 A -&gt; B -&gt; A 的过程，这个过程我们无法感知，最后的结果是返回 true，因为比对的结果没问题；</p>
<p>从逻辑上看两个线程的操作相当于是没有做修改，但是实际上他们修改了两次，只是结果和第一次的相同；</p>
<p>那么我们如何知道这个变量已经被修改了呢？</p>
<h5 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h5><p>我们可以给共享变量一个版本，当我们修改了这个共享变量，那么此时它的版本号发生变化，当其他线程要修改的时候，获取最新的版本号进行对比，如果发现版本号不一致，那么修改不成功，相反则成功。</p>
<p><strong>AtomicStampedReferenc</strong>* 它就是使用这种机制来保证共享资源的安全</p>
<p><strong>方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AtomicStampedReferenc</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(V expectedReference, V newReference, <span class="type">int</span> expectedStamp, <span class="type">int</span> newStamp)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>expectedReference：旧引用</li>
<li>newReference：新引用</li>
<li>expectedStamp：旧印记</li>
<li>newStamp：新印记</li>
</ul>
<h5 id="解决ABA问题"><a href="#解决ABA问题" class="headerlink" title="解决ABA问题"></a>解决ABA问题</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ABAQuestion&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABAQuestionSolution</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicStampedReference&lt;String&gt; CODE = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="string">&quot;A&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> CODE.getStamp();</span><br><span class="line">        other();</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;更新版本为：&#123;&#125;&quot;</span>, stamp);</span><br><span class="line">        log.debug(<span class="string">&quot;A -&gt; C：&#123;&#125;&quot;</span>, CODE.compareAndSet(CODE.getReference(), <span class="string">&quot;C&quot;</span>, stamp, stamp + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">other</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> CODE.getStamp();</span><br><span class="line">            log.debug(<span class="string">&quot;更新版本为：&#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            log.debug(<span class="string">&quot;A -&gt; B：&#123;&#125;&quot;</span>, CODE.compareAndSet(CODE.getReference(), <span class="string">&quot;B&quot;</span>, stamp, stamp + <span class="number">1</span>));</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        TimeUtil.sleep(<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> CODE.getStamp();</span><br><span class="line">            log.debug(<span class="string">&quot;更新版本为：&#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            log.debug(<span class="string">&quot;B -&gt; A：&#123;&#125;&quot;</span>, CODE.compareAndSet(CODE.getReference(), <span class="string">&quot;A&quot;</span>, stamp, stamp + <span class="number">1</span>));</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">06</span>:<span class="number">41.313</span> [t1] DEBUG ABAQuestion - 更新版本为：<span class="number">0</span></span><br><span class="line"><span class="number">22</span>:<span class="number">06</span>:<span class="number">41.319</span> [t1] DEBUG ABAQuestion - A -&gt; B：<span class="literal">true</span></span><br><span class="line"><span class="number">22</span>:<span class="number">06</span>:<span class="number">41.813</span> [t2] DEBUG ABAQuestion - 更新版本为：<span class="number">1</span></span><br><span class="line"><span class="number">22</span>:<span class="number">06</span>:<span class="number">41.814</span> [t2] DEBUG ABAQuestion - B -&gt; A：<span class="literal">true</span></span><br><span class="line"><span class="number">22</span>:<span class="number">06</span>:<span class="number">42.822</span> [main] DEBUG ABAQuestion - 更新版本为：<span class="number">0</span></span><br><span class="line"><span class="number">22</span>:<span class="number">06</span>:<span class="number">42.822</span> [main] DEBUG ABAQuestion - A -&gt; C：<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>可以看到因为我们是以版本号为基准判断是否已经被修改，所以 main 修改不成功，因为版本号已经发生改变</p>
<h4 id="AtomicMarkableReference"><a href="#AtomicMarkableReference" class="headerlink" title="AtomicMarkableReference"></a>AtomicMarkableReference</h4><p>有时候我们不关注它修改了多少次，我们关心的是它是否被修改了没，所以就有了 AtomicMarkableReference，它只有两个标记分别是 true 和 false，通过这两个标记来做对应的业务，为true干什么，为 false 又干什么</p>
<p><strong>案例</strong></p>
<p>这里我们做一个 【吃饭拉屎】🤣 的案例，我们有两个线程，一个是肚子和屁股，肚子饿了要吃，吃饱了就拉</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicMarkableReferenceTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="literal">true</span>);</span><br><span class="line">        AtomicMarkableReference&lt;Person&gt; ref = <span class="keyword">new</span> <span class="title class_">AtomicMarkableReference</span>&lt;Person&gt;(person, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 是 true 的就让设置为 false</span></span><br><span class="line">            <span class="keyword">if</span> (ref.isMarked()) &#123;</span><br><span class="line">                person.setAbdomen(<span class="literal">false</span>);</span><br><span class="line">                ref.compareAndSet(person, person, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;eat&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ref.isMarked()) &#123;</span><br><span class="line">                person.setAbdomen(<span class="literal">true</span>);</span><br><span class="line">                ref.compareAndSet(person, person, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;la&quot;</span>).start();</span><br><span class="line">        TimeUtil.sleep(<span class="number">0.5</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> abdomen;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(<span class="type">boolean</span> abdomen)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.abdomen = abdomen;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAbdomen</span><span class="params">(<span class="type">boolean</span> abdomen)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.abdomen = abdomen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (abdomen) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;肚子好饿&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;吃饱拉出&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">15</span>:<span class="number">44.781</span> [eat] DEBUG AtomicMarkableReferenceTest - 它饿了，吃了一顿，肚子好饱...</span><br><span class="line"><span class="number">23</span>:<span class="number">15</span>:<span class="number">45.291</span> [la] DEBUG AtomicMarkableReferenceTest - 它拉了，又饿了...</span><br><span class="line"><span class="number">23</span>:<span class="number">15</span>:<span class="number">45.794</span> [main] DEBUG AtomicMarkableReferenceTest - 最后它肚子好饿</span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：</p>
<ul>
<li>Person 对象中有一个肚子属性 abdomen，为 true 就是肚子空了，false 肚子饱了</li>
<li>创建两个线程，饿了就吃，吃了就拉（设 abdomen 为空）</li>
<li>最后肚子空了</li>
</ul>
<h3 id="原子数组"><a href="#原子数组" class="headerlink" title="原子数组"></a>原子数组</h3><p>访问数组元素的时候它并不是线程安全的，所以 JDK 提供以下类来保证访问数据安全：</p>
<ul>
<li>AtomicIntegerArray</li>
<li>AtomicLongArray</li>
<li>AtomicReferenceArray</li>
</ul>
<p><strong>案例</strong></p>
<p>对数组中的元素加加 1000_0 次</p>
<p>封装一个万能的 demo 方法，方便测试使用原子数组前后的对比</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arraySupplier     提供数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> countFun          获取数组元素个数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> putConsumer       元素自增方法，参数 (array, index)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> printConsumer     打印数组方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Supplier&lt;T&gt; arraySupplier,</span></span><br><span class="line"><span class="params">                            Function&lt;T, Integer&gt; countFun,</span></span><br><span class="line"><span class="params">                            BiConsumer&lt;T, Integer&gt; putConsumer,</span></span><br><span class="line"><span class="params">                            Consumer&lt;T&gt; printConsumer)</span> &#123;</span><br><span class="line">    List&lt;Thread&gt; threads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();   <span class="comment">// 保存 Thread</span></span><br><span class="line">    <span class="type">T</span> <span class="variable">array</span> <span class="operator">=</span> arraySupplier.get();  <span class="comment">// 获取数组</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> countFun.apply(array);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000_0</span>; j++) &#123;</span><br><span class="line">                <span class="comment">// 这里 index 不能使用 i，以为lambda 中的外部变量必须要 final 修饰，i最后的值1000_0</span></span><br><span class="line">                putConsumer.accept(array, j % count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        threads.add(thread);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    threads.forEach(thread -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    printConsumer.accept(array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>不安全实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    demo(</span><br><span class="line">            () -&gt; <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>],</span><br><span class="line">            array -&gt; array.length,</span><br><span class="line">            (array, index) -&gt; array[index]++,</span><br><span class="line">            array -&gt; System.out.println(<span class="string">&quot;res：&quot;</span> + Arrays.toString(array))</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res：[<span class="number">8835</span>, <span class="number">8814</span>, <span class="number">8828</span>, <span class="number">8815</span>, <span class="number">8793</span>]</span><br></pre></td></tr></table></figure>

<p>结果显示错误</p>
<p><strong>使用引用数组的安全实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">demo(</span><br><span class="line">        () -&gt; <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="number">5</span>),</span><br><span class="line">        AtomicIntegerArray::length,</span><br><span class="line">        AtomicIntegerArray::incrementAndGet,</span><br><span class="line">        System.out::println</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>]</span><br></pre></td></tr></table></figure>



<h3 id="原子累加器"><a href="#原子累加器" class="headerlink" title="原子累加器"></a>原子累加器</h3><ul>
<li>LongAdder</li>
<li>DoubleAdder</li>
</ul>
<h4 id="累加器性能比较"><a href="#累加器性能比较" class="headerlink" title="累加器性能比较"></a>累加器性能比较</h4><p>编写一个测试方法，让它累加到 20万</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Supplier&lt;T&gt; adderSupplier, Consumer&lt;T&gt; consumer)</span> &#123;</span><br><span class="line">    <span class="type">T</span> <span class="variable">adder</span> <span class="operator">=</span> adderSupplier.get();</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    List&lt;Thread&gt; threads = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        threads.add(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">5000_00</span>; j++) &#123;</span><br><span class="line">                consumer.accept(adder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    threads.forEach(Thread::start);</span><br><span class="line">    threads.forEach(t -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    System.out.println(adder + <span class="string">&quot; 耗时：&quot;</span> + (end - start) / <span class="number">1000_000</span> + <span class="string">&quot;ns&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        demo(</span><br><span class="line">                () -&gt; <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>),</span><br><span class="line">                AtomicInteger::getAndIncrement</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;=============================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        demo(</span><br><span class="line">                LongAdder::<span class="keyword">new</span>,</span><br><span class="line">                LongAdder::increment</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2000000</span> 耗时：42ns</span><br><span class="line"><span class="number">2000000</span> 耗时：40ns</span><br><span class="line"><span class="number">2000000</span> 耗时：31ns</span><br><span class="line"><span class="number">2000000</span> 耗时：34ns</span><br><span class="line"><span class="number">2000000</span> 耗时：29ns</span><br><span class="line">=============================</span><br><span class="line"><span class="number">2000000</span> 耗时：15ns</span><br><span class="line"><span class="number">2000000</span> 耗时：6ns</span><br><span class="line"><span class="number">2000000</span> 耗时：6ns</span><br><span class="line"><span class="number">2000000</span> 耗时：6ns</span><br><span class="line"><span class="number">2000000</span> 耗时：6ns</span><br></pre></td></tr></table></figure>

<p>可以看到是累加器性能更好一点~~~</p>
<h4 id="LongAdder源码解析"><a href="#LongAdder源码解析" class="headerlink" title="LongAdder源码解析"></a>LongAdder源码解析</h4><p>LongAdder 是并发大师 @author Doug Lea （大哥李）的作品，设计的非常精巧</p>
<p>LongAdder 它的原理就是每个线程都有对应的累加单元 Cell，在最后将每个线程的 Cell 进行累加，最终得出总结果</p>
<h5 id="重要域"><a href="#重要域" class="headerlink" title="重要域"></a>重要域</h5><p>LongAdder 中的几个重要属性，准确的来说不是 LongAdder 中的， 而是 Striped64 类中的，但是 LongAdder 继承了 Striped64，所以也可以这么说</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 累加载单元数组，懒加载</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基础值，如果没有竞争就使用这个来累加</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> base;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 cells 创建或扩容时，置为1，表示加锁 </span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>补充</strong>：transient 关键字的作用就是不进行序列化</p>
</blockquote>
<h5 id="原理之伪共享"><a href="#原理之伪共享" class="headerlink" title="原理之伪共享"></a>原理之伪共享</h5><p>Striped64的内部类 Cell</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> value;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它使用 <code>@sun.misc.Contended</code>  注解进行修饰，这个注解有什么作业呢？</p>
<p><strong>CPU缓存结果解析</strong></p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231103205928681.png" alt="image-20231103205928681"></p>
<p>CPU 它有三级缓存分别是 L1、L2、L3，通过缓存取值可以缩短执行时间，因为从内存中取值相对于缓存更慢</p>
<p>他们的速度比较如下：</p>
<table>
<thead>
<tr>
<th><strong>从</strong> <strong>cpu</strong> <strong>到</strong></th>
<th><strong>大约需要的时钟周期</strong></th>
</tr>
</thead>
<tbody><tr>
<td>寄存器</td>
<td>1 cycle (4GHz 的 CPU 约为0.25ns)</td>
</tr>
<tr>
<td>L1</td>
<td>3~4 cycle</td>
</tr>
<tr>
<td>L2</td>
<td>10~20 cycle</td>
</tr>
<tr>
<td>L3</td>
<td>40~45 cycle</td>
</tr>
<tr>
<td>内存</td>
<td>120~240 cycle</td>
</tr>
</tbody></table>
<p>缓存以缓存行为单位，每个缓存行对应着一块内存，一般是 <strong>64 byte（8 个 long）</strong></p>
<p>缓存的加入会造成副本的产生，一份数据会被缓存到不同核心的缓存中</p>
<p>CPU要保证缓存一致性，一旦某个核心更改了数据，其它 CPU 核心对应的整个缓存行必须失效</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231103210303644.png" alt="image-20231103210303644"> </p>
<p>LongAdder 中的 Cell 是以数组的形式存在的，数组是一个连续的内存结构。一个 Cell 为 24 个字节（对象头为16字节，属性 vlue 为 8字节），那么一个缓存块最多 2 个 cell对象，假设我们的操作如下：</p>
<ul>
<li>Core1 修改 Cell[0]</li>
<li>Core2 修改 Cell[1]</li>
</ul>
<p>那么 Core1 和 Core2 的缓存快中都有 Cell[0]、Cell[1]，此时我们的 Core1 修改 Cell[0] 就会导致 Core2 的缓存行失效需要重新加载数据，这个过程的时间就被浪费了，我们能不能将我们需要修改的 Cell 分开呢？</p>
<p>可以的，我们可以给 Cell 后面填充 padding，让我们一整行的缓存快填满，那么这个时候我们两个 Core 加载的就是不一样的数据了</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231103212252096.png" alt="image-20231103212252096"> </p>
<p>这样我们其中的 Core 更改数据就不会对其他的 Core 造成影响，性能就提升了</p>
<p>&#x3D;&#x3D;而 <code>@sun.misc.Contended</code> 就是来做内存填充的&#x3D;&#x3D;</p>
<h5 id="原理之-increment"><a href="#原理之-increment" class="headerlink" title="原理之 increment()"></a>原理之 increment()</h5><p>这是 LongAdder 的自增方法，我们看它到底做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">    add(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// as为累积单元数组，b为基础值，x为累加值</span></span><br><span class="line">    Cell[] as; <span class="type">long</span> b, v; <span class="type">int</span> m; Cell a;</span><br><span class="line">    <span class="comment">// 进入 if 的条件</span></span><br><span class="line">    <span class="comment">// as 不为空，表示发生竞争  ||  cas失败表示有竞争	</span></span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// as 还没创建</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// 当前对应的 Cell 还没有</span></span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// cas 给当前线程的 cell 累加失败</span></span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">            <span class="comment">// 创建 Cell 数组</span></span><br><span class="line">            longAccumulate(x, <span class="literal">null</span>, uncontended);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看一下 <code>longAccumulate(x, null, uncontended);</code> 如何创建数组的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 值为别是 x, null, ture</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">longAccumulate</span><span class="params">(<span class="type">long</span> x, LongBinaryOperator fn,</span></span><br><span class="line"><span class="params">                          <span class="type">boolean</span> wasUncontended)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="comment">// 当前线程还没有对应的 cell, 需要随机生成一个 h 值用来将当前线程绑定到 cell</span></span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化 probe</span></span><br><span class="line">        ThreadLocalRandom.current(); </span><br><span class="line">        <span class="comment">// h 对应新的 probe 值, 用来对应 cell</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// collide 为 true 表示需要扩容</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">collide</span> <span class="operator">=</span> <span class="literal">false</span>;              </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Cell[] as; Cell a; <span class="type">int</span> n; <span class="type">long</span> v;</span><br><span class="line">        <span class="comment">// 已经创建了 cells</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 当前线程还没有对应的 Cell 对象</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 没有加锁</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;       </span><br><span class="line">                    <span class="type">Cell</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cell</span>(x);   </span><br><span class="line">                    <span class="comment">// 再次判断是否有加锁</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="comment">// 是否已经创建，这个标记是退出使用的</span></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">created</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;             </span><br><span class="line">                            <span class="comment">// 下面就是将创建好的 Cell 放入数组中</span></span><br><span class="line">                            Cell[] rs; <span class="type">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="literal">null</span>) &#123;</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="comment">// 这里做一个解锁</span></span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 创建不成功就继续创建，成功就退出</span></span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;          </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 有竞争, 改变线程对应的 cell 来重试 cas</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)     </span><br><span class="line">                wasUncontended = <span class="literal">true</span>;   </span><br><span class="line">            <span class="comment">// fn为空个，使用 LongAdder 进行 CAS</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="literal">null</span>) ? v + x :</span><br><span class="line">                                         fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//  如果 cells 长度已经超过了最大核心数, 或者已经扩容, 改变线程对应的 cell 来重试 cas</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                collide = <span class="literal">false</span>;       </span><br><span class="line">            <span class="comment">// 产生冲突，需要扩容 </span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="comment">// 加锁成功，扩容 x 2</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;    </span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        cells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;              </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 改变线程对应的 cell</span></span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 还没有 cells, 尝试给 cellsBusy 加锁</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">init</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// 加锁成功，初始化 cells，长度为 2，并填充一个 null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;                       </span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Cell</span>(x);</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 初始化成功 break</span></span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 上面两种情况失败，尝试给 base 累加  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="literal">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h2><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>原子类的底层调用的是 Unsafe 的方法，它提供了底层操作内存、线程的方法</p>
<p>Unsafe 不能直接获取，可以通过反射获得或者通过系统加载</p>
<p>cas方法</p>
<ul>
<li>compareAndSwapInt</li>
<li>compareAndSwapLong</li>
<li>compareAndSwapObject</li>
</ul>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">// 获取 unsafe 对象，它封装了一个获取方法</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafe.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.获取域(属性)的偏移地址</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">id</span> <span class="operator">=</span> Student.class.getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> Student.class.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">idOffset</span> <span class="operator">=</span> unsafe.objectFieldOffset(id);</span><br><span class="line">        <span class="type">long</span> <span class="variable">nameOffset</span> <span class="operator">=</span> unsafe.objectFieldOffset(name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.执行 cas 操作</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        unsafe.compareAndSwapObject(student, idOffset, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        unsafe.compareAndSwapObject(student, nameOffset, <span class="literal">null</span>, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.验证</span></span><br><span class="line">        System.out.println(student);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="我自己的原子类"><a href="#我自己的原子类" class="headerlink" title="我自己的原子类"></a>我自己的原子类</h3><p>封装一下 Unsafe </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeAccessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe UNSAFE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            UNSAFE = (Unsafe) theUnsafe.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们写一个自己的原子类继承 Account 来实现存钱取钱操作</p>
<p>Account类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="comment">// 获取余额</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getBalance</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 取钱</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="number">10</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            list.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;剩余金额：&quot;</span> + account.getBalance()</span><br><span class="line">                + <span class="string">&quot; coat：&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAtomicInteger</span> <span class="keyword">implements</span> <span class="title class_">Account</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe UNSAFE;</span><br><span class="line">    <span class="comment">// 记得添加 valatile 让它可见</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> VALUE_OFFSET;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNSAFE = UnsafeAccessor.getUnsafe();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            VALUE_OFFSET = UNSAFE.objectFieldOffset(MyAtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAtomicInteger</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(Integer amount)</span> &#123;</span><br><span class="line">        <span class="type">int</span> prev, next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            prev = <span class="built_in">this</span>.value;</span><br><span class="line">            next = <span class="built_in">this</span>.value - amount;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, VALUE_OFFSET, prev, next));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Account.demo(<span class="keyword">new</span> <span class="title class_">MyAtomicInteger</span>(<span class="number">1000_0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">剩余金额：<span class="number">0</span> coat：139ms</span><br></pre></td></tr></table></figure>

<p>完美~~~</p>
<h1 id="六、共享模型之不可变"><a href="#六、共享模型之不可变" class="headerlink" title="六、共享模型之不可变"></a>六、共享模型之不可变</h1><h2 id="可变的安全性"><a href="#可变的安全性" class="headerlink" title="可变的安全性"></a>可变的安全性</h2><h3 id="1、案例：格式化时间"><a href="#1、案例：格式化时间" class="headerlink" title="1、案例：格式化时间"></a>1、案例：格式化时间</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">simpleDateFormatTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> dateFormat.parse(<span class="string">&quot;2023-01-01&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;date：&#123;&#125;&quot;</span>, date);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 SimpleDateFormat  不是线程安全的，运行上述会出现以下错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NumberFormatException: multiple points</span><br><span class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:<span class="number">1890</span>)</span><br><span class="line">	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:<span class="number">110</span>)</span><br><span class="line">	at java.lang.Double.parseDouble(Double.java:<span class="number">538</span>)</span><br><span class="line">	at java.text.DigitList.getDouble(DigitList.java:<span class="number">169</span>)</span><br><span class="line">	at java.text.DecimalFormat.parse(DecimalFormat.java:<span class="number">2089</span>)</span><br><span class="line">	at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:<span class="number">1869</span>)</span><br><span class="line">	at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:<span class="number">1514</span>)</span><br><span class="line">	at java.text.DateFormat.parse(DateFormat.java:<span class="number">364</span>)</span><br></pre></td></tr></table></figure>



<h3 id="2、解决思路-加锁"><a href="#2、解决思路-加锁" class="headerlink" title="2、解决思路 - 加锁"></a>2、解决思路 - 加锁</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">simpleDateFormatTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Date.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> dateFormat.parse(<span class="string">&quot;2023-01-01&quot;</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;date：&#123;&#125;&quot;</span>, date);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然这样可以解决问题，但是会带来性能上的损耗</p>
<h3 id="3、解决思路-使用-DateTimeFormatter"><a href="#3、解决思路-使用-DateTimeFormatter" class="headerlink" title="3、解决思路 - 使用 DateTimeFormatter"></a>3、解决思路 - 使用 DateTimeFormatter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dateTimeFormatterTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DateTimeFormatter</span> <span class="variable">dateFormatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> dateFormatter.parse(<span class="string">&quot;2023-10-10&quot;</span>, LocalDate::from);</span><br><span class="line">            log.debug(<span class="string">&quot;date：&#123;&#125;&quot;</span>, date);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">4</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">1</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">0</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">9</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">5</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">6</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">8</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">2</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">3</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br><span class="line"><span class="number">22</span>:<span class="number">01</span>:<span class="number">58.427</span> [Thread-<span class="number">7</span>] DEBUG Test01 - date：<span class="number">2023</span>-<span class="number">10</span>-<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>没问题~~~</p>
<h3 id="4、分析"><a href="#4、分析" class="headerlink" title="4、分析"></a>4、分析</h3><p>分析一下 DateTimeFormatter 为什么没有像 SimpleDateFormat 一样出现了异常</p>
<p>我们看一下它的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DateTimeFormatter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CompositePrinterParser printerParser;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Locale locale;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DecimalStyle decimalStyle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResolverStyle resolverStyle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;TemporalField&gt; resolverFields;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Chronology chrono;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZoneId zone;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们的 DateTimeFormatter 类中所有变量都是 private + final 修饰的，就连类都是 final 修饰的，妥妥的安全，那么为什么加 final 可以保证它的线程安全性呢？</p>
<h2 id="final-原理"><a href="#final-原理" class="headerlink" title="final 原理"></a>final 原理</h2><h2 id="不可变设计"><a href="#不可变设计" class="headerlink" title="不可变设计"></a>不可变设计</h2><p>下面我们用 String 类来做示例，看一下 JDK 如何设计不可变类</p>
<h3 id="final-使用"><a href="#final-使用" class="headerlink" title="final 使用"></a>final 使用</h3><ul>
<li>属性使用了 final 来修饰，属性不能被修改</li>
<li>类使用 final 修饰，让类不能被继承重写，保证了方法的不可变安全</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">char</span> value[];</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> hash; <span class="comment">// Default to 0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6849794470754667710L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ObjectStreamField</span>[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>



<h3 id="保护性拷贝"><a href="#保护性拷贝" class="headerlink" title="保护性拷贝"></a>保护性拷贝</h3><p>观察 String 类方法发现它里面也有很多修改属性的方法，我们拿 substring 来举例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(beginIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> value.length - beginIndex;</span><br><span class="line">    <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(subLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">String</span>(value, beginIndex, subLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码做的是边界检查，重点是下面这句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">String</span>(value, beginIndex, subLen);</span><br></pre></td></tr></table></figure>

<p>如果 beginIndex &#x3D;&#x3D; 0 则返回当前对象，否则创建一个新对象返回</p>
<p>我们在看一下 String 的构造方法中做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上面的都是在做边界检查</span></span><br><span class="line"><span class="built_in">this</span>.value = Arrays.copyOfRange(value, offset, offset+count);</span><br></pre></td></tr></table></figure>

<p>它将之前的 value 做了切割然后复制一份，&#x3D;&#x3D;这种通过创建副本对象来避免共享的手段叫【保护性拷贝】&#x3D;&#x3D;</p>
<h3 id="无状态类"><a href="#无状态类" class="headerlink" title="无状态类"></a>无状态类</h3><p>没有任何成员变量的类是线程安全的，这就是我们的无状态类</p>
<h2 id="设计模式-享元模式"><a href="#设计模式-享元模式" class="headerlink" title="设计模式 - 享元模式"></a>设计模式 - 享元模式</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>我们之前讲过 【保护性拷贝】，它让我们避免了变量共享，但是出现了新问题就是对象不断创建会导致内存撑爆，不利于程序的运行，所以我们有没有什么办法优化一下呢？</p>
<p>有的，我们可以对相同的对象进行重用，这样就能不能重复创建独享，这种需要重用数量有限的同一类对象的模式就是享元模式。</p>
<h3 id="体现"><a href="#体现" class="headerlink" title="体现"></a>体现</h3><p>在JDK中 Boolean，Byte，Short，Integer，Long，Character 等包装类提供了 valueOf 方法，以 Long 为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">valueOf</span><span class="params">(<span class="type">long</span> l)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= -<span class="number">128</span> &amp;&amp; l &lt;= <span class="number">127</span>) &#123; <span class="comment">// will cache</span></span><br><span class="line">        <span class="keyword">return</span> LongCache.cache[(<span class="type">int</span>)l + offset];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Long</span>(l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到如果值在 -128 ~ 127 时，它会从缓存中获取奖值返回，如果超过了缓存范围它就会创建新的对象返回，这个就是享元模式</p>
<blockquote>
<p><strong>注意：</strong></p>
<ul>
<li>Byte, Short, Long 缓存的范围都是 -128~127</li>
<li>Character 缓存的范围是 0~127</li>
<li>Integer的默认范围是 -128~127</li>
<li>最小值不能变</li>
<li>但最大值可以通过调整虚拟机参数 &#96; </li>
<li>-Djava.lang.Integer.IntegerCache.high&#96; 来改变</li>
<li>Boolean 缓存了 TRUE 和 FALSE</li>
</ul>
</blockquote>
<h3 id="DIY-数据库连接池"><a href="#DIY-数据库连接池" class="headerlink" title="DIY-数据库连接池"></a>DIY-数据库连接池</h3><h4 id="简化版"><a href="#简化版" class="headerlink" title="简化版"></a>简化版</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DIY 连接池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;DIYPool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DIYPool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Pool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pool</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">                <span class="type">MockConnection</span> <span class="variable">conn</span> <span class="operator">=</span> pool.getConnection();</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125; 获取连接 &#123;&#125;&quot;</span>, name, conn.getName());</span><br><span class="line">                TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">                pool.free(conn);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125; 释放连接 &#123;&#125;&quot;</span>, name, conn.getName());</span><br><span class="line">            &#125;, <span class="string">&quot;t&quot;</span> + i).start();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Pool&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MockConnection[] connections;</span><br><span class="line">    <span class="comment">// 连接状态数组，空闲-0，繁忙-1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicIntegerArray states;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pool</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        states = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(size);</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">MockConnection</span>[size];</span><br><span class="line">        log.debug(<span class="string">&quot;============== 创建连接 ===============&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> <span class="title class_">MockConnection</span>(<span class="string">&quot;连接&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取连接</span></span><br><span class="line">    <span class="keyword">public</span> MockConnection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 遍历判断是否有空闲的连接</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (states.get(i) == <span class="number">0</span> &amp;&amp; states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> connections[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 归还连接</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; connections.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (conn == connections[i]) &#123;</span><br><span class="line">                <span class="comment">// 设置成空闲状态，它不用进行 cas 因为它是此时是获取锁的，所以没有其他线程竞争</span></span><br><span class="line">                states.set(i, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockConnection</span> <span class="keyword">implements</span> <span class="title class_">Connection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MockConnection</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 实现忽略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">53.224</span> [main] DEBUG Pool - ============== 创建连接 ===============</span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">53.274</span> [t0] DEBUG DIYPool - t0 获取连接 连接<span class="number">0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">53.274</span> [t1] DEBUG DIYPool - t1 获取连接 连接<span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">54.291</span> [t0] DEBUG DIYPool - t0 释放连接 连接<span class="number">0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">54.291</span> [t1] DEBUG DIYPool - t1 释放连接 连接<span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">54.291</span> [t3] DEBUG DIYPool - t3 获取连接 连接<span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">54.291</span> [t4] DEBUG DIYPool - t4 获取连接 连接<span class="number">0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">55.305</span> [t3] DEBUG DIYPool - t3 释放连接 连接<span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">55.305</span> [t4] DEBUG DIYPool - t4 释放连接 连接<span class="number">0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">55.305</span> [t2] DEBUG DIYPool - t2 获取连接 连接<span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">32</span>:<span class="number">56.319</span> [t2] DEBUG DIYPool - t2 释放连接 连接<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>结果没出题，释放连接后才可以获取连接</p>
<blockquote>
<p>这是参考了 Tomcat 的 JDBC连接池实现源码，建议可以读一下它的源码</p>
<p>拓展：不建议线上自己去写连接池，可以使用 c3p0、Druid等成熟的开源框架</p>
</blockquote>
<h4 id="改进版"><a href="#改进版" class="headerlink" title="改进版"></a>改进版</h4><p>改进的地方</p>
<ul>
<li>连接的增长和收缩，比如最小连接数和最大连接数</li>
<li>超市等待，如果连接池的连接一直被占用，那么就直接让它超时结束</li>
<li>连接保话（可用性检测），通过发送 SQL 语句来检测活性，如果一定时间内没有返回那么就是连接超时</li>
<li>分布式 hash，一个连接池维护<strong>多个数据库</strong>的多个连接，我们可以通过计算hash来获取对应位置的连接</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="七、工具之线程池"><a href="#七、工具之线程池" class="headerlink" title="七、工具之线程池"></a>七、工具之线程池</h1><p>本章内容</p>
<p>- </p>
<h2 id="自定义线程池"><a href="#自定义线程池" class="headerlink" title="自定义线程池"></a>自定义线程池</h2><p>之前我们讲过享元模式，它可以减少重复对象的创建，节省内存提高了性能。我们的线程池也是如此防止线程频繁的创建，我们可以复用之前创建的线程来执行我们的任务，提高我们的内存和提高性能。</p>
<p>我们先试着自己写一个线程池，后面我们会讲成熟的线程池</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231107164310936.png" alt="image-20231107164310936"> </p>
<p>上图是我们的架构图，它的主要部件：</p>
<ul>
<li>BlockerQueue：阻塞队列，当我们的线程池中的线程全部繁忙，那么就让他们在阻塞队列中等待线程执行结束，线程执行完其他任务之后就会从阻塞队列中获取 task 来执行，这里使用的是我们的生产者消费者模式。生产方一般是多余消费方，所以我们进行阻塞等待执行完毕。</li>
<li>ThreadPool：线程池，存放我们创建的线程，从 BlockedQueue 中获取 task 来执行</li>
</ul>
<h3 id="1-创建BlockedQueue-阻塞队列"><a href="#1-创建BlockedQueue-阻塞队列" class="headerlink" title="1.创建BlockedQueue 阻塞队列"></a>1.创建BlockedQueue 阻塞队列</h3><p>首先我们需要创建一个 BlockedQueue 对象来保存我们的 task</p>
<ul>
<li>addTask：添加 task，一直等待</li>
<li>timeOutAddTask：添加 task，超过一定时间就不等待了</li>
<li>getTask：获取 task，一直等待</li>
<li>timeOutGetTask：获取task，超过一定时间就不等待</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阻塞队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ThreadPoolTest&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockedQueue</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// 队列保存 task</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;(); <span class="comment">// 大多数情况下，它的性能比 LinkedList 好</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 锁</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生产者条件变量，如果它满了那么就让它进行等待</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">fullWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费者条件变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">idleWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞队列最大容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capcity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlockedQueue</span><span class="params">(<span class="type">int</span> capcity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capcity = capcity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前队列的数量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> tasks.size();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞添加</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTask</span><span class="params">(T task)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 如果队列满了那么就一直等待</span></span><br><span class="line">            <span class="keyword">while</span> (tasks.size() == capcity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;阻塞队列已满...&quot;</span>);</span><br><span class="line">                    fullWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            tasks.addLast(task);</span><br><span class="line">            log.debug(<span class="string">&quot;添加任务：&#123;&#125;&quot;</span>, task);</span><br><span class="line">            idleWaitSet.signal();       <span class="comment">// 唤醒空闲的线程</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超时等待阻塞添加</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">timeOutAddTask</span><span class="params">(T task, <span class="type">long</span> time, TimeUnit unit)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(time);</span><br><span class="line">            <span class="comment">// 如果队列满了那么就一直等待</span></span><br><span class="line">            <span class="keyword">while</span> (tasks.size() == capcity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// awaitNanos 方法返回等待的纳秒数</span></span><br><span class="line">                    nanos = fullWaitSet.awaitNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            tasks.add(task);</span><br><span class="line">            idleWaitSet.signal();       <span class="comment">// 唤醒空闲的线程</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞获取</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 如果它为空，那么让它等待</span></span><br><span class="line">            <span class="keyword">while</span> (tasks.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    idleWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">task</span> <span class="operator">=</span> tasks.removeFirst();</span><br><span class="line">            log.debug(<span class="string">&quot;添加任务 &#123;&#125;&quot;</span>, task);</span><br><span class="line">            fullWaitSet.signal();       <span class="comment">// 此时队列中有位置了，所以唤醒生产者</span></span><br><span class="line">            <span class="keyword">return</span> task;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超时等待阻塞获取</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">timeOutGetTask</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(time);</span><br><span class="line">            <span class="comment">// 如果它为空，那么让它等待</span></span><br><span class="line">            <span class="keyword">while</span> (tasks.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 记得要进行退出</span></span><br><span class="line">                    <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    log.debug(<span class="string">&quot;阻塞等待...&quot;</span>);</span><br><span class="line">                    nanos =  idleWaitSet.awaitNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">task</span> <span class="operator">=</span> tasks.removeFirst();</span><br><span class="line">            fullWaitSet.signal();       <span class="comment">// 此时队列中有位置了，所以唤醒生产者</span></span><br><span class="line">            <span class="keyword">return</span> task;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-创建线程池"><a href="#2-创建线程池" class="headerlink" title="2.创建线程池"></a>2.创建线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ThreadPoolTest&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPool</span> &#123;</span><br><span class="line">    <span class="comment">// 阻塞队列</span></span><br><span class="line">    <span class="keyword">private</span> BlockedQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程集合 - 保存线程</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;Worker&gt; workers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心线程数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> coreSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超时时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">    <span class="comment">// 时间单位</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit unit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPool</span><span class="params">(<span class="type">int</span> coreSize, <span class="type">int</span> capcity, <span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.unit = unit;</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="built_in">this</span>.coreSize);</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">BlockedQueue</span>&lt;&gt;(capcity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">            <span class="comment">// 线程没满就创建线程运行，如果线程池满了，则添加任务到阻塞队列中</span></span><br><span class="line">            <span class="keyword">if</span> (workers.size() &lt; coreSize) &#123;</span><br><span class="line">                <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">                log.debug(<span class="string">&quot;新增 worker &#123;&#125;&quot;</span>, worker);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                taskQueue.timeOutAddTask(task, timeout, unit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 执行条件：当前 task 不为空，队列中有 task</span></span><br><span class="line">            <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = taskQueue.timeOutGetTask(timeout, unit)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;执行任务：&#123;&#125;&quot;</span>, task);</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没有任务了就移除</span></span><br><span class="line">            <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">                workers.remove(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-测试"><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ThreadPoolTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyPool</span> <span class="variable">myPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyPool</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i;</span><br><span class="line">            myPool.execute(() -&gt; &#123;</span><br><span class="line">                TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, j);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">39.959</span> [main] DEBUG ThreadPoolTest - 阻塞队列已满...</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">39.959</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">1</span>/<span class="number">186276003</span>@3a9f7f17</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">39.962</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">0</span></span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">41.967</span> [main] DEBUG ThreadPoolTest - 阻塞队列已满...</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">41.967</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">1</span>/<span class="number">186276003</span>@4ea86b5d</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">41.967</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">1</span></span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">43.974</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">1</span>/<span class="number">186276003</span><span class="meta">@f0ed258</span></span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">43.974</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">2</span></span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">45.986</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">1</span>/<span class="number">186276003</span>@1fb2096f</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">45.986</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">3</span></span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">47.987</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">1</span>/<span class="number">186276003</span>@609096d0</span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">47.987</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">4</span></span><br><span class="line"><span class="number">20</span>:<span class="number">11</span>:<span class="number">49.987</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 阻塞等待...</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：从结果中我们可以知道队列满了两次</p>
<ul>
<li>一开始执行了 task0，task1 和 task2 放入阻塞队列中，task3, task4阻塞，日志输出队列已满</li>
<li>接着 task0 结束，task1 上位，队列空一个，task2 加入</li>
<li>此时 task4 再加入就会被阻塞等待，日志输出队列已满</li>
<li>最后 task1 执行完毕，task2上位，task4加入队列中</li>
<li>因为后面没有其他 task 了，所以没有输出队列已满</li>
</ul>
<h3 id="4、情况：阻塞队列满了"><a href="#4、情况：阻塞队列满了" class="headerlink" title="4、情况：阻塞队列满了"></a>4、情况：阻塞队列满了</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>我们的做法是如果当前没有空闲的线程去执行 task，就将任务放入到 阻塞队列中，那么如果此时阻塞队列满了，这些 task该如何处理呢？</p>
<p>列举一些处理方式：</p>
<ul>
<li>一直等待</li>
<li>带超时等待</li>
<li>让调用者放弃任务执行</li>
<li>让调用者抛出异常</li>
<li>让调用者自己去执行任务</li>
</ul>
<p>但是这么多的选项我们要一个个去写方法供调用者选择吗？当然不是，我们可以交给调用者自己来定义当阻塞队列满时该如何操作，因为我们提供的这些选择也可能不是人家想要的，所以让调用者自定义操作是比较稳妥的。</p>
<p>所以，这里我们用上 <strong>设计模式及 - 策略模式</strong> 来做这个改进</p>
<h4 id="代码改进"><a href="#代码改进" class="headerlink" title="代码改进"></a>代码改进</h4><p>首先我们这里需要定义一个接口，我们定义规范，然后让调用者来做实现。我们这里只提供一个抽象方法，所以我们选择函数式接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">RejectPolicy</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(BlockedQueue&lt;T&gt; queue, T task)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为是队列的功能实现，所以我们需要再 BlockedQueue 中添加一个方法，这个方法来做我们的自定义操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryAddTask</span><span class="params">(RejectPolicy&lt;T&gt; rejectPolicy, T task)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 判断队列中是否已满</span></span><br><span class="line">        <span class="keyword">if</span> (tasks.size() == capcity) &#123;</span><br><span class="line">            rejectPolicy.reject(<span class="built_in">this</span>, task);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;加入任务队列： &#123;&#125;&quot;</span>, task);</span><br><span class="line">            tasks.addLast(task);</span><br><span class="line">            idleWaitSet.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们需要使用这个自定义的方法，修改 execute 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">        <span class="comment">// 线程没满就创建线程运行，如果线程池满了，则添加任务到阻塞队列中</span></span><br><span class="line">        <span class="keyword">if</span> (workers.size() &lt; coreSize) &#123;</span><br><span class="line">            <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">            workers.add(worker);</span><br><span class="line">            worker.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// taskQueue.timeOutAddTask(task, timeout, unit);</span></span><br><span class="line">            <span class="comment">// rejectPolicy 通过构造器传入进来</span></span><br><span class="line">            taskQueue.tryAddTask(rejectPolicy, task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MyPool</span> <span class="variable">myPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyPool</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, TimeUnit.SECONDS,</span><br><span class="line">            ((queue, task) -&gt; &#123;</span><br><span class="line">                <span class="comment">// 一直等待</span></span><br><span class="line">                <span class="comment">// queue.addTask(task);</span></span><br><span class="line">                <span class="comment">// 带超时等待</span></span><br><span class="line">                <span class="comment">// queue.timeOutAddTask(task, 2, TimeUnit.SECONDS);</span></span><br><span class="line">                <span class="comment">// 让调用者放弃任务执行</span></span><br><span class="line">                <span class="comment">// log.debug(&quot;放弃任务：&#123;&#125;&quot;, task);</span></span><br><span class="line">                <span class="comment">// 让调用者抛出异常</span></span><br><span class="line">                <span class="comment">// throw new RuntimeException(&quot;任务执行失败：&quot; + task);</span></span><br><span class="line">                <span class="comment">// 让调用者自己去执行任务</span></span><br><span class="line">                task.run();</span><br><span class="line">            &#125;));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i;</span><br><span class="line">        myPool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, j);</span><br><span class="line">            TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">53.319</span> [main] DEBUG ThreadPoolTest - 加入任务队列： com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">2</span>/<span class="number">485815673</span>@5e8c92f4</span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">53.319</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">2</span>/<span class="number">485815673</span>@6c02e750</span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">53.323</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">0</span></span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">53.323</span> [main] DEBUG ThreadPoolTest - 加入任务队列： com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">2</span>/<span class="number">485815673</span>@3581c5f3</span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">53.323</span> [main] DEBUG ThreadPoolTest - <span class="number">3</span></span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">55.333</span> [main] DEBUG ThreadPoolTest - <span class="number">4</span></span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">57.343</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">2</span>/<span class="number">485815673</span>@5e8c92f4</span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">57.343</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">1</span></span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">59.354</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 执行任务：com.xiaozhi.tool07.ThreadPoolTest$$Lambda$<span class="number">2</span>/<span class="number">485815673</span>@3581c5f3</span><br><span class="line"><span class="number">20</span>:<span class="number">55</span>:<span class="number">59.354</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - <span class="number">2</span></span><br><span class="line"><span class="number">20</span>:<span class="number">56</span>:<span class="number">01.355</span> [Thread-<span class="number">0</span>] DEBUG ThreadPoolTest - 阻塞队列为空，等待中...</span><br></pre></td></tr></table></figure>

<p>可以看到有些任务是由调用者(main) 去执行的~~~</p>
<h2 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h2><p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231108160124123.png" alt="image-20231108160124123"> </p>
<h3 id="ThreadPoolExecutor-类分析"><a href="#ThreadPoolExecutor-类分析" class="headerlink" title="ThreadPoolExecutor 类分析"></a>ThreadPoolExecutor 类分析</h3><h4 id="线程池状态表示"><a href="#线程池状态表示" class="headerlink" title="线程池状态表示"></a>线程池状态表示</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure>

<p>在 ThreadPoolExecutor 声明了五种状态</p>
<table>
<thead>
<tr>
<th align="left">状态名</th>
<th align="center">高3位</th>
<th align="center">接收新任务</th>
<th align="center">处理阻塞队列中的任务</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">RUNNING</td>
<td align="center">111</td>
<td align="center">Y</td>
<td align="center">Y</td>
<td align="left">运行状态</td>
</tr>
<tr>
<td align="left">SHUTDOWN</td>
<td align="center">000</td>
<td align="center">N</td>
<td align="center">Y</td>
<td align="left">不会再接收新的任务，但是还是会执行阻塞队列中的任务</td>
</tr>
<tr>
<td align="left">STOP</td>
<td align="center">001</td>
<td align="center">N</td>
<td align="center">N</td>
<td align="left">不会接受新任务，也不会执行阻塞队列中的任务</td>
</tr>
<tr>
<td align="left">TIDYING</td>
<td align="center">010</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="left">任务全执行完毕，活动线程为0即进入终结状态</td>
</tr>
<tr>
<td align="left">TERMINATED</td>
<td align="center">011</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="left">终结状态</td>
</tr>
</tbody></table>
<p>ThreadPoolExecutor 使用 int 类型的高三位表示线程池的状态，剩下的 29 位表示线程的数量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreadPoolExecutor 类</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// 线程数量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>

<p>状态 和 线程数量存放在一个 原子变量 ctl 中，目的是将他们两个合二为一，减少一次 cas 操作，可以看到上面的代码中我们的 ctl 是一个原子整数。ctlOf 方法的功能就是使用异或将两个数合在一起。而状态的表示在上面我们已经看到过了</p>
<h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：</p>
<ul>
<li>corePoolSize：核心线程数（最多保留的线程数）</li>
<li>maximumPoolSize：最大线程数</li>
<li>keepAliveTime：急救线程生存时间</li>
<li>unit：急救线程生存时间单位</li>
<li>workQueue：阻塞队列</li>
<li>threadFactory：线程工厂，自定义线程的创建</li>
<li>handler：拒绝策略，当阻塞队列满时做出的策略</li>
</ul>
<p><strong>工作方式</strong>：</p>
<p><strong>核心线程</strong>：</p>
<ul>
<li>线程池一开始是没有线程的，当有任务提交了，线程池才会创建爱一个线程来执行任务</li>
<li>当线程数达到 corePoolSize 后，任务会被放到阻塞队列中，等待空闲的线程来获取执行</li>
</ul>
<p><strong>急救线程</strong>：</p>
<ul>
<li>如果选择的是有界阻塞队列时，当队列满时，就会创建  <strong>maximumPoolSize - corePoolSize</strong> 数量的急救线程来处理溢出的任务</li>
<li>当高峰期过后，超过 corePoolSize 的急救线程在一段时间内没有任务做，那么它就会被销毁，这个时间是由 <strong>keepAliveTime 和 unit</strong> 来控制</li>
</ul>
<p><strong>拒绝策略</strong>：如果核心线程 + 急救线程的数量达到 maximumPoolSize 时仍有任务这时就会执行拒绝策略。拒绝策略 JDK 提供了 4 种实现，其他著名的框架也提供了不同的实现</p>
<ul>
<li><p><strong>JDK</strong>：</p>
<p>  RejectedExecutionHandler 的实现类如下：</p>
<p>  <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231109002220187.png" alt="image-20231109002220187"> </p>
<ul>
<li><p>AbortPolicy：让调用者抛出 RejectedExecutionException 异常，这是默认策略</p>
</li>
<li><p>CallerRunsPolicy：让调用者运行任务</p>
</li>
<li><p>DiscardPolicy：放弃本次任务</p>
</li>
<li><p>DiscardOldestPolicy：放弃队列中最早的任务，本任务取而代之</p>
</li>
</ul>
</li>
<li><p><strong>其他框架</strong>：</p>
<ul>
<li><p>Dubbo 的实现，在抛出 RejectedExecutionException 异常之前会记录日志，并 dump 线程栈信息，方便定位问题</p>
</li>
<li><p>Netty 的实现，是创建一个新线程来执行任务</p>
</li>
<li><p>ActiveMQ 的实现，带超时等待（60s）尝试放入队列，类似我们之前自定义的拒绝策略</p>
</li>
<li><p>PinPoint 的实现，它使用了一个拒绝策略链，会逐一尝试策略链中每种拒绝策略</p>
</li>
</ul>
</li>
</ul>
<h3 id="创建线程池"><a href="#创建线程池" class="headerlink" title="创建线程池"></a>创建线程池</h3><p>JDK 提供一个 Executors 类通过众多工厂方法创建各种用途的线程池，不需要我们手动去 new</p>
<h4 id="newFixedThreadPool"><a href="#newFixedThreadPool" class="headerlink" title="newFixedThreadPool"></a>newFixedThreadPool</h4><p>特点：</p>
<ul>
<li>它可以创建只有核心线程的固定数量线程池</li>
<li>阻塞队列是无界的，可以放置任意数量的 task</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                  <span class="comment">// 没有救急线程，所以秒数为 0</span></span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="comment">// 无边界的阻塞队列</span></span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用</strong></p>
<p>ExecutorService#execute(Runnable)：接收一个task，然后执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;执行任务：&#123;&#125;&quot;</span>, finalI);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00:33:26.861 [pool-1-thread-4] DEBUG ExecutorsTest - 执行任务：3</span><br><span class="line">00:33:26.861 [pool-1-thread-5] DEBUG ExecutorsTest - 执行任务：4</span><br><span class="line">00:33:26.861 [pool-1-thread-1] DEBUG ExecutorsTest - 执行任务：0</span><br><span class="line">00:33:26.861 [pool-1-thread-2] DEBUG ExecutorsTest - 执行任务：1</span><br><span class="line">00:33:26.861 [pool-1-thread-3] DEBUG ExecutorsTest - 执行任务：2</span><br><span class="line">00:33:27.875 [pool-1-thread-3] DEBUG ExecutorsTest - 执行任务：9</span><br><span class="line">00:33:27.875 [pool-1-thread-1] DEBUG ExecutorsTest - 执行任务：7</span><br><span class="line">00:33:27.875 [pool-1-thread-4] DEBUG ExecutorsTest - 执行任务：5</span><br><span class="line">00:33:27.875 [pool-1-thread-5] DEBUG ExecutorsTest - 执行任务：6</span><br><span class="line">00:33:27.875 [pool-1-thread-2] DEBUG ExecutorsTest - 执行任务：8</span><br></pre></td></tr></table></figure>

<p>后面五个一秒后被执行了</p>
<p>&#x3D;&#x3D;<strong>注意</strong>：此时的程序还未结束，核心线程是不会消失的，所以它们会一直在等待，因此程序不会结束&#x3D;&#x3D;</p>
<h4 id="newCachedThreadPool"><a href="#newCachedThreadPool" class="headerlink" title="newCachedThreadPool"></a>newCachedThreadPool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>核心线程为 0，最大线程数是 Integer.MAX_VALUE，也就是说全部都是 急用线程</li>
<li>急用线程的存活是见是 60s，最多创建 Integer.MAX_VALUE 个急用线程</li>
<li>SynchronousQueue 队列没有容量，只有当线程来取的时候才能放进任务（一手交钱一手交货）</li>
</ul>
<blockquote>
<p><strong>评价</strong> 整个线程池表现为线程数会根据任务量不断增长，没有上限，当任务执行完毕，空闲 1分钟后释放线程。 适合任务数比较密集，但每个任务执行时间较短的情况</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method02</span><span class="params">()</span> &#123;</span><br><span class="line">    SynchronousQueue&lt;Integer&gt; synchronousQueue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            synchronousQueue.put(<span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;putted &#123;&#125;&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            synchronousQueue.put(<span class="number">2</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;putted &#123;&#125;&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">take</span> <span class="operator">=</span> synchronousQueue.take();</span><br><span class="line">            log.debug(<span class="string">&quot;taking &#123;&#125;&quot;</span>, take);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">take</span> <span class="operator">=</span> synchronousQueue.take();</span><br><span class="line">            log.debug(<span class="string">&quot;taking &#123;&#125;&quot;</span>, take);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">56</span>:<span class="number">44.499</span> [t2] DEBUG ExecutorsTest - taking <span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">56</span>:<span class="number">44.499</span> [t1] DEBUG ExecutorsTest - putted <span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">56</span>:<span class="number">44.502</span> [t1] DEBUG ExecutorsTest - putted <span class="number">2</span></span><br><span class="line"><span class="number">00</span>:<span class="number">56</span>:<span class="number">44.502</span> [t3] DEBUG ExecutorsTest - taking <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>t2 先 take，然后 t3 等待 t2 获取，所以 putted 2输出了，最后它才获取了 take</p>
<p><strong>newSingleThreadExecutor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：只有一个核心线程和一个无界的阻塞队列</p>
<p><strong>使用场景</strong>：希望任务一个一个按顺序执行</p>
<p><strong>手动创建和它区别</strong>：</p>
<ul>
<li><p>手动创建任务失败了没有补救措施，而线程池会保证有一个线程存在</p>
</li>
<li><p>线程池的个数不能被修改，FinalizableDelegatedExecutorService 使用装饰器模式，对外暴露了 ExecutorService 接口，因此不能调用修改方法来修改它的个数</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">DelegatedExecutorService</span> &#123;</span><br><span class="line">    FinalizableDelegatedExecutorService(ExecutorService executor) &#123;</span><br><span class="line">        <span class="built_in">super</span>(executor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finalize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;输出：&#123;&#125;&quot;</span>, finalI);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>:08:<span class="number">06.297</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ExecutorsTest - 输出：<span class="number">0</span></span><br><span class="line"><span class="number">01</span>:08:<span class="number">06.302</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ExecutorsTest - 输出：<span class="number">1</span></span><br><span class="line"><span class="number">01</span>:08:<span class="number">06.302</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ExecutorsTest - 输出：<span class="number">2</span></span><br><span class="line"><span class="number">01</span>:08:<span class="number">06.302</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ExecutorsTest - 输出：<span class="number">3</span></span><br><span class="line"><span class="number">01</span>:08:<span class="number">06.302</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ExecutorsTest - 输出：<span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>结果有序输出~~~</p>
<h3 id="提交任务"><a href="#提交任务" class="headerlink" title="提交任务"></a>提交任务</h3><p>等待任务的执行结果返回才往下执行</p>
<h4 id="ExecutorService方法"><a href="#ExecutorService方法" class="headerlink" title="ExecutorService方法"></a>ExecutorService方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 提交任务 task，用返回值 Future 获得任务执行结果</span></span><br><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交 tasks 中所有任务，所有任务都完成才能提交</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="line"> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交 tasks 中所有任务，所有任务都完成才能提交，带超时时间</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="title function_">invokeAll</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span><br><span class="line"><span class="params"> <span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line"> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span><br><span class="line"> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消，带超时时间</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span><br><span class="line"><span class="params"> <span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line"> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br></pre></td></tr></table></figure>



<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SubmitTaskTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubmitTaskTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// submitTest();</span></span><br><span class="line">        <span class="comment">// invokeAllTest();</span></span><br><span class="line">        <span class="comment">// invokeAnyTest();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeAllTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        List&lt;Future&lt;Object&gt;&gt; futures = threadPool.invokeAll(Arrays.asList(</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;执行完毕 1&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;str1&quot;</span>;</span><br><span class="line">                &#125;,</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;执行完毕 2&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;str2&quot;</span>;</span><br><span class="line">                &#125;,</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;执行完毕 3&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;str3&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        ));</span><br><span class="line">        futures.forEach(f -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;result：&#123;&#125;&quot;</span>, f.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           结果输出：</span></span><br><span class="line"><span class="comment">                01:41:12.051 [pool-1-thread-1] DEBUG SubmitTaskTest - 执行完毕 1</span></span><br><span class="line"><span class="comment">                01:41:13.058 [pool-1-thread-3] DEBUG SubmitTaskTest - 执行完毕 3</span></span><br><span class="line"><span class="comment">                01:41:14.059 [pool-1-thread-2] DEBUG SubmitTaskTest - 执行完毕 2</span></span><br><span class="line"><span class="comment">                01:41:14.059 [main] DEBUG SubmitTaskTest - result：str1</span></span><br><span class="line"><span class="comment">                01:41:14.060 [main] DEBUG SubmitTaskTest - result：str2</span></span><br><span class="line"><span class="comment">                01:41:14.060 [main] DEBUG SubmitTaskTest - result：str3</span></span><br><span class="line"><span class="comment">                // 全部执行完了才会提交结果</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeAnyTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> threadPool.invokeAny(Arrays.asList(</span><br><span class="line">                () -&gt;  &#123;</span><br><span class="line">                    TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;str1&quot;</span>;</span><br><span class="line">                &#125;,</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;str2&quot;</span>;</span><br><span class="line">                &#125;,</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;str3&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        ));</span><br><span class="line">        log.debug(<span class="string">&quot;result：&#123;&#125;&quot;</span>, res);    <span class="comment">// result：str1，它的执行时间最短</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">submitTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">        Future&lt;?&gt; future = threadPool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> (String) future.get();</span><br><span class="line">        log.debug(<span class="string">&quot;result：&#123;&#125;&quot;</span>, str);    <span class="comment">// result：test</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="关闭线程池"><a href="#关闭线程池" class="headerlink" title="关闭线程池"></a>关闭线程池</h3><h4 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	线程池状态变为 SHUTDOWN</span></span><br><span class="line"><span class="comment">		- 不会接收新任务</span></span><br><span class="line"><span class="comment"> 		- 会完成已加入阻塞队列中的任务</span></span><br><span class="line"><span class="comment"> 		- 次方法不会阻塞调用线程的执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>ThreadPoolExecutor 中的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建锁</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// 修改线程池状态</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// 仅会打断空闲线程</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        onShutdown();	<span class="comment">// 扩展点 ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尝试终结</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shutdownTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">        pool.execute(() -&gt; &#123;</span><br><span class="line">            TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;执行任务：&#123;&#125;&quot;</span>, finalI);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;执行关闭操作...&quot;</span>);</span><br><span class="line">    pool.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">45</span>:<span class="number">47.937</span> [main] DEBUG ShutdownTest - 执行关闭操作...</span><br><span class="line"><span class="number">15</span>:<span class="number">45</span>:<span class="number">49.945</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG ShutdownTest - 执行任务：<span class="number">3</span></span><br><span class="line"><span class="number">15</span>:<span class="number">45</span>:<span class="number">49.945</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG ShutdownTest - 执行任务：<span class="number">2</span></span><br><span class="line"><span class="number">15</span>:<span class="number">45</span>:<span class="number">49.945</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG ShutdownTest - 执行任务：<span class="number">4</span></span><br><span class="line"><span class="number">15</span>:<span class="number">45</span>:<span class="number">49.945</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ShutdownTest - 执行任务：<span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">45</span>:<span class="number">49.945</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG ShutdownTest - 执行任务：<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可以看到我们是先关闭，然后才执行的~~</p>
<h4 id="shutdownNow"><a href="#shutdownNow" class="headerlink" title="shutdownNow"></a>shutdownNow</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	线程池状态变为 STOP</span></span><br><span class="line"><span class="comment">		- 不会接收新任务</span></span><br><span class="line"><span class="comment">		- 不会处理阻塞队列中的任务</span></span><br><span class="line"><span class="comment">		- 使用 interupt 的方式中断正在执行任务的线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// 修改线程状态</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// 打断所有线程</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// 获取队列中剩余的任务</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尝试关闭</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="使用效果"><a href="#使用效果" class="headerlink" title="使用效果"></a>使用效果</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ShutdownTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShutdownTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">pool2</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">(ExecutorService pool, Consumer&lt;ExecutorService&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">            pool.execute(() -&gt; &#123;</span><br><span class="line">                TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;执行任务：&#123;&#125;&quot;</span>, finalI);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        consumer.accept(pool);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;========== shutdown =========&quot;</span>);</span><br><span class="line">        demo(pool , ExecutorService::shutdown);</span><br><span class="line">        TimeUtil.sleep(<span class="number">3</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;========== shutdownNow =========&quot;</span>);</span><br><span class="line">        demo(pool2, ExecutorService::shutdownNow);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">15.007</span> [main] DEBUG ShutdownTest - ========== shutdown =========</span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">15.066</span> [main] DEBUG ShutdownTest - 执行关闭...</span><br><span class="line"><span class="comment">// 关闭后还是将队列中的任务执行完毕了</span></span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">16.067</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG ShutdownTest - 执行任务：<span class="number">3</span></span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">16.067</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG ShutdownTest - 执行任务：<span class="number">4</span></span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">16.067</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ShutdownTest - 执行任务：<span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">16.067</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG ShutdownTest - 执行任务：<span class="number">1</span></span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">16.082</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG ShutdownTest - 执行任务：<span class="number">2</span></span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">18.078</span> [main] DEBUG ShutdownTest - ========== shutdownNow =========</span><br><span class="line"><span class="number">16</span>:<span class="number">07</span>:<span class="number">18.079</span> [main] DEBUG ShutdownTest - 执行关闭...</span><br><span class="line"><span class="comment">// shutdownNow 它调用了打断线程的方法，所以 sleep 被打断就会报错</span></span><br><span class="line">Exception in thread <span class="string">&quot;pool-2-thread-5&quot;</span> Exception in thread <span class="string">&quot;pool-2-thread-1&quot;</span> Exception in thread <span class="string">&quot;pool-2-thread-2&quot;</span> Exception in thread <span class="string">&quot;pool-2-thread-4&quot;</span> Exception in thread <span class="string">&quot;pool-2-thread-3&quot;</span> java.lang.RuntimeException: java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at com.xiaozhi.utils.TimeUtil.sleep(TimeUtil.java:<span class="number">14</span>)</span><br><span class="line">	at com.xiaozhi.tool07.ShutdownTest.lambda$demo$<span class="number">0</span>(ShutdownTest.java:<span class="number">23</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">750</span>)</span><br></pre></td></tr></table></figure>



<h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不在 RUNNING 状态的线程池，此方法就返回 true</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isShutdown</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程池状态是否是 TERMINATED</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isTerminated</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 shutdown 后，由于调用线程并不会等待所有任务运行结束，因此如果它想在线程池 TERMINATED 后做些事情，可以利用此方法等待</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">awaitTermination</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    threadPool.execute(() -&gt; &#123; System.out.println(<span class="string">&quot;aaa&quot;</span>); &#125;);</span><br><span class="line">    threadPool.shutdown();</span><br><span class="line">    System.out.println(threadPool.isShutdown());</span><br><span class="line">    TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">    System.out.println(threadPool.isTerminated());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="任务调度线程池"><a href="#任务调度线程池" class="headerlink" title="任务调度线程池"></a>任务调度线程池</h3><h4 id="Timer-不推荐"><a href="#Timer-不推荐" class="headerlink" title="Timer(不推荐)"></a>Timer(不推荐)</h4><p>在任务调度线程池功能加入之前，可以使用 java.util.Timer 来做任务调度，但是由于它是单线程调度的，因此所有的任务都是串行的，同一时间内只有一个任务可以被执行，<strong>前一个任务的延迟或异常会影响后面的任务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 两个任务延迟1秒后执行</span></span><br><span class="line">    timer.schedule(task1, <span class="number">1000</span>);</span><br><span class="line">    timer.schedule(task2, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">13</span>:<span class="number">52.239</span> [main] DEBUG ScheduledTasksTest - start...</span><br><span class="line"><span class="number">17</span>:<span class="number">13</span>:<span class="number">53.251</span> [Timer-<span class="number">0</span>] DEBUG ScheduledTasksTest - task1</span><br><span class="line"><span class="number">17</span>:<span class="number">13</span>:<span class="number">54.264</span> [Timer-<span class="number">0</span>] DEBUG ScheduledTasksTest - task2</span><br></pre></td></tr></table></figure>

<p>我们设置的是程序在一秒后执行，task1 在一秒后输出了，但是 task2 是在启动后两秒才输出的，这就是因为 task1 睡眠了一秒影响了后面 task2 的执行</p>
<h4 id="ScheduledExecutorService"><a href="#ScheduledExecutorService" class="headerlink" title="ScheduledExecutorService"></a>ScheduledExecutorService</h4><p>它可以设置它的线程核心数，相比于固定大小的 Timer 更好，前面的任务不会影响后面任务的执行，即使前面出现异常也不会影响。但是如果核心线程数设置为1，那么它的效果和 Timer 一样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    service.schedule(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    service.schedule(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;task2&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">19</span>:<span class="number">44.212</span> [main] DEBUG ScheduledTasksTest - start...</span><br><span class="line"><span class="number">17</span>:<span class="number">19</span>:<span class="number">45.263</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG ScheduledTasksTest - task2</span><br><span class="line"><span class="number">17</span>:<span class="number">19</span>:<span class="number">45.263</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - task1</span><br></pre></td></tr></table></figure>

<p>task1 和 task2 一同输出，因为有两个线程，所以可以并发处理任务</p>
<h4 id="定时任务线程池"><a href="#定时任务线程池" class="headerlink" title="定时任务线程池"></a>定时任务线程池</h4><p><strong>scheduleAtFixedRate</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command,</span><br><span class="line">                                              <span class="type">long</span> initialDelay,</span><br><span class="line">                                              <span class="type">long</span> period,</span><br><span class="line">                                              TimeUnit unit);</span><br></pre></td></tr></table></figure>

<ul>
<li>Runnable command：Runnable 对象</li>
<li>long initialDelay：隔多久时间触发</li>
<li>long period：距离上次任务结束后多久触发一次</li>
<li>TimeUnit unit：时间单位</li>
</ul>
<p><strong>案例</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method03</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    service.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">37</span>:<span class="number">26.692</span> [main] DEBUG ScheduledTasksTest - start...</span><br><span class="line"><span class="number">19</span>:<span class="number">37</span>:<span class="number">27.748</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br><span class="line"><span class="number">19</span>:<span class="number">37</span>:<span class="number">28.749</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br><span class="line"><span class="number">19</span>:<span class="number">37</span>:<span class="number">29.740</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br></pre></td></tr></table></figure>

<p>我们让任务执行久一点，睡眠 2 s，再次启动测试一下</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231113194209749.png" alt="image-20231113194209749"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">08.806</span> [main] DEBUG ScheduledTasksTest - start...</span><br><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">09.858</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">11.863</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br><span class="line"><span class="number">19</span>:<span class="number">39</span>:<span class="number">13.874</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br></pre></td></tr></table></figure>

<p>我们可以看到从原来的间隔 1s 变成了现在的间隔 2s，也就是说任务执行时间一旦超过了我们设定的时间，那么它就不会等待间隔时间，而是马上执行</p>
<p><strong>scheduleWithFixedDelay</strong></p>
<p>这个和 scheduleAtFixedRate 功能一样，但是它是会等够设定的间隔时间才会执行下一次任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">    service.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">        TimeUtil.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">45</span>:<span class="number">11.196</span> [main] DEBUG ScheduledTasksTest - start...</span><br><span class="line"><span class="number">19</span>:<span class="number">45</span>:<span class="number">12.246</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br><span class="line"><span class="number">19</span>:<span class="number">45</span>:<span class="number">15.268</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br><span class="line"><span class="number">19</span>:<span class="number">45</span>:<span class="number">18.290</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - running...</span><br></pre></td></tr></table></figure>

<p>可以看到往下执行的每一次间隔了 3s，任务2s +  1s 间隔时间</p>
<h4 id="应用：每星期周四6-00执行任务"><a href="#应用：每星期周四6-00执行任务" class="headerlink" title="应用：每星期周四6:00执行任务"></a>应用：每星期周四6:00执行任务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每周四 6:00 执行任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 获取当前时间</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 设定开始时间</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">nextDate</span> <span class="operator">=</span> now.with(DayOfWeek.THURSDAY).withHour(<span class="number">18</span>).withMinute(<span class="number">0</span>).withSecond(<span class="number">0</span>).withNano(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 这里需要判断这周的星期四是否已经过去了</span></span><br><span class="line">    nextDate = now.isBefore(nextDate) ? nextDate : nextDate.plusWeeks(<span class="number">1</span>);</span><br><span class="line">    System.out.println(nextDate);</span><br><span class="line">    <span class="comment">// 计算当前时间到开始时间的时间差</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">initialDelay</span> <span class="operator">=</span> Duration.between(now, nextDate).toMillis();</span><br><span class="line">    <span class="comment">// 间隔时间</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>;</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125; start...&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    service.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125; running...&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;, initialDelay, delayTime, TimeUnit.MILLISECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>：</p>
<p>我们将时间设置为目标时间差一分钟的时候，看一下执行效果</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231116175933579.png" alt="image-20231116175933579"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">59</span>:<span class="number">14.016</span> [main] DEBUG ScheduledTasksTest - Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">59</span>:<span class="number">14</span> GMT+08:<span class="number">00</span> <span class="number">2023</span> start...</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>:<span class="number">00.085</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG ScheduledTasksTest - Thu Nov <span class="number">16</span> <span class="number">18</span>:<span class="number">00</span>:<span class="number">00</span> GMT+08:<span class="number">00</span> <span class="number">2023</span> running...</span><br></pre></td></tr></table></figure>





<h3 id="创建多少个线程合适？"><a href="#创建多少个线程合适？" class="headerlink" title="创建多少个线程合适？"></a>创建多少个线程合适？</h3><ul>
<li>过小会导致程序不能充分地利用系统资源、容易导致饥饿</li>
<li>过大会导致更多的线程上下文切换，占用更多内存</li>
</ul>
<p><strong>CPU</strong> <strong>密集型运算</strong></p>
<p>通常采用 cpu 核数 + 1 能够实现最优的 CPU 利用率，+1 是保证当线程由于页缺失故障（操作系统）或其它原因导致暂停时，额外的这个线程就能顶上去，保证 CPU 时钟周期不被浪费</p>
<p><strong>I&#x2F;O</strong> <strong>密集型运算</strong></p>
<p>CPU 不总是处于繁忙状态，例如，当你执行业务计算时，这时候会使用 CPU 资源，但当你执行 I&#x2F;O 操作时、远程RPC 调用时，包括进行数据库操作时，这时候 CPU 就闲下来了，你可以利用多线程提高它的利用率。</p>
<p><strong>经验公式如下</strong></p>
<p>线程数 &#x3D; 核数 * 期望 CPU 利用率 * 总时间(CPU计算时间+等待时间) &#x2F; CPU 计算时间</p>
<p>例如 4 核 CPU 计算时间是 50% ，其它等待时间是 50%，期望 cpu 被 100% 利用，套用公式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span> * <span class="number">100</span>% * <span class="number">100</span>% / <span class="number">50</span>% = <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>例如 4 核 CPU 计算时间是 10% ，其它等待时间是 90%，期望 cpu 被 100% 利用，套用公式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span> * <span class="number">100</span>% * <span class="number">100</span>% / <span class="number">10</span>% = <span class="number">40</span></span><br></pre></td></tr></table></figure>





<h3 id="Tomcat-线程池源码分析"><a href="#Tomcat-线程池源码分析" class="headerlink" title="Tomcat 线程池源码分析"></a>Tomcat 线程池源码分析</h3><p>Tomcat 在哪里用到了线程池？</p>
<ul>
<li>LimitLatch 用来限流，可以控制最大连接个数，类似 J.U.C 中的 Semaphore 后面再讲</li>
<li>Acceptor 只负责【接收新的 socket 连接】</li>
<li>Poller 只负责监听 socket channel 是否有【可读的 I&#x2F;O 事件】</li>
<li>一旦可读，封装一个任务对象（socketProcessor），提交给 Executor 线程池处理</li>
<li>Executor 线程池中的工作线程最终负责【处理请求】</li>
</ul>
<p>Tomcat 的线程池扩展了 ThreadPoolExecutor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br></pre></td></tr></table></figure>

<p>它的行为和 JDK 的稍有不同，如果总线程数达到 maximumPoolSize </p>
<ul>
<li>这个时候不会立刻抛 RejectedExecutionException 异常，而是再次判断</li>
<li>再次尝试放入阻塞队列中，如果还是失败，那么它就会抛出异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command, <span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    submittedCount.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        executeInternal(command);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getQueue() <span class="keyword">instanceof</span> TaskQueue) &#123;</span><br><span class="line">            <span class="comment">// If the Executor is close to maximum pool size, concurrent</span></span><br><span class="line">            <span class="comment">// calls to execute() may result (due to Tomcat&#x27;s use of</span></span><br><span class="line">            <span class="comment">// TaskQueue) in some tasks being rejected rather than queued.</span></span><br><span class="line">            <span class="comment">// If this happens, add them to the queue.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">TaskQueue</span> <span class="variable">queue</span> <span class="operator">=</span> (TaskQueue) getQueue();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!queue.force(command, timeout, unit)) &#123;</span><br><span class="line">                    submittedCount.decrementAndGet();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(sm.getString(<span class="string">&quot;threadPoolExecutor.queueFull&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                submittedCount.decrementAndGet();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            submittedCount.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> rx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="异步模式之-Worker-Thread"><a href="#异步模式之-Worker-Thread" class="headerlink" title="异步模式之 Worker Thread"></a>异步模式之 Worker Thread</h2><h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p>让有限的工作线程（Worker Thread）来轮流异步执行无限多的任务。也可以归类为分工模式，它的典型模式就是线程池，也体现了经典设计模式中的享元模式</p>
<h3 id="饥饿现象"><a href="#饥饿现象" class="headerlink" title="饥饿现象"></a>饥饿现象</h3><p>比如我们现在的业务是综合了多种类型任务的业务，在固定数量的线程池中，当所有的线程去执行同一种类型的任务，那么就会导致另外的业务没有线程来处理，这个僵持局面就是饥饿现象，我们看一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;HungerPhenomenonTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HungerPhenomenonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;猪脚饭&quot;</span>, <span class="string">&quot;木桶饭&quot;</span>, <span class="string">&quot;小鸡炖蘑菇&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;处理点餐...&quot;</span>);</span><br><span class="line">                Future&lt;?&gt; future = threadPool.submit(() -&gt; &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;做菜...&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;上菜：&#123;&#125;&quot;</span>, future.get());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：</p>
<ul>
<li>创建了 两个线程的线程池</li>
<li>执行两次任务，它执行的任务分为以下两部分<ul>
<li>前台：点餐和上菜</li>
<li>厨房：做菜</li>
</ul>
</li>
</ul>
<p><strong>执行结果</strong>：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231112233508354.png" alt="image-20231112233508354"> </p>
<p>我们的程序在这里卡住了，因为线程池中一共就只有两个线程，我们的前台任务将这两个线程使用了，接下来到我们厨房线程的时候线程池中无线程可用就会导致我们的程序一直处于等待对方先释放的状态，所以程序僵持住了</p>
<h3 id="解决饥饿问题"><a href="#解决饥饿问题" class="headerlink" title="解决饥饿问题"></a>解决饥饿问题</h3><p>我们可以增加线程来解决这个问题，但是这不能解决根本问题。将同类型的任务交给不同的线程池来处理是比较合理的，使用分而治之的思想。</p>
<p>使用不同的线程池来改进我们的程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 前台线程池</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">receptionPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 厨房线程池</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">cookPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">        receptionPool.execute(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;处理点餐...&quot;</span>);</span><br><span class="line">            Future&lt;?&gt; future = cookPool.submit(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;做菜...&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;上菜：&#123;&#125;&quot;</span>, future.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">44</span>:<span class="number">09.833</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG HungerPhenomenonTest - 处理点餐...</span><br><span class="line"><span class="number">23</span>:<span class="number">44</span>:<span class="number">09.833</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG HungerPhenomenonTest - 处理点餐...</span><br><span class="line"><span class="number">23</span>:<span class="number">44</span>:<span class="number">09.837</span> [pool-<span class="number">2</span>-thread-<span class="number">1</span>] DEBUG HungerPhenomenonTest - 做菜...</span><br><span class="line"><span class="number">23</span>:<span class="number">44</span>:<span class="number">09.837</span> [pool-<span class="number">2</span>-thread-<span class="number">2</span>] DEBUG HungerPhenomenonTest - 做菜...</span><br><span class="line"><span class="number">23</span>:<span class="number">44</span>:<span class="number">09.837</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG HungerPhenomenonTest - 上菜：小鸡炖蘑菇</span><br><span class="line"><span class="number">23</span>:<span class="number">44</span>:<span class="number">09.837</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG HungerPhenomenonTest - 上菜：猪脚饭</span><br></pre></td></tr></table></figure>

<p>此时就没什么问题了</p>
<h2 id="Fork-Join"><a href="#Fork-Join" class="headerlink" title="Fork&#x2F;Join"></a>Fork&#x2F;Join</h2><h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><p>Fork&#x2F;Join 是 JDK 1.7 加入的新的线程池实现，体现的是分而治之的思想，将一个任务拆分成多个小任务给多个线程去执行，最后汇总结果，<strong>适用于能够进行任务拆分的CPU密集型计算任务</strong></p>
<h3 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h3><p>创建 ForkJoinPool 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建CPU核心个数的核心线程</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line"><span class="comment">// 创建指定个数的核心线程</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行方法</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">invoke</span><span class="params">(ForkJoinTask&lt;T&gt; task)</span></span><br></pre></td></tr></table></figure>



<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>计算从 1 加到 n</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ForkJoinPoolTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForkJoinPoolTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;结果输出：&#123;&#125;&quot;</span>, forkJoinPool.invoke(<span class="keyword">new</span> <span class="title class_">Task1</span>(<span class="number">5</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Task1&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task1</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task1</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.n = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> + n + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 程序出口</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;join() &#123;&#125;&quot;</span>, n);</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将任务拆分</span></span><br><span class="line">        <span class="type">Task1</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task1</span>(n - <span class="number">1</span>);</span><br><span class="line">        task1.fork();</span><br><span class="line">        log.debug(<span class="string">&quot;fork() &#123;&#125; + &#123;&#125;&quot;</span>, n, task1);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> n + task1.join();</span><br><span class="line">        log.debug(<span class="string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, n, task1, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：fork() 的作用就是调用一个线程来执行 compute() 方法，我们通过构造方法来改变推出条件，知道我们程序到最后面满足条件然后返回结果，最后通过逐层返回得到最终结果，递归的思想</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.973</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">0</span>] DEBUG Task1 - fork() <span class="number">2</span> + &#123;<span class="number">1</span>&#125;</span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.973</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">1</span>] DEBUG Task1 - fork() <span class="number">5</span> + &#123;<span class="number">4</span>&#125;</span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.973</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">3</span>] DEBUG Task1 - fork() <span class="number">3</span> + &#123;<span class="number">2</span>&#125;</span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.973</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">2</span>] DEBUG Task1 - fork() <span class="number">4</span> + &#123;<span class="number">3</span>&#125;</span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.979</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">0</span>] DEBUG Task1 - join() <span class="number">1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.980</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">0</span>] DEBUG Task1 - join() <span class="number">2</span> + &#123;<span class="number">1</span>&#125; = <span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.980</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">3</span>] DEBUG Task1 - join() <span class="number">3</span> + &#123;<span class="number">2</span>&#125; = <span class="number">6</span></span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.980</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">2</span>] DEBUG Task1 - join() <span class="number">4</span> + &#123;<span class="number">3</span>&#125; = <span class="number">10</span></span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.980</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">1</span>] DEBUG Task1 - join() <span class="number">5</span> + &#123;<span class="number">4</span>&#125; = <span class="number">15</span></span><br><span class="line"><span class="number">00</span>:<span class="number">21</span>:<span class="number">06.980</span> [main] DEBUG ForkJoinPoolTest - 结果输出：<span class="number">15</span></span><br></pre></td></tr></table></figure>



<h3 id="案例改进"><a href="#案例改进" class="headerlink" title="案例改进"></a>案例改进</h3><p>我们之前的案例有弊端，结果需要等待，我们可以将他们各自拆分并行执行，最后将结果汇总</p>
<p>这里我们使用二分法，每次拆一半，不进行全部拆分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Task2&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task2</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> begin;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> end;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task2</span><span class="params">(<span class="type">int</span> begin, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.begin = begin;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> + begin + <span class="string">&quot;,&quot;</span> + end + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (begin == end) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;join() &#123;&#125;&quot;</span>, begin);</span><br><span class="line">            <span class="keyword">return</span> begin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (end - begin == <span class="number">1</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, begin, end, begin + end);</span><br><span class="line">            <span class="keyword">return</span> begin + end;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (end + begin) / <span class="number">2</span>;</span><br><span class="line">        <span class="type">Task2</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task2</span>(begin, mid);</span><br><span class="line">        t1.fork();</span><br><span class="line">        <span class="type">Task2</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task2</span>(mid + <span class="number">1</span>, end);</span><br><span class="line">        t2.fork();</span><br><span class="line">        log.debug(<span class="string">&quot;fork() &#123;&#125; + &#123;&#125; = ?&quot;</span>, t1, t2);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> t1.join() + t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, t1, t2, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.278</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">2</span>] DEBUG Task2 - fork() &#123;<span class="number">1</span>,<span class="number">2</span>&#125; + &#123;<span class="number">3</span>,<span class="number">3</span>&#125; = ?</span><br><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.278</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">3</span>] DEBUG Task2 - join() <span class="number">4</span> + <span class="number">5</span> = <span class="number">9</span></span><br><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.278</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">1</span>] DEBUG Task2 - fork() &#123;<span class="number">1</span>,<span class="number">3</span>&#125; + &#123;<span class="number">4</span>,<span class="number">5</span>&#125; = ?</span><br><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.278</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">0</span>] DEBUG Task2 - join() <span class="number">1</span> + <span class="number">2</span> = <span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.282</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">3</span>] DEBUG Task2 - join() <span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.282</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">2</span>] DEBUG Task2 - join() &#123;<span class="number">1</span>,<span class="number">2</span>&#125; + &#123;<span class="number">3</span>,<span class="number">3</span>&#125; = <span class="number">6</span></span><br><span class="line"><span class="number">00</span>:<span class="number">47</span>:<span class="number">20.282</span> [ForkJoinPool-<span class="number">1</span>-worker-<span class="number">1</span>] DEBUG Task2 - join() &#123;<span class="number">1</span>,<span class="number">3</span>&#125; + &#123;<span class="number">4</span>,<span class="number">5</span>&#125; = <span class="number">15</span></span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure>







<h1 id="八、工具之JUC"><a href="#八、工具之JUC" class="headerlink" title="八、工具之JUC"></a>八、工具之JUC</h1><h2 id="AQS原理"><a href="#AQS原理" class="headerlink" title="AQS原理"></a>AQS原理</h2><h3 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h3><p>AQS的全称是 AbstractQueuedSynchronizer，是阻塞式锁和相关的同步器工具的框架，JUC类的底层很多都用到它</p>
<p>特点：</p>
<ul>
<li>用 state 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取锁和释放锁<ul>
<li>getState：获取 state 状态</li>
<li>setState：设置 state 状态</li>
<li>compareAndSetState：cas机制设置 state</li>
<li>独占模式只能有一个线程可以访问资源，共享模式可以多个线程访问资源</li>
</ul>
</li>
<li>提供了基于 FIFO(先进先出) 的等待队列</li>
<li>条件变量实现等待、唤醒机制，拥有多个条件变量</li>
</ul>
<p>子类需要实现的方法</p>
<ul>
<li>tryAcquire：尝试获取锁</li>
<li>tryRelease：尝试释放锁</li>
<li>tryAcquireShared：尝试获取共享锁</li>
<li>tryReleaseShared：尝试释放共享锁</li>
<li>isHeldExclusively：是否是独占锁</li>
</ul>
<h3 id="AQS-中-Node-的状态"><a href="#AQS-中-Node-的状态" class="headerlink" title="AQS 中 Node 的状态"></a>AQS 中 Node 的状态</h3><p>AQS的中 Node 的四大状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment"> * unconditionally propagate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一些常量值，用于表示节点的等待状态。具体含义如下：  </p>
<ul>
<li><strong>CANCELLED</strong>(1)：表示当前结点已取消调度。当timeout或被中断（响应中断的情况下），会触发变更为此状态，进入该状态后的结点将不会再变化。</li>
<li><strong>SIGNAL</strong>(-1)：表示后继结点在等待当前结点唤醒。后继结点入队时，会将前继结点的状态更新为SIGNAL。</li>
<li><strong>CONDITION</strong>(-2)：表示结点等待在Condition上，当其他线程调用了Condition的signal()方法后，CONDITION状态的结点将<strong>从等待队列转移到同步队列中</strong>，等待获取同步锁。</li>
<li><strong>PROPAGATE</strong>(-3)：共享模式下，前继结点不仅会唤醒其后继结点，同时也可能会唤醒后继的后继结点。</li>
<li><strong>0</strong>：新结点入队时的默认状态。</li>
</ul>
<p>这些常量值用于在节点获取过程中判断前驱节点的状态，以便进行相应的处理。</p>
<p>例如，如果前驱节点的等待状态为SIGNAL，说明后继节点可以安全地继续执行，因此可以返回true。如果前驱节点的等待状态为CANCELLED，则需要跳过前驱节点并表示重试。如果等待状态为CONDITION，则需要等待条件满足后再继续执行。如果等待状态为PROPAGATE，则需要将此节点设置为可传播状态，以便后续的操作可以无条件传播。说白了就是通过这几个状态来标记当前节点线程的所处的状态</p>
<blockquote>
<p>备注：后面我们看源码的时候会用到，在这里提前预习一下</p>
</blockquote>
<h3 id="自定义不可重入锁"><a href="#自定义不可重入锁" class="headerlink" title="自定义不可重入锁"></a>自定义不可重入锁</h3><h4 id="自定义同步器"><a href="#自定义同步器" class="headerlink" title="自定义同步器"></a>自定义同步器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MySync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试加锁</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arg == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尝试释放锁</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(arg == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(getState() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 是否是独占锁</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConditionObject</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="自定义锁（不可重入）"><a href="#自定义锁（不可重入）" class="headerlink" title="自定义锁（不可重入）"></a>自定义锁（不可重入）</h4><p>使用我们自定义的同步器来实现自定义锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;MyLock&quot;)</span>    <span class="comment">// 自定义锁（不可重入）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">MySync</span> <span class="variable">SYNC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySync</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试，不成功进入等待队列</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        SYNC.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可打断锁</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        SYNC.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SYNC.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> SYNC.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        SYNC.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SYNC.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>创建两个线程分别是 t1 和 t2，t1 执行久一点，观察他们两个线程的输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MyLock</span> <span class="variable">myLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLock</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        myLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;unlock...&quot;</span>);</span><br><span class="line">            myLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        myLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;unlock...&quot;</span>);</span><br><span class="line">            myLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">45.723</span> [t1] DEBUG AQSTest - running...</span><br><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">46.737</span> [t1] DEBUG AQSTest - unlock...</span><br><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">46.737</span> [t2] DEBUG AQSTest - running...</span><br><span class="line"><span class="number">14</span>:<span class="number">42</span>:<span class="number">46.737</span> [t2] DEBUG AQSTest - unlock...</span><br></pre></td></tr></table></figure>

<p>t1 先获取锁，所以是 t1 先执行，因为是独享锁，所以 t1 执行完成之后才到 t2</p>
<h2 id="ReentranLock原理"><a href="#ReentranLock原理" class="headerlink" title="ReentranLock原理"></a>ReentranLock原理</h2><p>ReentranLock 的使用在前面我们已经讲过，忘记了可以回顾一下…</p>
<p>下图是 ReentranLock 的类图</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231114155705085.png" alt="image-20231114155705085"></p>
<h3 id="非公平锁原理"><a href="#非公平锁原理" class="headerlink" title="非公平锁原理"></a>非公平锁原理</h3><h4 id="加锁解锁流程分析"><a href="#加锁解锁流程分析" class="headerlink" title="加锁解锁流程分析"></a>加锁解锁流程分析</h4><p>ReentranLock 的默认实现是非公平锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有线程竞争时</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115221153929.png" alt="image-20231115221153929"> </p>
<p>第一个竞争出现时</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115221210194.png" alt="image-20231115221210194"> </p>
<p>Thread-1 执行</p>
<ol>
<li>CAS 尝试将 state 改为1，结果失败，Owner 已经存在了，此时 state 为 1</li>
<li>再次进入 tryAcquire 逻辑，如果 Thread-0 还未释放锁，那么还会失败</li>
<li>接下来进入 addWaiter 逻辑，构建 Node 阻塞队列<ul>
<li>下图中黄色三角表示该 Node 的 waitState 状态，其中 0 为默认正常状态</li>
<li>Node 的创建是懒惰的，它会先判断是否已经存在元素了，没有存在它就会创建一个</li>
<li>其中第一个 Node 称为 Dummy（哑元）或哨兵，并不关联线程，它负责唤醒后面的线程</li>
</ul>
</li>
</ol>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115221557157.png" alt="image-20231115221557157"> </p>
<p>当线程进入 acquireQueued 逻辑</p>
<ol>
<li><p>acquireQueued 会在一个死循环这on不断尝试获取锁，失败后进入 park阻塞</p>
</li>
<li><p>如果当前节点的前一个节点是 head，那么再次 tryAcquire 尝试获取锁，如果此时 state 仍为 1，那么失败</p>
</li>
<li><p>进入 shourldParkAfterFailedAcquire 逻辑，将前驱 node，即 head 的 waitStatus 改为 <em>SIGNAL</em>(-1)，这次返回 false</p>
<p> <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115221846046.png" alt="image-20231115221846046"></p>
</li>
<li><p>进入 parkAndCheckInterrupt，Thread01 park （灰色表示）</p>
<p> <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115222045392.png" alt="image-20231115222045392"></p>
</li>
</ol>
<p>再次有多个线程经历上述过程竞争失败，就会变成下图：</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115222152656.png" alt="image-20231115222152656"></p>
<p>Thread-0 释放锁，进入 tryRelease 流程，如果成功</p>
<ul>
<li>设置 exclusiveOwnerThread 为 null</li>
<li>设置 state 为 0</li>
</ul>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115235342718.png" alt="image-20231115235342718"></p>
<p>当前队列不为 null，并且 head 的waitStatus&#x3D;-1，进入 unparkSucccesor 流程</p>
<ul>
<li><p>设置 waitStatus &#x3D; 0</p>
</li>
<li><p>获取头节点</p>
</li>
<li><p>如果头节点不为空，那么将头节点的第二个节点唤醒</p>
<p>  <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231115235858908.png" alt="image-20231115235858908"></p>
<p>  Thread-1 加锁成功，执行加锁的步骤，然后刚刚的 head 会被清除 Thraed</p>
<p>  如果这个时候有其他的线程来竞争（非公平锁的体现），例如 Thread-4 来了</p>
<p>  <img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231116000127647.png" alt="image-20231116000127647"></p>
<p>  如果被 Thread-4 先抢到锁，那么Thread-1再次进入 acquireQueued 流程，重新进入 park 阻塞</p>
</li>
<li><p>如果头节点为空 或者 waitStatus &gt; 0，则从尾节点开始遍历获取 waitStatus &lt;&#x3D; 0 的节点作为新节点，然后将其唤醒</p>
</li>
</ul>
<h4 id="加锁源码"><a href="#加锁源码" class="headerlink" title="加锁源码"></a>加锁源码</h4><p>我们看一下调用 lock 方法它做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是调用的 NonfairSync#lock()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要实现：</p>
<ol>
<li><p>修改 state 为 1，如果修改成功就将当前线程设置为 Owner</p>
</li>
<li><p>acquire(1)</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) <span class="comment">// 尝试获取锁，如果获取失败就返回 fasle，因为 !false=true，所以就会执行下一个判断</span></span><br><span class="line">		<span class="comment">// Node.EXCLUSIVE 独占锁模式</span></span><br><span class="line">        &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>首先它会执行 tryAcquire(arg) </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是非公平锁的实现</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// 还没有线程获取到锁</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 尝试 cas 获取锁，这里体现的是非公平性；不去检查 AQS 队列</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">// cas 成功，将 owner 设置为当前线程表示当前线程获取到锁</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断当前线程是否已经获取到锁了，如果是就表示发生了锁重入</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// 锁重入就添加次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置 state 为重入的次数</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取锁失败</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>尝试获取锁失败就会进入 acquireQueued(addWaiter(Node.EXCLUSIVE), arg) 流程</p>
</li>
<li><p>首先我们先进入 addWaiter(Node.EXCLUSIVE) 中</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个 Node 节点，模式是独占模式		Node.EXCLUSIVE</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// 尾节点</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// 尾节点不为空</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 新进入的 node 前指针指向尾节点（因为它要成为新的尾节点） </span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// 这边执行 cas 操作将 node 置为新的尾节点</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            <span class="comment">// 上一个尾节点的 next 指针指向新加入的节点</span></span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尾节点为空的情况执行 enq(node) 方法</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 假设我们现在还没有线程加入，队列的 head 和 tail 都为空，那么它就会走 enq(node) 方法</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// 这个判断主要是为了将哑元节点创建</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="comment">// 尾节点为空就创建一个空节点为头节点和尾节点</span></span><br><span class="line">            <span class="comment">// 这个第一个的Node 称为 Dummy（哑元）或哨兵，并不关联线程，它来唤醒后面的线程</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 走到这里说明头节点已经被创建了</span></span><br><span class="line">            <span class="comment">// prev 指针指向尾节点</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// node 成为新的 tail 节点</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>加入队列之后就会执行 acquireQueued 方法</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// 失败标记</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 打断标记</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// 获取前一个节点</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// 如果前一个节点为头节点 和 再次尝试获取锁，tryAcquire 的逻辑上面讲过</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// 设置当前节点为头节点</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                <span class="comment">// 之前的头节点不要了</span></span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果前一个不是头节点，那么就会执行下面的逻辑（下面会讲）</span></span><br><span class="line">  		   <span class="comment">// 获取锁失败的锁应该 park </span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                <span class="comment">// park 和 打断执行</span></span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们看一下 shouldParkAfterFailedAcquire(p, node) 和 做了什么 parkAndCheckInterrupt()</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取上一个节点的状态</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="comment">// Node.SIGNAL 表示请求释放通知，也就阻塞了</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">// 如果前一个节点阻塞了，那么当前节点也阻塞好了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// &gt; 0 表示取消状态</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 移除被打断的节点</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设置新加入的节点的前节点等待状态为 SIGNAL</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 让当前线程暂停</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// 打断线程</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="释放锁源码"><a href="#释放锁源码" class="headerlink" title="释放锁源码"></a>释放锁源码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// 尝试释放锁</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">// 获取头节点</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// 头节点不为空 &amp;&amp; 状态不等于0</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tryRelease(arg) 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// c = 0 说明解锁成功 </span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 自由标识</span></span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回 true 表示释放锁成功，接下来 头节点不为空且waitStatus !&#x3D; 0 就执行下一步 <code>unparkSuccessor(h);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// 当前 node 为 head 节点</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// 设置 state 为 0</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 获取第二个节点</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="comment">// 如果第二个节点为空 或者 节点的状态为 CANCELLED(1)，表示当前结点已取消调度（timeout或被打断）</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 从尾节点开始遍历寻找不为 CANCELLED(1) 状态的节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// 线程恢复运行</span></span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="可重入锁原理"><a href="#可重入锁原理" class="headerlink" title="可重入锁原理"></a>可重入锁原理</h3><p>每次加锁 state 就会 +1，解锁的时候就 -1，最后 state &#x3D; 0 就表示锁被释放了</p>
<p><strong>我们看一下源码如何实现</strong></p>
<p>加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用顺序：lock -&gt; acquire -&gt; tryAcquire -&gt; nonfairTryAcquire</span></span><br><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// 省略......</span></span><br><span class="line">    <span class="comment">// 判断当前线程是否已经获取到锁了，如果是就表示发生了锁重入</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// 锁重入就添加次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置 state 为重入的次数</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取锁失败</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>释放锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用顺序：unlock -&gt; release -&gt; tryRelease</span></span><br><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// c = 0 说明解锁成功 </span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 自由标识</span></span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="可打断原理"><a href="#可打断原理" class="headerlink" title="可打断原理"></a>可打断原理</h3><h4 id="不可打断模式"><a href="#不可打断模式" class="headerlink" title="不可打断模式"></a>不可打断模式</h4><p>在此模式下，即使它被打断了，任然会驻留在 AQS 队列中，等待获取到锁的时候才会知道被打断了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock -&gt; acquire -&gt; tryAcquire -&gt; acquireQueued</span></span><br><span class="line"><span class="comment">// 目前是竞争失败，将 Node 放入到同步队列中</span></span><br><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 打断标记</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// 获取锁后才会将打断标记返回</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置前一个节点的 waitStatus </span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// 这是因为 Thread.interrupted() 方法会清除标记，为了给下次循环便利的时候返回打断标记</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// park 被打断就会往下执行</span></span><br><span class="line">    <span class="comment">// 注意：如果打断标记为 true，那么 park 就会失效，也就是说下次再进来就无效了</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// 返回打断标记</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 acquireQueued 被打断返回为 true，那么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;		<span class="comment">// true</span></span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))	<span class="comment">// 若返回 true</span></span><br><span class="line">        <span class="comment">// 执行下面方法</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selfInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 调用方法打断线程运行</span></span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="可打断模式"><a href="#可打断模式" class="headerlink" title="可打断模式"></a>可打断模式</h4><p>使用 lockInterruptibly() 的时候才是可打断模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="comment">// 如果打断了，那就直接抛出错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// 尝试获取锁</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// 它这里和不可打断锁的区别就是它直接就抛出异常结束循环了</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="公平锁实现原理"><a href="#公平锁实现原理" class="headerlink" title="公平锁实现原理"></a>公平锁实现原理</h3><p>它比非公平锁多一个步骤就是检查 AQS队列 是否有元素，如果存在那么就 AQS队列中的优先获取锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fair 为 true 就是使用公平锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下它的 lock() 方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>acquire 方法和公平锁的实现一样的逻辑，但是 tryAcquire方法中存在不一样的逻辑</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231116173218833.png" alt="image-20231116173218833"> </p>
<p>首先它会先执行 hasQueuedPredecessors()，如果它为true表示有前驱节点，那么不会往下执行，如果没有前驱节点，就会执行是当前线程获取锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t 	<span class="comment">// 第一个是哑元节点，h != t 表示存在 第二个元素</span></span><br><span class="line">        <span class="comment">// 第二个不为空才会执行</span></span><br><span class="line">        &amp;&amp; ((s = h.next) == <span class="literal">null</span></span><br><span class="line">        <span class="comment">// 第二个节点不为空个而且不是当前线程，因为是当前线程的话就会返回 true 直接获取锁了</span></span><br><span class="line">        || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h3><p>使用条件变量我们会创建一个条件变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> ConditionObject <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConditionObject</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看一下 ConditionObject 类做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1173984872572414699L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br></pre></td></tr></table></figure>

<p>通过它的类属性我们可以看出来它底层也是维护了一个链表，它会将不满足条件变量的线程放入到链表中</p>
<p>每个条件变量对应着一个 ConditionObject 等待队列</p>
<h4 id="await流程"><a href="#await流程" class="headerlink" title="await流程"></a>await流程</h4><p>当 Thread-0 调用了 await 方法就会将 Thread-0 放入到 ConditionObject 队列中，节点的 waitStatus 为Node.CONDITION(-2)</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231116174909173.png" alt="image-20231116174909173"> </p>
<p>加入队列过程：</p>
<ol>
<li>循环便利循环释放队列中已取消的节点</li>
<li>设置当前节点，状态为 CONDITION</li>
<li>队列中如果不存在节点，那么新加入的节点作为头节点，负责成为尾节点</li>
</ol>
<p>释放当前节点持有的所有锁（锁重入情况）</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231120163025942.png" alt="image-20231120163025942"> </p>
<p>判断是否在 AQS队列（同步队列）中，从尾部开始找，如果不在那么就将当前线程 park</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231120163203714.png" alt="image-20231120163203714"></p>
<h4 id="await-源码解读"><a href="#await-源码解读" class="headerlink" title="await 源码解读"></a>await 源码解读</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 判断当前线程是否被打断了</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// 将当前线程 添加到等待队列</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">    <span class="comment">// 释放节点持有的所有锁（考虑锁重入情况）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">    <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 是否在同步队列中，从尾开始找</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        <span class="comment">// 不在就 park</span></span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addConditionWaiter() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 最后一个节点</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">	<span class="comment">// 所有已取消的 Node （调用了 signal 或 被打断了）从队列列表中删除</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置当前节点，状态为 CONDITION</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="comment">// 此时还没有元素，则新节点为 firstWaiter</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 上面已经将节点便利到了最后一个节点，所以接入到它的下一个节点</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    <span class="comment">// 尾指针指向当前节点</span></span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">trail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 头节点不为空</span></span><br><span class="line">    <span class="keyword">while</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 下一个 nextWaiter</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> t.nextWaiter;</span><br><span class="line">        <span class="comment">// 如果状态不是 CONDITION，此时的头要被移除</span></span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            <span class="comment">// 当前头节点的下个节点为空</span></span><br><span class="line">            t.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 此时 trail 为 null</span></span><br><span class="line">            <span class="keyword">if</span> (trail == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// 之前的头节点的下一个节点称为头节点</span></span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 下次循环进来 trail 不为 null</span></span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            trail = t;</span><br><span class="line">        t = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fullyRelease 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullyRelease</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取 state</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// release 会将所有的锁释放（考虑锁重入）</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 释放锁失败抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            <span class="comment">// CANCELLED(-2) 节点为取消调用状态</span></span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// 尝试释放锁</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// 头节点不为空且状态不是刚加入时候的</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// 释放锁完成之后第二个节点恢复运行</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="signal-流程"><a href="#signal-流程" class="headerlink" title="signal 流程"></a>signal 流程</h4><p>假设 Thread-1 要来唤醒  Thread-0</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231120165028651.png" alt="image-20231120165028651"></p>
<p>进入 doSignal 流程，取得等待队列中的第一个 Node，即 Thread-0</p>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231120165201712.png" alt="image-20231120165201712"> </p>
<p>执行 transferForSignal 流程：</p>
<ol>
<li>waitStatus 修改：Node.CONDITION -&gt; 0</li>
<li>节点加入到 AQS 队列尾部</li>
<li>如果前一个节点waitStatus 小于或等于0，则尝试将当前节点前一个节点的 waitStatus 设置为 Node.SIGNAL<ul>
<li>失败：说明此时前一个节点被别的节点抢先修改了，即锁被释放了，案例这里是 Thraed-1，接着就不用修改了，Thread-0 直接上位成为 ExclusiveOwnerThread</li>
<li>成功：状态修改成功，成功加入 AQS 队列</li>
</ul>
</li>
</ol>
<p><img src="https://xiaozhi-blog.oss-cn-guangzhou.aliyuncs.com/img01/img01/image-20231120165209374.png" alt="image-20231120165209374"></p>
<h4 id="signal-源码解读"><a href="#signal-源码解读" class="headerlink" title="signal 源码解读"></a>signal 源码解读</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 判断是否拥有锁，这里只有锁才能进来，所以不需要加锁</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">// 获取第一个节点</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// 恢复节点</span></span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 只有一个头节点，就将 lastWaiter</span></span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="literal">null</span>)</span><br><span class="line">            lastWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 将要释放的节点断开</span></span><br><span class="line">        first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 循环判断信号转换是否成功，成功就结束循环</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) </span><br><span class="line">             <span class="comment">// 不成功就继续获取头节点来释放</span></span><br><span class="line">             &amp;&amp; (first = firstWaiter) != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>transferForSignal(first) 源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// waitStatus 转换 Node.CONDITION -&gt; 0</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 加入到 AQS队列 尾部</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node);</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line">    <span class="comment">// waitStatus 大于0</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> </span><br><span class="line">        <span class="comment">// 将当前节点的前一个节点 waitStatus 设置为 SIGNAL</span></span><br><span class="line">        || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        <span class="comment">// waitStatus 设置失败说明有节点加入了 AQS队列中，ExclusiveOwnerThread 此时为空，那么可以让当前线程 unpark</span></span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="读写锁-ReentranReadWriteLock"><a href="#读写锁-ReentranReadWriteLock" class="headerlink" title="读写锁(ReentranReadWriteLock)"></a>读写锁(ReentranReadWriteLock)</h2><h3 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h3><p>它和 ReentranLock 有什么区别呢？</p>
<p>ReentranLock 不管是读还是写都是使用的互斥锁来保证线程安全，而 ReentranReadWriteLock 更加细粒度化一点，读写操作分别上锁，对于读操作我们可以让线程并发执行，前提是写操作没有执行，当写操作执行的时只能有一个线程能访问共享资源。可以理解为是 <code>读-读</code> 并发，<code>写-写</code> 和 <code>读-写</code> 互斥</p>
<p>ReentranReadWriteLock 适合读多写少的场景下</p>
<p><strong>注意事项</strong></p>
<ul>
<li>读锁不支持条件变量</li>
<li>重入时升级不支持：即持有读锁的情况下去获取写锁，会导致获取写锁永久等待</li>
<li>重入锁降级支持：即持有写锁的情况下获取读锁</li>
</ul>
<h3 id="使用-4"><a href="#使用-4" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantReadWriteLock</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">r</span> <span class="operator">=</span> rw.readLock();		<span class="comment">// 读锁</span></span><br><span class="line">ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">w</span> <span class="operator">=</span> rw.writeLock();	<span class="comment">// 写锁</span></span><br></pre></td></tr></table></figure>

<p>使用方法和 ReentranLock 一样</p>
<p><strong>案例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;DataContainer&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">r</span> <span class="operator">=</span> rw.readLock();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">w</span> <span class="operator">=</span> rw.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;获取读锁...&quot;</span>);</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; 读取...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;释放读锁...&quot;</span>);</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;获取写锁...&quot;</span>);</span><br><span class="line">        w.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; 写入...&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            TimeUtil.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;释放写锁...&quot;</span>);</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>读-读</code> 并发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(dataContainer::read, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(dataContainer::read, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:08:<span class="number">32.542</span> [t1] DEBUG DataContainer - 获取读锁...</span><br><span class="line"><span class="number">15</span>:08:<span class="number">32.542</span> [t2] DEBUG DataContainer - 获取读锁...</span><br><span class="line"><span class="number">15</span>:08:<span class="number">32.546</span> [t2] DEBUG DataContainer - t2 读取...</span><br><span class="line"><span class="number">15</span>:08:<span class="number">32.545</span> [t1] DEBUG DataContainer - t1 读取...</span><br><span class="line"><span class="number">15</span>:08:<span class="number">33.553</span> [t1] DEBUG DataContainer - 释放读锁...</span><br><span class="line"><span class="number">15</span>:08:<span class="number">33.553</span> [t2] DEBUG DataContainer - 释放读锁...</span><br></pre></td></tr></table></figure>

<p><code>读-写</code> 或 <code>写-写</code> 互斥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">DataContainer</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(dataContainer::read, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(dataContainer::write, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">10</span>:<span class="number">28.055</span> [t1] DEBUG DataContainer - 获取写锁...</span><br><span class="line"><span class="number">15</span>:<span class="number">10</span>:<span class="number">28.055</span> [t2] DEBUG DataContainer - 获取读锁...</span><br><span class="line"><span class="number">15</span>:<span class="number">10</span>:<span class="number">28.058</span> [t1] DEBUG DataContainer - t1 写入...</span><br><span class="line"><span class="number">15</span>:<span class="number">10</span>:<span class="number">29.069</span> [t1] DEBUG DataContainer - 释放写锁...</span><br><span class="line"><span class="number">15</span>:<span class="number">10</span>:<span class="number">29.069</span> [t2] DEBUG DataContainer - t2 读取...</span><br><span class="line"><span class="number">15</span>:<span class="number">10</span>:<span class="number">30.083</span> [t2] DEBUG DataContainer - 释放读锁...</span><br></pre></td></tr></table></figure>

<p>可以看到获取写锁后是先写入完成然后再读取。</p>
<h3 id="读写锁原理"><a href="#读写锁原理" class="headerlink" title="读写锁原理"></a>读写锁原理</h3><h4 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h4><h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><h3 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h3><p>信号量，限制访问资源的线程数量上限</p>
<p>举个例子：可以把它理解成是停车场，线程表示车，当停车场满了，车就不能进来了。当共享资源的线程达到设定的最大值，那么其他线程就只能阻塞等待活跃的线程执行完毕</p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li>StampedLock 不支持条件变量</li>
<li>StampedLock 不支持可重入</li>
</ul>
</blockquote>
<h3 id="使用-5"><a href="#使用-5" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">    <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        threadPool.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取许可</span></span><br><span class="line">                semaphore.acquire();</span><br><span class="line">                log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;end...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                semaphore.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">04.375</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">04.375</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">04.375</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">05.394</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">05.394</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">05.394</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">05.394</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">05.394</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">05.394</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">06.407</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">06.407</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">06.407</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">06.407</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">06.407</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">06.407</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">07.420</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">07.420</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">07.420</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - running...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">07.420</span> [pool-<span class="number">1</span>-thread-<span class="number">3</span>] DEBUG SemaphoreTest - end...</span><br><span class="line"><span class="number">20</span>:<span class="number">58</span>:<span class="number">08.431</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG SemaphoreTest - end...</span><br></pre></td></tr></table></figure>



<h3 id="应用-连接池"><a href="#应用-连接池" class="headerlink" title="应用 - 连接池"></a>应用 - 连接池</h3><p>修改我们之前的连接池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> MockConnection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历判断是否有空闲的连接</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取许可</span></span><br><span class="line">        semaphore.acquire();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (states.get(i) == <span class="number">0</span> &amp;&amp; states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> connections[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 归还连接</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection conn)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; connections.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn == connections[i]) &#123;</span><br><span class="line">            <span class="comment">// 设置成空闲状态，它不用进行 cas 因为它是此时是获取锁的，所以没有其他线程竞争</span></span><br><span class="line">            states.set(i, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 释放许可</span></span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><h2 id="CountdownLatch"><a href="#CountdownLatch" class="headerlink" title="CountdownLatch"></a>CountdownLatch</h2><h3 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h3><p>用来进行线程同步协作，通过减少次数来使线程停止等待往下执行</p>
<p>举个例子：三人开车去郊游，小明和小红上厕所了，我们需要满人才能发车，此时小路在车上，未到人数-1，未到人数为 2，接着两人回来，未到人数为0，此时我们可以出发了。</p>
<p>通过这个例子我们可以知道 小明、小红、小路 就是我们的线程，我们可以通过最终数是否为 0 的方式来等待三个线程的执行，当三个线程完成了减数操作，那么我们就可以停止等待继续执行了</p>
<blockquote>
<p>TIP：我们可以使用 join，wait 等 方法来完成，但是这些都是偏底层的而且使用起来比较繁琐，推荐使用 JUC 并发包提供的类</p>
</blockquote>
<h3 id="使用-6"><a href="#使用-6" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// count 总计数</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">CountDownLatch</span><span class="params">(<span class="type">int</span> count)</span></span><br></pre></td></tr></table></figure>

<p>使用方法</p>
<ul>
<li>await()：等待</li>
<li>countDown：总计数 - 1</li>
</ul>
<p><strong>注意</strong>：</p>
<ul>
<li>如果使用线程池，线程数量要和设定的数一样，这样才可以防止执行顺序错误。</li>
<li>CountDownLatch 不能重复使用，它只能使用一次，需要重新创建</li>
</ul>
<p><strong>实例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;CountdownLatchTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountdownLatchTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; being...&quot;</span>, name);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; end...&#123;&#125;&quot;</span>, name, countDownLatch.getCount());</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; being...&quot;</span>, name);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; end...&#123;&#125;&quot;</span>, name, countDownLatch.getCount());</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;结束...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">07.786</span> [t2] DEBUG CountdownLatchTest - t2 being...</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">07.786</span> [t1] DEBUG CountdownLatchTest - t1 being...</span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">08.796</span> [t1] DEBUG CountdownLatchTest - t1 end..<span class="number">.1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">09.799</span> [t2] DEBUG CountdownLatchTest - t2 end..<span class="number">.0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">18</span>:<span class="number">09.799</span> [main] DEBUG CountdownLatchTest - 结束...</span><br></pre></td></tr></table></figure>



<h3 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h3><h4 id="同步等待多线程准备完毕"><a href="#同步等待多线程准备完毕" class="headerlink" title="同步等待多线程准备完毕"></a>同步等待多线程准备完毕</h4><p>10 个线程分别加载游戏资源，这里我们模拟使用随机睡眠代替，都加载完毕，则游戏可以开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaozhi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 多线程加载游戏</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiThreadLoadingOfGame</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">num</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>, (r) -&gt; <span class="keyword">new</span> <span class="title class_">Thread</span>( r, <span class="string">&quot;t&quot;</span> + num.getAndIncrement()));</span><br><span class="line">        String[] schedule = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= <span class="number">100</span>; j++) &#123;</span><br><span class="line">                    TimeUtil.sleepMillisecond(random.nextInt(<span class="number">100</span>));</span><br><span class="line">                    schedule[k] = Thread.currentThread().getName() + <span class="string">&quot;(&quot;</span> + j + <span class="string">&quot;%)&quot;</span>;</span><br><span class="line">                    <span class="comment">// 不换行 + r（回车符） 实现进度条效果</span></span><br><span class="line">                    System.out.print(<span class="string">&quot;\r&quot;</span> + Arrays.toString(schedule));</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">            System.out.println(<span class="string">&quot;\n游戏加载完成...&quot;</span>);</span><br><span class="line">            threadPool.shutdown();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中间执行</span></span><br><span class="line">[t0(<span class="number">37</span>%), t1(<span class="number">39</span>%), t2(<span class="number">37</span>%), t3(<span class="number">44</span>%), t4(<span class="number">42</span>%), t5(<span class="number">45</span>%), t6(<span class="number">45</span>%), t7(<span class="number">48</span>%), t8(<span class="number">49</span>%), t9(<span class="number">39</span>%)]</span><br><span class="line"><span class="comment">// 最后加载完毕</span></span><br><span class="line">[t0(<span class="number">100</span>%), t1(<span class="number">100</span>%), t2(<span class="number">100</span>%), t3(<span class="number">100</span>%), t4(<span class="number">100</span>%), t5(<span class="number">100</span>%), t6(<span class="number">100</span>%), t7(<span class="number">100</span>%), t8(<span class="number">100</span>%), t9(<span class="number">100</span>%)]</span><br><span class="line">游戏加载完成...</span><br></pre></td></tr></table></figure>



<h4 id="同步等待多个远程调用结束"><a href="#同步等待多个远程调用结束" class="headerlink" title="同步等待多个远程调用结束"></a>同步等待多个远程调用结束</h4><p>这里我们有一个场景就是加载主页的适合需要加载多个接口，那么此时我们就可以使用 CountDownLatch 同步等待回调，最后我们再将它们汇总返回给前端</p>
<p>这里我们使用睡眠来做调用时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SynchronousWaitingForRemoteCalls&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronousWaitingForRemoteCalls</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="type">remoteCell</span> <span class="variable">remoteCell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">remoteCell</span>();</span><br><span class="line">        Future&lt;Object&gt; userInfo = threadPool.submit(remoteCell::getUserInfo);</span><br><span class="line">        Future&lt;List&lt;Object&gt;&gt; list = threadPool.submit(remoteCell::list);</span><br><span class="line">        Future&lt;List&lt;Object&gt;&gt; list2 = threadPool.submit(remoteCell::list2);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, userInfo.get());</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, list.get());</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, list2.get());</span><br><span class="line">        log.debug(<span class="string">&quot;执行完毕...&quot;</span>);</span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">remoteCell</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">list</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;a1&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;a2&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;a3&quot;</span>);</span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">list2</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;a5&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;a6&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;a7&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">21</span>:<span class="number">55.350</span> [main] DEBUG SynchronousWaitingForRemoteCalls - java.lang.Object@22927a81</span><br><span class="line"><span class="number">20</span>:<span class="number">21</span>:<span class="number">56.344</span> [main] DEBUG SynchronousWaitingForRemoteCalls - [a1, a2, a3]</span><br><span class="line"><span class="number">20</span>:<span class="number">21</span>:<span class="number">56.344</span> [main] DEBUG SynchronousWaitingForRemoteCalls - [a5, a6, a7]</span><br><span class="line"><span class="number">20</span>:<span class="number">21</span>:<span class="number">56.344</span> [main] DEBUG SynchronousWaitingForRemoteCalls - 执行完毕...</span><br></pre></td></tr></table></figure>

<p>调用完毕才会执行完毕</p>
<h2 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h2><p>[ˈsaɪklɪk ˈbæriɚ]  循环栅栏，用来进行线程协作，当线程的数量达到设定的数值时才会往下执行，程序需要同步协作的是就可以用这个来做，使用它的 await 等待其他线程加入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;CyclicBarrierTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CyclicBarrierTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">cb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        threadPool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t1 线程开始...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 等待其他线程加入直到计数到到设定值才执行</span></span><br><span class="line">                cb.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;t1 继续执行&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        threadPool.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t2 线程开始...&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 等待其他线程加入直到计数到到设定值才执行</span></span><br><span class="line">                cb.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;t2 继续执行&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">34</span>:<span class="number">19.537</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG CyclicBarrierTest - t2 线程开始...</span><br><span class="line"><span class="number">20</span>:<span class="number">34</span>:<span class="number">19.537</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG CyclicBarrierTest - t1 线程开始...</span><br><span class="line"><span class="number">20</span>:<span class="number">34</span>:<span class="number">21.546</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG CyclicBarrierTest - t2 继续执行</span><br><span class="line"><span class="number">20</span>:<span class="number">34</span>:<span class="number">21.546</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] DEBUG CyclicBarrierTest - t1 继续执行</span><br></pre></td></tr></table></figure>

<p>可以看到 t1 等待 t2 加入进来才会继续执行，调用 await 方法就算是进来，进来表示计数 - 1，当计数等于 0 时取消等待</p>
<h1 id="九、线程安全集合类"><a href="#九、线程安全集合类" class="headerlink" title="九、线程安全集合类"></a>九、线程安全集合类</h1><h2 id="ConcurrentHashMap-原理"><a href="#ConcurrentHashMap-原理" class="headerlink" title="ConcurrentHashMap 原理"></a>ConcurrentHashMap 原理</h2><h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><p>队列就是出队和入队方法，使用方式这里就不讲解，这里讲解实现的原理</p>
<h3 id="LinkedBlockingQueue-原理"><a href="#LinkedBlockingQueue-原理" class="headerlink" title="LinkedBlockingQueue 原理"></a>LinkedBlockingQueue 原理</h3><h3 id="ConcurrentLinkedQueue原理"><a href="#ConcurrentLinkedQueue原理" class="headerlink" title="ConcurrentLinkedQueue原理"></a>ConcurrentLinkedQueue原理</h3><h2 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h2></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/dd/tags/test/">test</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/83541888?s=400&amp;u=c1a17f2da2425d5c4214b9d1e0a3c3a6de998d4a&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/dd/2024/10/25/Spring%20Data/" title="Spring Data"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Spring Data</div></div><div class="info-2"><div class="info-item-1">Spring Data JPA概述 官网：Spring Data JPA provides repository support for the Jakarta Persistence API (JPA). It eases development of applications with a consistent programming model that need to access JPA data sources. 翻译：Spring Data JPA为Jakarta Persistence API（JPA）提供存储库支持。它通过一致的编程模型简化了需要访问JPA数据源的应用程序的开发。  JPA 是 Java 5.0 的概念，规范持久化操作的API规范，而 Spring Data JPA 是对 JPA  的二次封装，提供给各个 ORM 框架遵循的 API 规范，底层负责实现各种功能的是各种的 ORM 框架，比如知名的 Hibernate 框架。 Spring Data JPA 默认使用的是 Hibernate，由它来完成数据库的一系列操作 Getter...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/SpringBoot-%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/" title="SpringBoot-接口设计"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">SpringBoot-接口设计</div></div><div class="info-2"><div class="info-item-1">接口 - 结果返回封装enum类12345678910111213141516171819202122232425262728@Getter@AllArgsConstructorpublic enum ResponseStatus &#123;    SUCCESS(&quot;200&quot;, &quot;success&quot;),    FAIL(&quot;500&quot;, &quot;failed&quot;),    HTTP_STATUS_200(&quot;200&quot;, &quot;ok&quot;),    HTTP_STATUS_400(&quot;400&quot;, &quot;request error&quot;),    HTTP_STATUS_401(&quot;401&quot;, &quot;no authentication&quot;),    HTTP_STATUS_403(&quot;403&quot;, &quot;no authorities&quot;),   ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/dd/2024/10/25/Dubbo/" title="Dubbo"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">Dubbo</div></div><div class="info-2"><div class="info-item-1">一、基础知识1、分布式基础理论1.1 什么是分布式系统分布式系统就是由多个计算机提供服务组成的系统 随着互联网的发展，网站应用的规模不断扩大，常规的垂直应用架构已经无法应付，分布式架构与流动计算架构势在必行，还需一个治理系统来对应用进行管理 1.2...</div></div></div></a><a class="pagination-related no-desc" href="/dd/2024/10/25/JVM/" title="JVM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">JVM</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/IDEA/" title="IDEA"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">IDEA</div></div><div class="info-2"><div class="info-item-1">快捷键使用系统快捷键   ctrl + alt + 空格 提示信息    ctrl + alt + v 相当于Ecelipse里面的ctr+1，显示左边的内容   alt + n 抛异常   ctrl + o 查看关系   ctrl + shift + T 查看文档   ctrl + alt + T 包起来   ctrl + alt + L 格式化   alt + ins 自动生成get和set方法等   ctrl + r 搜索关键字、替换   ctrl + f 搜索关键字   ctrl +   H 显示出Hierarchy（继承树）   ctrl + shift + u 转换大小写   ctrl + shift + I 预览某个类、某个方法、某个字段、某个变量的代码   ctrl + alt + B 或 ctrl + alt + 鼠标左键 跳转实现类   F11 添加书签   TODO 待完成   ctrl + alt + shift + U 查看依赖关系   ctrl + alt + U 查看依赖关系（只有查看功能）   ctrl + F12 查看类的所有方法   ctrl...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/Git&GitHub&Gitee/" title="Git&amp;GitHub&amp;Gitee"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">Git&amp;GitHub&amp;Gitee</div></div><div class="info-2"><div class="info-item-1">git概述Git 是一个免费的、开源的分布式版本控制系统，可以快速高效地处理从小型到大型的各种项目。Git 易于学习，占地面积小，性能极快。 它具有廉价的本地库，方便的暂存区域和多个工作流分支等特性。 其性能优于 Subversion、 CVS、 Perforce 和 ClearCase 等版本控制工具。 什么是版本控制？版本控制是一种记录文件内容变化，以便将来查阅特定版本修订情况的系统。版本控制其实最重要的是可以记录文件修改历史记录，从而让用户能够查看历史版本，方便版本切换。   为什么需要版本控制我们从个人过度到团队，团队之间进行协作  比如两个人来进行合作，第一个人上传了一个版本，我们第二个人就是要在第一个版本来进行修改形成第二个版本，这样的话就可以进行更好的合作 版本控制工具集中式版本控制工具   集中化的版本控制系统诸如 CVS、 SVN 等 ...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/Maven/" title="Maven"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">Maven</div></div><div class="info-2"><div class="info-item-1">一、Maven概述和安装1、概述​	是一个工具，项目架构管理工具 目前阶段：自动导入jar包，解决导jar包的工作 核心思想：约定大于配置  有约束，不要去违反  Maven会规定好如何去编写我们的java代码，必须按照这个规范来； 2、安装官网：https://maven.apache.org/  下载文件后解压即可 目录结构bin：可执行文件 boot：需要启动的一些选项，jar包 conf：配置文件 lib：依赖 配置环境变量 M2_HOME			maven目录下的bin目录 MAVEN_HOME     maven的目录 在系统的path中呢配置 %MAVEN_HOME%\bin  说明：为什么要创建两个，按照规范来 通过mvn...</div></div></div></a><a class="pagination-related" href="/dd/2024/10/25/MyBatis/" title="MyBatis"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="info-item-2">MyBatis</div></div><div class="info-2"><div class="info-item-1">MyBatis简介环境说明 jdk 8 + MySQL 5.7.19 maven-3.6.1 IDEA  学习前需要掌握：  JDBC MySQL Java 基础 Maven Junit  什么是MyBatis MyBatis 是一款优秀的持久层框架 MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集的过程 MyBatis 可以使用简单的 XML 或注解来配置和映射原生信息，将接口和 Java 的 实体类 【Plain Old Java Objects,普通的 Java对象】映射成数据库中的记录。 MyBatis 本是apache的一个开源项目ibatis, 2010年这个项目由apache 迁移到了google code，并且改名为MyBatis 。 2013年11月迁移到Github . Mybatis官方文档 : http://www.mybatis.org/mybatis-3/zh/index.html GitHub :...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/83541888?s=400&amp;u=c1a17f2da2425d5c4214b9d1e0a3c3a6de998d4a&amp;v=4" onerror="this.onerror=null;this.src='/dd/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">小智</div><div class="author-info-description">孤独患者</div><div class="site-data"><a href="/dd/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/dd/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/dd/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/xxxxx" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">一、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1、进程与线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%A4%E8%80%85%E5%AF%B9%E6%AF%94"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 两者对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%B9%B6%E8%A1%8C%E5%92%8C%E5%B9%B6%E5%8F%91"><span class="toc-number">1.2.</span> <span class="toc-text">2、并行和并发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%B9%B6%E5%8F%91"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 并发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%B9%B6%E8%A1%8C"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 并行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Java%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">二、Java线程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%92%8C%E8%BF%90%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">1、创建和运行线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9AThread"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 方式一：Thread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9ARunnable"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 方式二：Runnable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%96%B9%E5%BC%8F%E4%B8%89%EF%BC%9AFutureTask"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 方式三：FutureTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81Thread-%E5%92%8C-Runnable-%E7%9A%84%E5%85%B3%E7%B3%BB%EF%BC%88%E5%8E%9F%E7%90%86%EF%BC%89"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4、Thread 和 Runnable 的关系（原理）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8B%E8%BF%9B%E5%9F%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">2、查看进城线程的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-windows"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1 windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Linux"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2 Linux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Java%E8%87%AA%E5%B8%A6%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.3.</span> <span class="toc-text">3.2 Java自带工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">3、线程运行原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%A0%88%E5%92%8C%E6%A0%88%E5%B8%A7"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 栈和栈帧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%EF%BC%88Thread-Context-Switch%EF%BC%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 线程上下文切换（Thread Context Switch）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95"><span class="toc-number">2.4.</span> <span class="toc-text">4、常见方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-start%E5%92%8Crun"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 start和run</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-join"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-interrupt%E3%80%81interrupted%E3%80%81isInterrupted"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.3 interrupt、interrupted、isInterrupted</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-%E6%89%93%E6%96%AD-wait%E3%80%81sleep%E3%80%81join-%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">4.3.1 打断 wait、sleep、join 的线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-%E6%89%93%E6%96%AD%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">4.3.2 打断正常运行的线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.4.3.3.</span> <span class="toc-text">4.3.3 两阶段终止模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-4-%E6%89%93%E6%96%ADpack%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.4.3.4.</span> <span class="toc-text">4.3.4 打断pack线程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-sleep-%E4%B8%8E-yield"><span class="toc-number">2.4.4.</span> <span class="toc-text">4.4  sleep 与 yield</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">2.4.5.</span> <span class="toc-text">4.5 线程优先级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F-%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">5、同步模式-两阶段终止模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%B8%8D%E6%8E%A8%E8%8D%90%E6%96%B9%E6%B3%95"><span class="toc-number">2.6.</span> <span class="toc-text">6、不推荐方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E4%B8%BB%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.7.</span> <span class="toc-text">7、主线程与守护线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="toc-number">2.8.</span> <span class="toc-text">8、线程状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E4%BA%94%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">2.8.1.</span> <span class="toc-text">8.1 五种状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%85%AD%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">2.8.2.</span> <span class="toc-text">8.2 六种状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">三、共享模型之管程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%85%B1%E4%BA%AB%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">1、共享带来的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%87%8F%E4%BE%8B%E5%AD%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">加减例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90"><span class="toc-number">3.1.2.</span> <span class="toc-text">问题解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E7%95%8C%E5%8C%BA-Critical-Section-%E5%92%8C-%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6-Race-Condition"><span class="toc-number">3.1.3.</span> <span class="toc-text">临界区 Critical Section 和 竞态条件 Race Condition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81synchronized%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.2.</span> <span class="toc-text">2、synchronized解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%94%B9%E8%BF%9B"><span class="toc-number">3.2.3.</span> <span class="toc-text">面向对象改进</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%96%B9%E6%B3%95%E4%B8%8A%E7%9A%84-synchronized"><span class="toc-number">3.3.</span> <span class="toc-text">3、方法上的 synchronized</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%A0%E9%A2%98%EF%BC%9A%E2%80%9C%E7%BA%BF%E7%A8%8B%E5%85%AB%E9%94%81%E2%80%9D"><span class="toc-number">3.3.1.</span> <span class="toc-text">习题：“线程八锁”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%8F%98%E9%87%8F%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.4.</span> <span class="toc-text">4、变量线程安全分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.4.1.</span> <span class="toc-text">局部变量线程安全分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">基本数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">引用数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E7%B1%BB%E5%AE%89%E5%85%A8"><span class="toc-number">3.4.1.3.</span> <span class="toc-text">子类安全</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%B1%BB"><span class="toc-number">3.4.2.</span> <span class="toc-text">常见线程安全类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%96%B9%E6%B3%95%E7%9A%84%E7%BB%84%E5%90%88"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">线程安全方法的组合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E7%B1%BB%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">不可变类线程安全性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E4%B9%A0%E9%A2%98"><span class="toc-number">3.5.</span> <span class="toc-text">5、习题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%96%E7%A5%A8"><span class="toc-number">3.5.1.</span> <span class="toc-text">卖票</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6"><span class="toc-number">3.5.2.</span> <span class="toc-text">转账</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81Monitor"><span class="toc-number">3.6.</span> <span class="toc-text">6、Monitor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="toc-number">3.6.1.</span> <span class="toc-text">Java对象头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8B-Monitor%EF%BC%88%E9%94%81%EF%BC%89"><span class="toc-number">3.6.2.</span> <span class="toc-text">原理之 Monitor（锁）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8B-synchronized"><span class="toc-number">3.6.3.</span> <span class="toc-text">原理之 synchronized</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8B-synchronized%E8%BF%9B%E9%98%B6"><span class="toc-number">3.6.4.</span> <span class="toc-text">原理之 synchronized进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%95%85%E4%BA%8B"><span class="toc-number">3.6.4.1.</span> <span class="toc-text">小故事</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">3.6.4.2.</span> <span class="toc-text">1.轻量级锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%94%81%E8%86%A8%E8%83%80"><span class="toc-number">3.6.4.3.</span> <span class="toc-text">2.锁膨胀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%87%AA%E6%97%8B%E4%BC%98%E5%8C%96"><span class="toc-number">3.6.4.4.</span> <span class="toc-text">3.自旋优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-number">3.6.4.5.</span> <span class="toc-text">4.偏向锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">3.6.4.5.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E7%8A%B6%E6%80%81"><span class="toc-number">3.6.4.5.2.</span> <span class="toc-text">偏向状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%92%A4%E9%94%80%E5%81%8F%E5%90%91%E9%94%81%E6%83%85%E5%86%B5"><span class="toc-number">3.6.4.5.3.</span> <span class="toc-text">撤销偏向锁情况</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81%E5%AF%B9%E8%B1%A1%E8%B0%83%E7%94%A8-hashCode"><span class="toc-number">3.6.4.5.3.1.</span> <span class="toc-text">1、对象调用 hashCode</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E5%85%B6%E5%AE%83%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.6.4.5.3.2.</span> <span class="toc-text">2、其它线程使用对象</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3%E3%80%81%E8%B0%83%E7%94%A8-wait-notify"><span class="toc-number">3.6.4.5.3.3.</span> <span class="toc-text">3、调用 wait&#x2F;notify</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E9%87%8D%E5%81%8F%E5%90%91"><span class="toc-number">3.6.4.5.4.</span> <span class="toc-text">批量重偏向</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%92%A4%E9%94%80"><span class="toc-number">3.6.4.5.5.</span> <span class="toc-text">批量撤销</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E9%94%81%E6%B6%88%E9%99%A4"><span class="toc-number">3.6.4.6.</span> <span class="toc-text">5.锁消除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81wait-%E5%92%8C-notify"><span class="toc-number">3.7.</span> <span class="toc-text">7、wait 和 notify</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%95%85%E4%BA%8B-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81wait"><span class="toc-number">3.7.1.</span> <span class="toc-text">小故事 - 为什么需要wait</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.7.2.</span> <span class="toc-text">API 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wati-notify-%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF"><span class="toc-number">3.7.3.</span> <span class="toc-text">wati &#x2F; notify 的正确使用姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep-n-%E5%92%8C-wait-n-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">3.7.3.1.</span> <span class="toc-text">sleep(n) 和 wait(n) 的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%BD%93%E4%BC%9A%E4%B8%80%E4%B8%8B%E4%B8%A4%E8%80%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">3.7.3.2.</span> <span class="toc-text">案例：体会一下两者的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#setp1%EF%BC%9Asleepd%E7%AD%89%E5%BE%85"><span class="toc-number">3.7.3.2.1.</span> <span class="toc-text">setp1：sleepd等待</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setp2%EF%BC%9Await-notify-%E6%9C%BA%E5%88%B6"><span class="toc-number">3.7.3.2.2.</span> <span class="toc-text">setp2：wait - notify 机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setp3%EF%BC%9AnotifyAll"><span class="toc-number">3.7.3.2.3.</span> <span class="toc-text">setp3：notifyAll()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setp4%EF%BC%9A%E8%A7%A3%E5%86%B3%E8%99%9A%E5%81%87%E7%AD%89%E5%BE%85"><span class="toc-number">3.7.3.2.4.</span> <span class="toc-text">setp4：解决虚假等待</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8Bwati-notify"><span class="toc-number">3.7.4.</span> <span class="toc-text">原理之wati &#x2F; notify</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C"><span class="toc-number">3.7.5.</span> <span class="toc-text">同步模式之保护性暂停</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%9A%E4%B9%89"><span class="toc-number">3.7.5.1.</span> <span class="toc-text">1. 定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.7.5.2.</span> <span class="toc-text">2. 实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%B6%85%E6%97%B6%E7%89%88-GuardedObject"><span class="toc-number">3.7.5.3.</span> <span class="toc-text">3. 超时版 GuardedObject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%8E%9F%E7%90%86%E4%B9%8Bjoin"><span class="toc-number">3.7.5.4.</span> <span class="toc-text">4. 原理之join()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%89%88-GuardedObject"><span class="toc-number">3.7.5.5.</span> <span class="toc-text">5. 多任务版 GuardedObject</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">3.7.6.</span> <span class="toc-text">异步模式之生产者消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">3.7.6.1.</span> <span class="toc-text">1.概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">3.7.6.2.</span> <span class="toc-text">2.实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BA%94%E7%94%A8"><span class="toc-number">3.7.6.3.</span> <span class="toc-text">3.应用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81park-unpark"><span class="toc-number">3.8.</span> <span class="toc-text">8、park &amp; unpark</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.8.1.</span> <span class="toc-text">API介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-number">3.8.2.</span> <span class="toc-text">应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">3.8.3.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.8.4.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.9.</span> <span class="toc-text">9、线程状态转换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%86%B51%EF%BC%9ANEW-RUNABLE"><span class="toc-number">3.9.1.</span> <span class="toc-text">情况1：NEW -&gt; RUNABLE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%86%B52%EF%BC%9ARUNNABLE-WAITING"><span class="toc-number">3.9.2.</span> <span class="toc-text">情况2：RUNNABLE &lt;--&gt; WAITING</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%86%B53%EF%BC%9ARUNNABLE-TIMED-WAITING"><span class="toc-number">3.9.3.</span> <span class="toc-text">情况3：RUNNABLE &lt;--&gt; TIMED_WAITING</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%86%B54%EF%BC%9ARUNNABLE-BLOCKED"><span class="toc-number">3.9.4.</span> <span class="toc-text">情况4：RUNNABLE &lt;--&gt; BLOCKED</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%86%B55%EF%BC%9ARUNNABLE-TERMINATED"><span class="toc-number">3.9.5.</span> <span class="toc-text">情况5：RUNNABLE &lt;--&gt; TERMINATED</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E6%B4%BB%E8%B7%83%E6%80%A7"><span class="toc-number">3.10.</span> <span class="toc-text">11、活跃性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%8A%8A%E9%94%81"><span class="toc-number">3.10.1.</span> <span class="toc-text">多把锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-number">3.10.2.</span> <span class="toc-text">死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81"><span class="toc-number">3.10.2.1.</span> <span class="toc-text">什么是死锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E6%AD%BB%E9%94%81"><span class="toc-number">3.10.2.2.</span> <span class="toc-text">定位死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#jconsole"><span class="toc-number">3.10.2.2.1.</span> <span class="toc-text">jconsole</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstack"><span class="toc-number">3.10.2.2.2.</span> <span class="toc-text">jstack</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98"><span class="toc-number">3.10.2.3.</span> <span class="toc-text">案例：哲学家就餐问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B4%BB%E9%94%81"><span class="toc-number">3.10.3.</span> <span class="toc-text">活锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF"><span class="toc-number">3.10.4.</span> <span class="toc-text">饥饿</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81ReentrantLock"><span class="toc-number">3.11.</span> <span class="toc-text">12、ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-number">3.11.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8F%AF%E9%87%8D%E5%85%A5"><span class="toc-number">3.11.2.</span> <span class="toc-text">1.可重入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%AF%E6%89%93%E6%96%AD"><span class="toc-number">3.11.3.</span> <span class="toc-text">2.可打断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%94%81%E8%B6%85%E6%97%B6"><span class="toc-number">3.11.4.</span> <span class="toc-text">3.锁超时</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E8%8E%B7%E5%8F%96%E9%94%81"><span class="toc-number">3.11.4.1.</span> <span class="toc-text">尝试获取锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98"><span class="toc-number">3.11.4.2.</span> <span class="toc-text">解决哲学家就餐问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">3.11.5.</span> <span class="toc-text">4.公平锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%8F%AF%E5%A4%9A%E4%B8%AA%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">3.11.6.</span> <span class="toc-text">5.可多个条件变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95"><span class="toc-number">3.11.6.1.</span> <span class="toc-text">方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E4%B9%B0%E7%83%9F%E5%92%8C%E4%B9%B0%E6%97%A9%E9%A4%90"><span class="toc-number">3.11.6.2.</span> <span class="toc-text">例子：买烟和买早餐</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%A1%BA%E5%BA%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">3.12.</span> <span class="toc-text">同步模式之顺序控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C"><span class="toc-number">3.12.1.</span> <span class="toc-text">顺序执行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#wait-notify-%E7%89%88"><span class="toc-number">3.12.1.1.</span> <span class="toc-text">wait &amp; notify 版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#park-unpark-%E7%89%88"><span class="toc-number">3.12.1.2.</span> <span class="toc-text">park &amp; unpark 版</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%9B%BF%E8%BE%93%E5%87%BA"><span class="toc-number">3.12.2.</span> <span class="toc-text">交替输出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#wait-notify-%E7%89%88-1"><span class="toc-number">3.12.2.1.</span> <span class="toc-text">wait &amp; notify 版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#park-unpark-%E7%89%88-1"><span class="toc-number">3.12.2.2.</span> <span class="toc-text">park &amp; unpark 版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReentranLock%E7%89%88"><span class="toc-number">3.12.2.3.</span> <span class="toc-text">ReentranLock版</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93"><span class="toc-number">3.13.</span> <span class="toc-text">本章小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C-1"><span class="toc-number">3.14.</span> <span class="toc-text">同步模式之保护性暂停</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%86%85%E5%AD%98"><span class="toc-number">4.</span> <span class="toc-text">四、共享模型之内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">Java 内存模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">可见性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.1.</span> <span class="toc-text">可见性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">4.2.2.</span> <span class="toc-text">问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.3.</span> <span class="toc-text">解决问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.4.</span> <span class="toc-text">终止模式之两阶段终止模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B-Balking"><span class="toc-number">4.2.5.</span> <span class="toc-text">同步模式之 Balking</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">监控程序实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E5%8D%95%E4%BE%8B"><span class="toc-number">4.2.5.2.</span> <span class="toc-text">线程安全的单例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">4.3.</span> <span class="toc-text">有序性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">指令重排序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">1.什么是指令重排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">2.指令重排的规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%87%8D%E6%8E%92%E5%BA%8F%E5%AF%B9%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">3.重排序对多线程的影响</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A1%E5%BC%82%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="toc-number">4.3.2.</span> <span class="toc-text">诡异的结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92"><span class="toc-number">4.3.3.</span> <span class="toc-text">禁止指令重排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-%E7%BC%93%E5%AD%98%E7%BB%93%E6%9E%84%E5%8E%9F%E7%90%86"><span class="toc-number">4.3.4.</span> <span class="toc-text">CPU 缓存结构原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volatile%E5%8E%9F%E7%90%86"><span class="toc-number">4.3.5.</span> <span class="toc-text">Volatile原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">4.3.5.1.</span> <span class="toc-text">1、如何保证可见性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">4.3.5.2.</span> <span class="toc-text">2、如何保证有序性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81double-checked-locking-%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.5.3.</span> <span class="toc-text">3、double-checked locking 问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81double-checked-locking-%E8%A7%A3%E5%86%B3"><span class="toc-number">4.3.5.4.</span> <span class="toc-text">4、double-checked locking 解决</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E6%97%A0%E9%94%81-CAS"><span class="toc-number">5.</span> <span class="toc-text">五、共享模型之无锁(CAS)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">CAS概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%94%81-%E9%80%BB%E8%BE%91%E9%94%81"><span class="toc-number">5.1.1.</span> <span class="toc-text">无锁(逻辑锁)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%90%E5%87%BA"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">问题提出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E9%9A%BE%E9%A2%98-%E6%9C%89%E9%94%81"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">解题难题 - 有锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98-%E6%97%A0%E9%94%81"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">解决问题 - 无锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS-%E4%B8%8E-Volatile"><span class="toc-number">5.1.2.</span> <span class="toc-text">CAS 与 Volatile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CAS%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">CAS是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#volatile"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">volatile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%97%A0%E9%94%81%E6%95%88%E7%8E%87%E9%AB%98%E5%91%A2%EF%BC%9F"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">为什么无锁效率高呢？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">CAS类和方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B4%E6%95%B0"><span class="toc-number">5.2.1.</span> <span class="toc-text">原子整数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">三种类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95-1"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#updateAndGet%E5%8E%9F%E7%90%86"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">updateAndGet原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E5%BC%95%E7%94%A8"><span class="toc-number">5.2.2.</span> <span class="toc-text">原子引用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AtomicReference"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">AtomicReference</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-Account-%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="toc-number">5.2.2.1.1.</span> <span class="toc-text">修改 Account 的案例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98-1"><span class="toc-number">5.2.2.1.2.</span> <span class="toc-text">解决问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AtomicStampedReference"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">AtomicStampedReference</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ABA%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.2.2.1.</span> <span class="toc-text">ABA问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">5.2.2.2.2.</span> <span class="toc-text">版本号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3ABA%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.2.2.3.</span> <span class="toc-text">解决ABA问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AtomicMarkableReference"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">AtomicMarkableReference</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B0%E7%BB%84"><span class="toc-number">5.2.3.</span> <span class="toc-text">原子数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E7%B4%AF%E5%8A%A0%E5%99%A8"><span class="toc-number">5.2.4.</span> <span class="toc-text">原子累加器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%AF%E5%8A%A0%E5%99%A8%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83"><span class="toc-number">5.2.4.1.</span> <span class="toc-text">累加器性能比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LongAdder%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">5.2.4.2.</span> <span class="toc-text">LongAdder源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E5%9F%9F"><span class="toc-number">5.2.4.2.1.</span> <span class="toc-text">重要域</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8B%E4%BC%AA%E5%85%B1%E4%BA%AB"><span class="toc-number">5.2.4.2.2.</span> <span class="toc-text">原理之伪共享</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8B-increment"><span class="toc-number">5.2.4.2.3.</span> <span class="toc-text">原理之 increment()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe"><span class="toc-number">5.3.</span> <span class="toc-text">Unsafe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="toc-number">5.3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">5.3.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-number">5.3.3.</span> <span class="toc-text">我自己的原子类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-number">6.</span> <span class="toc-text">六、共享模型之不可变</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E5%8F%98%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-number">6.1.</span> <span class="toc-text">可变的安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%97%B6%E9%97%B4"><span class="toc-number">6.1.1.</span> <span class="toc-text">1、案例：格式化时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF-%E5%8A%A0%E9%94%81"><span class="toc-number">6.1.2.</span> <span class="toc-text">2、解决思路 - 加锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF-%E4%BD%BF%E7%94%A8-DateTimeFormatter"><span class="toc-number">6.1.3.</span> <span class="toc-text">3、解决思路 - 使用 DateTimeFormatter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E6%9E%90"><span class="toc-number">6.1.4.</span> <span class="toc-text">4、分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#final-%E5%8E%9F%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">final 原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.3.</span> <span class="toc-text">不可变设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#final-%E4%BD%BF%E7%94%A8"><span class="toc-number">6.3.1.</span> <span class="toc-text">final 使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%8B%B7%E8%B4%9D"><span class="toc-number">6.3.2.</span> <span class="toc-text">保护性拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81%E7%B1%BB"><span class="toc-number">6.3.3.</span> <span class="toc-text">无状态类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.4.</span> <span class="toc-text">设计模式 - 享元模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">6.4.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%93%E7%8E%B0"><span class="toc-number">6.4.2.</span> <span class="toc-text">体现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DIY-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">6.4.3.</span> <span class="toc-text">DIY-数据库连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8C%96%E7%89%88"><span class="toc-number">6.4.3.1.</span> <span class="toc-text">简化版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E7%89%88"><span class="toc-number">6.4.3.2.</span> <span class="toc-text">改进版</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%B7%A5%E5%85%B7%E4%B9%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.</span> <span class="toc-text">七、工具之线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.1.</span> <span class="toc-text">自定义线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BABlockedQueue-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.创建BlockedQueue 阻塞队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.1.2.</span> <span class="toc-text">2.创建线程池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%B5%8B%E8%AF%95"><span class="toc-number">7.1.3.</span> <span class="toc-text">3.测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%83%85%E5%86%B5%EF%BC%9A%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E6%BB%A1%E4%BA%86"><span class="toc-number">7.1.4.</span> <span class="toc-text">4、情况：阻塞队列满了</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0"><span class="toc-number">7.1.4.1.</span> <span class="toc-text">描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%94%B9%E8%BF%9B"><span class="toc-number">7.1.4.2.</span> <span class="toc-text">代码改进</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">7.1.4.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-number">7.2.</span> <span class="toc-text">ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadPoolExecutor-%E7%B1%BB%E5%88%86%E6%9E%90"><span class="toc-number">7.2.1.</span> <span class="toc-text">ThreadPoolExecutor 类分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81%E8%A1%A8%E7%A4%BA"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">线程池状态表示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">构造方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.2.2.</span> <span class="toc-text">创建线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#newFixedThreadPool"><span class="toc-number">7.2.2.1.</span> <span class="toc-text">newFixedThreadPool</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#newCachedThreadPool"><span class="toc-number">7.2.2.2.</span> <span class="toc-text">newCachedThreadPool</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-number">7.2.3.</span> <span class="toc-text">提交任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ExecutorService%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.3.1.</span> <span class="toc-text">ExecutorService方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">7.2.3.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.2.4.</span> <span class="toc-text">关闭线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shutdown"><span class="toc-number">7.2.4.1.</span> <span class="toc-text">shutdown</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shutdownNow"><span class="toc-number">7.2.4.2.</span> <span class="toc-text">shutdownNow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%95%88%E6%9E%9C"><span class="toc-number">7.2.4.3.</span> <span class="toc-text">使用效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.5.</span> <span class="toc-text">其他方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.2.6.</span> <span class="toc-text">任务调度线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Timer-%E4%B8%8D%E6%8E%A8%E8%8D%90"><span class="toc-number">7.2.6.1.</span> <span class="toc-text">Timer(不推荐)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ScheduledExecutorService"><span class="toc-number">7.2.6.2.</span> <span class="toc-text">ScheduledExecutorService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.2.6.3.</span> <span class="toc-text">定时任务线程池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%EF%BC%9A%E6%AF%8F%E6%98%9F%E6%9C%9F%E5%91%A8%E5%9B%9B6-00%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">7.2.6.4.</span> <span class="toc-text">应用：每星期周四6:00执行任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%B0%91%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%90%88%E9%80%82%EF%BC%9F"><span class="toc-number">7.2.7.</span> <span class="toc-text">创建多少个线程合适？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">7.2.8.</span> <span class="toc-text">Tomcat 线程池源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B-Worker-Thread"><span class="toc-number">7.3.</span> <span class="toc-text">异步模式之 Worker Thread</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF%E7%8E%B0%E8%B1%A1"><span class="toc-number">7.3.2.</span> <span class="toc-text">饥饿现象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%A5%A5%E9%A5%BF%E9%97%AE%E9%A2%98"><span class="toc-number">7.3.3.</span> <span class="toc-text">解决饥饿问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fork-Join"><span class="toc-number">7.4.</span> <span class="toc-text">Fork&#x2F;Join</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-4"><span class="toc-number">7.4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-3"><span class="toc-number">7.4.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">7.4.3.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%94%B9%E8%BF%9B"><span class="toc-number">7.4.4.</span> <span class="toc-text">案例改进</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%B7%A5%E5%85%B7%E4%B9%8BJUC"><span class="toc-number">8.</span> <span class="toc-text">八、工具之JUC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS%E5%8E%9F%E7%90%86"><span class="toc-number">8.1.</span> <span class="toc-text">AQS原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-5"><span class="toc-number">8.1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS-%E4%B8%AD-Node-%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">8.1.2.</span> <span class="toc-text">AQS 中 Node 的状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81"><span class="toc-number">8.1.3.</span> <span class="toc-text">自定义不可重入锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8C%E6%AD%A5%E5%99%A8"><span class="toc-number">8.1.3.1.</span> <span class="toc-text">自定义同步器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%81%EF%BC%88%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5%EF%BC%89"><span class="toc-number">8.1.3.2.</span> <span class="toc-text">自定义锁（不可重入）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">8.1.3.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReentranLock%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.</span> <span class="toc-text">ReentranLock原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.1.</span> <span class="toc-text">非公平锁原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">加锁解锁流程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E6%BA%90%E7%A0%81"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">加锁源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E9%94%81%E6%BA%90%E7%A0%81"><span class="toc-number">8.2.1.3.</span> <span class="toc-text">释放锁源码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.2.</span> <span class="toc-text">可重入锁原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.3.</span> <span class="toc-text">可打断原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E6%89%93%E6%96%AD%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.2.3.1.</span> <span class="toc-text">不可打断模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.2.3.2.</span> <span class="toc-text">可打断模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.4.</span> <span class="toc-text">公平锁实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">8.2.5.</span> <span class="toc-text">条件变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#await%E6%B5%81%E7%A8%8B"><span class="toc-number">8.2.5.1.</span> <span class="toc-text">await流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#await-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="toc-number">8.2.5.2.</span> <span class="toc-text">await 源码解读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#signal-%E6%B5%81%E7%A8%8B"><span class="toc-number">8.2.5.3.</span> <span class="toc-text">signal 流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#signal-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="toc-number">8.2.5.4.</span> <span class="toc-text">signal 源码解读</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81-ReentranReadWriteLock"><span class="toc-number">8.3.</span> <span class="toc-text">读写锁(ReentranReadWriteLock)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-6"><span class="toc-number">8.3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-4"><span class="toc-number">8.3.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.3.</span> <span class="toc-text">读写锁原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">8.3.3.1.</span> <span class="toc-text">流程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">8.3.3.2.</span> <span class="toc-text">源码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Semaphore"><span class="toc-number">8.4.</span> <span class="toc-text">Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-7"><span class="toc-number">8.4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-5"><span class="toc-number">8.4.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">8.4.3.</span> <span class="toc-text">应用 - 连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">8.4.4.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CountdownLatch"><span class="toc-number">8.5.</span> <span class="toc-text">CountdownLatch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-8"><span class="toc-number">8.5.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-6"><span class="toc-number">8.5.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-1"><span class="toc-number">8.5.3.</span> <span class="toc-text">应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E7%AD%89%E5%BE%85%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%87%86%E5%A4%87%E5%AE%8C%E6%AF%95"><span class="toc-number">8.5.3.1.</span> <span class="toc-text">同步等待多线程准备完毕</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E7%AD%89%E5%BE%85%E5%A4%9A%E4%B8%AA%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E7%BB%93%E6%9D%9F"><span class="toc-number">8.5.3.2.</span> <span class="toc-text">同步等待多个远程调用结束</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CyclicBarrier"><span class="toc-number">8.6.</span> <span class="toc-text">CyclicBarrier</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88%E7%B1%BB"><span class="toc-number">9.</span> <span class="toc-text">九、线程安全集合类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConcurrentHashMap-%E5%8E%9F%E7%90%86"><span class="toc-number">9.1.</span> <span class="toc-text">ConcurrentHashMap 原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Queue"><span class="toc-number">9.2.</span> <span class="toc-text">Queue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LinkedBlockingQueue-%E5%8E%9F%E7%90%86"><span class="toc-number">9.2.1.</span> <span class="toc-text">LinkedBlockingQueue 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConcurrentLinkedQueue%E5%8E%9F%E7%90%86"><span class="toc-number">9.2.2.</span> <span class="toc-text">ConcurrentLinkedQueue原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CopyOnWriteArrayList"><span class="toc-number">9.3.</span> <span class="toc-text">CopyOnWriteArrayList</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dd/2024/10/25/Dubbo/" title="Dubbo">Dubbo</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dd/2024/10/25/JVM/" title="JVM">JVM</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dd/2024/10/25/IDEA/" title="IDEA">IDEA</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dd/2024/10/25/Git&amp;GitHub&amp;Gitee/" title="Git&amp;GitHub&amp;Gitee">Git&amp;GitHub&amp;Gitee</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dd/2024/10/25/Maven/" title="Maven">Maven</a><time datetime="2024-10-24T17:53:53.000Z" title="Created 2024-10-25 01:53:53">2024-10-25</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347);"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 小智</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/dd/js/utils.js"></script><script src="/dd/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>